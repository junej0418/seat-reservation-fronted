<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
<title>ëœì„ ì„ ì˜ˆì•½ ì‹œìŠ¤í…œ</title>
<link rel="icon" href="data:;base64,iVBORw0KGgo="> 
<style>
  /* CSS ìŠ¤íƒ€ì¼: ì´ì „ ë²„ì „ê³¼ ë™ì¼í•˜ë©°, ëª¨ë“  ì„¸ë¶€ ìŠ¤íƒ€ì¼ì´ í¬í•¨ë˜ì–´ ìˆìŠµë‹ˆë‹¤. */
  /* ê°€ë…ì„±ì„ ìœ„í•´ ì£¼ì„ ì²˜ë¦¬í•˜ì§€ë§Œ, ì‹¤ì œ ì½”ë“œì—ëŠ” ëª¨ë“  CSSê°€ ë“¤ì–´ê°‘ë‹ˆë‹¤. */
  body {
    font-family: 'Malgun Gothic', Arial, sans-serif;
    margin: 0; padding: 10px 0;
    background: #fafafc;
    color: #2c3e50;
  }
  h1, h2 {
    text-align: center;
    margin: 1em 0;
    color: #334155;
  }
  .container {
    max-width: 960px;
    margin: 10px auto 40px;
    background: white;
    padding: 15px 20px;
    border-radius: 12px;
    box-shadow: 0 0 20px rgba(0,0,0,0.06);
  }
  .hidden { display: none !important; }
  form {
    max-width: 400px;
    margin: 0 auto;
  }
  label {
    font-weight: 700;
    margin-top: 12px;
    display: block;
    color: #475569;
  }
  input[type=text], input[type=password], input[type=datetime-local], select, textarea {
    width: 100%;
    padding: 10px 12px;
    margin-top: 6px;
    font-size: 1rem;
    border: 2px solid #cbd5e1;
    border-radius: 8px;
    box-sizing: border-box;
    transition: border-color 0.3s;
  }
  input[type=text]:focus, input[type=password]:focus, input[type=datetime-local]:focus,
  select:focus, textarea:focus {
    border-color: #fbbf24;
    outline: none;
  }
  .error {
    color: #dc2626;
    font-size: 0.9rem;
    height: 20px;
    margin-top: 4px;
  }
  button {
    background-color: #fbbf24;
    border: none;
    border-radius: 8px;
    padding: 12px 25px;
    font-size: 1.1rem;
    font-weight: 700;
    color: #92400e;
    cursor: pointer;
    margin-top: 20px;
    box-shadow: 1px 3px 6px rgba(251,191,36,0.5);
    transition: background-color 0.3s;
    display: inline-block;
    min-width: 120px;
  }
  button:hover:not(:disabled) {
    background-color: #f59e0b;
  }
  button:disabled {
    background-color: #fde68a;
    cursor: not-allowed;
  }
  nav {
    text-align: center;
    margin-top: 20px;
  }
  nav button {
    background: transparent;
    color: #b45309;
    font-weight: 600;
    padding: 8px 16px;
    border: 2px solid #fbbf24;
    border-radius: 8px;
    cursor: pointer;
    transition: background-color 0.3s;
  }
  nav button:hover {
    background-color: #fbbf24;
    color: #92400e;
  }
  #seatMapWrapper {
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
    padding-bottom: 10px;
  }
  #seatMap {
    margin: 20px auto 40px;
    display: grid;
    gap: 8px;
    justify-content: center;
    min-width: fit-content;
  }
  .seat-btn {
    background: #CCFFCC;
    border: 2px solid #88CC88;
    font-weight: 700;
    color: #336633;
    cursor: pointer;
    user-select: none;
    display: flex;
    justify-content: center;
    align-items: center;
    font-size: 1.1rem;
    min-width: 44px;
    aspect-ratio: 1 / 1;
    border-radius: 6px;
    transition: background-color 0.3s, border-color 0.3s;
  }
  .seat-btn:hover:not(.booked) {
    background-color: #AACC88;
    border-color: #669944;
  }
  .seat-btn.booked {
    background: #FFCCCC;
    border: 2px solid #CC8888;
    color: #663333;
    cursor: not-allowed;
  }
  .seat-btn.mine {
    background: #FFCCFF;
    border: 2px solid #CC88CC;
    color: #663366;
  }
  .seat-btn.selected {
    background: #ffcc99;
    border: 2px solid #ff9933;
    color: #663300;
  }
  .seat-btn.empty {
    visibility: hidden;
    pointer-events: none;
  }
  table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 15px;
    font-size: 1rem;
  }
  th, td {
    border: 1px solid #cbd5e1;
    padding: 10px 12px;
    text-align: center;
  }
  th {
    background-color: #fbbf24;
    color: #92400e;
  }
  td button {
    background: #ef4444;
    color: white;
    border: none;
    border-radius: 6px;
    padding: 6px 12px;
    font-weight: 600;
    cursor: pointer;
    transition: background-color 0.3s;
  }
  td button:hover {
    background: #b91c1c;
  }
  #reservationAvailabilityMessage {
    margin-top: 10px;
    font-weight: 700;
    padding: 0.5em;
    border-radius: 5px;
    text-align: center;
    color: #ef4444;
    background-color: #fee2e2;
  }
  #reservationAvailabilityMessage.available {
    color: #10b981;
    background-color: #d1fae5;
  }
  #timeSettingMessage {
    margin-top: 12px;
    text-align: center;
    font-size: 0.9rem;
    min-height: 1.5em;
  }
  @media (max-width: 768px) {
    .container {
      margin: 10px auto 30px;
      padding: 10px;
    }
    .seat-btn {
      min-width: 38px;
      font-size: 1rem;
    }
    h1, h2 { font-size: 1.5rem; }
  }
  @media (max-width: 480px) {
    body { padding: 5px; }
    .container {
      margin: 5px auto 20px;
      padding: 8px;
      border-radius: 8px;
    }
    h1, h2 { font-size: 1.4rem; margin: 0.8em 0; }
    label, input, select, textarea { font-size: 0.9rem; }
    button { padding: 8px 12px; font-size: 0.95rem; margin-top: 15px; min-width: auto; }
    nav button { padding: 5px 8px; font-size: 0.85rem; }
    .seat-btn {
      min-width: 26px;
      font-size: 0.85rem;
      padding: 0;
    }
    table { font-size: 0.8rem; }
    th, td { padding: 6px 4px; }
    td button { padding: 3px 6px; font-size: 0.75rem; }
  }
  .announcement-overlay {
    position: fixed;
    top: 0; left: 0;
    width: 100%; height: 100%;
    background: rgba(0,0,0,0.7);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 1000;
  }
  .announcement-popup {
    background: white;
    padding: 30px;
    border-radius: 10px;
    box-shadow: 0 0 25px rgba(0,0,0,0.5);
    max-width: 500px;
    width: 90%;
    text-align: left;
    position: relative;
    font-size: 1.1rem;
    line-height: 1.5;
  }
  .announcement-popup h3 {
    margin-top: 0;
    color: #b45309;
    font-size: 1.5rem;
    margin-bottom: 20px;
    text-align: center;
  }
  .announcement-popup p {
    margin-bottom: 20px;
    color: #333;
    white-space: pre-wrap;
  }
  .announcement-popup button.close-btn {
    background: #b45309;
    color: white;
    border: none;
    border-radius: 5px;
    padding: 10px 20px;
    cursor: pointer;
    font-size: 1rem;
    transition: background 0.3s;
    margin: 0 auto;
    display: block;
  }
  .announcement-popup button.close-btn:hover {
    background: #8e420b;
  }
  #announcementMessageInput {
    width: calc(100% - 20px);
    height: 80px;
    padding: 10px;
    margin-top: 10px;
    border: 1px solid #ccc;
    border-radius: 5px;
    resize: vertical;
    font-size: 1rem;
  }
  #announcementActiveCheckbox {
    margin-top: 15px;
    margin-right: 8px;
  }
  .button-group {
    display: flex;
    justify-content: space-between; 
    align-items: center;
    width: 100%;
    margin-top: 20px;
    flex-wrap: wrap; 
  }
  .button-group button {
    margin-top: 0;
    flex-grow: 1;
    margin: 5px;
    min-width: 100px;
  }
  #homeButton {
    background-color: #3498db;
    color: white;
    box-shadow: 1px 3px 6px rgba(52,152,219,0.5);
  }
  #homeButton:hover {
    background-color: #2980b9;
  }
  .color-legend {
    text-align: center;
    margin-top: 30px;
    padding: 15px;
    border-top: 1px solid #eee;
    display: flex;
    flex-wrap: wrap;
    justify-content: center;
    gap: 20px;
    font-size: 0.9rem;
    color: #555;
  }
  .legend-item {
    display: flex;
    align-items: center;
    gap: 8px;
  }
  .legend-box {
    width: 20px;
    height: 20px;
    border-radius: 4px;
    border: 1px solid #ccc;
  }
  .legend-box.empty {
    background-color: #CCFFCC;
    border-color: #88CC88;
  }
  .legend-box.booked {
    background-color: #FFCCCC;
    border-color: #CC8888;
  }
  .legend-box.mine {
    background-color: #FFCCFF;
    border-color: #CC88CC;
  }
</style>

<body>
  <div class="container" id="loginPage">
    <h1>ëœì„ ì„ ì˜ˆì•½ ë¡œê·¸ì¸</h1>
    <form id="loginForm" autocomplete="off" novalidate>
      <label for="roomNo">ë£¸ ë²ˆí˜¸ (000í˜¸ í˜•ì‹):</label>
      <input type="text" id="roomNo" name="roomNo" placeholder="ì˜ˆ: 101í˜¸" required />
      <div id="roomError" class="error"></div>

      <label for="userName">ì´ë¦„ (í•œê¸€ 2~4ì):</label>
      <input type="text" id="userName" name="userName" placeholder="ì˜ˆ: í™ê¸¸ë™" required />
      <div id="nameError" class="error"></div>

      <label for="dormitory">ê¸°ìˆ™ì‚¬ ì„ íƒ:</label>
      <select id="dormitory" name="dormitory" required>
        <option value="" disabled selected>ì„ íƒí•˜ì„¸ìš”</option>
        <option value="ê¿ˆë™">ê¿ˆë™</option>
        <option value="ë¯¸ë˜ë™">ë¯¸ë˜ë™</option>
      </select>
      <div id="dormError" class="error"></div>
      
      <label for="userPassword">ë¹„ë°€ë²ˆí˜¸ ì„¤ì • (4ìë¦¬ ìˆ«ì):</label>
      <input type="password" id="userPassword" name="userPassword" placeholder="ì˜ˆ: 1234" pattern="\d{4}" maxlength="4" required />
      <div id="passwordError" class="error"></div>

      <input type="text" name="honeypot_field" style="display:none; width:0; height:0; border:none;" tabindex="-1" autocomplete="off" />

      <button type="submit">ë‹¤ìŒ</button>
    </form>
    <nav>
      <button id="adminLoginBtn" type="button">ê´€ë¦¬ì ë¡œê·¸ì¸</button>
    </nav>
  </div>

  <div class="container hidden" id="floorSelectPage">
    <h2><span id="welcomeText"></span>ë‹˜, ì¸µì„ ì„ íƒí•´ì£¼ì„¸ìš”</h2>
    <select id="floorSelect" aria-label="ì¸µ ì„ íƒ"></select>
    <div class="button-group">
      <button id="backToLoginBtn" type="button">ë’¤ë¡œê°€ê¸°</button>
      <button id="floorNextBtn" type="button">ì¢Œì„ ì„ íƒìœ¼ë¡œ</button>
    </div>
  </div>

  <div class="container hidden" id="seatMapPage">
    <h2>ì¢Œì„ ë°°ì¹˜ë„ - <span id="selectedDorm"></span> <span id="selectedFloor"></span>ì¸µ</h2>
    <div id="seatMapWrapper">
      <div id="seatMap"></div>
    </div>
    <div id="reservationAvailabilityMessage"></div>
    <div class="button-group">
      <button id="homeButton" type="button">í™ˆìœ¼ë¡œ</button> 
      <button id="backToFloorBtn" type="button">ë’¤ë¡œê°€ê¸°</button> 
      <button id="cancelMyReservationBtn" type="button" class="hidden">ë‚´ ì˜ˆì•½ ì·¨ì†Œ</button>
      <button id="confirmBtn" type="button" disabled>ì˜ˆì•½ í™•ì •</button>
    </div>
    <div class="color-legend">
      <div class="legend-item"><div class="legend-box empty"></div>ë¹ˆìë¦¬</div>
      <div class="legend-item"><div class="legend-box booked"></div>ì˜ˆì•½ë¨</div>
      <div class="legend-item"><div class="legend-box mine"></div>ë‚´ ìë¦¬</div>
    </div>
  </div>

  <div class="container hidden" id="adminLoginPage">
    <h1>ê´€ë¦¬ì ë¡œê·¸ì¸</h1>
    <form id="adminLoginForm" autocomplete="off" novalidate>
      <label for="adminPasswordInput">ë¹„ë°€ë²ˆí˜¸:</label>
      <div style="position: relative;">
        <input type="password" id="adminPasswordInput" name="adminPassword" required style="padding-right: 35px;" />
        <button type="button" id="toggleAdminPasswordBtn" 
          style="position: absolute; right: 5px; top: 50%; transform: translateY(-50%); background: none; border: none; cursor: pointer;">
          ğŸ‘ï¸
        </button>
      </div>
      <div id="adminError" class="error"></div>
      <div class="button-group">
        <button id="adminLoginBackBtn" type="button">ë¡œê·¸ì¸í˜ì´ì§€ë¡œ ëŒì•„ê°€ê¸°</button>
        <button type="submit">ë¡œê·¸ì¸</button>
      </div>
    </form>
  </div>

  <div class="container hidden" id="adminPage">
    <h1>ê´€ë¦¬ì í˜ì´ì§€</h1>
    <button id="adminLogoutBtn" type="button">ë¡œê·¸ì•„ì›ƒ</button>

    <h2>ì˜ˆì•½ ê°€ëŠ¥ ì‹œê°„ ì„¤ì •</h2>
    <form id="reservationTimeForm" novalidate>
      <label for="resStartTimeInput">ì˜ˆì•½ ì‹œì‘ ì‹œê°„:</label>
      <input type="datetime-local" id="resStartTimeInput" required />
      <label for="resEndTimeInput">ì˜ˆì•½ ì¢…ë£Œ ì‹œê°„:</label>
      <input type="datetime-local" id="resEndTimeInput" required />
      <button type="submit">ì‹œê°„ ì„¤ì • ì €ì¥</button>
      <div id="timeSettingMessage"></div>
    </form>

    <hr>

    <h2>ê³µì§€ì‚¬í•­ ì„¤ì •</h2>
    <form id="announcementForm" novalidate>
      <label for="announcementMessageInput">ê³µì§€ ë‚´ìš©:</label>
      <textarea id="announcementMessageInput" rows="4" placeholder="ê³µì§€ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”." rows="4"></textarea>
      <div>
        <input type="checkbox" id="announcementActiveCheckbox" />
        <label for="announcementActiveCheckbox">ê³µì§€ í™œì„±í™”</label>
      </div>
      <button type="submit">ê³µì§€ ì €ì¥</button>
      <div id="announcementMessageStatus" class="error"></div>
    </form>

    <hr>

    <h2>ì˜ˆì•½ í˜„í™©</h2>
    <table>
      <thead>
        <tr><th>ì´ë¦„</th><th>ë£¸ ë²ˆí˜¸</th><th>ê¸°ìˆ™ì‚¬</th><th>ì¸µ</th><th>ìë¦¬ ë²ˆí˜¸</th><th>ì˜ˆì•½ ì‹œê°„</th><th>ì˜ˆì•½ ë¹„ë°€ë²ˆí˜¸</th><th>ì·¨ì†Œ</th></tr>
      </thead>
      <tbody id="reservationListBody"></tbody>
    </table>

    <button id="clearAllReservationsBtn" type="button" style="background-color: #dc2626; color: white; float: right; margin-top: 15px;">ëª¨ë“  ì˜ˆì•½ ì·¨ì†Œ</button>
  </div>

  <div class="announcement-overlay hidden" id="announcementOverlay">
    <div class="announcement-popup">
      <h3>ê³µì§€ì‚¬í•­</h3>
      <p id="announcementMessage"></p>
      <button class="close-btn" type="button">ë‹«ê¸°</button>
    </div>
  </div>

  <script src="https://seat-reservation-backend-ygl9.onrender.com/socket.io/socket.io.js"></script>

  <script>
    (() => {
      const BACKEND_URL = "https://seat-reservation-backend-ygl9.onrender.com";
      let socket = null;

      let allReservations = {};
      let adminSettings = {};
      let availabilityCheckInterval = null;
      let prevAllowedState = null;
      let currentAnnouncement = null;
      let isAdminLoggedIn = !!localStorage.getItem('adminPassword');

      let loginPage, loginForm, roomNoInput, userNameInput, dormitorySelect, userPasswordInput, passwordError, adminLoginBtn;
      let floorSelectPage, floorSelect, floorNextBtn, backToLoginBtn, welcomeText;
      let seatMapPage, seatMapContainer, confirmBtn, cancelMyReservationBtn, backToFloorBtn, selectedDormTitle, selectedFloorTitle, reservationAvailabilityMessage;
      let homeButton;
      let adminLoginPage, adminLoginForm, adminPasswordInput, toggleAdminPasswordBtn, adminError;
      let adminPage, adminLogoutBtn, reservationListBody, clearAllReservationsBtn;
      let reservationTimeForm, resStartTimeInput, resEndTimeInput, timeSettingMessage;
      let announcementOverlay, announcementPopupMessage, announcementCloseBtn, announcementForm, announcementMessageInput, announcementActiveCheckbox, announcementMessageStatus;

      let currentUser = JSON.parse(localStorage.getItem('currentUser')) || null;
      // deviceIdentifierëŠ” ì œê±°ë˜ì—ˆìœ¼ë¯€ë¡œ ë” ì´ìƒ ì‚¬ìš©í•˜ì§€ ì•ŠìŒ
      // let deviceIdentifier = localStorage.getItem('deviceIdentifier') || generateUniqueId();
      // localStorage.setItem('deviceIdentifier', deviceIdentifier);

      let currentUserReservation = null;
      let currentFloor = null;
      let selectedSeat = null;

      const roomNoPattern = /^\d{3}í˜¸$/;
      const koreanNamePattern = /^[ê°€-í£]{2,4}$/;
      const userPasswordPattern = /^\d{4}$/; // 4ìë¦¬ ìˆ«ì ë¹„ë°€ë²ˆí˜¸ íŒ¨í„´

      const seatLayouts = {
        "ê¿ˆë™": {
          "2": [
            [null,4,null,5,6,7,8,9,10,null,null,null,null],
            [null,3,null,null,null,null,null,null,null,11,null,null,null],
            [null,2,null,null,null,null,null,null,null,12,null,null,null],
            [null,1,null,null,null,null,null,null,null,null,null,null,null]
          ],
          "3": [
            [null,4,null,5,6,7,8,9,10,null,11,null,null,null],
            [null,3,null,null,null,null,null,null,null,null,12,null,null,null],
            [null,2,null,null,null,null,null,null,null,null,13,null,null,null],
            [null,1,null,null,null,null,null,null,null,null,14,null,null,null]
          ],
          "4": [
            [null,4,null,null,null,null,null,null,null,null],
            [null,3,null,null,5,7,null,null,null,null],
            [null,2,null,null,6,8,null,null,null,null],
            [null,1,null,null,null,null,null,null,null,null]
          ],
          "5": [
            [null,4,null,null,null,5,8,null,null,null],
            [null,3,null,null,null,6,9,null,null,null],
            [null,2,null,null,null,7,10,null,null,null],
            [null,1,null,null,null,null,null,null,null,null]
          ],
          "8": [
            [null,4,null,5,6,7,8,null,null,null,null,null,null],
            [null,3,null,null,null,null,null,null,null,null,null,null,null],
            [null,2,null,null,null,null,null,null,null,null,null,null,null],
            [null,1,null,null,null,null,null,null,null,null,null,null,null]
          ]
        },
        "ë¯¸ë˜ë™": {
          "2": [
            [null,null,null,null,null,5,6,7,8,9,10,11,12,null,null,null,null,null],
            [null,null,null,null,4,null,null,null,null,null,null,null,null,13,null,null,null,null],
            [null,null,null,null,3,null,null,null,null,null,null,null,null,14,null,null,null,null],
            [null,null,1,2,null,null,null,null,null,null,null,null,null,null,15,16,null,null],
            [null,17,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null]
          ],
          "4-1": [
            [null,3,null,4,5,null,6,null,null],
            [null,2,null,null,null,null,7,null,null],
            [null,1,null,null,null,null,8,null,null]
          ],
          "4-2": [
            [null,4,null,5,6,7,8,9,10,11,12,null,13,null],
            [null,3,null,null,null,null,null,null,null,null,null,null,14,null],
            [null,2,null,null,null,null,null,null,null,null,null,null,null,null],
            [null,1,null,null,null,null,null,null,null,null,null,null,null,null]
          ]
        }
      };

      // ê¸°ê¸° ì‹ë³„ì ìƒì„± í•¨ìˆ˜ (ì‚¬ìš©ì ë¹„ë°€ë²ˆí˜¸ ì¸ì¦ìœ¼ë¡œ ëŒ€ì²´ë˜ì—ˆì§€ë§Œ, ê¸°ì¡´ êµ¬ì¡° ìœ ì§€ë¥¼ ìœ„í•´ ì •ì˜ë§Œ ë‚¨ê²¨ë‘¡ë‹ˆë‹¤.)
      function generateUniqueId() {
        return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
          const r = Math.random() * 16 | 0;
          const v = c === 'x' ? r : (r & 0x3 | 0x8);
          return v.toString(16);
        });
      }

      // API í˜¸ì¶œ í•¨ìˆ˜ë“¤
      async function fetchAllReservations() {
        try {
          const res = await fetch(`${BACKEND_URL}/api/reservations`);
          if (!res.ok) throw new Error('ì˜ˆì•½ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨: ' + res.statusText);
          const data = await res.json();
          allReservations = {};
          data.forEach(r => allReservations[r._id] = r);
        } catch (e) {
          alert('ì˜ˆì•½ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¤ëŠ” ë° ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë°±ì—”ë“œ ì„œë²„ ìƒíƒœë¥¼ í™•ì¸í•˜ì„¸ìš”.');
          console.error('API í˜¸ì¶œ ì—ëŸ¬: fetchAllReservations', e);
          return {};
        }
      }

      async function fetchAdminSettings() {
        try {
          const adminPass = localStorage.getItem('adminPassword');
          const headers = { 'Content-Type': 'application/json' };
          if (adminPass) {
            headers['Authorization'] = `Bearer ${adminPass}`;
          }

          const res = await fetch(`${BACKEND_URL}/api/admin-settings`, {
            method: 'GET',
            headers: headers,
          });

          if (!res.ok) {
            if (res.status === 401 || res.status === 403) {
              isAdminLoggedIn = false;
              localStorage.removeItem('adminPassword');
            }
            const errorData = await res.json(); // ì—ëŸ¬ ì‘ë‹µ íŒŒì‹±
            throw new Error(errorData.message || 'ê´€ë¦¬ì ì„¤ì • ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨: ' + res.statusText);
          }
          adminSettings = await res.json();
          if (adminSettings.reservationStartTime) {
            resStartTimeInput.value = formatDateTimeLocal(adminSettings.reservationStartTime);
          }
          if (adminSettings.reservationEndTime) {
            resEndTimeInput.value = formatDateTimeLocal(adminSettings.reservationEndTime);
          }
        } catch (e) {
          console.error('API í˜¸ì¶œ ì—ëŸ¬: fetchAdminSettings', e);
          adminSettings = { reservationStartTime: null, reservationEndTime: null }; // ì˜¤ë¥˜ ì‹œ ì„¤ì • ì´ˆê¸°í™”
          if (resStartTimeInput) resStartTimeInput.value = '';
          if (resEndTimeInput) resEndTimeInput.value = '';
          return adminSettings;
        }
      }

      async function fetchAnnouncement() {
        try {
          const adminPass = localStorage.getItem('adminPassword');
          const headers = { 'Content-Type': 'application/json' };
          if (adminPass) {
            headers['Authorization'] = `Bearer ${adminPass}`;
          }

          const res = await fetch(`${BACKEND_URL}/api/announcement`, {
            method: 'GET',
            headers: headers,
          });
          
          if (!res.ok) {
            if (res.status === 401 || res.status === 403) {
              isAdminLoggedIn = false;
              localStorage.removeItem('adminPassword');
            }
            const errorData = await res.json(); // ì—ëŸ¬ ì‘ë‹µ íŒŒì‹±
            throw new Error(errorData.message || 'ê³µì§€ì‚¬í•­ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨: ' + res.statusText);
          }
          currentAnnouncement = await res.json();
          updateAnnouncementDisplay();
        } catch (e) {
          console.error('API í˜¸ì¶œ ì—ëŸ¬: fetchAnnouncement', e);
          hideAnnouncement(); // ê³µì§€ì‚¬í•­ ìˆ¨ê¹€ ì²˜ë¦¬
          return null;
        }
      }

      async function adminLogin(password) {
        try {
          const res = await fetch(`${BACKEND_URL}/api/admin-login`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ password })
          });
          const data = await res.json();
          if (res.ok && data.success) { // `res.ok`ë¥¼ í•¨ê»˜ í™•ì¸
            adminError.textContent = '';
            localStorage.setItem('adminPassword', password);
            isAdminLoggedIn = true;
            return true;
          } else {
            adminError.textContent = data.message || 'ë¡œê·¸ì¸ ì‹¤íŒ¨';
            isAdminLoggedIn = false;
            localStorage.removeItem('adminPassword');
            return false;
          }
        } catch (e) {
          console.error('API í˜¸ì¶œ ì—ëŸ¬: adminLogin', e);
          adminError.textContent = 'ë¡œê·¸ì¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';
          isAdminLoggedIn = false;
          localStorage.removeItem('adminPassword');
          return false;
        }
      }

      async function sendReservation(reservationData) {
        try {
          // password í•„ë“œëŠ” reservationDataì— ì´ë¯¸ í¬í•¨ë˜ì–´ ìˆìŒ
          const payload = { ...reservationData }; 
          const res = await fetch(`${BACKEND_URL}/api/reservations`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
          });
          const data = await res.json();
          if (!res.ok) {
            const errorMsg = data.message || 'ì˜ˆì•½ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';
            throw new Error(errorMsg);
          }
          return { success: true, message: data.message, newReservation: data.newReservation };
        } catch (e) {
          console.error('API í˜¸ì¶œ ì—ëŸ¬: sendReservation', e);
          return { success: false, message: e.message || 'ì˜ˆì•½ ì²˜ë¦¬ ì¤‘ ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜ ë°œìƒ' };
        }
      }

      async function updateReservation(reservationId, updatedData, password) {
          try {
              if (!currentUser) throw new Error('ë¡œê·¸ì¸ëœ ì‚¬ìš©ì ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤. ë‹¤ì‹œ ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.');

              // password í•„ë“œë¥¼ updatedDataì— ì¶”ê°€
              const payload = { ...updatedData, password }; 

              const res = await fetch(`${BACKEND_URL}/api/reservations/update/${reservationId}`, {
                  method: 'PUT',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify(payload)
              });
              const data = await res.json();
              if (!res.ok) {
                  const errorMsg = data.message || 'ì˜ˆì•½ ë³€ê²½ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';
                  throw new Error(errorMsg);
              }
              return { success: true, message: data.message, updatedReservation: data.updatedReservation };
          } catch (e) {
              console.error('API í˜¸ì¶œ ì—ëŸ¬: updateReservation', e);
              return { success: false, message: e.message || 'ì˜ˆì•½ ë³€ê²½ ì¤‘ ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜ ë°œìƒ' };
          }
      }

      async function deleteReservation(id, password, isAdmin = false) {
        try {
          const payload = { password }; // ì˜ˆì•½ ë¹„ë°€ë²ˆí˜¸
          if (isAdmin) { // ê´€ë¦¬ì ìš”ì²­ì¸ ê²½ìš°, ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ ì¶”ê°€
            payload.isAdmin = true;
            payload.adminPassword = localStorage.getItem('adminPassword');
          }
          
          const res = await fetch(`${BACKEND_URL}/api/reservations/${id}`, {
            method: 'DELETE',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
          });
          const data = await res.json();
          if (!res.ok) throw new Error(data.message || 'ì˜ˆì•½ ì·¨ì†Œ ì‹¤íŒ¨');
          return { success: true, message: data.message };
        } catch (e) {
          console.error('API í˜¸ì¶œ ì—ëŸ¬: deleteReservation', e);
          return { success: false, message: e.message || 'ì˜ˆì•½ ì·¨ì†Œ ì¤‘ ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜ ë°œìƒ' };
        }
      }

      async function deleteAllReservations() {
        try {
          if (!isAdminLoggedIn) {
            throw new Error('ê´€ë¦¬ì ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤. ê´€ë¦¬ìë¡œ ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.');
          }
          const adminPass = localStorage.getItem('adminPassword');
          const res = await fetch(`${BACKEND_URL}/api/reservations/all`, {
            method: 'DELETE',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ adminPassword: adminPass })
          });
          const data = await res.json();
          if (!res.ok) throw new Error(data.message || 'ëª¨ë“  ì˜ˆì•½ ì·¨ì†Œ ì‹¤íŒ¨');
          return { success: true, message: data.message };
        } catch (e) {
          console.error('API í˜¸ì¶œ ì—ëŸ¬: deleteAllReservations', e);
          return { success: false, message: e.message || 'ëª¨ë“  ì˜ˆì•½ ì·¨ì†Œ ì¤‘ ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜ ë°œìƒ' };
        }
      }

      async function updateAdminSettings(startTime, endTime) {
        try {
          if (!isAdminLoggedIn) {
            throw new Error('ê´€ë¦¬ì ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤. ê´€ë¦¬ìë¡œ ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.');
          }
          const adminPass = localStorage.getItem('adminPassword');
          const res = await fetch(`${BACKEND_URL}/api/admin-settings`, {
            method: 'PUT',
            headers: { 
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${adminPass}` 
            },
            body: JSON.stringify({ reservationStartTime: startTime, reservationEndTime: endTime })
          });
          if (!res.ok) {
            const errorData = await res.json();
            throw new Error(errorData.message || 'ì„¤ì • ì €ì¥ ì‹¤íŒ¨');
          }
          const data = await res.json();
          return { success: true, message: 'ì„¤ì •ì´ ì„±ê³µì ìœ¼ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.', data: data };
        } catch (e) {
          console.error('API í˜¸ì¶œ ì—ëŸ¬: updateAdminSettings', e);
          return { success: false, message: e.message || 'ì„¤ì • ì €ì¥ ì¤‘ ì˜¤ë¥˜ ë°œìƒ' };
        }
      }

      async function updateAnnouncement(message, active) {
        try {
          if (!isAdminLoggedIn) {
            throw new Error('ê´€ë¦¬ì ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤. ê´€ë¦¬ìë¡œ ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.');
          }
          const adminPass = localStorage.getItem('adminPassword');
          const res = await fetch(`${BACKEND_URL}/api/announcement`, {
            method: 'PUT',
            headers: { 
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${adminPass}` 
            },
            body: JSON.stringify({ message, active })
          });
          if (!res.ok) {
            const errorData = await res.json();
            throw new Error(errorData.message || 'ê³µì§€ì‚¬í•­ ì €ì¥ ì‹¤íŒ¨');
          }
          const data = await res.json();
          return { success: true, message: 'ê³µì§€ì‚¬í•­ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.', data: data };
        } catch (e) {
          console.error('API í˜¸ì¶œ ì—ëŸ¬: updateAnnouncement', e);
          return { success: false, message: e.message || 'ê³µì§€ì‚¬í•­ ì €ì¥ ì¤‘ ì˜¤ë¥˜ ë°œìƒ' };
        }
      }

      async function deleteAnnouncement() {
        return updateAnnouncement("", false);
      }

      function isReservationTimeAllowed() {
        if (!adminSettings || !adminSettings.reservationStartTime || !adminSettings.reservationEndTime) {
          return { allowed: false, message: 'ê´€ë¦¬ìê°€ ì˜ˆì•½ ê°€ëŠ¥ ì‹œê°„ì„ ì„¤ì •í•˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.' };
        }
        const now = new Date();
        const startTime = new Date(adminSettings.reservationStartTime);
        const endTime = new Date(adminSettings.reservationEndTime);

        return now >= startTime && now <= endTime
          ? { allowed: true, message: `ì˜ˆì•½ ê°€ëŠ¥ ì‹œê°„ì…ë‹ˆë‹¤. (${formatDate(startTime, false)} ~ ${formatDate(endTime, false)})` }
          : { allowed: false, message: `í˜„ì¬ ì˜ˆì•½ ê°€ëŠ¥ ì‹œê°„ì´ ì•„ë‹™ë‹ˆë‹¤. (${formatDate(startTime, false)} ~ ${formatDate(endTime, false)})` };
      }

      function formatDate(date, includeMilliseconds = true) {
        const d = new Date(date);
        const year = d.getFullYear();
        const month = String(d.getMonth() + 1).padStart(2, '0');
        const day = String(d.getDate()).padStart(2, '0');
        const hours = String(d.getHours()).padStart(2, '0');
        const minutes = String(d.getMinutes()).padStart(2, '0');
        const seconds = String(d.getSeconds()).padStart(2, '0');
        const milliseconds = String(d.getMilliseconds()).padStart(3, '0');

        if (includeMilliseconds) {
            return `${year}-${month}-${day} ${hours}:${minutes}:${seconds}.${milliseconds}`;
        } else {
            return `${year}-${month}-${day} ${hours}:${minutes}:${seconds}`;
        }
      }

      function showSection(section) {
        [loginPage, floorSelectPage, seatMapPage, adminLoginPage, adminPage].forEach(el => {
          if(el) el.classList.add('hidden');
        });
        if(section) section.classList.remove('hidden');

        // ê´€ë¦¬ì í˜ì´ì§€ ì§„ì… ì‹œ ì¸ì¦ í™•ì¸
        if (section === adminPage) {
            if (!localStorage.getItem('adminPassword')) {
                showSection(adminLoginPage); // ë¹„ë°€ë²ˆí˜¸ ì—†ìœ¼ë©´ ê´€ë¦¬ì ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ë¦¬ë””ë ‰ì…˜
                alert('ê´€ë¦¬ì ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
                return;
            }
        }

        // ì¢Œì„ ë§µ í˜ì´ì§€ ì§„ì… ì‹œì—ë§Œ ì˜ˆì•½ ê°€ëŠ¥ ì‹œê°„ ìë™ ì—…ë°ì´íŠ¸ ì¸í„°ë²Œ ì‹œì‘
        if (section === seatMapPage) {
          if (availabilityCheckInterval) clearInterval(availabilityCheckInterval); // ê¸°ì¡´ ì¸í„°ë²Œ í´ë¦¬ì–´
          updateReservationAvailability(); // ì¦‰ì‹œ í•œë²ˆ ì—…ë°ì´íŠ¸
          availabilityCheckInterval = setInterval(updateReservationAvailability, 1000); // ìƒˆ ì¸í„°ë²Œ ì‹œì‘
          updateSeatPageButtonsVisibility();
        } else {
          // ë‹¤ë¥¸ í˜ì´ì§€ë¡œ ì´ë™í•˜ê±°ë‚˜ ì¢Œì„ ë§µ í˜ì´ì§€ê°€ ì•„ë‹Œ ê²½ìš° ì¸í„°ë²Œ í´ë¦¬ì–´
          if (availabilityCheckInterval) {
            clearInterval(availabilityCheckInterval);
            availabilityCheckInterval = null;
          }
        }
      }

      function updateSeatPageButtonsVisibility() {
          const myReservation = getMyReservation();
          if (cancelMyReservationBtn) {
              if (myReservation) {
                  cancelMyReservationBtn.classList.remove('hidden');
              } else {
                  cancelMyReservationBtn.classList.add('hidden');
              }
          }

          if (confirmBtn) {
              if (myReservation && selectedSeat !== null &&
                 (myReservation.floor !== currentFloor || myReservation.seat !== selectedSeat)) {
                  confirmBtn.textContent = 'ì˜ˆì•½ ë³€ê²½';
              } else {
                  confirmBtn.textContent = 'ì˜ˆì•½ í™•ì •';
              }
          }
      }

      function clearErrors() {
        if (roomError) roomError.textContent = "";
        if (nameError) nameError.textContent = "";
        if (dormError) dormError.textContent = "";
        if (passwordError) passwordError.textContent = ""; // ë¹„ë°€ë²ˆí˜¸ ì—ëŸ¬ ë©”ì‹œì§€ ì´ˆê¸°í™” ì¶”ê°€
      }

      function setFloorOptions(dorm) {
        if (!floorSelect) {
          alert('ì˜¤ë¥˜: ì¸µ ì„ íƒ ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•´ì£¼ì„¸ìš”.');
          return;
        }
        floorSelect.innerHTML = '<option value="" disabled selected>ì„ íƒí•˜ì„¸ìš”</option>';
        if (!seatLayouts[dorm]) {
          floorSelect.innerHTML = '<option value="" disabled selected>í•´ë‹¹ ê¸°ìˆ™ì‚¬ì˜ ì¸µ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.</option>';
          return;
        }
        const floors = Object.keys(seatLayouts[dorm]).sort((a,b) => {
          const parseFloor = (f) => parseFloat(f.replace('-', '.'));
          return parseFloor(a) - parseFloor(b);
        });
        floors.forEach(floor => {
          const option = document.createElement('option');
          option.value = floor;
          option.textContent = floor.includes('-') ? floor.replace('-', 'ì¸µ-') : floor + 'ì¸µ';
          floorSelect.appendChild(option);
        });
      }

      function renderSeatMap(dorm, floor) {
        if (!seatMapContainer) {
          alert('ì˜¤ë¥˜: ì¢Œì„ ë°°ì¹˜ë„ ì»¨í…Œì´ë„ˆë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•´ì£¼ì„¸ìš”.');
          return;
        }
        seatMapContainer.innerHTML = '';

        const layout = seatLayouts[dorm]?.[floor];
        if (!layout) {
          seatMapContainer.textContent = 'í•´ë‹¹ ì¸µ ì¢Œì„ ë°°ì¹˜ë„ê°€ ì—†ìŠµë‹ˆë‹¤.';
          return;
        }
        const maxCols = Math.max(...layout.map(row => row.length));
        seatMapContainer.style.gridTemplateColumns = `repeat(${maxCols}, 1fr)`;

        const allowed = isReservationTimeAllowed().allowed;

        const currentReservation = getMyReservation();

        layout.forEach(row => {
          row.forEach(seatNum => {
            const btn = document.createElement('button');
            btn.type = 'button';

            if (seatNum === null) {
              btn.classList.add('seat-btn', 'empty');
              btn.textContent = '';
            } else {
              btn.classList.add('seat-btn');
              btn.textContent = seatNum;

              const booked = Object.values(allReservations).find(r =>
                r.dormitory === dorm &&
                r.floor === floor &&
                r.seat === seatNum
              );

              if (booked) {
                btn.classList.add('booked');
                btn.disabled = true;

                if (currentReservation &&
                    currentReservation.roomNo === booked.roomNo &&
                    currentReservation.name === booked.name &&
                    currentReservation.dormitory === booked.dormitory &&
                    currentReservation.floor === booked.floor &&
                    currentReservation.seat === booked.seat) {
                  btn.classList.add('mine');
                  btn.disabled = false; // ë‚´ ì¢Œì„ì€ ì˜ˆì•½ë˜ì–´ ìˆì–´ë„ ì„ íƒ ê°€ëŠ¥í•˜ê²Œ í•¨
                  btn.title = `ë‚´ ì˜ˆì•½ (${booked.name}ë‹˜)`;
                } else {
                  btn.title = `ì˜ˆì•½ëœ ì¢Œì„`;
                }
              } else {
                btn.title = allowed ? 'ì˜ˆì•½ ê°€ëŠ¥ ìë¦¬' : 'ì˜ˆì•½ ê°€ëŠ¥ ì‹œê°„ì´ ì•„ë‹™ë‹ˆë‹¤.';
                btn.disabled = !allowed;
                btn.onclick = () => {
                  if (allowed) {
                    selectedSeat = seatNum;
                    updateSeatPageButtonsVisibility();
                    if (confirmBtn) confirmBtn.disabled = false;
                    highlightSelectedSeat();
                  }
                };
              }
            }
            seatMapContainer.appendChild(btn);
          });
        });
        highlightSelectedSeat();
        updateSeatPageButtonsVisibility();
      }

      function highlightSelectedSeat() {
        if(!seatMapContainer) return;
        seatMapContainer.querySelectorAll("button.seat-btn").forEach(btn => {
          btn.classList.remove('selected');

          if (btn.textContent && parseInt(btn.textContent) === selectedSeat) {
            btn.classList.add('selected');
          }
        });
      }

      function updateReservationAvailability() {
        const status = isReservationTimeAllowed();
        if(reservationAvailabilityMessage) reservationAvailabilityMessage.textContent = status.message;

        const currentAllowedState = status.allowed;
        const hasAllowedStateChanged = (prevAllowedState !== null && prevAllowedState !== currentAllowedState);
        prevAllowedState = currentAllowedState;

        if (currentAllowedState) {
          if(reservationAvailabilityMessage) reservationAvailabilityMessage.classList.add("available");
          if(confirmBtn) confirmBtn.disabled = (selectedSeat === null);
          if(cancelMyReservationBtn) cancelMyReservationBtn.disabled = false;
        } else {
          if(reservationAvailabilityMessage) reservationAvailabilityMessage.classList.remove("available");
          if(confirmBtn) confirmBtn.disabled = true;
          if(cancelMyReservationBtn) cancelMyReservationBtn.disabled = true;
        }
        updateSeatPageButtonsVisibility();

        if (seatMapPage && !seatMapPage.classList.contains("hidden") && currentUser && currentFloor && hasAllowedStateChanged) {
          renderSeatMap(currentUser.dormitory, currentFloor);
          alert(`í˜„ì¬ ì˜ˆì•½ ${currentAllowedState ? 'ê°€ëŠ¥' : 'ë¶ˆê°€ëŠ¥'} ì‹œê°„ì…ë‹ˆë‹¤.`);
        }
      }

      function getMyReservation() {
        if (!currentUser) return null;
        // currentUserì˜ ë£¸ ë²ˆí˜¸, ì´ë¦„, ê¸°ìˆ™ì‚¬ê°€ ì¼ì¹˜í•˜ëŠ” ì˜ˆì•½ì„ ì°¾ìŒ
        return Object.values(allReservations).find(r => r.roomNo === currentUser.roomNo && r.name === currentUser.name && r.dormitory === currentUser.dormitory);
      }

      async function loadAdminPage() {
        isAdminLoggedIn = !!localStorage.getItem('adminPassword');
        if (!isAdminLoggedIn) {
            showSection(adminLoginPage); // ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ê°€ ë¡œì»¬ìŠ¤í† ë¦¬ì§€ì— ì—†ìœ¼ë©´ ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ì´ë™
            alert('ê´€ë¦¬ì ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
            return;
        }

        await fetchAllReservations(); // ëª¨ë“  ì˜ˆì•½ í˜„í™© ë¶ˆëŸ¬ì˜¤ê¸°
        renderReservationList(); // í…Œì´ë¸” ë Œë”ë§
        await fetchAdminSettings(); // ì˜ˆì•½ ê°€ëŠ¥ ì‹œê°„ ì„¤ì • ë¶ˆëŸ¬ì˜¤ê¸°
        await fetchAnnouncement(); // ê³µì§€ì‚¬í•­ ë¶ˆëŸ¬ì˜¤ê¸°

        // ê´€ë¦¬ì í˜ì´ì§€ì— ê³µì§€ì‚¬í•­ ë°ì´í„° ì±„ìš°ê¸°
        if (announcementMessageInput) announcementMessageInput.value = currentAnnouncement ? currentAnnouncement.message : '';
        if (announcementActiveCheckbox) announcementActiveCheckbox.checked = currentAnnouncement ? currentAnnouncement.active : false;
        
        showSection(adminPage); // ê´€ë¦¬ì í˜ì´ì§€ í‘œì‹œ
      }

      function renderReservationList() {
        if (!reservationListBody) return;
        reservationListBody.innerHTML = '';
        
        const reservationsArray = Object.values(allReservations).sort((a, b) => {
            const dormCompare = a.dormitory.localeCompare(b.dormitory);
            if (dormCompare !== 0) { return dormCompare; }
            const parseFloor = (f) => parseFloat(f.replace('-', '.'));
            const floorA = parseFloor(a.floor);
            const floorB = parseFloor(b.floor);
            if (floorA !== floorB) { return floorA - floorB; }
            return a.seat - b.seat;
        });

        reservationsArray.forEach(res => {
          const row = reservationListBody.insertRow();
          row.insertCell(0).textContent = res.name;
          row.insertCell(1).textContent = res.roomNo;
          row.insertCell(2).textContent = res.dormitory;
          row.insertCell(3).textContent = res.floor;
          row.insertCell(4).textContent = res.seat;
          row.insertCell(5).textContent = formatDate(res.createdAt);
          
          // ì˜ˆì•½ ë¹„ë°€ë²ˆí˜¸ ì…€ ì¶”ê°€ (í† ê¸€ ê¸°ëŠ¥ í¬í•¨)
          const passwordCell = row.insertCell(6);
          const passwordSpan = document.createElement('span');
          passwordSpan.textContent = '****'; // ì´ˆê¸°ì—ëŠ” ê°€ë ¤ì§„ ìƒíƒœë¡œ í‘œì‹œ
          passwordCell.appendChild(passwordSpan);

          const toggleButton = document.createElement('button');
          toggleButton.textContent = 'ğŸ‘ï¸';
          // CSSì—ì„œ inline ìŠ¤íƒ€ì¼ë¡œ ì¤€ ë¶€ë¶„ì„ ì¼ë°˜ì ì¸ style ì†ì„±ìœ¼ë¡œ ë³€í™˜
          toggleButton.style.cssText = "margin-left: 5px; font-size: 0.8rem; padding: 3px 6px; background: #ddd; color: #333; border: none; border-radius: 3px; cursor: pointer;";
          
          toggleButton.onclick = function() {
            if (passwordSpan.textContent === '****') {
              passwordSpan.textContent = res.password; // ì €ì¥ëœ ì‹¤ì œ ë¹„ë°€ë²ˆí˜¸ í‘œì‹œ
              this.textContent = 'ğŸ™ˆ';
            } else {
              passwordSpan.textContent = '****'; // ë‹¤ì‹œ ê°€ë¦¬ê¸°
              this.textContent = 'ğŸ‘ï¸';
            }
          };
          passwordCell.appendChild(toggleButton);

          const cancelCell = row.insertCell(7); // ì·¨ì†Œ ë²„íŠ¼ ì…€ì€ ì´ì œ 7ë²ˆì§¸ (0ë¶€í„° ì‹œì‘)
          const cancelButton = document.createElement('button');
          cancelButton.textContent = 'ì·¨ì†Œ';
          cancelButton.dataset.id = res._id;
          cancelButton.onclick = async () => { // `async` í‚¤ì›Œë“œ ì¶”ê°€
            if (confirm('ì´ ì˜ˆì•½ì„ ì·¨ì†Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? (ê´€ë¦¬ì ê¶Œí•œ)')) {
              // ê´€ë¦¬ì ê¶Œí•œ ì·¨ì†Œ ì‹œì—ëŠ” ì‚¬ìš©ì ë¹„ë°€ë²ˆí˜¸ ë¶ˆí•„ìš” (ë°±ì—”ë“œì—ì„œ adminPasswordë¡œ ì¸ì¦)
              const result = await deleteReservation(res._id, '', true); // ì‚¬ìš©ì ë¹„ë°€ë²ˆí˜¸ëŠ” ë¹ˆ ë¬¸ìì—´ë¡œ, isAdmin true
              if (result.success) {
                alert(result.message);
              } else {
                alert('ì·¨ì†Œ ì‹¤íŒ¨: ' + result.message);
              }
            }
          };
          cancelCell.appendChild(cancelButton);
        });
      }

      function updateAnnouncementDisplay() {
        if (announcementOverlay && announcementPopupMessage) {
          if (currentAnnouncement && currentAnnouncement.active && currentAnnouncement.message) {
            announcementPopupMessage.textContent = currentAnnouncement.message;
            announcementOverlay.classList.remove('hidden');
          } else {
            announcementOverlay.classList.add('hidden');
          }
        }
      }

      function hideAnnouncement() {
        if (announcementOverlay) announcementOverlay.classList.add('hidden');
      }

      // ë‚ ì§œ í˜•ì‹ì„ 'YYYY-MM-DD HH:MM:SS'ë¡œ í¬ë§· (datetime-local ì…ë ¥ìš©)
      function formatDateTimeLocal(date) {
        if (!date) return '';
        const d = new Date(date);
        // ISO ë¬¸ìì—´ì—ì„œ ë¡œì»¬ íƒ€ì„ì¡´ ì˜¤í”„ì…‹ì„ ê³ ë ¤í•˜ì—¬ 'YYYY-MM-DDTHH:MM' í˜•ì‹ìœ¼ë¡œ ìë¦„
        const localIsoString = new Date(d.getTime() - (d.getTimezoneOffset() * 60000)).toISOString();
        return localIsoString.slice(0, 16);
      }

      // ë¡œê·¸ì¸ í¼ ì œì¶œ í•¸ë“¤ëŸ¬
      async function handleSubmitLoginForm(e) {
        e.preventDefault(); // ê¸°ë³¸ í¼ ì œì¶œ ë™ì‘(í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨) ë°©ì§€
        clearErrors(); // ê¸°ì¡´ ì—ëŸ¬ ë©”ì‹œì§€ ì´ˆê¸°í™”

        const roomNo = roomNoInput.value.trim();
        const name = userNameInput.value.trim();
        const selectedDorm = dormitorySelect.value;
        const userPassword = userPasswordInput.value.trim(); // ì‚¬ìš©ì ì„¤ì • ë¹„ë°€ë²ˆí˜¸
        const honeypotField = loginForm.querySelector('input[name="honeypot_field"]').value;

        let valid = true; // ìœ íš¨ì„± ê²€ì‚¬ í”Œë˜ê·¸
        if (!roomNoPattern.test(roomNo)) {
          roomError.textContent = 'ë£¸ ë²ˆí˜¸ëŠ” 000í˜¸ í˜•ì‹ìœ¼ë¡œ ì…ë ¥í•˜ì„¸ìš”.';
          valid = false;
        }
        if (!koreanNamePattern.test(name)) {
          nameError.textContent = 'ì´ë¦„ì€ í•œê¸€ 2~4ìì—¬ì•¼ í•©ë‹ˆë‹¤.';
          valid = false;
        }
        if (!selectedDorm) {
          dormError.textContent = 'ê¸°ìˆ™ì‚¬ë¥¼ ì„ íƒí•˜ì„¸ìš”.';
          valid = false;
        }
        if (!userPasswordPattern.test(userPassword)) { // ë¹„ë°€ë²ˆí˜¸ ìœ íš¨ì„± ê²€ì‚¬ ì¶”ê°€
          passwordError.textContent = 'ë¹„ë°€ë²ˆí˜¸ëŠ” 4ìë¦¬ ìˆ«ìì—¬ì•¼ í•©ë‹ˆë‹¤.';
          valid = false;
        }
        if (honeypotField) { // Honeypot í•„ë“œ ì²´í¬
          alert('ë¹„ì •ìƒì ì¸ ìš”ì²­ì´ ê°ì§€ë˜ì—ˆìŠµë‹ˆë‹¤. (Honeypot)');
          valid = false;
        }

        if (!valid) return; // ìœ íš¨ì„± ê²€ì‚¬ ì‹¤íŒ¨ ì‹œ í•¨ìˆ˜ ì¢…ë£Œ

        // ìœ íš¨ì„± ê²€ì‚¬ í†µê³¼ ì‹œ ì‚¬ìš©ì ì •ë³´ ì €ì¥ ë° í˜ì´ì§€ ì „í™˜
        currentUser = {roomNo, name, dormitory: selectedDorm, password: userPassword}; // ì‚¬ìš©ì ë¹„ë°€ë²ˆí˜¸ë„ currentUserì— ì €ì¥
        localStorage.setItem('currentUser', JSON.stringify(currentUser)); // ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì— ì €ì¥


        currentUserReservation = getMyReservation(); // í˜„ì¬ ì‚¬ìš©ìì˜ ì˜ˆì•½ ì •ë³´ í™•ì¸

        if (currentUserReservation) { // ê¸°ì¡´ ì˜ˆì•½ì´ ìˆë‹¤ë©´
          currentFloor = currentUserReservation.floor; // ì˜ˆì•½ëœ ì¸µìœ¼ë¡œ ì„¤ì •
          selectedSeat = null; // ì„ íƒëœ ì¢Œì„ ì´ˆê¸°í™”
          
          setFloorOptions(selectedDorm); // ê¸°ìˆ™ì‚¬ì— ë§ëŠ” ì¸µ ì˜µì…˜ ì„¤ì •
          if (floorSelect) floorSelect.value = currentFloor; // ì¸µ ì„ íƒ ë“œë¡­ë‹¤ìš´ ì„¤ì •
          if (welcomeText) welcomeText.textContent = `${name}ë‹˜ í™˜ì˜í•©ë‹ˆë‹¤! (${selectedDorm} ê¸°ìˆ™ì‚¬)`;
          if (selectedDormTitle) selectedDormTitle.textContent = selectedDorm;
          if (selectedFloorTitle) selectedFloorTitle.textContent = currentFloor;
          
          showSection(seatMapPage); // ì¢Œì„ ë§µ í˜ì´ì§€ë¡œ ì „í™˜
          renderSeatMap(selectedDorm, currentFloor); // ì¢Œì„ ë§µ ë Œë”ë§
        } else { // ê¸°ì¡´ ì˜ˆì•½ì´ ì—†ë‹¤ë©´ ì¸µ ì„ íƒ í˜ì´ì§€ë¡œ ì´ë™
          currentFloor = null; // ì¸µ ì´ˆê¸°í™”
          selectedSeat = null; // ì¢Œì„ ì´ˆê¸°í™”
          setFloorOptions(selectedDorm); // ì¸µ ì˜µì…˜ ì„¤ì •
          if (welcomeText) welcomeText.textContent = `${name}ë‹˜ í™˜ì˜í•©ë‹ˆë‹¤! (${selectedDorm} ê¸°ìˆ™ì‚¬)`;
          showSection(floorSelectPage); // ì¸µ ì„ íƒ í˜ì´ì§€ë¡œ ì „í™˜
        }
        updateSeatPageButtonsVisibility(); // ë²„íŠ¼ ê°€ì‹œì„± ì—…ë°ì´íŠ¸
      }

      function navigateToHome() {
        // ëª¨ë“  ì‚¬ìš©ì ë° ì„¸ì…˜ ì •ë³´ ì´ˆê¸°í™”
        currentUser = null;
        localStorage.removeItem('currentUser');
        currentUserReservation = null;
        currentFloor = null;
        selectedSeat = null;
        isAdminLoggedIn = false;
        localStorage.removeItem('adminPassword');

        // í¼ í•„ë“œ ì´ˆê¸°í™”
        if (loginForm) loginForm.reset();
        if (adminLoginForm) adminLoginForm.reset();
        clearErrors(); // ì—ëŸ¬ ë©”ì‹œì§€ ì´ˆê¸°í™”ë„ í¬í•¨

        showSection(loginPage); // ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ëŒì•„ê°€ê¸°
        updateSeatPageButtonsVisibility(); // ë²„íŠ¼ ê°€ì‹œì„± ì—…ë°ì´íŠ¸
      }

      function handleClickBackToLoginBtn() {
        navigateToHome(); // í™ˆìœ¼ë¡œ ì´ë™ (ë¡œê·¸ì¸ í˜ì´ì§€)
      }

      function handleClickFloorNextBtn() {
        if (!floorSelect) {
          alert('ì˜¤ë¥˜: ì¸µ ì„ íƒ ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•´ì£¼ì„¸ìš”.');
          return;
        }
        if (!floorSelect.value) { // ì¸µì´ ì„ íƒë˜ì§€ ì•Šì•˜ì„ ê²½ìš°
          alert('ì¸µì„ ì„ íƒí•˜ì„¸ìš”.');
          return;
        }
        currentFloor = floorSelect.value; // ì„ íƒëœ ì¸µ ì €ì¥
        if (selectedDormTitle) selectedDormTitle.textContent = currentUser.dormitory; // ìƒë‹¨ ê¸°ìˆ™ì‚¬ í‘œì‹œ
        if (selectedFloorTitle) selectedFloorTitle.textContent = currentFloor; // ìƒë‹¨ ì¸µ í‘œì‹œ

        selectedSeat = null; // ì¢Œì„ ì„ íƒ ì´ˆê¸°í™”
        
        if (confirmBtn) confirmBtn.disabled = true; // ì˜ˆì•½ í™•ì • ë²„íŠ¼ ë¹„í™œì„±í™”
        showSection(seatMapPage); // ì¢Œì„ ë§µ í˜ì´ì§€ë¡œ ì „í™˜
        renderSeatMap(currentUser.dormitory, currentFloor); // ì¢Œì„ ë§µ ë Œë”ë§
        updateSeatPageButtonsVisibility(); // ë²„íŠ¼ ê°€ì‹œì„± ì—…ë°ì´íŠ¸
      }

      function handleClickBackToFloorBtn() {
          currentFloor = null;
          selectedSeat = null;
          if(confirmBtn) confirmBtn.disabled = true;
          if(floorSelect) floorSelect.value = "";
          showSection(floorSelectPage);
          updateSeatPageButtonsVisibility();
      }

      async function handleClickCancelMyReservationBtn() {
        const myReservation = getMyReservation();
        if (!myReservation) {
            alert('í˜„ì¬ ì˜ˆì•½ëœ ì¢Œì„ì´ ì—†ìŠµë‹ˆë‹¤.');
            return;
        }

        // ë¹„ë°€ë²ˆí˜¸ ì…ë ¥ í”„ë¡¬í”„íŠ¸
        const passwordInput = prompt("ì˜ˆì•½ì„ ì·¨ì†Œí•˜ë ¤ë©´ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”:");
        if (passwordInput === null) return; // ì‚¬ìš©ìê°€ ì·¨ì†Œ ë²„íŠ¼ ëˆ„ë¥¸ ê²½ìš°

        // ì…ë ¥ ë¹„ë°€ë²ˆí˜¸ì™€ ì €ì¥ëœ ë¹„ë°€ë²ˆí˜¸ ëŒ€ì¡°
        if (myReservation.password !== passwordInput) { // myReservationì˜ passwordì™€ ëŒ€ì¡°
            alert("ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");
            return;
        }

        if (confirm(`í˜„ì¬ ì˜ˆì•½ëœ ${myReservation.dormitory} ${myReservation.floor}ì¸µ ${myReservation.seat}ë²ˆ ì¢Œì„ì„ ì·¨ì†Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
            const result = await deleteReservation(myReservation._id, passwordInput, false); // passwordInput ì „ë‹¬
            if (result.success) {
                alert(result.message);
                currentUserReservation = null;
                selectedSeat = null;
                // ì˜ˆì•½ ì·¨ì†Œ í›„ ì¢Œì„ ë§µì„ ë‹¤ì‹œ ë Œë”ë§í•˜ê±°ë‚˜ í˜ì´ì§€ ì „í™˜
                if (currentFloor && currentUser) {
                    renderSeatMap(currentUser.dormitory, currentFloor);
                    updateReservationAvailability();
                } else if (currentUser) {
                    showSection(floorSelectPage);
                } else {
                    navigateToHome();
                }
            } else {
                alert('ì·¨ì†Œ ì‹¤íŒ¨: ' + result.message);
            }
        }
        updateSeatPageButtonsVisibility();
      }

      function handleClickAdminLoginBtn() {
        if (adminPasswordInput) adminPasswordInput.value = ''; // ë¹„ë°€ë²ˆí˜¸ í•„ë“œ ì´ˆê¸°í™”
        if (adminError) adminError.textContent = ''; // ì—ëŸ¬ ë©”ì‹œì§€ ì´ˆê¸°í™”
        showSection(adminLoginPage); // ê´€ë¦¬ì ë¡œê·¸ì¸ í˜ì´ì§€ í‘œì‹œ
      }

      function handleClickAdminLoginBackBtn() {
        navigateToHome(); // ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ëŒì•„ê°€ê¸°
      }

      async function handleSubmitAdminLoginForm(e) {
        e.preventDefault(); // ê¸°ë³¸ í¼ ì œì¶œ ë™ì‘ ë°©ì§€
        const password = adminPasswordInput.value; // ì…ë ¥ëœ ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸
        const success = await adminLogin(password); // ê´€ë¦¬ì ë¡œê·¸ì¸ API í˜¸ì¶œ
        if (success) {
          await loadAdminPage(); // ë¡œê·¸ì¸ ì„±ê³µ ì‹œ ê´€ë¦¬ì í˜ì´ì§€ ë¡œë“œ
        }
      }

      function handleClickAdminLogoutBtn() {
        if (confirm('ê´€ë¦¬ì í˜ì´ì§€ì—ì„œ ë¡œê·¸ì•„ì›ƒí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
          navigateToHome(); // ë¡œê·¸ì•„ì›ƒ í›„ í™ˆìœ¼ë¡œ ì´ë™ (ë¡œê·¸ì¸ í˜ì´ì§€)
        }
      }

      async function handleClickClearAllReservationsBtn() {
        if (confirm('ê²½ê³ : ëª¨ë“  ì˜ˆì•½ì„ ì •ë§ë¡œ ì·¨ì†Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. (ê´€ë¦¬ì ê¶Œí•œ)')) {
          const adminPass = localStorage.getItem('adminPassword'); // ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì—ì„œ ê°€ì ¸ì˜¤ê¸°
          if (!adminPass) {
              alert('ê´€ë¦¬ì ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤. ë‹¤ì‹œ ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.');
              return;
          }
          // deleteAllReservations í•¨ìˆ˜ ìˆ˜ì • (ë°±ì—”ë“œì— adminPassword ì „ë‹¬)
          try {
            const res = await fetch(`${BACKEND_URL}/api/reservations/all`, {
                method: 'DELETE',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ adminPassword: adminPass })
            });
            const data = await res.json();
            if (!res.ok) throw new Error(data.message || 'ëª¨ë“  ì˜ˆì•½ ì·¨ì†Œ ì‹¤íŒ¨');
            alert(data.message);
          } catch (e) {
            console.error('ëª¨ë“  ì˜ˆì•½ ì·¨ì†Œ ì‹¤íŒ¨:', e);
            alert('ëª¨ë“  ì˜ˆì•½ ì·¨ì†Œ ì‹¤íŒ¨: ' + e.message);
          }
        }
      }

      async function handleSubmitConfirmBtn() {
        if (confirmBtn.disabled) return; // ë²„íŠ¼ ë¹„í™œì„±í™” ìƒíƒœë©´ í•¨ìˆ˜ ì¢…ë£Œ

        if (!selectedSeat) { // ì¢Œì„ì´ ì„ íƒë˜ì§€ ì•Šì•˜ì„ ê²½ìš°
          alert('ì¢Œì„ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
          return;
        }
        const myReservation = getMyReservation(); // í˜„ì¬ ì‚¬ìš©ìì˜ ì˜ˆì•½ ì •ë³´

        let result;
        if (myReservation) { // ê¸°ì¡´ ì˜ˆì•½ì´ ìˆëŠ” ê²½ìš° (ë³€ê²½)
            if (myReservation.floor === currentFloor && myReservation.seat === selectedSeat) {
                alert('ì„ íƒí•˜ì‹  ì¢Œì„ì€ ì´ë¯¸ ì˜ˆì•½ëœ ë‹¹ì‹ ì˜ ìë¦¬ì…ë‹ˆë‹¤. ë³€ê²½í•  ì¢Œì„ì„ ìƒˆë¡œ ì„ íƒí•´ì£¼ì„¸ìš”.');
                return;
            }
            // ì„ íƒëœ ìƒˆ ì¢Œì„ì´ ë‹¤ë¥¸ ì‚¬ëŒì—ê²Œ ì˜ˆì•½ë˜ì—ˆëŠ”ì§€ í™•ì¸ (ë³¸ì¸ì˜ ê¸°ì¡´ ì˜ˆì•½ì€ ì œì™¸)
            const isNewSeatBookedByOthers = Object.values(allReservations).some(r =>
                r.dormitory === currentUser.dormitory &&
                r.floor === currentFloor &&
                r.seat === selectedSeat &&
                r._id !== myReservation._id // ë³¸ì¸ì˜ ê¸°ì¡´ ì˜ˆì•½ IDì™€ ë‹¤ë¥¸ ê²½ìš°ë§Œ
            );
            if (isNewSeatBookedByOthers) {
                alert('ì„ íƒí•˜ì‹  ì¢Œì„ì€ ì´ë¯¸ ì˜ˆì•½ë˜ì—ˆìŠµë‹ˆë‹¤.');
                return;
            }

            // ì˜ˆì•½ ë³€ê²½ì„ ìœ„í•œ ë¹„ë°€ë²ˆí˜¸ ì…ë ¥
            const passwordInput = prompt("ì˜ˆì•½ì„ ë³€ê²½í•˜ë ¤ë©´ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”:");
            if (passwordInput === null) return; // ì‚¬ìš©ìê°€ ì·¨ì†Œ í´ë¦­

            if (myReservation.password !== passwordInput) { // myReservationì˜ passwordì™€ ëŒ€ì¡°
                alert("ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");
                return;
            }

            const updatedData = { // ì—…ë°ì´íŠ¸í•  ì˜ˆì•½ ë°ì´í„°
                roomNo: currentUser.roomNo,
                name: currentUser.name,
                dormitory: currentUser.dormitory,
                floor: currentFloor,
                seat: selectedSeat
            };
            result = await updateReservation(myReservation._id, updatedData, passwordInput); // ë¹„ë°€ë²ˆí˜¸ ì „ë‹¬í•˜ì—¬ ì˜ˆì•½ ì—…ë°ì´íŠ¸
        } else { // ì‹ ê·œ ì˜ˆì•½ì¸ ê²½ìš°
            // ì„ íƒëœ ì¢Œì„ì´ ì´ë¯¸ ì˜ˆì•½ë˜ì—ˆëŠ”ì§€ í™•ì¸
            const isNewSeatBooked = Object.values(allReservations).some(r =>
                r.dormitory === currentUser.dormitory &&
                r.floor === currentFloor &&
                r.seat === selectedSeat
            );
            if (isNewSeatBooked) {
                alert('ì„ íƒí•˜ì‹  ì¢Œì„ì€ ì´ë¯¸ ì˜ˆì•½ë˜ì—ˆìŠµë‹ˆë‹¤.');
                return;
            }
            const reservationData = { // ì‹ ê·œ ì˜ˆì•½ ë°ì´í„°
                roomNo: currentUser.roomNo,
                name: currentUser.name,
                dormitory: currentUser.dormitory,
                floor: currentFloor,
                seat: selectedSeat,
                password: currentUser.password // ì‹ ê·œ ì˜ˆì•½ ì‹œ ì„¤ì •í•œ ë¹„ë°€ë²ˆí˜¸ ì‚¬ìš©
            };
            result = await sendReservation(reservationData); // ì‹ ê·œ ì˜ˆì•½ ìƒì„±
        }
        
        if (result.success) { // ì˜ˆì•½ ì²˜ë¦¬ ì„±ê³µ ì‹œ
          alert(`${currentUser.dormitory} ${currentFloor}ì¸µ ${selectedSeat}ë²ˆ ìë¦¬ ${myReservation ? 'ë³€ê²½' : 'ì˜ˆì•½'}ì— ì„±ê³µí–ˆìŠµë‹ˆë‹¤!`);
          navigateToHome(); // í™ˆìœ¼ë¡œ ì´ë™
        } else { // ì˜ˆì•½ ì²˜ë¦¬ ì‹¤íŒ¨ ì‹œ
          alert(`${myReservation ? 'ì˜ˆì•½ ë³€ê²½' : 'ì˜ˆì•½'} ì‹¤íŒ¨: ` + result.message);
        }
        updateSeatPageButtonsVisibility(); // ë²„íŠ¼ ê°€ì‹œì„± ì—…ë°ì´íŠ¸
      }

      async function handleSubmitReservationTimeForm(e) {
        e.preventDefault(); // ê¸°ë³¸ í¼ ì œì¶œ ë°©ì§€
        const startTime = resStartTimeInput.value;
        const endTime = resEndTimeInput.value;

        if (!startTime || !endTime) {
          timeSettingMessage.textContent = 'ì‹œì‘ ì‹œê°„ê³¼ ì¢…ë£Œ ì‹œê°„ì„ ëª¨ë‘ ì…ë ¥í•˜ì„¸ìš”.';
          timeSettingMessage.style.color = 'red';
          return;
        }

        const startDateTime = new Date(startTime);
        const endDateTime = new Date(endTime);

        if (startDateTime >= endDateTime) {
          timeSettingMessage.textContent = 'ì‹œì‘ ì‹œê°„ì€ ì¢…ë£Œ ì‹œê°„ë³´ë‹¤ ë¹¨ë¼ì•¼ í•©ë‹ˆë‹¤.';
          timeSettingMessage.style.color = 'red';
          return;
        }

        const result = await updateAdminSettings(startDateTime, endDateTime); // ê´€ë¦¬ì ì„¤ì • ì—…ë°ì´íŠ¸ API í˜¸ì¶œ
        if (result.success) {
          timeSettingMessage.textContent = result.message;
          timeSettingMessage.style.color = 'green';
        } else {
          timeSettingMessage.textContent = 'ì„¤ì • ì €ì¥ ì‹¤íŒ¨: ' + result.message;
          timeSettingMessage.style.color = 'red';
        }
      }

      async function handleSubmitAnnouncementForm(e) {
        e.preventDefault(); // ê¸°ë³¸ í¼ ì œì¶œ ë°©ì§€
        const message = announcementMessageInput.value.trim();
        const active = announcementActiveCheckbox.checked;

        if (!active && !message) { // ê³µì§€ ë¹„í™œì„±í™” ë° ë‚´ìš© ì—†ì„ ê²½ìš°
          const result = await updateAnnouncement("", false); // ê³µì§€ ì´ˆê¸°í™”
          if (result.success) {
            announcementMessageStatus.textContent = 'ê³µì§€ì‚¬í•­ì´ ë¹„í™œì„±í™”ë˜ì—ˆìŠµë‹ˆë‹¤.';
            announcementMessageStatus.style.color = 'green';
          } else {
            announcementMessageStatus.textContent = result.message;
            announcementMessageStatus.style.color = 'red';
          }
          return;
        }

        if (active && !message) { // ê³µì§€ í™œì„±í™”í•˜ì§€ë§Œ ë‚´ìš©ì´ ì—†ëŠ” ê²½ìš°
          announcementMessageStatus.textContent = 'ê³µì§€ë¥¼ í™œì„±í™”í•˜ë ¤ë©´ ë‚´ìš©ì„ ì…ë ¥í•´ì•¼ í•©ë‹ˆë‹¤.';
          announcementMessageStatus.style.color = 'red';
          return;
        }

        const result = await updateAnnouncement(message, active); // ê³µì§€ì‚¬í•­ ì—…ë°ì´íŠ¸ API í˜¸ì¶œ
        if (result.success) {
          announcementMessageStatus.textContent = result.message;
          announcementMessageStatus.style.color = 'green';
        } else {
          announcementMessageStatus.textContent = result.message;
          announcementMessageStatus.style.color = 'red';
        }
      }

      // í˜ì´ì§€ ì´ˆê¸°í™” í•¨ìˆ˜
      async function initializePage() {
        // DOM ìš”ì†Œë“¤ ê°€ì ¸ì˜¤ê¸° (DOMì´ ë¡œë“œëœ í›„ì— ì‹¤í–‰ë˜ë¯€ë¡œ ì•ˆì „)
        loginPage = document.getElementById('loginPage');
        loginForm = document.getElementById('loginForm');
        roomNoInput = document.getElementById('roomNo');
        userNameInput = document.getElementById('userName');
        dormitorySelect = document.getElementById('dormitory');
        userPasswordInput = document.getElementById('userPassword');
        passwordError = document.getElementById('passwordError');
        roomError = document.getElementById('roomError');
        nameError = document.getElementById('nameError');
        dormError = document.getElementById('dormError');
        adminLoginBtn = document.getElementById('adminLoginBtn');

        floorSelectPage = document.getElementById('floorSelectPage');
        floorSelect = document.getElementById('floorSelect');
        floorNextBtn = document.getElementById('floorNextBtn');
        backToLoginBtn = document.getElementById('backToLoginBtn');
        welcomeText = document.getElementById('welcomeText');

        seatMapPage = document.getElementById('seatMapPage');
        seatMapContainer = document.getElementById('seatMap');
        confirmBtn = document.getElementById('confirmBtn');
        cancelMyReservationBtn = document.getElementById('cancelMyReservationBtn');
        backToFloorBtn = document.getElementById('backToFloorBtn');
        selectedDormTitle = document.getElementById('selectedDorm');
        selectedFloorTitle = document.getElementById('selectedFloor');
        reservationAvailabilityMessage = document.getElementById('reservationAvailabilityMessage');
        homeButton = document.getElementById('homeButton');

        adminLoginPage = document.getElementById('adminLoginPage');
        adminLoginForm = document.getElementById('adminLoginForm');
        adminPasswordInput = document.getElementById('adminPasswordInput');
        toggleAdminPasswordBtn = document.getElementById('toggleAdminPasswordBtn');
        adminError = document.getElementById('adminError');

        adminPage = document.getElementById('adminPage');
        adminLogoutBtn = document.getElementById('adminLogoutBtn');
        reservationListBody = document.getElementById('reservationListBody');
        clearAllReservationsBtn = document.getElementById('clearAllReservationsBtn');

        reservationTimeForm = document.getElementById('reservationTimeForm');
        resStartTimeInput = document.getElementById('resStartTimeInput');
        resEndTimeInput = document.getElementById('resEndTimeInput');
        timeSettingMessage = document.getElementById('timeSettingMessage');

        announcementOverlay = document.getElementById('announcementOverlay');
        announcementPopupMessage = document.getElementById('announcementMessage');
        announcementCloseBtn = announcementOverlay.querySelector('.close-btn');
        announcementForm = document.getElementById('announcementForm');
        announcementMessageInput = document.getElementById('announcementMessageInput');
        announcementActiveCheckbox = document.getElementById('announcementActiveCheckbox');
        announcementMessageStatus = document.getElementById('announcementMessageStatus');

        // Socket.IO ì—°ê²°
        socket = io(BACKEND_URL);

        socket.on('connect', () => {
          console.log('Socket.IO ì—°ê²° ì„±ê³µ!', socket.id);
        });

        socket.on('disconnect', () => {
          console.log('Socket.IO ì—°ê²° ì¢…ë£Œ!');
        });

        // ì‹¤ì‹œê°„ ì˜ˆì•½ ì •ë³´ ì—…ë°ì´íŠ¸ ìˆ˜ì‹ 
        socket.on('reservationsUpdated', (updatedReservations) => {
          console.log('ì˜ˆì•½ ì •ë³´ ì—…ë°ì´íŠ¸ ìˆ˜ì‹ :', updatedReservations);
          allReservations = {}; // ê¸°ì¡´ ë°ì´í„° ì´ˆê¸°í™”
          updatedReservations.forEach(r => allReservations[r._id] = r); // ìƒˆë¡œìš´ ë°ì´í„°ë¡œ ì±„ìš°ê¸°

          if (currentUser) {
            currentUserReservation = getMyReservation(); // í˜„ì¬ ì‚¬ìš©ìì˜ ì˜ˆì•½ ì •ë³´ ê°±ì‹ 
          }

          // í˜„ì¬ ì¢Œì„ ë§µ í˜ì´ì§€ì´ê³  ìœ íš¨í•œ currentUserì™€ currentFloorê°€ ìˆì„ ë•Œë§Œ ì¢Œì„ ë§µ ë‹¤ì‹œ ë Œë”ë§
          if (seatMapPage && !seatMapPage.classList.contains("hidden") && currentUser && currentFloor) {
            renderSeatMap(currentUser.dormitory, currentFloor);
            updateReservationAvailability(); // ìƒíƒœ ì—…ë°ì´íŠ¸ (ì˜ˆì•½ ê°€ëŠ¥ ì‹œê°„ ì²´í¬ ë“±)
          }
          if (adminPage && !adminPage.classList.contains("hidden")) {
            renderReservationList(); // ê´€ë¦¬ì í˜ì´ì§€ ì˜ˆì•½ ëª©ë¡ ê°±ì‹ 
          }
          updateSeatPageButtonsVisibility();
        });

        // ê´€ë¦¬ì ì„¤ì • ì—…ë°ì´íŠ¸ ìˆ˜ì‹ 
        socket.on('settingsUpdated', (updatedSettings) => {
          console.log('ê´€ë¦¬ì ì„¤ì • ì—…ë°ì´íŠ¸ ìˆ˜ì‹ :', updatedSettings);
          adminSettings = updatedSettings; // ê´€ë¦¬ì ì„¤ì • ê°±ì‹ 
          updateReservationAvailability(); // ì˜ˆì•½ ê°€ëŠ¥ ì‹œê°„ ì—…ë°ì´íŠ¸ ë¡œì§ ì‹¤í–‰
          if (adminPage && !adminPage.classList.contains("hidden")) {
            // ê´€ë¦¬ì í˜ì´ì§€ì— ì˜ˆì•½ ì‹œì‘/ì¢…ë£Œ ì‹œê°„ í•„ë“œ ê°±ì‹ 
            if (adminSettings.reservationStartTime) resStartTimeInput.value = formatDateTimeLocal(adminSettings.reservationStartTime);
            if (adminSettings.reservationEndTime) resEndTimeInput.value = formatDateTimeLocal(adminSettings.reservationEndTime);
          }
        });

        // ê³µì§€ì‚¬í•­ ì—…ë°ì´íŠ¸ ìˆ˜ì‹ 
        socket.on('announcementUpdated', (updatedAnnouncement) => {
          console.log('ê³µì§€ì‚¬í•­ ì—…ë°ì´íŠ¸ ìˆ˜ì‹ :', updatedAnnouncement);
          currentAnnouncement = updatedAnnouncement; // ê³µì§€ì‚¬í•­ ê°±ì‹ 
          updateAnnouncementDisplay(); // ê³µì§€ íŒì—… í‘œì‹œ/ìˆ¨ê¹€ ê°±ì‹ 
          if (adminPage && !adminPage.classList.contains("hidden")) {
            // ê´€ë¦¬ì í˜ì´ì§€ ê³µì§€ì‚¬í•­ í•„ë“œ ê°±ì‹ 
            announcementMessageInput.value = currentAnnouncement ? currentAnnouncement.message : '';
            announcementActiveCheckbox.checked = currentAnnouncement ? currentAnnouncement.active : false;
            announcementMessageStatus.textContent = 'ê³µì§€ì‚¬í•­ì´ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤.';
            announcementMessageStatus.style.color = 'green';
          }
        });

        // --- ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡ ---
        // í¼ ì œì¶œ ì´ë²¤íŠ¸
        if (loginForm) loginForm.addEventListener('submit', handleSubmitLoginForm);
        if (adminLoginForm) adminLoginForm.addEventListener('submit', handleSubmitAdminLoginForm);
        if (reservationTimeForm) reservationTimeForm.addEventListener('submit', handleSubmitReservationTimeForm);
        if (announcementForm) announcementForm.addEventListener('submit', handleSubmitAnnouncementForm);

        // ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
        if (adminLoginBtn) adminLoginBtn.addEventListener('click', handleClickAdminLoginBtn);
        if (adminLogoutBtn) adminLogoutBtn.addEventListener('click', handleClickAdminLogoutBtn);
        if (backToLoginBtn) backToLoginBtn.addEventListener('click', handleClickBackToLoginBtn);
        if (floorNextBtn) floorNextBtn.addEventListener('click', handleClickFloorNextBtn);
        if (backToFloorBtn) backToFloorBtn.addEventListener('click', handleClickBackToFloorBtn);
        if (cancelMyReservationBtn) cancelMyReservationBtn.addEventListener('click', handleClickCancelMyReservationBtn);
        if (adminLoginBackBtn) adminLoginBackBtn.addEventListener('click', handleClickAdminLoginBackBtn);
        if (clearAllReservationsBtn) clearAllReservationsBtn.addEventListener('click', handleClickClearAllReservationsBtn);
        if (confirmBtn) confirmBtn.addEventListener('click', handleSubmitConfirmBtn);
        if (announcementCloseBtn) announcementCloseBtn.addEventListener('click', hideAnnouncement);
        if (homeButton) homeButton.addEventListener('click', navigateToHome);

        // ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ í† ê¸€ ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
        if (toggleAdminPasswordBtn && adminPasswordInput) {
          toggleAdminPasswordBtn.addEventListener('click', () => {
            if (adminPasswordInput.type === 'password') {
              adminPasswordInput.type = 'text';
              toggleAdminPasswordBtn.textContent = 'ğŸ™ˆ'; // ë¹„ë°€ë²ˆí˜¸ ìˆ¨ê¸°ê¸° ì•„ì´ì½˜ìœ¼ë¡œ ë³€ê²½
            } else {
              adminPasswordInput.type = 'password';
              toggleAdminPasswordBtn.textContent = 'ğŸ‘ï¸'; // ë¹„ë°€ë²ˆí˜¸ ë³´ê¸° ì•„ì´ì½˜
            }
          });
        }

        // --- ì´ˆê¸° ë°ì´í„° ë¡œë”© ë° í˜ì´ì§€ í‘œì‹œ ---
        await fetchAllReservations(); // ëª¨ë“  ì˜ˆì•½ ë°ì´í„°ë¥¼ ë¨¼ì € ë¶ˆëŸ¬ì˜µë‹ˆë‹¤.

        // ê´€ë¦¬ì ë¡œê·¸ì¸ ìƒíƒœ í™•ì¸ ë° ì´ˆê¸° ë°ì´í„° í˜ì¹­ (ìƒˆë¡œê³ ì¹¨ ì‹œì—ë„ ê´€ë¦¬ì ì„¸ì…˜ ìœ ì§€)
        isAdminLoggedIn = !!localStorage.getItem('adminPassword');
        if (isAdminLoggedIn) {
            await fetchAdminSettings(); // ê´€ë¦¬ì ì„¤ì • ê°€ì ¸ì˜¤ê¸°
            await fetchAnnouncement();  // ê³µì§€ì‚¬í•­ ê°€ì ¸ì˜¤ê¸°
        }

        // currentUser ì •ë³´ ê¸°ë°˜ìœ¼ë¡œ í˜ì´ì§€ ì „í™˜ (ìƒˆë¡œê³ ì¹¨ ì‹œ ë¡œê·¸ì¸ ìœ ì§€)
        if (currentUser) {
            // ë¡œê·¸ì¸ í¼ í•„ë“œë¥¼ ì‚¬ìš©ì ì •ë³´ë¡œ ë¯¸ë¦¬ ì±„ìš°ê¸°
            if (roomNoInput) roomNoInput.value = currentUser.roomNo;
            if (userNameInput) userNameInput.value = currentUser.name;
            if (dormitorySelect) dormitorySelect.value = currentUser.dormitory;
            if (userPasswordInput) userPasswordInput.value = currentUser.password; // ì‚¬ìš©ì ë¹„ë°€ë²ˆí˜¸ í•„ë“œë„ ì±„ì›€

            currentUserReservation = getMyReservation(); // í˜„ì¬ ì‚¬ìš©ìì˜ ì˜ˆì•½ ì •ë³´ ì°¾ê¸° (ê°±ì‹ ëœ allReservations ê¸°ë°˜)
            if (currentUserReservation) {
                // ì˜ˆì•½ì´ ìˆë‹¤ë©´ ë°”ë¡œ ì¢Œì„ ë§µ í˜ì´ì§€ë¡œ ì´ë™ ë° ë Œë”ë§
                currentFloor = currentUserReservation.floor; // ì˜ˆì•½ëœ ì¸µìœ¼ë¡œ ì„¤ì •
                selectedSeat = null; // ì´ˆê¸°ì—ëŠ” ì„ íƒëœ ì¢Œì„ ì—†ìŒ

                setFloorOptions(currentUser.dormitory); // ê¸°ìˆ™ì‚¬ì— ë§ëŠ” ì¸µ ì˜µì…˜ ì„¤ì •
                if (floorSelect) floorSelect.value = currentFloor; // ì„ íƒëœ ì¸µìœ¼ë¡œ ë“œë¡­ë‹¤ìš´ ì„¤ì •
                if (welcomeText) welcomeText.textContent = `${currentUser.name}ë‹˜ í™˜ì˜í•©ë‹ˆë‹¤! (${currentUser.dormitory} ê¸°ìˆ™ì‚¬)`;
                if (selectedDormTitle) selectedDormTitle.textContent = currentUser.dormitory;
                if (selectedFloorTitle) selectedFloorTitle.textContent = currentFloor;

                showSection(seatMapPage); // ì¢Œì„ ë§µ í˜ì´ì§€ë¡œ ì „í™˜
                renderSeatMap(currentUser.dormitory, currentFloor); // ì¢Œì„ ë§µ ë Œë”ë§
            } else {
                // ì˜ˆì•½ì´ ì—†ë‹¤ë©´ ì¸µ ì„ íƒ í˜ì´ì§€ë¡œ ì´ë™
                currentFloor = null;
                selectedSeat = null;
                setFloorOptions(currentUser.dormitory);
                if (welcomeText) welcomeText.textContent = `${currentUser.name}ë‹˜ í™˜ì˜í•©ë‹ˆë‹¤! (${currentUser.dormitory} ê¸°ìˆ™ì‚¬)`;
                showSection(floorSelectPage);
            }
        } else {
            // currentUser ì •ë³´ê°€ ì—†ë‹¤ë©´ ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ
            showSection(loginPage);
        }
      }
    })();
  </script>
</body>
</html>