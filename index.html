<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>랜선석 예약 시스템</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      padding: 20px;
    }
    .container {
      background: white;
      border-radius: 20px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      padding: 40px;
      max-width: 450px;
      width: 100%;
    }
    h1 {
      text-align: center;
      color: #667eea;
      margin-bottom: 30px;
      font-size: 28px;
    }
    .form-group {
      margin-bottom: 20px;
    }
    label {
      display: block;
      margin-bottom: 8px;
      color: #333;
      font-weight: 600;
    }
    input[type="text"],
    input[type="password"],
    input[type="datetime-local"],
    select,
    textarea {
      width: 100%;
      padding: 12px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 16px;
      transition: border-color 0.3s;
    }
    input:focus,
    select:focus,
    textarea:focus {
      outline: none;
      border-color: #667eea;
    }
    button {
      width: 100%;
      padding: 14px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.2s, box-shadow 0.2s;
      margin-top: 10px;
    }
    button:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
    }
    button:active {
      transform: translateY(0);
    }
    .secondary-btn {
      background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
    }
    .back-btn {
      background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
    }
    .seats-container {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
      gap: 15px;
      margin: 30px 0;
    }
    .seat {
      aspect-ratio: 1;
      border: 2px solid #e0e0e0;
      border-radius: 12px;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      cursor: pointer;
      transition: all 0.3s;
      background: white;
      font-weight: 600;
    }
    .seat:hover {
      transform: scale(1.05);
    }
    .seat.available {
      background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);
      border-color: #4facfe;
    }
    .seat.available:hover {
      background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
      color: white;
    }
    .seat.reserved {
      background: #ffcccb;
      border-color: #ff6b6b;
      cursor: not-allowed;
      opacity: 0.6;
    }
    .seat.my-seat {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border-color: #667eea;
    }
    .seat.selected {
      background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
      color: white;
      border-color: #f5576c;
    }
    .legend {
      display: flex;
      justify-content: space-around;
      margin: 20px 0;
      flex-wrap: wrap;
    }
    .legend-item {
      display: flex;
      align-items: center;
      margin: 5px;
    }
    .legend-color {
      width: 20px;
      height: 20px;
      border-radius: 4px;
      margin-right: 8px;
    }
    #loginPage, #floorSelectionPage, #seatPage, #adminLoginPage, #adminPage, #announcementModal, #adminAnnouncementModal, #privacyConsentModal {
      display: none;
    }
    #loginPage.active, #floorSelectionPage.active, #seatPage.active, #adminLoginPage.active, #adminPage.active {
      display: block;
    }
    .admin-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
      font-size: 14px;
    }
    .admin-table th,
    .admin-table td {
      border: 1px solid #ddd;
      padding: 10px;
      text-align: left;
    }
    .admin-table th {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      font-weight: 600;
    }
    .admin-table tr:nth-child(even) {
      background: #f9f9f9;
    }
    .admin-table tr:hover {
      background: #f0f0f0;
    }
    .delete-btn {
      padding: 6px 12px;
      background: #ff6b6b;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 12px;
    }
    .delete-btn:hover {
      background: #ee5555;
    }
    textarea {
      resize: vertical;
      min-height: 80px;
    }
    .checkbox-group {
      display: flex;
      align-items: center;
      margin-top: 10px;
    }
    .checkbox-group input[type="checkbox"] {
      width: auto;
      margin-right: 8px;
    }
    .modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.7);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }
    .modal-content {
      background: white;
      border-radius: 20px;
      padding: 30px;
      max-width: 500px;
      width: 90%;
      max-height: 80vh;
      overflow-y: auto;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    }
    .modal-content h2 {
      color: #667eea;
      margin-bottom: 20px;
      text-align: center;
    }
    .modal-content p {
      line-height: 1.6;
      color: #333;
      margin-bottom: 15px;
    }
    .close-btn {
      background: #ff6b6b;
      margin-top: 20px;
    }
    .admin-link {
      text-align: center;
      margin-top: 15px;
      color: #667eea;
      cursor: pointer;
      text-decoration: underline;
      font-size: 14px;
    }
    .error-message {
      color: #ff6b6b;
      font-size: 14px;
      margin-top: 10px;
      text-align: center;
    }
    .success-message {
      color: #4caf50;
      font-size: 14px;
      margin-top: 10px;
      text-align: center;
    }
    .info-message {
      color: #2196F3;
      font-size: 14px;
      margin-top: 10px;
      text-align: center;
      background: #e3f2fd;
      padding: 10px;
      border-radius: 8px;
      border-left: 4px solid #2196F3;
    }
    .view-password-btn {
      padding: 6px 12px;
      background: #4facfe;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 12px;
      margin-left: 5px;
    }
    .view-password-btn:hover {
      background: #3a9ae0;
    }
    
    /* 개인정보 동의 모달 전용 스타일 */
    .privacy-content {
      text-align: left;
      line-height: 1.8;
    }
    .privacy-content h3 {
      color: #764ba2;
      margin-top: 20px;
      margin-bottom: 10px;
      font-size: 16px;
    }
    .privacy-content ul {
      margin-left: 20px;
      margin-bottom: 15px;
    }
    .privacy-content li {
      margin-bottom: 8px;
    }
    .privacy-consent-checkbox {
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 20px 0;
      padding: 15px;
      background: #f5f5f5;
      border-radius: 8px;
    }
    .privacy-consent-checkbox input[type="checkbox"] {
      width: auto;
      margin-right: 10px;
      transform: scale(1.3);
      cursor: pointer;
    }
    .privacy-consent-checkbox label {
      font-weight: 600;
      color: #667eea;
      cursor: pointer;
      margin: 0;
    }
    .consent-buttons {
      display: flex;
      gap: 10px;
    }
    .consent-buttons button {
      flex: 1;
    }
  </style>
</head>
<body>
  <!-- 로그인 페이지 -->
  <div id="loginPage" class="container active">
    <h1>랜선석 예약 로그인</h1>
    
    <div id="loginAnnouncement" class="info-message" style="display:none;"></div>
    
    <form id="loginForm">
      <div class="form-group">
        <label for="roomNo">룸 번호 (000호 형식):</label>
        <input type="text" id="roomNo" placeholder="예: 101" required pattern="\d{3}" title="3자리 숫자를 입력하세요">
      </div>
      
      <div class="form-group">
        <label for="name">이름 (한글 2~4자):</label>
        <input type="text" id="name" placeholder="예: 홍길동" required pattern="[가-힣]{2,4}" title="한글 2~4자를 입력하세요">
      </div>
      
      <div class="form-group">
        <label for="dormitory">기숙사 선택:</label>
        <select id="dormitory" required>
          <option value="">선택하세요</option>
          <option value="꿈동">꿈동</option>
          <option value="미래동">미래동</option>
        </select>
      </div>
      
      <div class="form-group">
        <label for="password">예약 비밀번호 (4자 이상):</label>
        <input type="password" id="password" placeholder="4자 이상 입력" required minlength="4">
      </div>
      
      <button type="submit">다음</button>
      <div class="admin-link" id="goToAdminLoginBtn">관리자 로그인</div>
    </form>
  </div>

  <!-- 개인정보 수집·이용 동의 모달 -->
  <div id="privacyConsentModal" style="display:none;" class="modal">
    <div class="modal-content">
      <h2>개인정보 수집·이용 동의</h2>
      
      <div class="privacy-content">
        <p style="margin-bottom: 15px; line-height: 1.6;">
          본 기숙사 랜선석 예약 시스템(이하 '본 시스템')은 정보주체의 개인정보를 중요하게 생각하며, 「개인정보 보호법」 등 관련 법령을 준수하고 있습니다. 다음 사항에 대하여 동의하시면, 본 시스템을 이용하실 수 있습니다.
        </p>

        <h3>1. 개인정보처리자의 명칭</h3>
        <p>본 시스템의 개인정보처리자는 고양국제고 기숙사부입니다. 여기서 고양국제고 기숙사부라 함은 꿈동, 미래동 사감실을 포함하여 학생회 기숙생활부, 기숙사 관련 부서를 포함합니다.</p>

        <h3>2. 개인정보의 수집 및 이용 목적</h3>
        <p>본 시스템은 다음과 같은 목적으로 학생의 개인정보를 수집 및 이용합니다.</p>
        <ul>
          <li>기숙사 랜선석 예약 및 좌석 배정</li>
          <li>예약자 본인 확인 및 중복 예약 방지</li>
          <li>예약 현황 관리</li>
          <li>서비스 이용 관련 공지사항 전달</li>
        </ul>

        <h3>3. 수집하는 개인정보 항목</h3>
        <p>본 시스템은 서비스 제공을 위해 아래와 같은 개인정보를 수집합니다.</p>
        <ul>
          <li>필수항목: 이름, 룸 번호, 기숙사 건물명, 예약 비밀번호</li>
          <li>자동 수집 항목: 접속 기기 IP 주소, 예약 일시, 좌석 위치(층 및 좌석 번호)</li>
        </ul>

        <h3>4. 개인정보의 보유 및 이용 기간</h3>
        <p>수집된 개인정보는 예약 관리 및 학사 행정 목적을 위해 학기 종료 후 1년까지 보관되며, 해당 기간 경과 시 지체 없이 파기됩니다. 다만, 관련 법령에 따라 보존 의무가 있는 경우 해당 법령이 정한 기간 동안 보관될 수 있습니다.</p>

        <h3>5. 개인정보의 파기 절차 및 방법</h3>
        <p>개인정보는 보유 기간이 경과한 후에는 다음 절차 및 방법에 따라 파기됩니다.</p>
        <ul>
          <li><strong>파기 절차:</strong> 정보주체로부터 동의받은 개인정보 보유기간이 경과하거나 처리 목적이 달성된 후 내부 방침 및 기타 관련 법령에 따라 일정 기간 저장된 후 파기됩니다.</li>
          <li><strong>파기 방법:</strong> 전자적 파일 형태로 기록된 개인정보는 MongoDB Atlas 데이터베이스에서 영구 삭제하며, 종이 문서에 기록된 개인정보는 분쇄기로 분쇄하거나 소각하여 파기합니다.</li>
        </ul>

        <h3>6. 개인정보의 제3자 제공</h3>
        <p>본 시스템은 정보주체의 개인정보를 개인정보의 수집 및 이용 목적에서 명시한 범위 내에서만 이용하며, 정보주체의 사전 동의 없이 해당 범위를 초과하여 이용하거나 원칙적으로 제3자에게 제공하지 않습니다. 단, 다음의 경우에는 개인정보를 제공할 수 있습니다.</p>
        <ul>
          <li>정보주체(학생) 본인이 자신의 정보를 열람하는 경우</li>
          <li>학교 측의 정당한 요청으로 예약 내역 등을 공개해야 하는 경우</li>
          <li>시스템 관리 권한을 가진 담당 교사 또는 관리자가 학생들의 예약 현황을 조회하는 경우</li>
          <li>법령의 규정에 의거하거나, 수사 목적으로 법령에 정해진 절차와 방법에 따라 수사기관의 요구가 있는 경우</li>
        </ul>

        <h3>7. 개인정보 처리 업무의 위탁</h3>
        <p>본 시스템은 원활한 개인정보 처리 업무를 위하여 다음과 같이 개인정보 처리 업무를 위탁하고 있습니다.</p>
        <ul>
          <li><strong>수탁업체:</strong> Render (클라우드 서비스 제공 및 백엔드 서버 운영)</li>
          <li><strong>수탁업체:</strong> Netlify (프론트엔드 웹사이트 호스팅 및 운영)</li>
          <li><strong>수탁업체:</strong> MongoDB Atlas (데이터베이스 서비스 제공)</li>
          <li><strong>위탁 업무 내용:</strong> 시스템 서버 운영 및 데이터베이스 관리, 서비스 인프라 제공 등</li>
        </ul>
        <p>위탁 계약 시 「개인정보 보호법」 등 관련 법령에 따라 위탁 업무 수행 목적 외 개인정보 처리 금지, 기술적·관리적 보호조치 등 책임에 관한 사항을 확인하고 수탁자가 개인정보를 안전하게 처리하는지 감독하고 있습니다.</p>

        <h3>8. 정보주체의 권리 행사 방법</h3>
        <p>정보주체(학생)는 언제든지 개인정보 열람, 정정·삭제, 처리정지 요청 및 개인정보 수집 및 이용 동의 철회를 요구할 수 있습니다. 권리 행사는 담당 부서 또는 관리자에게 서면, 전화 등을 통하여 요청하시면 지체 없이 조치하겠습니다. 단, 권리 행사 시 관리자가 본인 확인 등의 확인 절차를 거치기 위해 추가적인 개인정보를 요구할 수 있습니다.</p>

        <h3>9. 동의 거부권 및 불이익</h3>
        <p>귀하는 위 개인정보 수집 및 이용에 대한 동의를 거부할 권리가 있습니다. 다만, 필수항목에 대한 동의를 거부하실 경우, 본 시스템의 랜선석 예약 서비스 이용이 제한됩니다.</p>

        <h3>10. 개인정보의 안전성 확보 조치</h3>
        <p>본 시스템은 「개인정보 보호법」 제29조에 따라 다음과 같이 안전성 확보에 필요한 기술적·관리적 및 물리적 조치를 하고 있습니다.</p>
        <ul>
          <li>개인정보 취급 담당자의 최소화 및 교육</li>
          <li>내부 관리 계획 수립 및 시행</li>
          <li>개인정보 데이터 암호화 (비밀번호 bcrypt 해싱 처리)</li>
          <li>개인정보 조회 시 로그인 및 비밀번호 인증 필요</li>
          <li>개인정보 데이터베이스에 대한 접근 통제 및 접근 권한 제한</li>
          <li>접속 기록의 보관 및 위·변조 방지 조치</li>
          <li>보안 프로그램 설치 및 주기적 갱신</li>
          <li>생성형 인공지능 등의 AI를 활용한 접근 제한</li>
        </ul>

        <h3>11. 개인정보처리방침 변경에 관한 사항</h3>
        <p>본 처리방침은 2025년 11월 18일부터 적용됩니다. 법령 및 방침에 따른 변경 내용 추가, 삭제 및 정정이 있을 경우에는 변경사항 시행 7일 전부터 웹사이트 공지사항을 통하여 고지하며, 불가피하게 정보주체의 권리 또는 의무에 중대한 영향을 미치는 변경의 경우에는 30일 전부터 고지합니다.</p>
      </div>

      <div class="privacy-consent-checkbox">
        <input type="checkbox" id="privacyConsentCheckbox">
        <label for="privacyConsentCheckbox">위 개인정보 수집·이용에 동의합니다.</label>
      </div>

      <div class="consent-buttons">
        <button type="button" class="close-btn" id="privacyConsentDeclineBtn">거부</button>
        <button type="button" id="privacyConsentAgreeBtn">동의하고 계속</button>
      </div>
    </div>
  </div>

  <!-- 층 선택 페이지 -->
  <div id="floorSelectionPage" class="container">
    <h1><span id="userNameDisplay"></span>님, 층을 선택해주세요</h1>
    
    <div id="floorAnnouncement" class="info-message" style="display:none;"></div>
    
    <div class="form-group">
      <label for="floorSelect">층 선택:</label>
      <select id="floorSelect">
        <option value="">선택하세요</option>
        <option value="1">1층</option>
        <option value="2">2층</option>
        <option value="3">3층</option>
      </select>
    </div>
    
    <button id="goToSeatsBtn">좌석 선택으로</button>
    <button class="back-btn" id="backToLoginBtn">뒤로가기</button>
  </div>

  <!-- 좌석 선택 페이지 -->
  <div id="seatPage" class="container" style="max-width: 800px;">
    <h1>좌석 배치도 - <span id="floorDisplay"></span>층</h1>
    
    <div id="seatAnnouncement" class="info-message" style="display:none;"></div>
    
    <div class="legend">
      <div class="legend-item">
        <div class="legend-color" style="background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);"></div>
        <span>빈자리</span>
      </div>
      <div class="legend-item">
        <div class="legend-color" style="background: #ffcccb;"></div>
        <span>예약됨</span>
      </div>
      <div class="legend-item">
        <div class="legend-color" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);"></div>
        <span>내 자리</span>
      </div>
    </div>
    
    <div class="seats-container" id="seatsContainer">
      <!-- 좌석이 동적으로 생성됩니다 -->
    </div>
    
    <button class="back-btn" id="backToFloorBtn">뒤로가기</button>
    <button id="cancelMyReservationBtn" style="display:none; background: #ff6b6b;">내 예약 취소</button>
    <button id="confirmReservationBtn" style="display:none;">예약 확정</button>
  </div>

  <!-- 관리자 로그인 페이지 -->
  <div id="adminLoginPage" class="container">
    <h1>관리자 로그인</h1>
    
    <form id="adminLoginForm">
      <div class="form-group">
        <label for="adminUsername">관리자 이름:</label>
        <input type="text" id="adminUsername" placeholder="관리자 이름" required>
      </div>
      
      <div class="form-group">
        <label for="adminPassword">비밀번호:</label>
        <input type="password" id="adminPassword" placeholder="관리자 비밀번호" required>
      </div>
      
      <button type="submit">로그인</button>
      <button type="button" class="back-btn" id="backToLoginFromAdminBtn">로그인페이지로 돌아가기</button>
    </form>
  </div>

  <!-- 관리자 페이지 -->
  <div id="adminPage" class="container" style="max-width: 1200px;">
    <h1>관리자 페이지</h1>
    
    <button class="secondary-btn" id="adminLogoutBtn">로그아웃</button>
    
    <div id="adminOnlyAnnouncementDisplay" class="info-message" style="display:none; margin-top: 20px;"></div>
    
    <h2 style="margin-top: 30px; color: #667eea;">예약 가능 시간 설정</h2>
    <div class="form-group">
      <label for="reservationStartTime">예약 시작 시간:</label>
      <input type="datetime-local" id="reservationStartTime">
    </div>
    <div class="form-group">
      <label for="reservationEndTime">예약 종료 시간:</label>
      <input type="datetime-local" id="reservationEndTime">
    </div>
    <button id="saveAdminSettingsBtn">시간 설정 저장</button>
    
    <h2 style="margin-top: 30px; color: #667eea;">전체 공지사항 설정 (사용자에게도 표시)</h2>
    <div class="form-group">
      <label for="announcementMessage">공지 내용:</label>
      <textarea id="announcementMessage" placeholder="공지사항을 입력하세요"></textarea>
    </div>
    <div class="checkbox-group">
      <input type="checkbox" id="announcementActive">
      <label for="announcementActive">공지 활성화</label>
    </div>
    <button id="saveAnnouncementBtn">공지 저장</button>
    
    <h2 style="margin-top: 30px; color: #667eea;">관리자 전용 공지사항 설정 (관리자에게만 표시)</h2>
    <div class="form-group">
      <label for="adminAnnouncementMessage">관리자 공지 내용:</label>
      <textarea id="adminAnnouncementMessage" placeholder="관리자 전용 공지사항을 입력하세요"></textarea>
    </div>
    <div class="checkbox-group">
      <input type="checkbox" id="adminAnnouncementActive">
      <label for="adminAnnouncementActive">공지 활성화</label>
    </div>
    <button id="saveAdminAnnouncementBtn">공지 저장</button>
    
    <h2 style="margin-top: 30px; color: #667eea;">예약 현황</h2>
    <table class="admin-table" id="adminReservationsTable">
      <thead>
        <tr>
          <th>이름</th>
          <th>룸 번호</th>
          <th>기숙사</th>
          <th>층</th>
          <th>자리 번호</th>
          <th>예약 시간</th>
          <th>예약 비밀번호</th>
          <th>기능</th>
        </tr>
      </thead>
      <tbody id="adminReservationsList">
        <!-- 예약 목록이 동적으로 생성됩니다 -->
      </tbody>
    </table>
    
    <button class="delete-btn" id="deleteAllReservationsBtn" style="width: 100%; margin-top: 20px; padding: 12px; font-size: 14px;">모든 예약 취소</button>
  </div>

  <!-- 일반 공지사항 모달 -->
  <div id="announcementModal" class="modal">
    <div class="modal-content">
      <h2>공지사항</h2>
      <p id="announcementContent"></p>
      <button class="close-btn" id="closeAnnouncementBtn">닫기</button>
    </div>
  </div>

  <!-- 관리자 전용 공지사항 모달 -->
  <div id="adminAnnouncementModal" class="modal">
    <div class="modal-content">
      <h2>관리자 전용 공지사항</h2>
      <p id="adminAnnouncementContent"></p>
      <button class="close-btn" id="closeAdminAnnouncementBtn">닫기</button>
    </div>
  </div>

  <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
  <script>
    // 환경 변수 설정 (실제 배포 시 환경에 맞게 수정)
    const API_URL = 'https://giseokseatsystem.onrender.com'; // 백엔드 서버 주소
    
    // Socket.IO 연결
    const socket = io(API_URL, {
      transports: ['websocket', 'polling'],
      reconnectionAttempts: 5,
      reconnectionDelay: 2000
    });
    
    // 전역 변수
    let currentUser = null;
    let currentFloor = null;
    let selectedSeat = null;
    let allReservations = [];
    let adminSettings = null;
    let currentAnnouncement = null;
    let adminOnlyAnnouncement = null;
    let adminUsername = null; // 로그인한 관리자 이름 저장
    
    // 페이지 요소
    const loginPage = document.getElementById('loginPage');
    const floorSelectionPage = document.getElementById('floorSelectionPage');
    const seatPage = document.getElementById('seatPage');
    const adminLoginPage = document.getElementById('adminLoginPage');
    const adminPage = document.getElementById('adminPage');
    const privacyConsentModal = document.getElementById('privacyConsentModal');
    
    // 로그인 폼
    const loginForm = document.getElementById('loginForm');
    const roomNoInput = document.getElementById('roomNo');
    const nameInput = document.getElementById('name');
    const dormitorySelect = document.getElementById('dormitory');
    const passwordInput = document.getElementById('password');
    
    // 층 선택
    const floorSelect = document.getElementById('floorSelect');
    const goToSeatsBtn = document.getElementById('goToSeatsBtn');
    const backToLoginBtn = document.getElementById('backToLoginBtn');
    const userNameDisplay = document.getElementById('userNameDisplay');
    
    // 좌석 선택
    const seatsContainer = document.getElementById('seatsContainer');
    const floorDisplay = document.getElementById('floorDisplay');
    const backToFloorBtn = document.getElementById('backToFloorBtn');
    const cancelMyReservationBtn = document.getElementById('cancelMyReservationBtn');
    const confirmReservationBtn = document.getElementById('confirmReservationBtn');
    
    // 관리자 로그인
    const adminLoginForm = document.getElementById('adminLoginForm');
    const adminUsernameInput = document.getElementById('adminUsername');
    const adminPasswordInput = document.getElementById('adminPassword');
    const goToAdminLoginBtn = document.getElementById('goToAdminLoginBtn');
    const backToLoginFromAdminBtn = document.getElementById('backToLoginFromAdminBtn');
    
    // 관리자 페이지
    const adminLogoutBtn = document.getElementById('adminLogoutBtn');
    const reservationStartTimeInput = document.getElementById('reservationStartTime');
    const reservationEndTimeInput = document.getElementById('reservationEndTime');
    const saveAdminSettingsBtn = document.getElementById('saveAdminSettingsBtn');
    const announcementMessageInput = document.getElementById('announcementMessage');
    const announcementActiveCheckbox = document.getElementById('announcementActive');
    const saveAnnouncementBtn = document.getElementById('saveAnnouncementBtn');
    const adminAnnouncementMessageInput = document.getElementById('adminAnnouncementMessage');
    const adminAnnouncementActiveCheckbox = document.getElementById('adminAnnouncementActive');
    const saveAdminAnnouncementBtn = document.getElementById('saveAdminAnnouncementBtn');
    const adminReservationsList = document.getElementById('adminReservationsList');
    const deleteAllReservationsBtn = document.getElementById('deleteAllReservationsBtn');
    
    // 공지사항 모달
    const announcementModal = document.getElementById('announcementModal');
    const announcementContent = document.getElementById('announcementContent');
    const closeAnnouncementBtn = document.getElementById('closeAnnouncementBtn');
    const adminAnnouncementModal = document.getElementById('adminAnnouncementModal');
    const adminAnnouncementContent = document.getElementById('adminAnnouncementContent');
    const closeAdminAnnouncementBtn = document.getElementById('closeAdminAnnouncementBtn');
    
    // 개인정보 동의 모달
    const privacyConsentCheckbox = document.getElementById('privacyConsentCheckbox');
    const privacyConsentAgreeBtn = document.getElementById('privacyConsentAgreeBtn');
    const privacyConsentDeclineBtn = document.getElementById('privacyConsentDeclineBtn');
    
    // Socket.IO 이벤트 리스너
    socket.on('connect', () => {
      console.log('서버에 연결되었습니다.');
    });
    
    socket.on('disconnect', () => {
      console.log('서버 연결이 끊겼습니다.');
    });
    
    socket.on('reservationsInitial', (reservations) => {
      allReservations = reservations;
      if(currentFloor) renderSeats();
      if(adminUsername) loadAdminReservations();
    });
    
    socket.on('reservationsUpdated', (reservations) => {
      allReservations = reservations;
      if(currentFloor) renderSeats();
      if(adminUsername) loadAdminReservations();
    });
    
    socket.on('adminSettingsInitial', (settings) => {
      adminSettings = settings;
      if(adminUsername) loadAdminSettings();
    });
    
    socket.on('settingsUpdated', (settings) => {
      adminSettings = settings;
      if(adminUsername) loadAdminSettings();
    });
    
    socket.on('announcementInitial', (announcement) => {
      currentAnnouncement = announcement;
      checkAndShowAnnouncement();
    });
    
    socket.on('announcementUpdated', (announcement) => {
      currentAnnouncement = announcement;
      checkAndShowAnnouncement();
    });
    
    socket.on('adminOnlyAnnouncementInitial', (announcement) => {
      adminOnlyAnnouncement = announcement;
      if(adminUsername) showAdminOnlyAnnouncement();
    });
    
    socket.on('adminAnnouncementUpdated', (announcement) => {
      adminOnlyAnnouncement = announcement;
      if(adminUsername) {
        showAdminOnlyAnnouncement();
        loadAdminAnnouncement();
      }
    });
    
    // 일반 공지사항 표시 확인
    function checkAndShowAnnouncement() {
      if(currentAnnouncement && currentAnnouncement.active && currentAnnouncement.message) {
        // 로그인 페이지 공지
        const loginAnn = document.getElementById('loginAnnouncement');
        if(loginAnn) {
          loginAnn.textContent = currentAnnouncement.message;
          loginAnn.style.display = 'block';
        }
        // 층 선택 페이지 공지
        const floorAnn = document.getElementById('floorAnnouncement');
        if(floorAnn) {
          floorAnn.textContent = currentAnnouncement.message;
          floorAnn.style.display = 'block';
        }
        // 좌석 페이지 공지
        const seatAnn = document.getElementById('seatAnnouncement');
        if(seatAnn) {
          seatAnn.textContent = currentAnnouncement.message;
          seatAnn.style.display = 'block';
        }
      } else {
        // 공지 숨기기
        const loginAnn = document.getElementById('loginAnnouncement');
        if(loginAnn) loginAnn.style.display = 'none';
        const floorAnn = document.getElementById('floorAnnouncement');
        if(floorAnn) floorAnn.style.display = 'none';
        const seatAnn = document.getElementById('seatAnnouncement');
        if(seatAnn) seatAnn.style.display = 'none';
      }
    }
    
    // 관리자 전용 공지사항 표시
    function showAdminOnlyAnnouncement() {
      const display = document.getElementById('adminOnlyAnnouncementDisplay');
      if(adminOnlyAnnouncement && adminOnlyAnnouncement.active && adminOnlyAnnouncement.message) {
        display.textContent = adminOnlyAnnouncement.message;
        display.style.display = 'block';
      } else {
        display.style.display = 'none';
      }
    }
    
    // 로그인 폼 제출
    loginForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const roomNo = roomNoInput.value.trim();
      const name = nameInput.value.trim();
      const dormitory = dormitorySelect.value;
      const password = passwordInput.value;
      
      if(!roomNo || !name || !dormitory || !password) {
        alert('모든 정보를 입력해주세요.');
        return;
      }
      
      // 룸 번호 형식 검증 (3자리 숫자)
      if(!/^\d{3}$/.test(roomNo)) {
        alert('룸 번호는 3자리 숫자로 입력해주세요. (예: 101)');
        return;
      }
      
      // 이름 형식 검증 (한글 2~4자)
      if(!/^[가-힣]{2,4}$/.test(name)) {
        alert('이름은 한글 2~4자로 입력해주세요.');
        return;
      }
      
      // 비밀번호 길이 검증
      if(password.length < 4) {
        alert('비밀번호는 4자 이상이어야 합니다.');
        return;
      }
      
      currentUser = { roomNo, name, dormitory, password };
      
      // 개인정보 동의 여부 확인
      try {
        const response = await fetch(`${API_URL}/api/check-privacy-consent`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ roomNo, name, dormitory })
        });
        
        const data = await response.json();
        
        if(data.success && data.consented) {
          // 이미 동의한 사용자
          proceedToFloorSelection();
        } else {
          // 최초 사용자 - 동의 모달 표시
          showPrivacyConsentModal();
        }
      } catch(error) {
        console.error('동의 확인 실패:', error);
        alert('서버 오류가 발생했습니다. 다시 시도해주세요.');
      }
    });
    
    // 개인정보 동의 모달 표시
    function showPrivacyConsentModal() {
      privacyConsentModal.style.display = 'flex';
      privacyConsentCheckbox.checked = false;
    }
    
    // 개인정보 동의 거부
    privacyConsentDeclineBtn.addEventListener('click', () => {
      privacyConsentModal.style.display = 'none';
      alert('개인정보 수집·이용에 동의하지 않으면 서비스를 이용할 수 없습니다.');
      currentUser = null;
    });
    
    // 개인정보 동의 및 계속
    privacyConsentAgreeBtn.addEventListener('click', async () => {
      if(!privacyConsentCheckbox.checked) {
        alert('개인정보 수집·이용에 동의해주세요.');
        return;
      }
      
      // 동의 정보 저장
      try {
        const response = await fetch(`${API_URL}/api/save-privacy-consent`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            roomNo: currentUser.roomNo,
            name: currentUser.name,
            dormitory: currentUser.dormitory
          })
        });
        
        const data = await response.json();
        
        if(data.success) {
          privacyConsentModal.style.display = 'none';
          proceedToFloorSelection();
        } else {
          alert(data.message || '동의 저장에 실패했습니다.');
        }
      } catch(error) {
        console.error('동의 저장 실패:', error);
        alert('서버 오류가 발생했습니다. 다시 시도해주세요.');
      }
    });
    
    // 층 선택 페이지로 이동
    function proceedToFloorSelection() {
      userNameDisplay.textContent = currentUser.name;
      loginPage.classList.remove('active');
      floorSelectionPage.classList.add('active');
    }
    
    // 층 선택 버튼
    goToSeatsBtn.addEventListener('click', () => {
      const floor = floorSelect.value;
      if(!floor) {
        alert('층을 선택해주세요.');
        return;
      }
      currentFloor = floor;
      floorDisplay.textContent = floor;
      floorSelectionPage.classList.remove('active');
      seatPage.classList.add('active');
      renderSeats();
    });
    
    // 뒤로가기 버튼
    backToLoginBtn.addEventListener('click', () => {
      floorSelectionPage.classList.remove('active');
      loginPage.classList.add('active');
      currentUser = null;
      floorSelect.value = '';
    });
    
    backToFloorBtn.addEventListener('click', () => {
      seatPage.classList.remove('active');
      floorSelectionPage.classList.add('active');
      currentFloor = null;
      selectedSeat = null;
      confirmReservationBtn.style.display = 'none';
    });
    
    // 좌석 렌더링
    function renderSeats() {
      seatsContainer.innerHTML = '';
      const totalSeats = 20; // 층당 20개 좌석
      
      // 현재 사용자의 예약 확인
      const myReservation = allReservations.find(r => 
        r.roomNo === currentUser.roomNo && 
        r.name === currentUser.name
      );
      
      if(myReservation) {
        cancelMyReservationBtn.style.display = 'block';
      } else {
        cancelMyReservationBtn.style.display = 'none';
      }
      
      for(let i = 1; i <= totalSeats; i++) {
        const seat = document.createElement('div');
        seat.className = 'seat';
        seat.textContent = i;
        
        // 해당 좌석의 예약 정보 확인
        const reservation = allReservations.find(r => 
          r.dormitory === currentUser.dormitory && 
          r.floor === currentFloor && 
          r.seat === i
        );
        
        if(reservation) {
          if(reservation.roomNo === currentUser.roomNo && reservation.name === currentUser.name) {
            // 내 예약
            seat.classList.add('my-seat');
            seat.title = '내 자리';
          } else {
            // 다른 사람 예약
            seat.classList.add('reserved');
            seat.title = '예약됨';
          }
        } else {
          // 빈자리
          seat.classList.add('available');
          seat.title = '빈자리';
          seat.addEventListener('click', () => selectSeat(i));
        }
        
        seatsContainer.appendChild(seat);
      }
    }
    
    // 좌석 선택
    function selectSeat(seatNumber) {
      // 이미 예약이 있는 경우 좌석 변경
      const myReservation = allReservations.find(r => 
        r.roomNo === currentUser.roomNo && 
        r.name === currentUser.name
      );
      
      if(myReservation && myReservation.dormitory === currentUser.dormitory && myReservation.floor === currentFloor && myReservation.seat === seatNumber) {
        alert('이미 해당 좌석을 예약하셨습니다.');
        return;
      }
      
      selectedSeat = seatNumber;
      
      // 모든 좌석의 선택 상태 초기화
      document.querySelectorAll('.seat').forEach(s => s.classList.remove('selected'));
      
      // 선택한 좌석 강조
      const seats = document.querySelectorAll('.seat');
      seats[seatNumber - 1].classList.add('selected');
      
      confirmReservationBtn.style.display = 'block';
    }
    
    // 예약 확정
    confirmReservationBtn.addEventListener('click', async () => {
      if(!selectedSeat) {
        alert('좌석을 선택해주세요.');
        return;
      }
      
      try {
        const response = await fetch(`${API_URL}/api/reservations`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            roomNo: currentUser.roomNo,
            name: currentUser.name,
            dormitory: currentUser.dormitory,
            floor: currentFloor,
            seat: selectedSeat,
            password: currentUser.password
          })
        });
        
        const data = await response.json();
        
        if(response.ok && data.success) {
          alert(data.message || '예약이 완료되었습니다!');
          selectedSeat = null;
          confirmReservationBtn.style.display = 'none';
          // 좌석 다시 렌더링 (Socket.IO를 통해 자동 업데이트됨)
        } else {
          alert(data.message || '예약에 실패했습니다.');
        }
      } catch(error) {
        console.error('예약 실패:', error);
        alert('서버 오류가 발생했습니다.');
      }
    });
    
    // 내 예약 취소
    cancelMyReservationBtn.addEventListener('click', async () => {
      if(!confirm('예약을 취소하시겠습니까?')) return;
      
      const myReservation = allReservations.find(r => 
        r.roomNo === currentUser.roomNo && 
        r.name === currentUser.name
      );
      
      if(!myReservation) {
        alert('예약 정보를 찾을 수 없습니다.');
        return;
      }
      
      try {
        const response = await fetch(`${API_URL}/api/reservations/${myReservation._id}`, {
          method: 'DELETE',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ password: currentUser.password })
        });
        
        const data = await response.json();
        
        if(response.ok && data.success) {
          alert(data.message || '예약이 취소되었습니다.');
          cancelMyReservationBtn.style.display = 'none';
        } else {
          alert(data.message || '예약 취소에 실패했습니다.');
        }
      } catch(error) {
        console.error('예약 취소 실패:', error);
        alert('서버 오류가 발생했습니다.');
      }
    });
    
    // 관리자 로그인 페이지로 이동
    goToAdminLoginBtn.addEventListener('click', () => {
      loginPage.classList.remove('active');
      adminLoginPage.classList.add('active');
    });
    
    backToLoginFromAdminBtn.addEventListener('click', () => {
      adminLoginPage.classList.remove('active');
      loginPage.classList.add('active');
      adminUsernameInput.value = '';
      adminPasswordInput.value = '';
    });
    
    // 관리자 로그인
    adminLoginForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const username = adminUsernameInput.value.trim();
      const password = adminPasswordInput.value;
      
      if(!username || !password) {
        alert('이름과 비밀번호를 입력해주세요.');
        return;
      }
      
      try {
        const response = await fetch(`${API_URL}/api/admin-login`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ username, password })
        });
        
        const data = await response.json();
        
        if(response.ok && data.success) {
          adminUsername = username;
          adminLoginPage.classList.remove('active');
          adminPage.classList.add('active');
          loadAdminData();
        } else {
          alert(data.message || '로그인에 실패했습니다.');
        }
      } catch(error) {
        console.error('관리자 로그인 실패:', error);
        alert('서버 오류가 발생했습니다.');
      }
    });
    
    // 관리자 로그아웃
    adminLogoutBtn.addEventListener('click', () => {
      adminUsername = null;
      adminPage.classList.remove('active');
      loginPage.classList.add('active');
      adminUsernameInput.value = '';
      adminPasswordInput.value = '';
    });
    
    // 관리자 데이터 로드
    function loadAdminData() {
      loadAdminSettings();
      loadAnnouncement();
      loadAdminAnnouncement();
      loadAdminReservations();
      showAdminOnlyAnnouncement();
    }
    
    // 관리자 설정 로드
    function loadAdminSettings() {
      if(adminSettings) {
        if(adminSettings.reservationStartTime) {
          const start = new Date(adminSettings.reservationStartTime);
          reservationStartTimeInput.value = formatDateTimeLocal(start);
        }
        if(adminSettings.reservationEndTime) {
          const end = new Date(adminSettings.reservationEndTime);
          reservationEndTimeInput.value = formatDateTimeLocal(end);
        }
      }
    }
    
    // 날짜를 datetime-local 형식으로 변환
    function formatDateTimeLocal(date) {
      const year = date.getFullYear();
      const month = String(date.getMonth() + 1).padStart(2, '0');
      const day = String(date.getDate()).padStart(2, '0');
      const hours = String(date.getHours()).padStart(2, '0');
      const minutes = String(date.getMinutes()).padStart(2, '0');
      return `${year}-${month}-${day}T${hours}:${minutes}`;
    }
    
    // 관리자 설정 저장
    saveAdminSettingsBtn.addEventListener('click', async () => {
      const startTime = reservationStartTimeInput.value;
      const endTime = reservationEndTimeInput.value;
      
      if(!startTime || !endTime) {
        alert('시작 시간과 종료 시간을 모두 입력해주세요.');
        return;
      }
      
      const start = new Date(startTime);
      const end = new Date(endTime);
      
      if(start >= end) {
        alert('종료 시간은 시작 시간보다 늦어야 합니다.');
        return;
      }
      
      const adminPass = prompt('관리자 비밀번호를 입력하세요:');
      if(!adminPass) return;
      
      try {
        const response = await fetch(`${API_URL}/api/admin-settings`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            reservationStartTime: start.toISOString(),
            reservationEndTime: end.toISOString(),
            adminUsername,
            adminPassword: adminPass
          })
        });
        
        const data = await response.json();
        
        if(response.ok && data.success) {
          alert(data.message || '설정이 저장되었습니다.');
        } else {
          alert(data.message || '설정 저장에 실패했습니다.');
        }
      } catch(error) {
        console.error('설정 저장 실패:', error);
        alert('서버 오류가 발생했습니다.');
      }
    });
    
    // 공지사항 로드
    function loadAnnouncement() {
      if(currentAnnouncement) {
        announcementMessageInput.value = currentAnnouncement.message || '';
        announcementActiveCheckbox.checked = currentAnnouncement.active || false;
      }
    }
    
    // 공지사항 저장
    saveAnnouncementBtn.addEventListener('click', async () => {
      const message = announcementMessageInput.value.trim();
      const active = announcementActiveCheckbox.checked;
      
      const adminPass = prompt('관리자 비밀번호를 입력하세요:');
      if(!adminPass) return;
      
      try {
        const response = await fetch(`${API_URL}/api/announcement`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            message,
            active,
            adminUsername,
            adminPassword: adminPass
          })
        });
        
        const data = await response.json();
        
        if(response.ok && data.success) {
          alert(data.message || '공지사항이 저장되었습니다.');
        } else {
          alert(data.message || '공지사항 저장에 실패했습니다.');
        }
      } catch(error) {
        console.error('공지사항 저장 실패:', error);
        alert('서버 오류가 발생했습니다.');
      }
    });
    
    // 관리자 전용 공지사항 로드
    function loadAdminAnnouncement() {
      if(adminOnlyAnnouncement) {
        adminAnnouncementMessageInput.value = adminOnlyAnnouncement.message || '';
        adminAnnouncementActiveCheckbox.checked = adminOnlyAnnouncement.active || false;
      }
    }
    
    // 관리자 전용 공지사항 저장
    saveAdminAnnouncementBtn.addEventListener('click', async () => {
      const message = adminAnnouncementMessageInput.value.trim();
      const active = adminAnnouncementActiveCheckbox.checked;
      
      const adminPass = prompt('관리자 비밀번호를 입력하세요:');
      if(!adminPass) return;
      
      try {
        const response = await fetch(`${API_URL}/api/admin-announcement`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            message,
            active,
            adminUsername,
            adminPassword: adminPass
          })
        });
        
        const data = await response.json();
        
        if(response.ok && data.success) {
          alert(data.message || '관리자 전용 공지사항이 저장되었습니다.');
        } else {
          alert(data.message || '공지사항 저장에 실패했습니다.');
        }
      } catch(error) {
        console.error('공지사항 저장 실패:', error);
        alert('서버 오류가 발생했습니다.');
      }
    });
    
    // 관리자 예약 현황 로드
    function loadAdminReservations() {
      adminReservationsList.innerHTML = '';
      
      if(allReservations.length === 0) {
        const row = document.createElement('tr');
        row.innerHTML = '<td colspan="8" style="text-align:center;">예약 정보가 없습니다.</td>';
        adminReservationsList.appendChild(row);
        return;
      }
      
      allReservations.forEach(r => {
        const row = document.createElement('tr');
        const createdAt = new Date(r.createdAt).toLocaleString('ko-KR');
        
        row.innerHTML = `
          <td>${r.name}</td>
          <td>${r.roomNo}</td>
          <td>${r.dormitory}</td>
          <td>${r.floor}층</td>
          <td>${r.seat}번</td>
          <td>${createdAt}</td>
          <td>
            <button class="view-password-btn" onclick="viewPlainPassword('${r._id}')">보기</button>
          </td>
          <td>
            <button class="delete-btn" onclick="deleteReservation('${r._id}')">취소</button>
          </td>
        `;
        adminReservationsList.appendChild(row);
      });
    }
    
    // 평문 비밀번호 보기
    window.viewPlainPassword = async function(id) {
      const adminPass = prompt('관리자 비밀번호를 입력하세요:');
      if(!adminPass) return;
      
      try {
        const response = await fetch(`${API_URL}/api/admin/reservations/${id}/view-plain-password`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ adminPassword: adminPass, adminUsername })
        });
        
        const data = await response.json();
        
        if(response.ok && data.success) {
          alert(`예약 비밀번호: ${data.plainPassword}`);
        } else {
          alert(data.message || '비밀번호 조회에 실패했습니다.');
        }
      } catch(error) {
        console.error('비밀번호 조회 실패:', error);
        alert('서버 오류가 발생했습니다.');
      }
    };
    
    // 개별 예약 취소
    window.deleteReservation = async function(id) {
      if(!confirm('이 예약을 취소하시겠습니까?')) return;
      
      try {
        const response = await fetch(`${API_URL}/api/reservations/${id}`, {
          method: 'DELETE',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ adminUsername })
        });
        
        const data = await response.json();
        
        if(response.ok && data.success) {
          alert(data.message || '예약이 취소되었습니다.');
        } else {
          alert(data.message || '예약 취소에 실패했습니다.');
        }
      } catch(error) {
        console.error('예약 취소 실패:', error);
        alert('서버 오류가 발생했습니다.');
      }
    };
    
    // 모든 예약 취소
    deleteAllReservationsBtn.addEventListener('click', async () => {
      if(!confirm('정말로 모든 예약을 취소하시겠습니까? 이 작업은 되돌릴 수 없습니다.')) return;
      
      const adminPass = prompt('관리자 비밀번호를 입력하세요:');
      if(!adminPass) return;
      
      try {
        const response = await fetch(`${API_URL}/api/reservations/all`, {
          method: 'DELETE',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ adminUsername, adminPassword: adminPass })
        });
        
        const data = await response.json();
        
        if(response.ok && data.success) {
          alert(data.message || '모든 예약이 취소되었습니다.');
        } else {
          alert(data.message || '예약 취소에 실패했습니다.');
        }
      } catch(error) {
        console.error('모든 예약 취소 실패:', error);
        alert('서버 오류가 발생했습니다.');
      }
    });
    
    // 공지사항 모달 닫기
    closeAnnouncementBtn.addEventListener('click', () => {
      announcementModal.style.display = 'none';
    });
    
    closeAdminAnnouncementBtn.addEventListener('click', () => {
      adminAnnouncementModal.style.display = 'none';
    });
  </script>
</body>
</html>
