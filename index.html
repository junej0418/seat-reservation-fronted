<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
<title>ëœì„ ì„ ì˜ˆì•½ ì‹œìŠ¤í…œ</title>
<style>
  /* ê¸°ë³¸ ìŠ¤íƒ€ì¼ */
  body {
    font-family: 'Malgun Gothic', Arial, sans-serif;
    margin: 0; padding: 10px 0;
    background: #fafafc;
    color: #2c3e50;
  }
  h1, h2 {
    text-align: center;
    margin: 1em 0;
    color: #334155;
  }
  .container {
    max-width: 960px;
    margin: 10px auto 40px;
    background: white;
    padding: 15px 20px;
    border-radius: 12px;
    box-shadow: 0 0 20px rgba(0,0,0,0.06);
  }
  .hidden { display: none !important; } /* ë‹¤ë¥¸ ìŠ¤íƒ€ì¼ì— ì˜í•´ ë®ì–´ì“°ê¸° ë°©ì§€ */

  /* í¼ ìš”ì†Œ */
  form {
    max-width: 400px;
    margin: 0 auto;
  }
  label {
    font-weight: 700;
    margin-top: 12px;
    display: block;
    color: #475569;
  }
  input[type=text], input[type=password], input[type=datetime-local], select {
    width: 100%;
    padding: 10px 12px;
    margin-top: 6px;
    font-size: 1rem;
    border: 2px solid #cbd5e1;
    border-radius: 8px;
    box-sizing: border-box;
    transition: border-color 0.3s;
  }
  input[type=text]:focus, input[type=password]:focus, input[type=datetime-local]:focus, select:focus {
    border-color: #fbbf24;
    outline: none;
  }
  .error {
    color: #dc2626;
    font-size: 0.9rem;
    height: 20px;
    margin-top: 4px;
  }

  /* ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
  button {
    background-color: #fbbf24;
    border: none;
    border-radius: 8px;
    padding: 12px 25px;
    font-size: 1.1rem;
    font-weight: 700;
    color: #92400e;
    cursor: pointer;
    margin-top: 20px;
    box-shadow: 1px 3px 6px rgba(251,191,36,0.5);
    transition: background-color 0.3s;
    display: inline-block;
    min-width: 120px;
  }
  button:hover:not(:disabled) {
    background-color: #f59e0b;
  }
  button:disabled {
    background-color: #fde68a;
    cursor: not-allowed;
  }
  nav {
    text-align: center;
    margin-top: 20px;
  }
  nav button {
    background: transparent;
    color: #b45309;
    font-weight: 600;
    padding: 8px 16px;
    border: 2px solid #fbbf24;
    border-radius: 8px;
    cursor: pointer;
    transition: background-color 0.3s;
  }
  nav button:hover {
    background-color: #fbbf24;
    color: #92400e;
  }

  /* ì¢Œì„ ë°°ì¹˜ë„ */
  #seatMapWrapper { /* ì¢Œì„ ë°°ì¹˜ë„ ìŠ¤í¬ë¡¤ë§ì„ ìœ„í•œ ë˜í¼ */
    overflow-x: auto; /* ë‚´ìš©ì´ ë„˜ì¹  ê²½ìš° ê°€ë¡œ ìŠ¤í¬ë¡¤ */
    -webkit-overflow-scrolling: touch; /* ëª¨ë°”ì¼ì—ì„œ ë¶€ë“œëŸ¬ìš´ ìŠ¤í¬ë¡¤ */
    padding-bottom: 10px; /* ìŠ¤í¬ë¡¤ë°” ë•Œë¬¸ì— ë‚´ìš©ì´ ê°€ë ¤ì§€ì§€ ì•Šë„ë¡ */
  }

  #seatMap {
    margin: 20px auto 40px;
    display: grid;
    gap: 8px;
    justify-content: center;
    min-width: fit-content; /* ë‚´ìš©ì— ë§ì¶° ìµœì†Œ ë„ˆë¹„ ì„¤ì •, ìŠ¤í¬ë¡¤ ê°€ëŠ¥í•˜ê²Œ í•¨ */
  }
  /* ì¢Œì„ ìƒ‰ìƒ ì»¤ìŠ¤í„°ë§ˆì´ì§• */
  .seat-btn {
    background: #CCFFCC; /* ë¹ˆìë¦¬: ì—°í•œ ì´ˆë¡ìƒ‰ */
    border: 2px solid #88CC88; /* ì•½ê°„ ë” ì§„í•œ ì´ˆë¡ í…Œë‘ë¦¬ */
    font-weight: 700;
    color: #336633; /* ì§™ì€ ì´ˆë¡ìƒ‰ ê¸€ì */
    cursor: pointer;
    user-select: none;
    display: flex;
    justify-content: center;
    align-items: center;
    font-size: 1.1rem;
    min-width: 44px; /* PC/íƒœë¸”ë¦¿ ê¸°ë³¸ ì¢Œì„ ë„ˆë¹„ */
    aspect-ratio: 1/1; /* 1:1 ë¹„ìœ¨ ìœ ì§€ */
    border-radius: 6px;
    transition: background-color 0.3s, border-color 0.3s;
  }
  .seat-btn:hover:not(.booked) {
    background-color: #AACC88; /* í˜¸ë²„ ì‹œ ì•½ê°„ ì§„í•˜ê²Œ */
    border-color: #669944;
  }
  .seat-btn.booked {
    background: #FFCCCC; /* ì˜ˆì•½ë¨: ì—°í•œ ë¹¨ê°„ìƒ‰ */
    border: 2px solid #CC8888; /* ì•½ê°„ ë” ì§„í•œ ë¹¨ê°„ í…Œë‘ë¦¬ */
    color: #663333; /* ì§™ì€ ë¹¨ê°„ìƒ‰ ê¸€ì */
    cursor: not-allowed;
  }
  .seat-btn.mine {
    background: #FFCCFF; /* ë³¸ì¸ ìë¦¬: ì—°í•œ í•‘í¬ */
    border: 2px solid #CC88CC; /* ì•½ê°„ ë” ì§„í•œ í•‘í¬ í…Œë‘ë¦¬ */
    color: #663366; /* ì§™ì€ í•‘í¬ ê¸€ì */
  }
  .seat-btn.empty {
    visibility: hidden;
    pointer-events: none;
  }

  /* ê´€ë¦¬ì ì˜ˆì•½ í˜„í™© í…Œì´ë¸” */
  table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 15px;
    font-size: 1rem;
  }
  th, td {
    border: 1px solid #cbd5e1;
    padding: 10px 12px;
    text-align: center;
  }
  th {
    background-color: #fbbf24;
    color: #92400e;
  }
  td button {
    background: #ef4444;
    color: white;
    border: none;
    border-radius: 6px;
    padding: 6px 12px;
    font-weight: 600;
    cursor: pointer;
    transition: background-color 0.3s;
  }
  td button:hover {
    background: #b91c1c;
  }

  /* ì˜ˆì•½ ì•ˆë‚´ ë©”ì‹œì§€ */
  #reservationAvailabilityMessage {
    margin-top: 10px;
    font-weight: 700;
    padding: 0.5em;
    border-radius: 5px;
    text-align: center;
    color: #ef4444;
    background-color: #fee2e2;
  }
  #reservationAvailabilityMessage.available {
    color: #10b981;
    background-color: #d1fae5;
  }

  #timeSettingMessage {
    margin-top: 12px;
    text-align: center;
    font-size: 0.9rem;
    min-height: 1.5em;
  }

  /* ë°˜ì‘í˜• */
  @media (max-width: 768px) {
    .container {
      margin: 10px auto 30px;
      padding: 10px;
    }
    .seat-btn {
      min-width: 38px;
      font-size: 1rem;
    }
    h1, h2 { font-size: 1.5rem; }
  }

  @media (max-width: 480px) {
    body { padding: 5px; }
    .container {
      margin: 5px auto 20px;
      padding: 8px;
      border-radius: 8px;
    }
    h1, h2 { font-size: 1.4rem; margin: 0.8em 0; }
    label, input, select { font-size: 0.9rem; }
    button { padding: 8px 12px; font-size: 0.95rem; margin-top: 15px; min-width: auto; }
    nav button { padding: 5px 8px; font-size: 0.85rem; }
    
    #seatMap {
      gap: 4px;
    }
    .seat-btn {
      min-width: 26px; /* íœ´ëŒ€í° ë“± ì‘ì€ í™”ë©´ì—ì„œì˜ ì¢Œì„ ìµœì†Œ ë„ˆë¹„ */
      font-size: 0.85rem;
      padding: 0;
    }
    table { font-size: 0.8rem; }
    th, td { padding: 6px 4px; }
    td button { padding: 3px 6px; font-size: 0.75rem; }
  }

  /* ê³µì§€ íŒì—… ìŠ¤íƒ€ì¼ */
  .announcement-overlay {
    position: fixed;
    top: 0; left: 0;
    width: 100%; height: 100%;
    background: rgba(0, 0, 0, 0.7);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 1000;
  }
  .announcement-popup {
    background: white;
    padding: 30px;
    border-radius: 10px;
    box-shadow: 0 0 25px rgba(0, 0, 0, 0.5);
    max-width: 500px;
    width: 90%;
    text-align: left; /* ê³µì§€ í…ìŠ¤íŠ¸ ì™¼ìª½ ì •ë ¬ */
    position: relative;
    font-size: 1.1rem;
    line-height: 1.5;
  }
  .announcement-popup h3 {
    margin-top: 0;
    color: #b45309;
    font-size: 1.5rem;
    margin-bottom: 20px;
    text-align: center; /* ì œëª©ì€ ì¤‘ì•™ ì •ë ¬ */
  }
  .announcement-popup p {
    margin-bottom: 20px;
    color: #333;
    white-space: pre-wrap; /* ê³µì§€ ë©”ì‹œì§€ ë‚´ ì—”í„° ê³µë°± ìœ ì§€ */
  }
  .announcement-popup button.close-btn {
    background: #b45309;
    color: white;
    border: none;
    border-radius: 5px;
    padding: 10px 20px;
    cursor: pointer;
    font-size: 1rem;
    transition: background 0.3s;
    margin-top: 0; /* ê¸°ì¡´ ë²„íŠ¼ ë§ˆì§„ ì´ˆê¸°í™” */
    display: block; /* ë²„íŠ¼ì„ ë¸”ë¡ ìš”ì†Œë¡œ ë§Œë“¤ì–´ í•˜ë‹¨ì— ë°°ì¹˜ */
    margin-left: auto; /* ì¤‘ì•™ ì •ë ¬ */
    margin-right: auto; /* ì¤‘ì•™ ì •ë ¬ */
  }
  .announcement-popup button.close-btn:hover {
    background: #8e420b;
  }
  /* ê´€ë¦¬ì í˜ì´ì§€ì˜ ê³µì§€ ì…ë ¥ë€ ìŠ¤íƒ€ì¼ */
  #announcementMessageInput {
    width: calc(100% - 20px);
    height: 80px;
    padding: 10px;
    margin-top: 10px;
    border: 1px solid #ccc;
    border-radius: 5px;
    resize: vertical;
    font-size: 1rem;
  }
  #announcementActiveCheckbox {
    margin-top: 15px;
    margin-right: 8px;
  }
  /* ë²„íŠ¼ ê·¸ë£¹ ìŠ¤íƒ€ì¼ (ë’¤ë¡œê°€ê¸° ë²„íŠ¼ ì™¼ìª½ ì •ë ¬) */
  .button-group {
    display: flex; /* Flexbox í™œì„±í™” */
    justify-content: space-between; /* ì–‘ ë ì •ë ¬ */
    align-items: center; /* ì„¸ë¡œ ì¤‘ì•™ ì •ë ¬ */
    width: 100%; /* ë„ˆë¹„ 100% */
    margin-top: 20px;
  }
  .button-group button { 
    margin-top: 0; /* ê·¸ë£¹ ë‚´ ë²„íŠ¼ì˜ ìƒë‹¨ ë§ˆì§„ ì´ˆê¸°í™” */
  }
  /* ìƒ‰ìƒ ë²”ë¡€ ìŠ¤íƒ€ì¼ */
  .color-legend {
    text-align: center;
    margin-top: 30px;
    padding: 15px;
    border-top: 1px solid #eee;
    display: flex; /* ê°€ë¡œ ì •ë ¬ */
    flex-wrap: wrap; /* ë°˜ì‘í˜•ìœ¼ë¡œ ì¤„ë°”ê¿ˆ */
    justify-content: center; /* ì¤‘ì•™ ì •ë ¬ */
    gap: 20px; /* ì•„ì´í…œ ê°„ ê°„ê²© */
    font-size: 0.9rem;
    color: #555;
  }
  .legend-item {
    display: flex;
    align-items: center;
    gap: 8px; /* ìƒ‰ìƒ ë°•ìŠ¤ì™€ í…ìŠ¤íŠ¸ ì‚¬ì´ ê°„ê²© */
  }
  .legend-box {
    width: 20px;
    height: 20px;
    border-radius: 4px;
    border: 1px solid #ccc;
  }
  .legend-box.empty { background-color: #CCFFCC; border-color: #88CC88; }
  .legend-box.booked { background-color: #FFCCCC; border-color: #CC8888; }
  .legend-box.mine { background-color: #FFCCFF; border-color: #CC88CC; }
</style>
</head>
<body>

<!-- ë¡œê·¸ì¸ í˜ì´ì§€ -->
<div class="container" id="loginPage">
  <h1>ëœì„ ì„ ì˜ˆì•½ ë¡œê·¸ì¸</h1>
  <form id="loginForm" autocomplete="off" novalidate>
    <label for="roomNo">ë£¸ ë²ˆí˜¸ (000í˜¸ í˜•ì‹):</label>
    <input type="text" id="roomNo" name="roomNo" placeholder="ì˜ˆ: 101í˜¸" required />
    <div id="roomError" class="error"></div>

    <label for="userName">ì´ë¦„ (í•œê¸€ 2~4ì):</label>
    <input type="text" id="userName" name="userName" placeholder="ì˜ˆ: í™ê¸¸ë™" required />
    <div id="nameError" class="error"></div>

    <label for="dormitory">ê¸°ìˆ™ì‚¬ ì„ íƒ:</label>
    <select id="dormitory" name="dormitory" required>
      <option value="" disabled selected>ì„ íƒí•˜ì„¸ìš”</option>
      <option value="ê¿ˆë™">ê¿ˆë™</option>
      <option value="ë¯¸ë˜ë™">ë¯¸ë˜ë™</option>
    </select>
    <div id="dormError" class="error"></div>

    <!-- ğŸ¯ í—ˆë‹ˆíŒŸ í•„ë“œ ì¶”ê°€: ë´‡ë§Œ ì±„ì›Œë„£ëŠ” ìˆ¨ê²¨ì§„ í•„ë“œ -->
    <input type="text" name="honeypot_field" style="display: none !important; visibility: hidden !important; opacity: 0 !important; width: 0 !important; height: 0 !important; border: none !important; padding: 0 !important; margin: 0 !important;" tabindex="-1" autocomplete="off" />

    <button type="submit">ë‹¤ìŒ</button>
  </form>
  <nav>
    <button id="adminLoginBtn" type="button">ê´€ë¦¬ì ë¡œê·¸ì¸</button>
  </nav>
</div>

<!-- ì¸µ ì„ íƒ í˜ì´ì§€ -->
<div class="container hidden" id="floorSelectPage">
  <!-- "ë‹˜" ì¤‘ë³µ í•´ê²°ì„ ìœ„í•´ HTMLì—ì„œ "ë‹˜, ì¸µì„ ì„ íƒí•´ì£¼ì„¸ìš”" ë¡œ ê³ ì •í•˜ê³  welcomeTextëŠ” ì´ë¦„ê³¼ ê¸°ìˆ™ì‚¬ë§Œ í‘œì‹œ -->
  <h2><span id="welcomeText"></span>ë‹˜, ì¸µì„ ì„ íƒí•´ì£¼ì„¸ìš”</h2> 
  <div class="button-group"> <!-- ë²„íŠ¼ ê·¸ë£¹ìœ¼ë¡œ ë¬¶ìŒ -->
    <button id="backToLoginBtn" type="button">ë’¤ë¡œê°€ê¸°</button>
    <button id="floorNextBtn" type="button">ì¢Œì„ ì„ íƒìœ¼ë¡œ</button>
  </div>
</div>

<!-- ì¢Œì„ ì„ íƒ í˜ì´ì§€ -->
<div class="container hidden" id="seatMapPage">
  <h2>ì¢Œì„ ë°°ì¹˜ë„ - <span id="selectedDorm"></span> <span id="selectedFloor"></span>ì¸µ</h2>
  <div id="seatMapWrapper">
    <div id="seatMap"></div>
  </div>
  <div id="reservationAvailabilityMessage"></div>
  <div class="button-group"> <!-- ë²„íŠ¼ ê·¸ë£¹ìœ¼ë¡œ ë¬¶ìŒ -->
    <button id="confirmBtn" type="button" disabled>ì˜ˆì•½ í™•ì •</button>
    <button id="cancelSeatBtn" type="button">ì·¨ì†Œ ë° ë’¤ë¡œê°€ê¸°</button>
  </div>
  <!-- ìƒ‰ìƒ ë²”ë¡€ ì¶”ê°€ -->
  <div class="color-legend">
    <div class="legend-item"><div class="legend-box empty"></div>ë¹ˆìë¦¬</div>
    <div class="legend-item"><div class="legend-box booked"></div>ì˜ˆì•½ë¨</div>
    <div class="legend-item"><div class="legend-box mine"></div>ë‚´ ìë¦¬</div>
  </div>
</div>

<!-- ê´€ë¦¬ì ë¡œê·¸ì¸ í˜ì´ì§€ -->
<div class="container hidden" id="adminLoginPage">
  <h1>ê´€ë¦¬ì ë¡œê·¸ì¸</h1>
  <form id="adminLoginForm" autocomplete="off" novalidate>
    <label for="adminPassword">ë¹„ë°€ë²ˆí˜¸:</label>
    <input type="password" id="adminPassword" name="adminPassword" required />
    <div id="adminError" class="error"></div>
    <div class="button-group"> <!-- ë²„íŠ¼ ê·¸ë£¹ìœ¼ë¡œ ë¬¶ìŒ -->
      <button id="adminLoginBackBtn" type="button">ë¡œê·¸ì¸í˜ì´ì§€ë¡œ ëŒì•„ê°€ê¸°</button>
      <button type="submit">ë¡œê·¸ì¸</button>
    </div>
  </form>
</div>

<!-- ê´€ë¦¬ì í˜ì´ì§€ -->
<div class="container hidden" id="adminPage">
  <h1>ê´€ë¦¬ì í˜ì´ì§€</h1>
  <button id="adminLogoutBtn" type="button">ë¡œê·¸ì•„ì›ƒ</button>

  <h2>ì˜ˆì•½ ê°€ëŠ¥ ì‹œê°„ ì„¤ì •</h2>
  <form id="reservationTimeForm" novalidate>
    <label for="resStartTime">ì˜ˆì•½ ì‹œì‘ ì‹œê°„:</label>
    <input type="datetime-local" id="resStartTime" required />
    <label for="resEndTime">ì˜ˆì•½ ì¢…ë£Œ ì‹œê°„:</label>
    <input type="datetime-local" id="resEndTime" required />
    <button type="submit">ì‹œê°„ ì„¤ì • ì €ì¥</button>
    <div id="timeSettingMessage"></div>
  </form>

  <hr style="margin: 2em 0;">

  <h2>ê³µì§€ì‚¬í•­ ì„¤ì •</h2>
  <form id="announcementForm" novalidate>
    <label for="announcementMessageInput">ê³µì§€ ë‚´ìš©:</label>
    <textarea id="announcementMessageInput" placeholder="ëª¨ë“  ì‚¬ìš©ìì—ê²Œ í‘œì‹œë  ê³µì§€ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”." rows="4"></textarea>
    <div>
      <input type="checkbox" id="announcementActiveCheckbox">
      <label for="announcementActiveCheckbox" style="display: inline-block; margin-top: 0; font-weight: normal;">ê³µì§€ í™œì„±í™”</label>
    </div>
    <button type="submit">ê³µì§€ ì €ì¥</button>
    <div id="announcementMessageStatus" class="error"></div>
  </form>

  <hr style="margin: 2em 0;">

  <h2>ì˜ˆì•½ í˜„í™©</h2>
  <table>
    <thead>
      <tr><th>ì´ë¦„</th><th>ë£¸ ë²ˆí˜¸</th><th>ê¸°ìˆ™ì‚¬</th><th>ì¸µ</th><th>ìë¦¬ ë²ˆí˜¸</th><th>ì˜ˆì•½ ì·¨ì†Œ</th></tr>
    </thead>
    <tbody id="reservationListBody"></tbody>
  </table>

  <button id="clearAllReservationsBtn" type="button" style="background-color: #dc2626; color: white; float: right; margin-top: 15px;">ëª¨ë“  ì˜ˆì•½ ì·¨ì†Œ</button>
</div>

<!-- ê³µì§€ì‚¬í•­ íŒì—… ì˜¤ë²„ë ˆì´ -->
<div class="announcement-overlay hidden" id="announcementOverlay">
  <div class="announcement-popup">
    <h3>ê³µì§€ì‚¬í•­</h3>
    <p id="announcementMessage"></p>
    <button class="close-btn" type="button">ë‹«ê¸°</button>
  </div>
</div>

<script src="https://seat-reservation-backend-ygl9.onrender.com/socket.io/socket.io.js"></script>
<script>
(() => {
  const BACKEND_URL = "https://seat-reservation-backend-ygl9.onrender.com";
  const socket = io(BACKEND_URL);
  // ADMIN_PASSWORD ìƒìˆ˜ëŠ” í”„ë¡ íŠ¸ì—”ë“œì—ì„œ ì œê±°í–ˆìŠµë‹ˆë‹¤. ì´ì œ ë°±ì—”ë“œì—ì„œ ê²€ì¦í•©ë‹ˆë‹¤.

  let allReservations = {};
  let adminSettings = {};
  let availabilityCheckInterval = null;
  let prevAllowedState = null;

  // DOM ìš”ì†Œ ì°¸ì¡° ë³€ìˆ˜ ì„ ì–¸ (ì´ˆê¸°í™”ëŠ” DOMContentLoaded ì•ˆì—ì„œ ì§„í–‰)
  let loginPage, loginForm, roomNoInput, userNameInput, dormitorySelect, roomError, nameError, dormError, adminLoginBtn;
  let floorSelectPage, floorSelect, floorNextBtn, backToLoginBtn, welcomeText;
  let seatMapPage, seatMapContainer, confirmBtn, cancelSeatBtn, selectedDormTitle, selectedFloorTitle, reservationAvailabilityMessage;
  let adminLoginPage, adminLoginForm, adminPasswordInput, adminError;
  let adminPage, adminLogoutBtn, reservationListBody, clearAllReservationsBtn;
  let reservationTimeForm, resStartTimeInput, resEndTimeInput, timeSettingMessage;
  let announcementOverlay, announcementPopupMessage, announcementCloseBtn, announcementForm, announcementMessageInput, announcementActiveCheckbox, announcementMessageStatus;


  let currentUser = null;
  let currentFloor = null;
  let selectedSeat = null;

  const roomNoPattern = /^\d{3}í˜¸$/;
  const koreanNamePattern = /^[ê°€-í£]{2,4}$/;

  const seatLayouts = {
    "ê¿ˆë™": {
      "2": [
        [null,4,null,5,6,7,8,9,10,null,null,null,null],
        [null,3,null,null,null,null,null,null,null,11,null,null,null],
        [null,2,null,null,null,null,null,null,null,12,null,null,null],
        [null,1,null,null,null,null,null,null,null,null,null,null,null]
      ],
      "3": [
        [null,4,null,5,6,7,8,9,10,null,11,null,null,null],
        [null,3,null,null,null,null,null,null,null,null,12,null,null,null],
        [null,2,null,null,null,null,null,null,null,null,13,null,null,null],
        [null,1,null,null,null,null,null,null,null,null,14,null,null,null]
      ],
      "4": [
        [null,4,null,null,null,null,null,null,null,null],
        [null,3,null,null,5,7,null,null,null,null],
        [null,2,null,null,6,8,null,null,null,null],
        [null,1,null,null,null,null,null,null,null,null]
      ],
      "5": [
        [null,4,null,null,null,5,8,null,null,null],
        [null,3,null,null,null,6,9,null,null,null],
        [null,2,null,null,null,7,10,null,null,null],
        [null,1,null,null,null,null,null,null,null,null]
      ],
      "8": [
        [null,4,null,5,6,7,8,null,null,null,null,null,null],
        [null,3,null,null,null,null,null,null,null,null,null,null,null],
        [null,2,null,null,null,null,null,null,null,null,null,null,null],
        [null,1,null,null,null,null,null,null,null,null,null,null,null]
      ]
    },
    "ë¯¸ë˜ë™": {
      "2": [
        [null,null,null,null,null,5,6,7,8,9,10,11,12,null,null,null,null,null],
        [null,null,null,null,4,null,null,null,null,null,null,null,null,13,null,null,null,null],
        [null,null,null,null,3,null,null,null,null,null,null,null,null,14,null,null,null,null],
        [null,null,1,2,null,null,null,null,null,null,null,null,null,null,15,16,null,null],
        [null,17,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null]
      ],
      // 4-1ì¸µ ì¢Œì„ ë°°ì¹˜ë„ - ìˆ˜ì •ëœ ë‚´ìš©ìœ¼ë¡œ ë°˜ì˜
      "4-1": [
        [null,3,null,4,5,null,6,null,null],
        [null,2,null,null,null,null,7,null,null],
        [null,1,null,null,null,null,8,null,null]
      ],
      "4-2": [
        [null,4,null,5,6,7,8,9,10,11,12,null,13,null],
        [null,3,null,null,null,null,null,null,null,null,null,null,14,null],
        [null,2,null,null,null,null,null,null,null,null,null,null,null,null],
        [null,1,null,null,null,null,null,null,null,null,null,null,null,null]
      ]
    }
  };

  // --- API í†µì‹  í•¨ìˆ˜ë“¤ --- (í•¨ìˆ˜ë“¤ì€ DOMContentLoaded ë°–ì—ì„œ ì •ì˜)
  async function fetchAllReservations() {
    console.log('Fetching all reservations...');
    try {
      const res = await fetch(`${BACKEND_URL}/api/reservations`);
      if (!res.ok) throw new Error('ì˜ˆì•½ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨: ' + res.statusText);
      const data = await res.json();
      allReservations = {};
      data.forEach(r => allReservations[r._id] = r);
      console.log('Reservations fetched successfully:', Object.keys(allReservations).length, 'reservations found.');
    } catch (e) {
      alert('ì˜ˆì•½ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¤ëŠ” ë° ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë°±ì—”ë“œ ì„œë²„ ìƒíƒœë¥¼ í™•ì¸í•˜ì„¸ìš”.');
      console.error('API í˜¸ì¶œ ì—ëŸ¬: ì˜ˆì•½ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨', e);
      return {};
    }
  }

  async function fetchAdminSettings() {
    console.log('Fetching admin settings...');
    try {
      const res = await fetch(`${BACKEND_URL}/api/admin-settings`);
      if (!res.ok) throw new Error('ê´€ë¦¬ì ì„¤ì • ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨: ' + res.statusText);
      adminSettings = await res.json();
      console.log('Admin settings fetched successfully:', adminSettings);
    } catch (e) {
      alert('ê´€ë¦¬ì ì„¤ì •ì„ ê°€ì ¸ì˜¤ëŠ” ë° ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë°±ì—”ë“œ ì„œë²„ ìƒíƒœë¥¼ í™•ì¸í•˜ì„¸ìš”.');
      console.error('API í˜¸ì¶œ ì—ëŸ¬: ê´€ë¦¬ì ì„¤ì • ë¡œë“œ ì‹¤íŒ¨', e);
      return { reservationStartTime: null, reservationEndTime: null };
    }
  }

  // --- ê³µì§€ì‚¬í•­ API í†µì‹  ---
  async function fetchAnnouncement() {
    console.log('Fetching announcement...');
    try {
      const res = await fetch(`${BACKEND_URL}/api/announcement`);
      if (!res.ok) throw new Error('ê³µì§€ì‚¬í•­ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨: ' + res.statusText);
      const data = await res.json();
      currentAnnouncement = data;
      console.log('Announcement fetched:', currentAnnouncement);
      if (currentAnnouncement.active && currentAnnouncement.message) {
        showAnnouncement(currentAnnouncement.message);
      } else {
        hideAnnouncement();
      }
    } catch (e) {
      console.error('API í˜¸ì¶œ ì—ëŸ¬: ê³µì§€ì‚¬í•­ ë¡œë“œ ì‹¤íŒ¨', e);
      hideAnnouncement(); // ì—ëŸ¬ ë°œìƒ ì‹œ íŒì—… ìˆ¨ê¹€
    }
  }

  // --- Socket.IO ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ (ì‹¤ì‹œê°„ ë™ê¸°í™”) ---
  // ì´ ë¦¬ìŠ¤ë„ˆë“¤ì€ DOMContentLoaded ë°–ì—ì„œ ì •ì˜ë˜ì–´ì•¼ ì†Œì¼“ ì—°ê²° ì‹œì ì— ë°”ë¡œ ì‘ë™í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
  if (socket) {
    socket.on('reservationsUpdated', async updated => {
      console.log('ğŸ”— Socket.IO: ì˜ˆì•½ ë°ì´í„° ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸ ìˆ˜ì‹ ');
      allReservations = {};
      updated.forEach(r => allReservations[r._id] = r);
      // í˜„ì¬ ë³´ê³  ìˆëŠ” í™”ë©´ì— ë”°ë¼ UI ê°±ì‹ 
      if (seatMapPage && !seatMapPage.classList.contains("hidden") && currentUser && currentFloor) { // DOM ìš”ì†Œ null ì²´í¬ ì¶”ê°€
        renderSeatMap(currentUser.dormitory, currentFloor);
      }
      if (adminPage && !adminPage.classList.contains("hidden")) { // DOM ìš”ì†Œ null ì²´í¬ ì¶”ê°€
        await loadAdminPage(); // ê´€ë¦¬ì í˜ì´ì§€ ì—…ë°ì´íŠ¸ ì‹œì—ë„ ì˜ˆì•½ ëª©ë¡ ì •ë ¬ ìœ ì§€
      }
      console.log('ğŸ”— Socket.IO: ì˜ˆì•½ ë°ì´í„° ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸ ì™„ë£Œ');
    });

    socket.on('settingsUpdated', async updated => {
      console.log('ğŸ”— Socket.IO: ê´€ë¦¬ì ì„¤ì • ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸ ìˆ˜ì‹ ');
      adminSettings = updated;
      // í˜„ì¬ ë³´ê³  ìˆëŠ” í™”ë©´ì— ë”°ë¼ UI ê°±ì‹ 
      if (adminPage && !adminPage.classList.contains("hidden")) { // DOM ìš”ì†Œ null ì²´í¬ ì¶”ê°€
        await loadAdminPage(); // ê´€ë¦¬ì í˜ì´ì§€ ì—…ë°ì´íŠ¸
      }
      updateReservationAvailability(); 
      if (seatMapPage && !seatMapPage.classList.contains("hidden") && currentUser && currentFloor) { // DOM ìš”ì†Œ null ì²´í¬ ì¶”ê°€
        renderSeatMap(currentUser.dormitory, currentFloor);
      }
      console.log('ğŸ”— Socket.IO: ê´€ë¦¬ì ì„¤ì • ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸ ì™„ë£Œ');
    });

    // ìƒˆë¡œìš´ Socket.IO ì´ë²¤íŠ¸: ê³µì§€ì‚¬í•­ ì—…ë°ì´íŠ¸
    socket.on('announcementUpdated', async updated => {
      console.log('ğŸ”— Socket.IO: ê³µì§€ì‚¬í•­ ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸ ìˆ˜ì‹ ');
      currentAnnouncement = updated;
      if (currentAnnouncement.active && currentAnnouncement.message) {
        showAnnouncement(currentAnnouncement.message);
      } else {
        hideAnnouncement();
      }
      // ê´€ë¦¬ì í˜ì´ì§€ì— ìˆë‹¤ë©´ ê³µì§€ ì„¤ì • UIë„ ì—…ë°ì´íŠ¸
      if (adminPage && !adminPage.classList.contains("hidden")) { // DOM ìš”ì†Œ null ì²´í¬ ì¶”ê°€
        if (announcementMessageInput) announcementMessageInput.value = currentAnnouncement.message; // DOM ìš”ì†Œ null ì²´í¬
        if (announcementActiveCheckbox) announcementActiveCheckbox.checked = currentAnnouncement.active; // DOM ìš”ì†Œ null ì²´í¬
        if (announcementMessageStatus) { // DOM ìš”ì†Œ null ì²´í¬
            announcementMessageStatus.textContent = "ê³µì§€ì‚¬í•­ì´ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤."; // ê³µì§€ ì—…ë°ì´íŠ¸ ìƒíƒœ í‘œì‹œ
            announcementMessageStatus.style.color = "green";
        }
      }
      console.log('ğŸ”— Socket.IO: ê³µì§€ì‚¬í•­ ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸ ì™„ë£Œ');
    });
  }

  // --- ì˜ˆì•½ ê°€ëŠ¥ ì‹œê°„ í™•ì¸ ë¡œì§ ---
  function isReservationTimeAllowed() {
    if (!adminSettings.reservationStartTime || !adminSettings.reservationEndTime) {
      return { allowed: false, message: 'ê´€ë¦¬ìê°€ ì˜ˆì•½ ê°€ëŠ¥ ì‹œê°„ì„ ì„¤ì •í•˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.' };
    }
    const now = new Date();
    const startTime = new Date(adminSettings.reservationStartTime);
    const endTime = new Date(adminSettings.reservationEndTime);
    
    return now >= startTime && now <= endTime
      ? { allowed: true, message: `ì˜ˆì•½ ê°€ëŠ¥ ì‹œê°„ì…ë‹ˆë‹¤. (${formatDate(startTime)} ~ ${formatDate(endTime)})` }
      : { allowed: false, message: `í˜„ì¬ ì˜ˆì•½ ê°€ëŠ¥ ì‹œê°„ì´ ì•„ë‹™ë‹ˆë‹¤. (${formatDate(startTime)} ~ ${formatDate(endTime)})` };
  }

  // ë‚ ì§œ í¬ë§·íŒ… ìœ í‹¸ë¦¬í‹°
  function formatDate(date) {
    const pad = n => (n < 10 ? '0' + n : n);
    return `${pad(date.getMonth() + 1)}-${pad(date.getDate())} ${pad(date.getHours())}:${pad(date.getMinutes())}`;
  }

  // --- UI í˜ì´ì§€ ì „í™˜ ---
  function showSection(section) {
    console.log('Showing section:', section.id);
    // ëª¨ë“  í˜ì´ì§€ ìš”ì†Œë¥¼ ë¯¸ë¦¬ ì°¸ì¡°í•œ ë³€ìˆ˜ë¥¼ ì‚¬ìš© (DOMContentLoadedì—ì„œ ì´ˆê¸°í™”ëœ ë³€ìˆ˜ë“¤)
    [loginPage, floorSelectPage, seatMapPage, adminLoginPage, adminPage].forEach(el => {
      if(el) el.classList.add('hidden'); // null ì²´í¬
    });
    if(section) section.classList.remove('hidden'); // null ì²´í¬
    
    // ì˜ˆì•½ ê°€ëŠ¥ ì‹œê°„ ì‹¤ì‹œê°„ ì²´í¬ ì¸í„°ë²Œ ê´€ë¦¬ (ìƒˆë¡œê³ ì¹¨ ì—†ì´ ë°”ë¡œ ë°˜ì˜ë˜ë„ë¡)
    if (section === seatMapPage) {
      if (availabilityCheckInterval) clearInterval(availabilityCheckInterval); // ê¸°ì¡´ ì¸í„°ë²Œ í´ë¦¬ì–´
      updateReservationAvailability(); // ì¦‰ì‹œ í•œë²ˆ í˜¸ì¶œí•˜ì—¬ ì´ˆê¸° ìƒíƒœ ë°˜ì˜
      availabilityCheckInterval = setInterval(updateReservationAvailability, 1000); 
    } else {
      if (availabilityCheckInterval) {
        clearInterval(availabilityCheckInterval);
        availabilityCheckInterval = null;
      }
    }
  }


  function clearErrors() {
    if (roomError) roomError.textContent = ""; 
    if (nameError) nameError.textContent = ""; 
    if (dormError) dormError.textContent = ""; 
  }

  // --- ì¢Œì„ ë°°ì¹˜ë„ ê´€ë ¨ í•¨ìˆ˜ë“¤ ---
  function setFloorOptions(dorm) {
    console.log('setFloorOptions called with dorm:', dorm); 
    // seatLayouts[dorm]ì´ ìœ íš¨í•œì§€ í™•ì¸í•˜ê³ , floorSelectê°€ nullì´ ì•„ë‹Œì§€ í™•ì¸
    if (!seatLayouts[dorm]) {
        console.error('Error: seatLayouts[' + dorm + '] is undefined or null. Check dorm value and seatLayouts definition.');
        if (floorSelect) floorSelect.innerHTML = '<option value="" disabled selected>í•´ë‹¹ ê¸°ìˆ™ì‚¬ì˜ ì¸µ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.</option>'; 
        return; 
    }

    if (floorSelect) floorSelect.innerHTML = '<option value="" disabled selected>ì¸µ ì„ íƒ</option>'; 
    else { console.error('Error: floorSelect is null when trying to setFloorOptions'); return; } // ì¤‘ìš” ë””ë²„ê¹…: nullì¼ ê²½ìš° ì¡°ê¸° ë°˜í™˜

    const floors = Object.keys(seatLayouts[dorm]).sort((a,b) => {
      const parseFloor = (f) => parseFloat(f.replace('-', '.'));
      return parseFloor(a) - parseFloor(b);
    });
    console.log('Available floors for dorm', dorm + ':', floors); 
    floors.forEach(floor => {
      const option = document.createElement('option');
      option.value = floor;
      option.textContent = floor.includes('-') ? floor.replace('-', 'ì¸µ-') : floor + 'ì¸µ';
      if(floorSelect) floorSelect.appendChild(option); 
    });
  }

  function renderSeatMap(dorm, floor) {
    console.log('renderSeatMap called with dorm:', dorm, 'floor:', floor); 
    if (seatMapContainer) seatMapContainer.innerHTML = ''; 
    else { console.error('Error: seatMapContainer is null when trying to renderSeatMap'); return; } // ì¤‘ìš” ë””ë²„ê¹…: nullì¼ ê²½ìš° ì¡°ê¸° ë°˜í™˜

    const layout = seatLayouts[dorm]?.[floor];
    if (!layout) {
      if (seatMapContainer) seatMapContainer.textContent = 'í•´ë‹¹ ì¸µ ì¢Œì„ ë°°ì¹˜ë„ê°€ ì—†ìŠµë‹ˆë‹¤.'; 
      console.warn('Layout for', dorm, floor, 'is undefined or null.'); 
      return;
    }
    // ê·¸ë¦¬ë“œ ì»¬ëŸ¼ ì„¤ì • (ë°˜ì‘í˜•: 1frë¡œ ìœ ì—°í•˜ê²Œ, minmaxë¡œ ìµœì†Œ í¬ê¸° ë³´ì¥)
    const maxCols = Math.max(...layout.map(row => row.length));
    seatMapContainer.style.gridTemplateColumns = `repeat(${maxCols}, 1fr)`;

    const allowed = isReservationTimeAllowed().allowed;

    layout.forEach(row => {
      row.forEach(seatNum => {
        const btn = document.createElement('button');
        btn.type = 'button';

        if (seatNum === null) {
          btn.classList.add('seat-btn', 'empty');
          btn.textContent = '';
        } else {
          btn.classList.add('seat-btn');
          btn.textContent = seatNum;

          const booked = Object.values(allReservations).find(r => 
            r.dormitory === dorm && 
            r.floor === floor && 
            r.seat === seatNum
          );
          
          if (booked) { 
            btn.classList.add('booked');
            btn.disabled = true; 

            console.log(`--- Checking seat ${seatNum} ---`);
            console.log(`Current User: roomNo='${currentUser ? currentUser.roomNo : 'N/A'}', name='${currentUser ? currentUser.name : 'N/A'}', floor='${currentUser ? currentUser.floor : 'N/A'}', seat='${currentUser ? currentUser.seat : 'N/A'}'`);
            console.log(`Booked by: roomNo='${booked.roomNo}', name='${booked.name}', floor='${booked.floor}', seat='${booked.seat}'`);

            if (currentUser && 
                currentUser.roomNo === booked.roomNo && 
                currentUser.name === booked.name) 
            {
              console.log(`Match found: Seat ${seatNum} is current user's. Marking as 'mine'.`);
              btn.classList.add('mine');
              btn.disabled = false; 
              btn.title = `ë‚´ ì˜ˆì•½ (${booked.name}ë‹˜)`; 
            } else {
              console.log(`No match: Seat ${seatNum} is booked by another user.`);
              btn.title = `ì˜ˆì•½ëœ ì¢Œì„`; 
            }
          } else { 
            btn.disabled = !allowed;
            btn.title = allowed ? 'ì˜ˆì•½ ê°€ëŠ¥ ìë¦¬' : 'ì˜ˆì•½ ê°€ëŠ¥ ì‹œê°„ì´ ì•„ë‹™ë‹ˆë‹¤.';
            btn.onclick = () => {
              if (allowed) { 
                selectedSeat = seatNum;
                if (confirmBtn) confirmBtn.disabled = false; 
                highlightSelectedSeat();
              }
            };
          }
        }
        if(seatMapContainer) seatMapContainer.appendChild(btn); 
      });
    });
    highlightSelectedSeat();
  }

  function highlightSelectedSeat() {
    if(!seatMapContainer) return; 
    seatMapContainer.querySelectorAll("button.seat-btn").forEach(btn => {
      btn.classList.remove('mine');

      if (parseInt(btn.textContent) === selectedSeat) {
          btn.classList.add('mine');
      } 
      else if (currentUser && 
               selectedDormTitle && currentUser.dormitory === selectedDormTitle.textContent && 
               selectedFloorTitle && currentUser.floor === selectedFloorTitle.textContent && 
               currentUser.seat === parseInt(btn.textContent)) {
          btn.classList.add('mine');
      }
    });
  }


  function updateReservationAvailability() {
    const status = isReservationTimeAllowed();
    if(reservationAvailabilityMessage) reservationAvailabilityMessage.textContent = status.message; 

    const currentAllowedState = status.allowed;
    const hasAllowedStateChanged = (prevAllowedState !== null && prevAllowedState !== currentAllowedState);
    prevAllowedState = currentAllowedState;

    if (currentAllowedState) {
      if(reservationAvailabilityMessage) reservationAvailabilityMessage.classList.add("available"); 
      if(confirmBtn) confirmBtn.disabled = (selectedSeat === null); 
    } else {
      if(reservationAvailabilityMessage) reservationAvailabilityMessage.classList.remove("available"); 
      if(confirmBtn) confirmBtn.disabled = true; 
    }
    
    if (hasAllowedStateChanged && seatMapPage && !seatMapPage.classList.contains("hidden") && currentUser && currentFloor) { 
        renderSeatMap(currentUser.dormitory, currentFloor); 
    }
  }

  // --- ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ í•¨ìˆ˜ë“¤ (DOMContentLoaded ì™¸ë¶€ì—ì„œ ì •ì˜) ---
  // ì´ë ‡ê²Œ í•¨ìˆ˜ë“¤ì„ IIFEì˜ ìµœìƒìœ„ ìŠ¤ì½”í”„ì— ì •ì˜í•˜ë©´ DOMContentLoaded ì•ˆì˜ ì½”ë“œë“¤ì´ ì´ í•¨ìˆ˜ë“¤ì„ í•­ìƒ ì°¸ì¡°í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

  async function handleSubmitLoginForm(e) {
    console.log('Login form submitted. Event triggered.');
    e.preventDefault(); 

    clearErrors(); 

    const roomNo = roomNoInput.value.trim();
    const name = userNameInput.value.trim();
    const selectedDorm = dormitorySelect.value; 
    const honeypotField = loginForm.querySelector('input[name="honeypot_field"]').value; 

    console.log('Input values:', { roomNo, name, selectedDorm, honeypotField }); 

    let valid = true; 
    if (!roomNoPattern.test(roomNo)) {
      roomError.textContent = 'ë£¸ ë²ˆí˜¸ëŠ” 000í˜¸ í˜•ì‹ìœ¼ë¡œ ì…ë ¥í•˜ì„¸ìš”.';
      valid = false;
    }
    if (!koreanNamePattern.test(name)) {
      nameError.textContent = 'ì´ë¦„ì€ í•œê¸€ 2~4ìì—¬ì•¼ í•©ë‹ˆë‹¤.';
      valid = false;
    }
    if (!selectedDorm) { 
      dormError.textContent = 'ê¸°ìˆ™ì‚¬ë¥¼ ì„ íƒí•˜ì„¸ìš”.';
      valid = false;
    }
    if (honeypotField) { 
        console.warn('ğŸ¯ Honeypot field filled on frontend. Likely a bot.');
        valid = false; 
        alert('ë¹„ì •ìƒì ì¸ ìš”ì²­ì´ ê°ì§€ë˜ì—ˆìŠµë‹ˆë‹¤. (Honeypot)');
    }

    if (!valid) {
      console.log('Login form validation failed. Not proceeding.');
      return; 
    }
    console.log('Login form validation passed. Proceeding with logic.');

    const hasReservation = Object.values(allReservations).some(r => r.roomNo === roomNo && r.name === name);
    console.log('User has existing reservation?', hasReservation);

    if (hasReservation) {
      const existing = Object.values(allReservations).find(r => r.roomNo === roomNo && r.name === name);
      currentUser = {roomNo, name, dormitory: selectedDorm}; 
      currentFloor = existing.floor;
      selectedSeat = existing.seat;
      setFloorOptions(selectedDorm); 
      floorSelect.value = currentFloor;
      welcomeText.textContent = `${name} (${selectedDorm} ê¸°ìˆ™ì‚¬)`; 
      selectedDormTitle.textContent = selectedDorm; 
      selectedFloorTitle.textContent = currentFloor;
      renderSeatMap(selectedDorm, currentFloor); 
      updateReservationAvailability();
      console.log('Existing user: Redirecting to seat map page.');
      showSection(seatMapPage);
    } else {
      currentUser = {roomNo, name, dormitory: selectedDorm}; 
      setFloorOptions(selectedDorm); 
      welcomeText.textContent = `${name} (${selectedDorm} ê¸°ìˆ™ì‚¬)`; 
      console.log('New user: Redirecting to floor select page.');
      showSection(floorSelectPage);
    }
  }

  function handleClickBackToLoginBtn() {
    console.log('Back to Login button clicked.');
    currentUser = currentFloor = selectedSeat = null;
    loginForm.reset();
    showSection(loginPage);
  }

  function handleClickFloorNextBtn() {
    console.log('Floor Next button clicked.');
    if (!floorSelect) { // â­ ì¤‘ìš”: floorSelectê°€ nullì¸ì§€ í™•ì¸ í›„ ì—ëŸ¬ ì²˜ë¦¬ â­
      console.error('Error: floorSelect element is null in handleClickFloorNextBtn.');
      alert('ì˜¤ë¥˜: ì¸µ ì„ íƒ ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•´ì£¼ì„¸ìš”.');
      return;
    }
    const floor = floorSelect.value;
    if (!floor) {
      alert('ì¸µì„ ì„ íƒí•˜ì„¸ìš”.');
      console.log('Floor not selected.');
      return;
    }
    currentFloor = floor;
    selectedDormTitle.textContent = currentUser.dormitory;
    selectedFloorTitle.textContent = currentFloor;
    selectedSeat = null;
    confirmBtn.disabled = true;
    renderSeatMap(currentUser.dormitory, currentFloor);
    updateReservationAvailability();
    showSection(seatMapPage);
  }

  function handleClickCancelSeatBtn() {
    console.log('Cancel Seat button clicked.');
    selectedSeat = null;
    confirmBtn.disabled = true;
    showSection(floorSelectPage);
  }

  function handleClickAdminLoginBtn() {
    console.log('Admin Login button clicked.');
    adminLoginForm.reset();
    adminError.textContent = '';
    showSection(adminLoginPage);
  }

  function handleClickAdminLoginBackBtn() {
    console.log('Admin Login Back button clicked.');
    showSection(loginPage);
  }

  async function handleSubmitAdminLoginForm(e) {
    console.log('Admin login form submitted. Event triggered.'); 
    e.preventDefault();
    const pw = adminPasswordInput.value.trim();

    try {
        console.log('Sending admin login request to backend...'); 
        const response = await fetch(`${BACKEND_URL}/api/admin-login`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ password: pw })
        });
        const result = await response.json();
        
        console.log('Admin login response:', result); 
        if (result.success) { 
            console.log('Admin login successful. Redirecting to admin page.'); 
            await loadAdminPage(); 
            if (currentAnnouncement) {
                announcementMessageInput.value = currentAnnouncement.message;
                announcementActiveCheckbox.checked = currentAnnouncement.active;
            }
            showSection(adminPage);
        } else {
            console.log('Admin login failed. Message:', result.message); 
            adminError.textContent = result.message || 'ë¡œê·¸ì¸ ì‹¤íŒ¨: ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜';
        }
    } catch (error) {
        console.error('Admin login fetch error:', error); 
        adminError.textContent = 'ë¡œê·¸ì¸ ìš”ì²­ ì¤‘ ì˜¤ë¥˜ ë°œìƒ. ì„œë²„ë¥¼ í™•ì¸í•˜ì„¸ìš”.';
    }
  }

  function handleClickAdminLogoutBtn() {
    showSection(loginPage);
  }

  async function handleSubmitConfirmBtn() {
    if (!selectedSeat) {
      alert("ì¢Œì„ì„ ì„ íƒí•´ì£¼ì„¸ìš”.");
      return;
    }
    if (!isReservationTimeAllowed().allowed) {
      alert("ì˜ˆì•½ ê°€ëŠ¥ ì‹œê°„ì´ ì•„ë‹™ë‹ˆë‹¤.");
      updateReservationAvailability();
      return;
    }

    try {
      const reservationData = {
          roomNo: currentUser.roomNo,
          name: currentUser.name,
          dormitory: currentUser.dormitory,
          floor: currentFloor,
          seat: selectedSeat,
          honeypot_field: '' 
      };

      const response = await fetch(`${BACKEND_URL}/api/reservations`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(reservationData),
      });
      const result = await response.json();

      if (response.ok) { 
        alert(`${result.newReservation.dormitory} ${result.newReservation.floor}ì¸µ ${result.newReservation.seat}ë²ˆ ìë¦¬ ì˜ˆì•½ ì™„ë£Œ!`);
        
        currentUser.dormitory = result.newReservation.dormitory;
        currentUser.floor = result.newReservation.floor;
        currentUser.seat = result.newReservation.seat;

        selectedSeat = null; 
        
        renderSeatMap(currentUser.dormitory, currentUser.floor);
        updateReservationAvailability();
      } else { 
        alert("ì˜ˆì•½ ì‹¤íŒ¨: " + (result.message || "ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜"));
        if (currentUser && currentFloor) {
            await fetchAllReservations(); 
            renderSeatMap(currentUser.dormitory, currentFloor);
        }
      }
    } catch (e) {
      alert("ì˜ˆì•½ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì„œë²„ ìƒíƒœë¥¼ í™•ì¸í•˜ì„¸ìš”.");
      console.error(e);
    }
  }

  async function loadAdminPage() {
    if(reservationListBody) reservationListBody.innerHTML = ""; 
    let resArr = Object.values(allReservations);
    
    resArr.sort((a, b) => {
        if (a.dormitory !== b.dormitory) {
            return a.dormitory.localeCompare(b.dormitory);
        }
        const parseFloor = (f) => parseFloat(f.replace('-', '.'));
        if (parseFloor(a.floor) !== parseFloor(b.floor)) {
            return parseFloor(a.floor) - parseFloor(b.buffer);
        }
        return a.seat - b.seat;
    });

    if (resArr.length === 0) {
      if(reservationListBody) reservationListBody.innerHTML = '<tr><td colspan="6">ë“±ë¡ëœ ì˜ˆì•½ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>'; 
      return;
    }
    resArr.forEach((resv) => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${resv.name}</td>
        <td>${resv.roomNo}</td>
        <td>${resv.dormitory}</td>
        <td>${resv.floor}</td>
        <td>${resv.seat}</td>
        <td><button type="button" class="cancel-btn" data-id="${resv._id}">ì·¨ì†Œ</button></td>`;
      if(reservationListBody) reservationListBody.appendChild(tr); 
    });
    if(reservationListBody) { 
      reservationListBody.querySelectorAll(".cancel-btn").forEach((btn) => {
        btn.onclick = async () => {
          if (confirm("ì •ë§ ì˜ˆì•½ì„ ì·¨ì†Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
            const id = btn.dataset.id;
            const res = await fetch(`${BACKEND_URL}/api/reservations/${id}`, { method: "DELETE" });
            if (res.ok) alert("ì˜ˆì•½ì´ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.");
            else alert("ì˜ˆì•½ ì·¨ì†Œ ì‹¤íŒ¨");
          }
        };
      });
    }

    if (resStartTimeInput) resStartTimeInput.value = adminSettings.reservationStartTime ? new Date(adminSettings.reservationStartTime).toISOString().slice(0, 16) : ""; 
    if (resEndTimeInput) resEndTimeInput.value = adminSettings.reservationEndTime ? new Date(adminSettings.reservationEndTime).toISOString().slice(0, 16) : ""; 
    if (timeSettingMessage) timeSettingMessage.textContent = ""; 
    
    if (currentAnnouncement) {
        if (announcementMessageInput) announcementMessageInput.value = currentAnnouncement.message; 
        if (announcementActiveCheckbox) announcementActiveCheckbox.checked = currentAnnouncement.active; 
        if (announcementMessageStatus) announcementMessageStatus.textContent = ''; 
    }
  }

  async function handleClickClearAllReservationsBtn() {
      if (!confirm('ì •ë§ ëª¨ë“  ì˜ˆì•½ì„ ì·¨ì†Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤!')) {
          return;
      }
      try {
          const response = await fetch(`${BACKEND_URL}/api/reservations/all`, {
              method: 'DELETE'
          });
          if (response.ok) {
              alert('ëª¨ë“  ì˜ˆì•½ì´ ì„±ê³µì ìœ¼ë¡œ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.');
          } else {
              const errorResult = await response.json();
              alert(`ëª¨ë“  ì˜ˆì•½ ì·¨ì†Œ ì‹¤íŒ¨: ${errorResult.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'}`);
          }
      } catch (e) {
          console.error('ëª¨ë“  ì˜ˆì•½ ì·¨ì†Œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:', e);
          alert('ëª¨ë“  ì˜ˆì•½ ì·¨ì†Œ ì¤‘ í†µì‹  ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë°±ì—”ë“œ ì„œë²„ë¥¼ í™•ì¸í•˜ì„¸ìš”.');
      }
  }

  async function handleSubmitReservationTimeForm(e) {
    e.preventDefault();

    if (!resStartTimeInput.value || !resEndTimeInput.value) {
      if (timeSettingMessage) { 
          timeSettingMessage.textContent = "ì‹œì‘ê³¼ ì¢…ë£Œ ì‹œê°„ì„ ëª¨ë‘ ì…ë ¥í•˜ì„¸ìš”.";
          timeSettingMessage.style.color = "red";
      }
      return;
    }

    if (new Date(resEndTimeInput.value) <= new Date(resStartTimeInput.value)) {
      if (timeSettingMessage) { 
          timeSettingMessage.textContent = "ì¢…ë£Œ ì‹œê°„ì€ ì‹œì‘ ì‹œê°„ë³´ë‹¤ ëŠ¦ì–´ì•¼ í•©ë‹ˆë‹¤.";
          timeSettingMessage.style.color = "red";
      }
      return;
    }

    try {
      const res = await fetch(`${BACKEND_URL}/api/admin-settings`, {
        method: "PUT",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          reservationStartTime: new Date(resStartTimeInput.value).toISOString(),
          reservationEndTime: new Date(resEndTimeInput.value).toISOString(),
        }),
      });

      if (res.ok) {
        if (timeSettingMessage) { 
            timeSettingMessage.textContent = "ì˜ˆì•½ ê°€ëŠ¥ ì‹œê°„ì´ ì„¤ì •ë˜ì—ˆìŠµë‹ˆë‹¤.";
            timeSettingMessage.style.color = "green";
        }
        await loadAdminPage(); 
      } else {
        if (timeSettingMessage) { 
            timeSettingMessage.textContent = "ì„¤ì • ì‹¤íŒ¨";
            timeSettingMessage.style.color = "red";
        }
      }
    } catch (e) {
      console.error(e);
      if (timeSettingMessage) { 
          timeSettingMessage.textContent = "ì„œë²„ ì˜¤ë¥˜ ë°œìƒ";
          timeSettingMessage.style.color = "red";
      }
    }
  }

  async function handleSubmitAnnouncementForm(e) {
      e.preventDefault();
      const message = announcementMessageInput.value.trim();
      const active = announcementActiveCheckbox.checked;

      if (!message && active) {
          if (announcementMessageStatus) { 
              announcementMessageStatus.textContent = 'í™œì„±í™”í•˜ë ¤ë©´ ê³µì§€ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”.';
              announcementMessageStatus.style.color = 'red';
          }
          return;
      }
      if (!message && !active) { 
          if (announcementMessageStatus) { 
              announcementMessageStatus.textContent = 'ê³µì§€ ë¹„í™œì„±í™” ë° ë‚´ìš© ì‚­ì œ ì™„ë£Œ.';
              announcementMessageStatus.style.color = "green";
          }
      }

      try {
          const response = await fetch(`${BACKEND_URL}/api/announcement`, {
              method: 'PUT',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ message, active })
          });
          if (response.ok) {
              if (announcementMessageStatus) { 
                  announcementMessageStatus.textContent = active ? 'ê³µì§€ì‚¬í•­ì´ ì €ì¥ë˜ê³  í™œì„±í™”ë˜ì—ˆìŠµë‹ˆë‹¤.' : 'ê³µì§€ì‚¬í•­ì´ ì €ì¥ë˜ê³  ë¹„í™œì„±í™”ë˜ì—ˆìŠµë‹ˆë‹¤.';
                  announcementMessageStatus.style.color = "green";
              }
          } else {
              if (announcementMessageStatus) { 
                  announcementMessageStatus.textContent = 'ê³µì§€ ì €ì¥ ì‹¤íŒ¨';
                  announcementMessageStatus.style.color = "red";
              }
          }
      } catch (e) {
          console.error('ê³µì§€ ì €ì¥ ì¤‘ ì˜¤ë¥˜:', e);
          if (announcementMessageStatus) { 
              announcementMessageStatus.textContent = 'ê³µì§€ ì €ì¥ ì¤‘ ì„œë²„ ì˜¤ë¥˜ ë°œìƒ';
              announcementMessageStatus.style.color = "red";
          }
      }
  }

  function showAnnouncement(message) {
      console.log("showAnnouncement called with message:", message); 
      if (announcementOverlay && announcementPopupMessage) {
          announcementPopupMessage.textContent = message; 
          announcementOverlay.classList.remove('hidden');
      } else {
          console.error("ê³µì§€ íŒì—… ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
      }
  }

  function hideAnnouncement() {
      console.log("hideAnnouncement called."); 
      if (announcementOverlay) {
          announcementOverlay.classList.add('hidden');
      } else {
          console.error("announcementOverlay not found during hideAnnouncement.");
      }
  }


  // --- ì´ˆê¸° ë°ì´í„° ë¡œë“œ ë° í˜ì´ì§€ í‘œì‹œ (ì´ì „ ì½”ë“œì™€ ë™ì¼) ---
  document.addEventListener('DOMContentLoaded', async () => {
      console.log('DOM Content Loaded. Script execution starts.');
      
      // â­â­ ëª¨ë“  DOM ìš”ì†Œ ì°¸ì¡°ë¥¼ DOMContentLoaded ì•ˆì—ì„œ ìˆ˜í–‰ â­â­
      loginPage = document.getElementById('loginPage');
      loginForm = document.getElementById('loginForm');
      roomNoInput = document.getElementById('roomNo');
      userNameInput = document.getElementById('userName');
      dormitorySelect = document.getElementById('dormitory');
      roomError = document.getElementById('roomError');
      nameError = document.getElementById('nameError');
      dormError = document.getElementById('dormError');
      adminLoginBtn = document.getElementById('adminLoginBtn');

      floorSelectPage = document.getElementById('floorSelectPage');
      floorSelect = document.getElementById('floorSelect');
      floorNextBtn = document.getElementById('floorNextBtn');
      backToLoginBtn = document.getElementById('backToLoginBtn');
      welcomeText = document.getElementById('welcomeText'); 

      seatMapPage = document.getElementById('seatMapPage');
      seatMapContainer = document.getElementById('seatMap');
      confirmBtn = document.getElementById('confirmBtn');
      cancelSeatBtn = document.getElementById('cancelSeatBtn');
      selectedDormTitle = document.getElementById('selectedDorm');
      selectedFloorTitle = document.getElementById('selectedFloor');
      reservationAvailabilityMessage = document.getElementById('reservationAvailabilityMessage');

      adminLoginPage = document.getElementById('adminLoginPage');
      adminLoginForm = document.getElementById('adminLoginForm');
      adminPasswordInput = document.getElementById('adminPassword');
      adminError = document.getElementById('adminError');

      adminPage = document.getElementById('adminPage');
      adminLogoutBtn = document.getElementById('adminLogoutBtn');
      reservationListBody = document.getElementById('reservationListBody');
      clearAllReservationsBtn = document.getElementById('clearAllReservationsBtn');

      reservationTimeForm = document.getElementById('reservationTimeForm');
      resStartTimeInput = document.getElementById('resStartTime');
      resEndTimeInput = document.getElementById('resEndTime');
      timeSettingMessage = document.getElementById('timeSettingMessage');

      announcementOverlay = document.getElementById('announcementOverlay');
      announcementPopupMessage = document.getElementById('announcementMessage');
      announcementCloseBtn = announcementOverlay ? announcementOverlay.querySelector('.close-btn') : null; 
      announcementForm = document.getElementById('announcementForm');
      announcementMessageInput = document.getElementById('announcementMessageInput');
      announcementActiveCheckbox = document.getElementById('announcementActiveCheckbox');
      announcementMessageStatus = document.getElementById('announcementMessageStatus');
      // â­â­â­ DOM ìš”ì†Œ ì°¸ì¡° ë â­â­â­

      // DOM ìš”ì†Œ ì°¸ì¡° ê²€ì‚¬ ë¡œê·¸ (ëª¨ë“  ìš”ì†Œê°€ 'found.'ë¡œ ë‚˜ì™€ì•¼ í•©ë‹ˆë‹¤!)
      console.log('--- DOM Element Checks ---');
      console.log('loginPage:', loginPage);
      console.log('loginForm:', loginForm);
      console.log('roomNoInput:', roomNoInput);
      console.log('userNameInput:', userNameInput);
      console.log('dormitorySelect:', dormitorySelect);
      console.log('roomError:', roomError);
      console.log('nameError:', nameError);
      console.log('dormError:', dormError);
      console.log('adminLoginBtn:', adminLoginBtn);
      console.log('floorSelectPage:', floorSelectPage);
      console.log('floorSelect:', floorSelect);
      console.log('floorNextBtn:', floorNextBtn);
      console.log('backToLoginBtn:', backToLoginBtn);
      console.log('welcomeText:', welcomeText);
      console.log('seatMapPage:', seatMapPage);
      console.log('seatMapContainer:', seatMapContainer);
      console.log('confirmBtn:', confirmBtn);
      console.log('cancelSeatBtn:', cancelSeatBtn);
      console.log('selectedDormTitle:', selectedDormTitle);
      console.log('selectedFloorTitle:', selectedFloorTitle);
      console.log('reservationAvailabilityMessage:', reservationAvailabilityMessage);
      console.log('adminLoginPage:', adminLoginPage);
      console.log('adminLoginForm:', adminLoginForm);
      console.log('adminPasswordInput:', adminPasswordInput);
      console.log('adminError:', adminError);
      console.log('adminPage:', adminPage);
      console.log('adminLogoutBtn:', adminLogoutBtn);
      console.log('reservationListBody:', reservationListBody);
      console.log('clearAllReservationsBtn:', clearAllReservationsBtn);
      console.log('announcementOverlay:', announcementOverlay);
      console.log('announcementPopupMessage:', announcementPopupMessage);
      console.log('announcementCloseBtn:', announcementCloseBtn);
      console.log('announcementForm:', announcementForm);
      console.log('announcementMessageInput:', announcementMessageInput);
      console.log('announcementActiveCheckbox:', announcementActiveCheckbox);
      console.log('announcementMessageStatus:', announcementMessageStatus);
      console.log('reservationTimeForm:', reservationTimeForm);
      console.log('resStartTimeInput:', resStartTimeInput);
      console.log('resEndTimeInput:', resEndTimeInput);
      console.log('timeSettingMessage:', timeSettingMessage);
      console.log('--- End DOM Element Checks ---');

      // â­â­â­ ëª¨ë“  ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡ â­â­â­
      // ì´ì œ DOMContentLoaded ì•ˆì—ì„œ ëª¨ë“  ìš”ì†Œê°€ í• ë‹¹ë˜ì—ˆìœ¼ë¯€ë¡œ, ì•ˆì „í•˜ê²Œ ë¦¬ìŠ¤ë„ˆ ë“±ë¡ ê°€ëŠ¥
      // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆì˜ ì½œë°± í•¨ìˆ˜ëŠ” ìµœìƒìœ„ ìŠ¤ì½”í”„ì— ì •ì˜ëœ í•¨ìˆ˜ë¥¼ ì°¸ì¡°í•©ë‹ˆë‹¤.
      if (loginForm) {
          console.log('Attaching event listener to loginForm.');
          loginForm.addEventListener('submit', handleSubmitLoginForm); 
      } else {
          console.error("Critical Error: loginForm element not found. Login will not work. Please check HTML IDs.");
      }

      if (backToLoginBtn) backToLoginBtn.addEventListener('click', handleClickBackToLoginBtn); 
      if (floorNextBtn) floorNextBtn.addEventListener('click', handleClickFloorNextBtn); 
      if (cancelSeatBtn) cancelSeatBtn.addEventListener('click', handleClickCancelSeatBtn); 
      if (adminLoginBtn) adminLoginBtn.addEventListener('click', handleClickAdminLoginBtn); 
      if (document.getElementById('adminLoginBackBtn')) document.getElementById('adminLoginBackBtn').addEventListener('click', handleClickAdminLoginBackBtn); 
      
      if (adminLoginForm) { 
          adminLoginForm.addEventListener('submit', handleSubmitAdminLoginForm); 
      } else {
          console.error("Critical Error: adminLoginForm element not found. Admin login will not work. Please check HTML IDs.");
      }

      if (adminLogoutBtn) adminLogoutBtn.addEventListener('click', handleClickAdminLogoutBtn); 
      if (clearAllReservationsBtn) clearAllReservationsBtn.addEventListener('click', handleClickClearAllReservationsBtn); 

      if (confirmBtn) confirmBtn.addEventListener("click", handleSubmitConfirmBtn); 

      if (reservationTimeForm) { 
          reservationTimeForm.addEventListener("submit", handleSubmitReservationTimeForm); 
      }

      if (announcementForm) { 
          announcementForm.addEventListener('submit', handleSubmitAnnouncementForm); 
      }
      
      if (announcementCloseBtn) { 
          announcementCloseBtn.addEventListener('click', hideAnnouncement);
      } else {
          console.error("Error: announcementCloseBtn element not found. Close button might not work.");
      }

      // --- ì´ˆê¸° ë°ì´í„° ë¡œë“œ ë° í˜ì´ì§€ í‘œì‹œ ---
      console.log('All event listeners attached. Starting initial fetches.');
      await fetchAllReservations();
      await fetchAdminSettings();
      await fetchAnnouncement(); 
      console.log('Initial fetches completed. Showing login page.');
      showSection(loginPage);
  });
})();
</script>