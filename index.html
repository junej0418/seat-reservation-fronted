<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
<title>ëœì„ ì„ ì˜ˆì•½ ì‹œìŠ¤í…œ</title>
<style>
Â  /* ê¸°ë³¸ ìŠ¤íƒ€ì¼ */
Â  body {
Â  Â  font-family: 'Malgun Gothic', Arial, sans-serif;
Â  Â  margin: 0; padding: 10px 0;
Â  Â  background: #fafafc;
Â  Â  color: #2c3e50;
Â  }
Â  h1, h2 {
Â  Â  text-align: center;
Â  Â  margin: 1em 0;
Â  Â  color: #334155;
Â  }
Â  .container {
Â  Â  max-width: 960px;
Â  Â  margin: 10px auto 40px;
Â  Â  background: white;
Â  Â  padding: 15px 20px;
Â  Â  border-radius: 12px;
Â  Â  box-shadow: 0 0 20px rgba(0,0,0,0.06);
Â  }
Â  .hidden { display: none !important; } /* ë‹¤ë¥¸ ìŠ¤íƒ€ì¼ì— ì˜í•´ ë®ì–´ì“°ê¸° ë°©ì§€ */

Â  /* í¼ ìš”ì†Œ */
Â  form {
Â  Â  max-width: 400px;
Â  Â  margin: 0 auto;
Â  }
Â  label {
Â  Â  font-weight: 700;
Â  Â  margin-top: 12px;
Â  Â  display: block;
Â  Â  color: #475569;
Â  }
Â  input[type=text], input[type=password], input[type=datetime-local], select {
Â  Â  width: 100%;
Â  Â  padding: 10px 12px;
Â  Â  margin-top: 6px;
Â  Â  font-size: 1rem;
Â  Â  border: 2px solid #cbd5e1;
Â  Â  border-radius: 8px;
Â  Â  box-sizing: border-box;
Â  Â  transition: border-color 0.3s;
Â  }
Â  input[type=text]:focus, input[type=password]:focus, input[type=datetime-local]:focus, select:focus {
Â  Â  border-color: #fbbf24;
Â  Â  outline: none;
Â  }
Â  .error {
Â  Â  color: #dc2626;
Â  Â  font-size: 0.9rem;
Â  Â  height: 20px;
Â  Â  margin-top: 4px;
Â  }

Â  /* ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
Â  button {
Â  Â  background-color: #fbbf24;
Â  Â  border: none;
Â  Â  border-radius: 8px;
Â  Â  padding: 12px 25px;
Â  Â  font-size: 1.1rem;
Â  Â  font-weight: 700;
Â  Â  color: #92400e;
Â  Â  cursor: pointer;
Â  Â  margin-top: 20px;
Â  Â  box-shadow: 1px 3px 6px rgba(251,191,36,0.5);
Â  Â  transition: background-color 0.3s;
Â  Â  display: inline-block;
Â  Â  min-width: 120px;
Â  }
Â  button:hover:not(:disabled) {
Â  Â  background-color: #f59e0b;
Â  }
Â  button:disabled {
Â  Â  background-color: #fde68a;
Â  Â  cursor: not-allowed;
Â  }
Â  nav {
Â  Â  text-align: center;
Â  Â  margin-top: 20px;
Â  }
Â  nav button {
Â  Â  background: transparent;
Â  Â  color: #b45309;
Â  Â  font-weight: 600;
Â  Â  padding: 8px 16px;
Â  Â  border: 2px solid #fbbf24;
Â  Â  border-radius: 8px;
Â  Â  cursor: pointer;
Â  Â  transition: background-color 0.3s;
Â  }
Â  nav button:hover {
Â  Â  background-color: #fbbf24;
Â  Â  color: #92400e;
Â  }

Â  /* ì¢Œì„ ë°°ì¹˜ë„ */
Â  #seatMapWrapper { /* ì¢Œì„ ë°°ì¹˜ë„ ìŠ¤í¬ë¡¤ë§ì„ ìœ„í•œ ë˜í¼ */
Â  Â  overflow-x: auto; /* ë‚´ìš©ì´ ë„˜ì¹  ê²½ìš° ê°€ë¡œ ìŠ¤í¬ë¡¤ */
Â  Â  -webkit-overflow-scrolling: touch; /* ëª¨ë°”ì¼ì—ì„œ ë¶€ë“œëŸ¬ìš´ ìŠ¤í¬ë¡¤ */
Â  Â  padding-bottom: 10px; /* ìŠ¤í¬ë¡¤ë°” ë•Œë¬¸ì— ë‚´ìš©ì´ ê°€ë ¤ì§€ì§€ ì•Šë„ë¡ */
Â  }

Â  #seatMap {
Â  Â  margin: 20px auto 40px;
Â  Â  display: grid;
Â  Â  gap: 8px;
Â  Â  justify-content: center;
Â  Â  min-width: fit-content; /* ë‚´ìš©ì— ë§ì¶° ìµœì†Œ ë„ˆë¹„ ì„¤ì •, ìŠ¤í¬ë¡¤ ê°€ëŠ¥í•˜ê²Œ í•¨ */
Â  }
Â  /* ì¢Œì„ ìƒ‰ìƒ ì»¤ìŠ¤í„°ë§ˆì´ì§• */
Â  .seat-btn {
Â  Â  background: #CCFFCC; /* ë¹ˆìë¦¬: ì—°í•œ ì´ˆë¡ìƒ‰ */
Â  Â  border: 2px solid #88CC88; /* ì•½ê°„ ë” ì§„í•œ ì´ˆë¡ í…Œë‘ë¦¬ */
Â  Â  font-weight: 700;
Â  Â  color: #336633; /* ì§™ì€ ì´ˆë¡ìƒ‰ ê¸€ì */
Â  Â  cursor: pointer;
Â  Â  user-select: none;
Â  Â  display: flex;
Â  Â  justify-content: center;
Â  Â  align-items: center;
Â  Â  font-size: 1.1rem;
Â  Â  min-width: 44px; /* PC/íƒœë¸”ë¦¿ ê¸°ë³¸ ì¢Œì„ ë„ˆë¹„ */
Â  Â  aspect-ratio: 1/1; /* 1:1 ë¹„ìœ¨ ìœ ì§€ */
Â  Â  border-radius: 6px;
Â  Â  transition: background-color 0.3s, border-color 0.3s;
Â  }
Â  .seat-btn:hover:not(.booked) {
Â  Â  background-color: #AACC88; /* í˜¸ë²„ ì‹œ ì•½ê°„ ì§„í•˜ê²Œ */
Â  Â  border-color: #669944;
Â  }
Â  .seat-btn.booked {
Â  Â  background: #FFCCCC; /* ì˜ˆì•½ë¨: ì—°í•œ ë¹¨ê°„ìƒ‰ */
Â  Â  border: 2px solid #CC8888; /* ì•½ê°„ ë” ì§„í•œ ë¹¨ê°„ í…Œë‘ë¦¬ */
Â  Â  color: #663333; /* ì§™ì€ ë¹¨ê°„ìƒ‰ ê¸€ì */
Â  Â  cursor: not-allowed;
Â  }
Â  .seat-btn.mine {
Â  Â  background: #FFCCFF; /* ë³¸ì¸ ìë¦¬: ì—°í•œ í•‘í¬ */
Â  Â  border: 2px solid #CC88CC; /* ì•½ê°„ ë” ì§„í•œ í•‘í¬ í…Œë‘ë¦¬ */
Â  Â  color: #663366; /* ì§™ì€ í•‘í¬ ê¸€ì */
Â  }
Â  .seat-btn.empty {
Â  Â  visibility: hidden;
Â  Â  pointer-events: none;
Â  }

Â  /* ê´€ë¦¬ì ì˜ˆì•½ í˜„í™© í…Œì´ë¸” */
Â  table {
Â  Â  width: 100%;
Â  Â  border-collapse: collapse;
Â  Â  margin-top: 15px;
Â  Â  font-size: 1rem;
Â  }
Â  th, td {
Â  Â  border: 1px solid #cbd5e1;
Â  Â  padding: 10px 12px;
Â  Â  text-align: center;
Â  }
Â  th {
Â  Â  background-color: #fbbf24;
Â  Â  color: #92400e;
Â  }
Â  td button {
Â  Â  background: #ef4444;
Â  Â  color: white;
Â  Â  border: none;
Â  Â  border-radius: 6px;
Â  Â  padding: 6px 12px;
Â  Â  font-weight: 600;
Â  Â  cursor: pointer;
Â  Â  transition: background-color 0.3s;
Â  }
Â  td button:hover {
Â  Â  background: #b91c1c;
Â  }

Â  /* ì˜ˆì•½ ì•ˆë‚´ ë©”ì‹œì§€ */
Â  #reservationAvailabilityMessage {
Â  Â  margin-top: 10px;
Â  Â  font-weight: 700;
Â  Â  padding: 0.5em;
Â  Â  border-radius: 5px;
Â  Â  text-align: center;
Â  Â  color: #ef4444;
Â  Â  background-color: #fee2e2;
Â  }
Â  #reservationAvailabilityMessage.available {
Â  Â  color: #10b981;
Â  Â  background-color: #d1fae5;
Â  }

Â  #timeSettingMessage {
Â  Â  margin-top: 12px;
Â  Â  text-align: center;
Â  Â  font-size: 0.9rem;
Â  Â  min-height: 1.5em;
Â  }

Â  /* ë°˜ì‘í˜• */
Â  @media (max-width: 768px) {
Â  Â  .container {
Â  Â  Â  margin: 10px auto 30px;
Â  Â  Â  padding: 10px;
Â  Â  }
Â  Â  .seat-btn {
Â  Â  Â  min-width: 38px;
Â  Â  Â  font-size: 1rem;
Â  Â  }
Â  Â  h1, h2 { font-size: 1.5rem; }
Â  }

Â  @media (max-width: 480px) {
Â  Â  body { padding: 5px; }
Â  Â  .container {
Â  Â  Â  margin: 5px auto 20px;
Â  Â  Â  padding: 8px;
Â  Â  Â  border-radius: 8px;
Â  Â  }
Â  Â  h1, h2 { font-size: 1.4rem; margin: 0.8em 0; }
Â  Â  label, input, select { font-size: 0.9rem; }
Â  Â  button { padding: 8px 12px; font-size: 0.95rem; margin-top: 15px; min-width: auto; }
Â  Â  nav button { padding: 5px 8px; font-size: 0.85rem; }
Â  Â  
Â  Â  #seatMap {
Â  Â  Â  gap: 4px;
Â  Â  }
Â  Â  .seat-btn {
Â  Â  Â  min-width: 26px; /* íœ´ëŒ€í° ë“± ì‘ì€ í™”ë©´ì—ì„œì˜ ì¢Œì„ ìµœì†Œ ë„ˆë¹„ */
Â  Â  Â  font-size: 0.85rem;
Â  Â  Â  padding: 0;
Â  Â  }
Â  Â  table { font-size: 0.8rem; }
Â  Â  th, td { padding: 6px 4px; }
Â  Â  td button { padding: 3px 6px; font-size: 0.75rem; }
Â  }

Â  /* ê³µì§€ íŒì—… ìŠ¤íƒ€ì¼ */
Â  .announcement-overlay {
Â  Â  position: fixed;
Â  Â  top: 0; left: 0;
Â  Â  width: 100%; height: 100%;
Â  Â  background: rgba(0, 0, 0, 0.7);
Â  Â  display: flex;
Â  Â  justify-content: center;
Â  Â  align-items: center;
Â  Â  z-index: 1000;
Â  }
Â  .announcement-popup {
Â  Â  background: white;
Â  Â  padding: 30px;
Â  Â  border-radius: 10px;
Â  Â  box-shadow: 0 0 25px rgba(0, 0, 0, 0.5);
Â  Â  max-width: 500px;
Â  Â  width: 90%;
Â  Â  text-align: left; /* ê³µì§€ í…ìŠ¤íŠ¸ ì™¼ìª½ ì •ë ¬ */
Â  Â  position: relative;
Â  Â  font-size: 1.1rem;
Â  Â  line-height: 1.5;
Â  }
Â  .announcement-popup h3 {
Â  Â  margin-top: 0;
Â  Â  color: #b45309;
Â  Â  font-size: 1.5rem;
Â  Â  margin-bottom: 20px;
Â  Â  text-align: center; /* ì œëª©ì€ ì¤‘ì•™ ì •ë ¬ */
Â  }
Â  .announcement-popup p {
Â  Â  margin-bottom: 20px;
Â  Â  color: #333;
Â  Â  white-space: pre-wrap; /* ê³µì§€ ë©”ì‹œì§€ ë‚´ ì—”í„° ê³µë°± ìœ ì§€ */
Â  }
Â  .announcement-popup button.close-btn {
Â  Â  background: #b45309;
Â  Â  color: white;
Â  Â  border: none;
Â  Â  border-radius: 5px;
Â  Â  padding: 10px 20px;
Â  Â  cursor: pointer;
Â  Â  font-size: 1rem;
Â  Â  transition: background 0.3s;
Â  Â  margin-top: 0; /* ê¸°ì¡´ ë²„íŠ¼ ë§ˆì§„ ì´ˆê¸°í™” */
Â  Â  display: block; /* ë²„íŠ¼ì„ ë¸”ë¡ ìš”ì†Œë¡œ ë§Œë“¤ì–´ í•˜ë‹¨ì— ë°°ì¹˜ */
Â  Â  margin-left: auto; /* ì¤‘ì•™ ì •ë ¬ */
Â  Â  margin-right: auto; /* ì¤‘ì•™ ì •ë ¬ */
Â  }
Â  .announcement-popup button.close-btn:hover {
Â  Â  background: #8e420b;
Â  }
Â  /* ê´€ë¦¬ì í˜ì´ì§€ì˜ ê³µì§€ ì…ë ¥ë€ ìŠ¤íƒ€ì¼ */
Â  #announcementMessageInput {
Â  Â  width: calc(100% - 20px);
Â  Â  height: 80px;
Â  Â  padding: 10px;
Â  Â  margin-top: 10px;
Â  Â  border: 1px solid #ccc;
Â  Â  border-radius: 5px;
Â  Â  resize: vertical;
Â  Â  font-size: 1rem;
Â  }
Â  #announcementActiveCheckbox {
Â  Â  margin-top: 15px;
Â  Â  margin-right: 8px;
Â  }
Â  /* ë²„íŠ¼ ê·¸ë£¹ ìŠ¤íƒ€ì¼ (ë’¤ë¡œê°€ê¸° ë²„íŠ¼ ì™¼ìª½ ì •ë ¬) */
Â  .button-group {
Â  Â  display: flex; /* Flexbox í™œì„±í™” */
Â  Â  justify-content: space-between; /* ì–‘ ë ì •ë ¬ */
Â  Â  align-items: center; /* ì„¸ë¡œ ì¤‘ì•™ ì •ë ¬ */
Â  Â  width: 100%; /* ë„ˆë¹„ 100% */
Â  Â  margin-top: 20px;
Â  }
Â  .button-group button { 
Â  Â  margin-top: 0; /* ê·¸ë£¹ ë‚´ ë²„íŠ¼ì˜ ìƒë‹¨ ë§ˆì§„ ì´ˆê¸°í™” */
Â  }
Â  /* ìƒ‰ìƒ ë²”ë¡€ ìŠ¤íƒ€ì¼ */
Â  .color-legend {
Â  Â  text-align: center;
Â  Â  margin-top: 30px;
Â  Â  padding: 15px;
Â  Â  border-top: 1px solid #eee;
Â  Â  display: flex; /* ê°€ë¡œ ì •ë ¬ */
Â  Â  flex-wrap: wrap; /* ë°˜ì‘í˜•ìœ¼ë¡œ ì¤„ë°”ê¿ˆ */
Â  Â  justify-content: center; /* ì¤‘ì•™ ì •ë ¬ */
Â  Â  gap: 20px; /* ì•„ì´í…œ ê°„ ê°„ê²© */
Â  Â  font-size: 0.9rem;
Â  Â  color: #555;
Â  }
Â  .legend-item {
Â  Â  display: flex;
Â  Â  align-items: center;
Â  Â  gap: 8px; /* ìƒ‰ìƒ ë°•ìŠ¤ì™€ í…ìŠ¤íŠ¸ ì‚¬ì´ ê°„ê²© */
Â  }
Â  .legend-box {
Â  Â  width: 20px;
Â  Â  height: 20px;
Â  Â  border-radius: 4px;
Â  Â  border: 1px solid #ccc;
Â  }
Â  .legend-box.empty { background-color: #CCFFCC; border-color: #88CC88; }
Â  .legend-box.booked { background-color: #FFCCCC; border-color: #CC8888; }
Â  .legend-box.mine { background-color: #FFCCFF; border-color: #CC88CC; }
</style>
</head>
<body>

<div class="container" id="loginPage">
Â  <h1>ëœì„ ì„ ì˜ˆì•½ ë¡œê·¸ì¸</h1>
Â  <form id="loginForm" autocomplete="off" novalidate>
Â  Â  <label for="roomNo">ë£¸ ë²ˆí˜¸ (000í˜¸ í˜•ì‹):</label>
Â  Â  <input type="text" id="roomNo" name="roomNo" placeholder="ì˜ˆ: 101í˜¸" required />
Â  Â  <div id="roomError" class="error"></div>

Â  Â  <label for="userName">ì´ë¦„ (í•œê¸€ 2~4ì):</label>
Â  Â  <input type="text" id="userName" name="userName" placeholder="ì˜ˆ: í™ê¸¸ë™" required />
Â  Â  <div id="nameError" class="error"></div>

Â  Â  <label for="dormitory">ê¸°ìˆ™ì‚¬ ì„ íƒ:</label>
Â  Â  <select id="dormitory" name="dormitory" required>
Â  Â  Â  <option value="" disabled selected>ì„ íƒí•˜ì„¸ìš”</option>
Â  Â  Â  <option value="ê¿ˆë™">ê¿ˆë™</option>
Â  Â  Â  <option value="ë¯¸ë˜ë™">ë¯¸ë˜ë™</option>
Â  Â  </select>
Â  Â  <div id="dormError" class="error"></div>

Â  Â  Â  Â  <input type="text" name="honeypot_field" style="display: none !important; visibility: hidden !important; opacity: 0 !important; width: 0 !important; height: 0 !important; border: none !important; padding: 0 !important; margin: 0 !important;" tabindex="-1" autocomplete="off" />

Â  Â  <button type="submit">ë‹¤ìŒ</button>
Â  </form>
Â  <nav>
Â  Â  <button id="adminLoginBtn" type="button">ê´€ë¦¬ì ë¡œê·¸ì¸</button>
Â  </nav>
</div>

<div class="container hidden" id="floorSelectPage">
Â  Â  <h2><span id="welcomeText"></span>ë‹˜, ì¸µì„ ì„ íƒí•´ì£¼ì„¸ìš”</h2> 
  <label for="floorSelect">ì¸µ ì„ íƒ:</label>
  <select id="floorSelect" name="floor" required>
    <option value="" disabled selected>ì¸µ ì„ íƒ</option>
  </select>
Â  <div class="button-group"> Â  Â  <button id="backToLoginBtn" type="button">ë’¤ë¡œê°€ê¸°</button>
Â  Â  <button id="floorNextBtn" type="button">ì¢Œì„ ì„ íƒìœ¼ë¡œ</button>
Â  </div>
</div>

<div class="container hidden" id="seatMapPage">
Â  <h2>ì¢Œì„ ë°°ì¹˜ë„ - <span id="selectedDorm"></span> <span id="selectedFloor"></span>ì¸µ</h2>
Â  <div id="seatMapWrapper">
Â  Â  <div id="seatMap"></div>
Â  </div>
Â  <div id="reservationAvailabilityMessage"></div>
Â  <div class="button-group"> Â  Â  <button id="confirmBtn" type="button" disabled>ì˜ˆì•½ í™•ì •</button>
Â  Â  <button id="cancelSeatBtn" type="button">ì·¨ì†Œ ë° ë’¤ë¡œê°€ê¸°</button>
Â  </div>
Â  Â  <div class="color-legend">
Â  Â  <div class="legend-item"><div class="legend-box empty"></div>ë¹ˆìë¦¬</div>
Â  Â  <div class="legend-item"><div class="legend-box booked"></div>ì˜ˆì•½ë¨</div>
Â  Â  <div class="legend-item"><div class="legend-box mine"></div>ë‚´ ìë¦¬</div>
Â  </div>
</div>

<div class="container hidden" id="adminLoginPage">
Â  <h1>ê´€ë¦¬ì ë¡œê·¸ì¸</h1>
Â  <form id="adminLoginForm" autocomplete="off" novalidate>
Â  Â  <label for="adminPassword">ë¹„ë°€ë²ˆí˜¸:</label>
Â  Â  <input type="password" id="adminPassword" name="adminPassword" required />
Â  Â  <div id="adminError" class="error"></div>
Â  Â  <div class="button-group"> Â  Â  Â  <button id="adminLoginBackBtn" type="button">ë¡œê·¸ì¸í˜ì´ì§€ë¡œ ëŒì•„ê°€ê¸°</button>
Â  Â  Â  <button type="submit">ë¡œê·¸ì¸</button>
Â  Â  </div>
Â  </form>
</div>

<div class="container hidden" id="adminPage">
Â  <h1>ê´€ë¦¬ì í˜ì´ì§€</h1>
Â  <button id="adminLogoutBtn" type="button">ë¡œê·¸ì•„ì›ƒ</button>

Â  <h2>ì˜ˆì•½ ê°€ëŠ¥ ì‹œê°„ ì„¤ì •</h2>
Â  <form id="reservationTimeForm" novalidate>
Â  Â  <label for="resStartTime">ì˜ˆì•½ ì‹œì‘ ì‹œê°„:</label>
Â  Â  <input type="datetime-local" id="resStartTime" required />
Â  Â  <label for="resEndTime">ì˜ˆì•½ ì¢…ë£Œ ì‹œê°„:</label>
Â  Â  <input type="datetime-local" id="resEndTime" required />
Â  Â  <button type="submit">ì‹œê°„ ì„¤ì • ì €ì¥</button>
Â  Â  <div id="timeSettingMessage"></div>
Â  </form>

Â  <hr style="margin: 2em 0;">

Â  <h2>ê³µì§€ì‚¬í•­ ì„¤ì •</h2>
Â  <form id="announcementForm" novalidate>
Â  Â  <label for="announcementMessageInput">ê³µì§€ ë‚´ìš©:</label>
Â  Â  <textarea id="announcementMessageInput" placeholder="ëª¨ë“  ì‚¬ìš©ìì—ê²Œ í‘œì‹œë  ê³µì§€ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”." rows="4"></textarea>
Â  Â  <div>
Â  Â  Â  <input type="checkbox" id="announcementActiveCheckbox">
Â  Â  Â  <label for="announcementActiveCheckbox" style="display: inline-block; margin-top: 0; font-weight: normal;">ê³µì§€ í™œì„±í™”</label>
Â  Â  </div>
Â  Â  <button type="submit">ê³µì§€ ì €ì¥</button>
Â  Â  <div id="announcementMessageStatus" class="error"></div>
Â  </form>

Â  <hr style="margin: 2em 0;">

Â  <h2>ì˜ˆì•½ í˜„í™©</h2>
Â  <table>
Â  Â  <thead>
Â  Â  Â  <tr><th>ì´ë¦„</th><th>ë£¸ ë²ˆí˜¸</th><th>ê¸°ìˆ™ì‚¬</th><th>ì¸µ</th><th>ìë¦¬ ë²ˆí˜¸</th><th>ì˜ˆì•½ ì·¨ì†Œ</th></tr>
Â  Â  </thead>
Â  Â  <tbody id="reservationListBody"></tbody>
Â  </table>

Â  <button id="clearAllReservationsBtn" type="button" style="background-color: #dc2626; color: white; float: right; margin-top: 15px;">ëª¨ë“  ì˜ˆì•½ ì·¨ì†Œ</button>
</div>

<div class="announcement-overlay hidden" id="announcementOverlay">
Â  <div class="announcement-popup">
Â  Â  <h3>ê³µì§€ì‚¬í•­</h3>
Â  Â  <p id="announcementMessage"></p>
Â  Â  <button class="close-btn" type="button">ë‹«ê¸°</button>
Â  </div>
</div>

<script src="https://seat-reservation-backend-ygl9.onrender.com/socket.io/socket.io.js"></script>
<script>
(() => {
Â  const BACKEND_URL = "https://seat-reservation-backend-ygl9.onrender.com";
Â  let socket = null; // Socket.IO í´ë¼ì´ì–¸íŠ¸ ê°ì²´. DOMContentLoaded ì´í›„ì— í• ë‹¹

Â  let allReservations = {};
Â  let adminSettings = {};
Â  let availabilityCheckInterval = null;
Â  let prevAllowedState = null;

Â  // DOM ìš”ì†Œ ì°¸ì¡° ë³€ìˆ˜ ì„ ì–¸ (ì´ˆê¸°í™”ëŠ” DOMContentLoaded ì•ˆì—ì„œ ì§„í–‰)
Â  let loginPage, loginForm, roomNoInput, userNameInput, dormitorySelect, roomError, nameError, dormError, adminLoginBtn;
Â  let floorSelectPage, floorSelect, floorNextBtn, backToLoginBtn, welcomeText;
Â  let seatMapPage, seatMapContainer, confirmBtn, cancelSeatBtn, selectedDormTitle, selectedFloorTitle, reservationAvailabilityMessage;
Â  let adminLoginPage, adminLoginForm, adminPasswordInput, adminError;
Â  let adminPage, adminLogoutBtn, reservationListBody, clearAllReservationsBtn;
Â  let reservationTimeForm, resStartTimeInput, resEndTimeInput, timeSettingMessage;
Â  let announcementOverlay, announcementPopupMessage, announcementCloseBtn, announcementForm, announcementMessageInput, announcementActiveCheckbox, announcementMessageStatus;


Â  let currentUser = null;
Â  let currentFloor = null;
Â  let selectedSeat = null;

Â  const roomNoPattern = /^\d{3}í˜¸$/;
Â  const koreanNamePattern = /^[ê°€-í£]{2,4}$/;

Â  const seatLayouts = {
Â  Â  "ê¿ˆë™": {
Â  Â  Â  "2": [
Â  Â  Â  Â  [null,4,null,5,6,7,8,9,10,null,null,null,null],
Â  Â  Â  Â  [null,3,null,null,null,null,null,null,null,11,null,null,null],
Â  Â  Â  Â  [null,2,null,null,null,null,null,null,null,12,null,null,null],
Â  Â  Â  Â  [null,1,null,null,null,null,null,null,null,null,null,null,null]
Â  Â  Â  ],
Â  Â  Â  "3": [
Â  Â  Â  Â  [null,4,null,5,6,7,8,9,10,null,11,null,null,null],
Â  Â  Â  Â  [null,3,null,null,null,null,null,null,null,null,12,null,null,null],
Â  Â  Â  Â  [null,2,null,null,null,null,null,null,null,null,13,null,null,null],
Â  Â  Â  Â  [null,1,null,null,null,null,null,null,null,null,14,null,null,null]
Â  Â  Â  ],
Â  Â  Â  "4": [
Â  Â  Â  Â  [null,4,null,null,null,null,null,null,null,null],
Â  Â  Â  Â  [null,3,null,null,5,7,null,null,null,null],
Â  Â  Â  Â  [null,2,null,null,6,8,null,null,null,null],
Â  Â  Â  Â  [null,1,null,null,null,null,null,null,null,null]
Â  Â  Â  ],
Â  Â  Â  "5": [
Â  Â  Â  Â  [null,4,null,null,null,5,8,null,null,null],
Â  Â  Â  Â  [null,3,null,null,null,6,9,null,null,null],
Â  Â  Â  Â  [null,2,null,null,null,7,10,null,null,null],
Â  Â  Â  Â  [null,1,null,null,null,null,null,null,null,null]
Â  Â  Â  ],
Â  Â  Â  "8": [
Â  Â  Â  Â  [null,4,null,5,6,7,8,null,null,null,null,null,null],
Â  Â  Â  Â  [null,3,null,null,null,null,null,null,null,null,null,null,null],
Â  Â  Â  Â  [null,2,null,null,null,null,null,null,null,null,null,null,null],
Â  Â  Â  Â  [null,1,null,null,null,null,null,null,null,null,null,null,null]
Â  Â  Â  ]
Â  Â  },
Â  Â  "ë¯¸ë˜ë™": {
Â  Â  Â  "2": [
Â  Â  Â  Â  [null,null,null,null,null,5,6,7,8,9,10,11,12,null,null,null,null,null],
Â  Â  Â  Â  [null,null,null,null,4,null,null,null,null,null,null,null,null,13,null,null,null,null],
Â  Â  Â  Â  [null,null,null,null,3,null,null,null,null,null,null,null,null,14,null,null,null,null],
Â  Â  Â  Â  [null,null,1,2,null,null,null,null,null,null,null,null,null,null,15,16,null,null],
Â  Â  Â  Â  [null,17,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null]
Â  Â  Â  ],
Â  Â  Â  // 4-1ì¸µ ì¢Œì„ ë°°ì¹˜ë„ - ìˆ˜ì •ëœ ë‚´ìš©ìœ¼ë¡œ ë°˜ì˜
Â  Â  Â  "4-1": [
Â  Â  Â  Â  [null,3,null,4,5,null,6,null,null],
Â  Â  Â  Â  [null,2,null,null,null,null,7,null,null],
Â  Â  Â  Â  [null,1,null,null,null,null,8,null,null]
Â  Â  Â  ],
Â  Â  Â  "4-2": [
Â  Â  Â  Â  [null,4,null,5,6,7,8,9,10,11,12,null,13,null],
Â  Â  Â  Â  [null,3,null,null,null,null,null,null,null,null,null,null,14,null],
Â  Â  Â  Â  [null,2,null,null,null,null,null,null,null,null,null,null,null,null],
Â  Â  Â  Â  [null,1,null,null,null,null,null,null,null,null,null,null,null,null]
Â  Â  Â  ]
Â  Â  }
Â  };

Â  // --- API í†µì‹  í•¨ìˆ˜ë“¤ ---
Â  async function fetchAllReservations() {
Â  Â  console.log('Fetching all reservations...');
Â  Â  try {
Â  Â  Â  const res = await fetch(`${BACKEND_URL}/api/reservations`);
Â  Â  Â  if (!res.ok) throw new Error('ì˜ˆì•½ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨: ' + res.statusText);
Â  Â  Â  const data = await res.json();
Â  Â  Â  allReservations = {};
Â  Â  Â  data.forEach(r => allReservations[r._id] = r);
Â  Â  Â  console.log('Reservations fetched successfully:', Object.keys(allReservations).length, 'reservations found.');
Â  Â  } catch (e) {
Â  Â  Â  alert('ì˜ˆì•½ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¤ëŠ” ë° ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë°±ì—”ë“œ ì„œë²„ ìƒíƒœë¥¼ í™•ì¸í•˜ì„¸ìš”.');
Â  Â  Â  console.error('API í˜¸ì¶œ ì—ëŸ¬: ì˜ˆì•½ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨', e);
Â  Â  Â  return {};
Â  Â  }
Â  }

Â  async function fetchAdminSettings() {
Â  Â  console.log('Fetching admin settings...');
Â  Â  try {
Â  Â  Â  const res = await fetch(`${BACKEND_URL}/api/admin-settings`);
Â  Â  Â  if (!res.ok) throw new Error('ê´€ë¦¬ì ì„¤ì • ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨: ' + res.statusText);
Â  Â  Â  adminSettings = await res.json();
Â  Â  Â  console.log('Admin settings fetched successfully:', adminSettings);
Â  Â  } catch (e) {
Â  Â  Â  alert('ê´€ë¦¬ì ì„¤ì •ì„ ê°€ì ¸ì˜¤ëŠ” ë° ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë°±ì—”ë“œ ì„œë²„ ìƒíƒœë¥¼ í™•ì¸í•˜ì„¸ìš”.');
Â  Â  Â  console.error('API í˜¸ì¶œ ì—ëŸ¬: ê´€ë¦¬ì ì„¤ì • ë¡œë“œ ì‹¤íŒ¨', e);
Â  Â  Â  return { reservationStartTime: null, reservationEndTime: null };
Â  Â  }
Â  }

Â  // --- ê³µì§€ì‚¬í•­ API í†µì‹  ---
Â  async function fetchAnnouncement() {
Â  Â  console.log('Fetching announcement...');
Â  Â  try {
Â  Â  Â  const res = await fetch(`${BACKEND_URL}/api/announcement`);
Â  Â  Â  if (!res.ok) throw new Error('ê³µì§€ì‚¬í•­ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨: ' + res.statusText);
Â  Â  Â  const data = await res.json();
Â  Â  Â  currentAnnouncement = data;
Â  Â  Â  console.log('Announcement fetched:', currentAnnouncement);
Â  Â  Â  if (currentAnnouncement.active && currentAnnouncement.message) {
Â  Â  Â  Â  showAnnouncement(currentAnnouncement.message);
Â  Â  Â  } else {
Â  Â  Â  Â  hideAnnouncement();
Â  Â  Â  }
Â  Â  } catch (e) {
Â  Â  Â  console.error('API í˜¸ì¶œ ì—ëŸ¬: ê³µì§€ì‚¬í•­ ë¡œë“œ ì‹¤íŒ¨', e);
Â  Â  Â  hideAnnouncement(); // ì—ëŸ¬ ë°œìƒ ì‹œ íŒì—… ìˆ¨ê¹€
Â  Â  }
Â  }

Â  // --- Socket.IO ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ (ì‹¤ì‹œê°„ ë™ê¸°í™”) ---
Â  function setupSocketListeners() {
Â  Â  Â  // socket ë³€ìˆ˜ëŠ” IIFE ì‹œì‘í•  ë•Œ io(BACKEND_URL)ë¡œ í• ë‹¹ë˜ë¯€ë¡œ, ì—¬ê¸°ì„œ ì´ˆê¸°í™” ì²´í¬ë§Œ.
Â  Â  Â  if (!socket) {
Â  Â  Â  Â  Â  console.error("Critical Error: Socket.IO client (socket object) is not initialized. Check if 'let socket = io(BACKEND_URL);' is executed.");
Â  Â  Â  Â  Â  return;
Â  Â  Â  }
Â  Â  Â  console.log("Setting up Socket.IO listeners...");

Â  Â  Â  socket.on('reservationsUpdated', async updated => {
Â  Â  Â  Â  Â  console.log('ğŸ”— Socket.IO: ì˜ˆì•½ ë°ì´í„° ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸ ìˆ˜ì‹ ');
Â  Â  Â  Â  Â  allReservations = {};
Â  Â  Â  Â  Â  updated.forEach(r => allReservations[r._id] = r);
Â  Â  Â  Â  Â  if (seatMapPage && !seatMapPage.classList.contains("hidden") && currentUser && currentFloor) { // DOM ìš”ì†Œ null ì²´í¬ ì¶”ê°€
Â  Â  Â  Â  Â  Â  renderSeatMap(currentUser.dormitory, currentFloor);
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  if (adminPage && !adminPage.classList.contains("hidden")) { // DOM ìš”ì†Œ null ì²´í¬ ì¶”ê°€
Â  Â  Â  Â  Â  Â  await loadAdminPage(); // ê´€ë¦¬ì í˜ì´ì§€ ì—…ë°ì´íŠ¸ ì‹œì—ë„ ì˜ˆì•½ ëª©ë¡ ì •ë ¬ ìœ ì§€
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  console.log('ğŸ”— Socket.IO: ì˜ˆì•½ ë°ì´í„° ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸ ì™„ë£Œ');
Â  Â  Â  });

Â  Â  Â  socket.on('settingsUpdated', async updated => {
Â  Â  Â  Â  Â  console.log('ğŸ”— Socket.IO: ê´€ë¦¬ì ì„¤ì • ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸ ìˆ˜ì‹ ');
Â  Â  Â  Â  Â  adminSettings = updated;
Â  Â  Â  Â  Â  // í˜„ì¬ ë³´ê³  ìˆëŠ” í™”ë©´ì— ë”°ë¼ UI ê°±ì‹ 
Â  Â  Â  Â  Â  if (adminPage && !adminPage.classList.contains("hidden")) { // DOM ìš”ì†Œ null ì²´í¬ ì¶”ê°€
Â  Â  Â  Â  Â  Â  await loadAdminPage(); // ê´€ë¦¬ì í˜ì´ì§€ ì—…ë°ì´íŠ¸
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  updateReservationAvailability(); 
Â  Â  Â  Â  Â  if (seatMapPage && !seatMapPage.classList.contains("hidden") && currentUser && currentFloor) { // DOM ìš”ì†Œ null ì²´í¬ ì¶”ê°€
Â  Â  Â  Â  Â  Â  renderSeatMap(currentUser.dormitory, currentFloor);
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  console.log('ğŸ”— Socket.IO: ê´€ë¦¬ì ì„¤ì • ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸ ì™„ë£Œ');
Â  Â  Â  });

Â  Â  Â  // ìƒˆë¡œìš´ Socket.IO ì´ë²¤íŠ¸: ê³µì§€ì‚¬í•­ ì—…ë°ì´íŠ¸
Â  Â  Â  socket.on('announcementUpdated', async updated => {
Â  Â  Â  Â  Â  console.log('ğŸ”— Socket.IO: ê³µì§€ì‚¬í•­ ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸ ìˆ˜ì‹ ');
Â  Â  Â  Â  Â  currentAnnouncement = updated;
Â  Â  Â  Â  Â  if (currentAnnouncement.active && currentAnnouncement.message) {
Â  Â  Â  Â  Â  Â  showAnnouncement(currentAnnouncement.message);
Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  hideAnnouncement();
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  // ê´€ë¦¬ì í˜ì´ì§€ì— ìˆë‹¤ë©´ ê³µì§€ ì„¤ì • UIë„ ì—…ë°ì´íŠ¸
Â  Â  Â  Â  Â  if (adminPage && !adminPage.classList.contains("hidden")) { // DOM ìš”ì†Œ null ì²´í¬ ì¶”ê°€
Â  Â  Â  Â  Â  Â  if (announcementMessageInput) announcementMessageInput.value = currentAnnouncement.message; // DOM ìš”ì†Œ null ì²´í¬
Â  Â  Â  Â  Â  Â  if (announcementActiveCheckbox) announcementActiveCheckbox.checked = currentAnnouncement.active; // DOM ìš”ì†Œ null ì²´í¬
Â  Â  Â  Â  Â  Â  if (announcementMessageStatus) { // DOM ìš”ì†Œ null ì²´í¬
Â  Â  Â  Â  Â  Â  Â  Â  announcementMessageStatus.textContent = "ê³µì§€ì‚¬í•­ì´ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤."; // ê³µì§€ ì—…ë°ì´íŠ¸ ìƒíƒœ í‘œì‹œ
Â  Â  Â  Â  Â  Â  Â  Â  announcementMessageStatus.style.color = "green";
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  console.log('ğŸ”— Socket.IO: ê³µì§€ì‚¬í•­ ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸ ì™„ë£Œ');
Â  Â  Â  });
Â  }

Â  // --- ì˜ˆì•½ ê°€ëŠ¥ ì‹œê°„ í™•ì¸ ë¡œì§ ---
Â  function isReservationTimeAllowed() {
Â  Â  if (!adminSettings.reservationStartTime || !adminSettings.reservationEndTime) {
Â  Â  Â  return { allowed: false, message: 'ê´€ë¦¬ìê°€ ì˜ˆì•½ ê°€ëŠ¥ ì‹œê°„ì„ ì„¤ì •í•˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.' };
Â  Â  }
Â  Â  const now = new Date();
Â  Â  const startTime = new Date(adminSettings.reservationStartTime);
Â  Â  const endTime = new Date(adminSettings.reservationEndTime);
Â  Â  
Â  Â  return now >= startTime && now <= endTime
Â  Â  Â  ? { allowed: true, message: `ì˜ˆì•½ ê°€ëŠ¥ ì‹œê°„ì…ë‹ˆë‹¤. (${formatDate(startTime)} ~ ${formatDate(endTime)})` }
Â  Â  Â  : { allowed: false, message: `í˜„ì¬ ì˜ˆì•½ ê°€ëŠ¥ ì‹œê°„ì´ ì•„ë‹™ë‹ˆë‹¤. (${formatDate(startTime)} ~ ${formatDate(endTime)})` };
Â  }

Â  // ë‚ ì§œ í¬ë§·íŒ… ìœ í‹¸ë¦¬í‹°
Â  function formatDate(date) {
Â  Â  const pad = n => (n < 10 ? '0' + n : n);
Â  Â  return `${pad(date.getMonth() + 1)}-${pad(date.getDate())} ${pad(date.getHours())}:${pad(date.getMinutes())}`;
Â  }

Â  // --- UI í˜ì´ì§€ ì „í™˜ ---
Â  function showSection(section) {
Â  Â  console.log('Showing section:', section.id);
Â  Â  // ëª¨ë“  í˜ì´ì§€ ìš”ì†Œë¥¼ ë¯¸ë¦¬ ì°¸ì¡°í•œ ë³€ìˆ˜ë¥¼ ì‚¬ìš© (DOMContentLoadedì—ì„œ ì´ˆê¸°í™”ëœ ë³€ìˆ˜ë“¤)
Â  Â  [loginPage, floorSelectPage, seatMapPage, adminLoginPage, adminPage].forEach(el => {
Â  Â  Â  if(el) el.classList.add('hidden'); // null ì²´í¬
Â  Â  });
Â  Â  if(section) section.classList.remove('hidden'); // null ì²´í¬
Â  Â  
Â  Â  // ì˜ˆì•½ ê°€ëŠ¥ ì‹œê°„ ì‹¤ì‹œê°„ ì²´í¬ ì¸í„°ë²Œ ê´€ë¦¬ (ìƒˆë¡œê³ ì¹¨ ì—†ì´ ë°”ë¡œ ë°˜ì˜ë˜ë„ë¡)
Â  Â  if (section === seatMapPage) {
Â  Â  Â  if (availabilityCheckInterval) clearInterval(availabilityCheckInterval); // ê¸°ì¡´ ì¸í„°ë²Œ í´ë¦¬ì–´
Â  Â  Â  updateReservationAvailability(); // ì¦‰ì‹œ í•œë²ˆ í˜¸ì¶œí•˜ì—¬ ì´ˆê¸° ìƒíƒœ ë°˜ì˜
Â  Â  Â  availabilityCheckInterval = setInterval(updateReservationAvailability, 1000); 
Â  Â  } else {
Â  Â  Â  if (availabilityCheckInterval) {
Â  Â  Â  Â  clearInterval(availabilityCheckInterval);
Â  Â  Â  Â  availabilityCheckInterval = null;
Â  Â  Â  }
Â  Â  }
Â  }


Â  function clearErrors() {
Â  Â  if (roomError) roomError.textContent = ""; 
Â  Â  if (nameError) nameError.textContent = ""; 
Â  Â  if (dormError) dormError.textContent = ""; 
Â  }

Â  // --- ì¢Œì„ ë°°ì¹˜ë„ ê´€ë ¨ í•¨ìˆ˜ë“¤ ---
Â  function setFloorOptions(dorm) {
Â  Â  console.log('setFloorOptions called with dorm:', dorm); 
Â  Â  // seatLayouts[dorm]ì´ ìœ íš¨í•œì§€ í™•ì¸í•˜ê³ , floorSelectê°€ nullì´ ì•„ë‹Œì§€ í™•ì¸
Â  Â  if (!seatLayouts[dorm]) {
Â  Â  Â  Â  console.error('Error: seatLayouts[' + dorm + '] is undefined or null. Check dorm value and seatLayouts definition.');
Â  Â  Â  Â  if (floorSelect) floorSelect.innerHTML = '<option value="" disabled selected>í•´ë‹¹ ê¸°ìˆ™ì‚¬ì˜ ì¸µ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.</option>'; 
Â  Â  Â  Â  return; 
Â  Â  }

Â  Â  if (!floorSelect) { // â­ ì¤‘ìš”: floorSelectê°€ nullì¼ ê²½ìš° ì´ ì˜¤ë¥˜ë¥¼ ë°œìƒì‹œí‚¤ê³  ì¡°ê¸° ë°˜í™˜ â­
Â  Â  Â  console.error('Critical Error: floorSelect is null when trying to setFloorOptions. Check HTML ID "floorSelect" and DOM loading.');
Â  Â  Â  alert('ì˜¤ë¥˜: ì¸µ ì„ íƒ ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•´ì£¼ì„¸ìš”.');
Â  Â  Â  return; 
Â  Â  }
Â  Â  floorSelect.innerHTML = '<option value="" disabled selected>ì¸µ ì„ íƒ</option>'; 

Â  Â  const floors = Object.keys(seatLayouts[dorm]).sort((a,b) => {
Â  Â  Â  const parseFloor = (f) => parseFloat(f.replace('-', '.'));
Â  Â  Â  return parseFloor(a) - parseFloor(b);
Â  Â  });
Â  Â  console.log('Available floors for dorm', dorm + ':', floors); 
Â  Â  floors.forEach(floor => {
Â  Â  Â  const option = document.createElement('option');
Â  Â  Â  option.value = floor;
Â  Â  Â  option.textContent = floor.includes('-') ? floor.replace('-', 'ì¸µ-') : floor + 'ì¸µ';
Â  Â  Â  floorSelect.appendChild(option); 
Â  Â  });
Â  }

Â  function renderSeatMap(dorm, floor) {
Â  Â  console.log('renderSeatMap called with dorm:', dorm, 'floor:', floor); 
Â  Â  if (!seatMapContainer) { // â­ ì¤‘ìš”: seatMapContainerê°€ nullì¼ ê²½ìš° ì´ ì˜¤ë¥˜ë¥¼ ë°œìƒì‹œí‚¤ê³  ì¡°ê¸° ë°˜í™˜ â­
Â  Â  Â  Â  console.error('Critical Error: seatMapContainer is null when trying to renderSeatMap. Check HTML ID "seatMap" and DOM loading.');
Â  Â  Â  Â  alert('ì˜¤ë¥˜: ì¢Œì„ ë°°ì¹˜ë„ ì»¨í…Œì´ë„ˆë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•´ì£¼ì„¸ìš”.');
Â  Â  Â  Â  return; 
Â  Â  }
Â  Â  seatMapContainer.innerHTML = ''; 

Â  Â  const layout = seatLayouts[dorm]?.[floor];
Â  Â  if (!layout) {
Â  Â  Â  if (seatMapContainer) seatMapContainer.textContent = 'í•´ë‹¹ ì¸µ ì¢Œì„ ë°°ì¹˜ë„ê°€ ì—†ìŠµë‹ˆë‹¤.'; 
Â  Â  Â  console.warn('Layout for', dorm, floor, 'is undefined or null.'); 
Â  Â  Â  return;
Â  Â  }
Â  Â  // ê·¸ë¦¬ë“œ ì»¬ëŸ¼ ì„¤ì • (ë°˜ì‘í˜•: 1frë¡œ ìœ ì—°í•˜ê²Œ, minmaxë¡œ ìµœì†Œ í¬ê¸° ë³´ì¥)
Â  Â  const maxCols = Math.max(...layout.map(row => row.length));
Â  Â  seatMapContainer.style.gridTemplateColumns = `repeat(${maxCols}, 1fr)`;

Â  Â  const allowed = isReservationTimeAllowed().allowed;

Â  Â  layout.forEach(row => {
Â  Â  Â  row.forEach(seatNum => {
Â  Â  Â  Â  const btn = document.createElement('button');
Â  Â  Â  Â  btn.type = 'button';

Â  Â  Â  Â  if (seatNum === null) {
Â  Â  Â  Â  Â  btn.classList.add('seat-btn', 'empty');
Â  Â  Â  Â  Â  btn.textContent = '';
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  btn.classList.add('seat-btn');
Â  Â  Â  Â  Â  btn.textContent = seatNum;

Â  Â  Â  Â  Â  const booked = Object.values(allReservations).find(r => 
Â  Â  Â  Â  Â  Â  r.dormitory === dorm && 
Â  Â  Â  Â  Â  Â  r.floor === floor && 
Â  Â  Â  Â  Â  Â  r.seat === seatNum
Â  Â  Â  Â  Â  );
Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  if (booked) { 
Â  Â  Â  Â  Â  Â  btn.classList.add('booked');
Â  Â  Â  Â  Â  Â  btn.disabled = true; 

Â  Â  Â  Â  Â  Â  console.log(`--- Checking seat ${seatNum} ---`);
Â  Â  Â  Â  Â  Â  console.log(`Current User: roomNo='${currentUser ? currentUser.roomNo : 'N/A'}', name='${currentUser ? currentUser.name : 'N/A'}', floor='${currentUser ? currentUser.floor : 'N/A'}', seat='${currentUser ? currentUser.seat : 'N/A'}'`);
Â  Â  Â  Â  Â  Â  console.log(`Booked by: roomNo='${booked.roomNo}', name='${booked.name}', floor='${booked.floor}', seat='${booked.seat}'`);

Â  Â  Â  Â  Â  Â  if (currentUser && 
Â  Â  Â  Â  Â  Â  Â  Â  currentUser.roomNo === booked.roomNo && 
Â  Â  Â  Â  Â  Â  Â  Â  currentUser.name === booked.name) 
Â  Â  Â  Â  Â  Â  {
Â  Â  Â  Â  Â  Â  Â  console.log(`Match found: Seat ${seatNum} is current user's. Marking as 'mine'.`);
Â  Â  Â  Â  Â  Â  Â  btn.classList.add('mine');
Â  Â  Â  Â  Â  Â  Â  btn.disabled = false; 
Â  Â  Â  Â  Â  Â  Â  btn.title = `ë‚´ ì˜ˆì•½ (${booked.name}ë‹˜)`; 
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  console.log(`No match: Seat ${seatNum} is booked by another user.`);
Â  Â  Â  Â  Â  Â  Â  btn.title = `ì˜ˆì•½ëœ ì¢Œì„`; 
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  } else { 
Â  Â  Â  Â  Â  Â  btn.disabled = !allowed;
Â  Â  Â  Â  Â  Â  btn.title = allowed ? 'ì˜ˆì•½ ê°€ëŠ¥ ìë¦¬' : 'ì˜ˆì•½ ê°€ëŠ¥ ì‹œê°„ì´ ì•„ë‹™ë‹ˆë‹¤.';
Â  Â  Â  Â  Â  Â  btn.onclick = () => {
Â  Â  Â  Â  Â  Â  Â  if (allowed) { 
Â  Â  Â  Â  Â  Â  Â  Â  selectedSeat = seatNum;
Â  Â  Â  Â  Â  Â  Â  Â  if (confirmBtn) confirmBtn.disabled = false; 
Â  Â  Â  Â  Â  Â  Â  Â  highlightSelectedSeat();
Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  Â  if(seatMapContainer) seatMapContainer.appendChild(btn); 
Â  Â  Â  });
Â  Â  });
Â  Â  highlightSelectedSeat();
Â  }

Â  function highlightSelectedSeat() {
Â  Â  if(!seatMapContainer) return; 
Â  Â  seatMapContainer.querySelectorAll("button.seat-btn").forEach(btn => {
Â  Â  Â  btn.classList.remove('mine');

Â  Â  Â  if (parseInt(btn.textContent) === selectedSeat) {
Â  Â  Â  Â  Â  btn.classList.add('mine');
Â  Â  Â  } 
Â  Â  Â  else if (currentUser && 
Â  Â  Â  Â  Â  Â  Â  Â selectedDormTitle && currentUser.dormitory === selectedDormTitle.textContent && 
Â  Â  Â  Â  Â  Â  Â  Â selectedFloorTitle && currentUser.floor === selectedFloorTitle.textContent && 
Â  Â  Â  Â  Â  Â  Â  Â currentUser.seat === parseInt(btn.textContent)) {
Â  Â  Â  Â  Â  btn.classList.add('mine');
Â  Â  Â  }
Â  Â  });
Â  }


Â  function updateReservationAvailability() {
Â  Â  const status = isReservationTimeAllowed();
Â  Â  if(reservationAvailabilityMessage) reservationAvailabilityMessage.textContent = status.message; 

Â  Â  const currentAllowedState = status.allowed;
Â  Â  const hasAllowedStateChanged = (prevAllowedState !== null && prevAllowedState !== currentAllowedState);
Â  Â  prevAllowedState = currentAllowedState;

Â  Â  if (currentAllowedState) {
Â  Â  Â  if(reservationAvailabilityMessage) reservationAvailabilityMessage.classList.add("available"); 
Â  Â  Â  if(confirmBtn) confirmBtn.disabled = (selectedSeat === null); 
Â  Â  } else {
Â  Â  Â  if(reservationAvailabilityMessage) reservationAvailabilityMessage.classList.remove("available"); 
Â  Â  Â  if(confirmBtn) confirmBtn.disabled = true; 
Â  Â  }
Â  Â  
Â  Â  if (hasAllowedStateChanged && seatMapPage && !seatMapPage.classList.contains("hidden") && currentUser && currentFloor) { 
Â  Â  Â  Â  renderSeatMap(currentUser.dormitory, currentFloor); 
Â  Â  }
Â  }

Â  // --- ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ í•¨ìˆ˜ë“¤ (DOMContentLoaded ì™¸ë¶€ì—ì„œ ì •ì˜) ---
Â  // ì´ë ‡ê²Œ í•¨ìˆ˜ë“¤ì„ IIFEì˜ ìµœìƒìœ„ ìŠ¤ì½”í”„ì— ì •ì˜í•˜ë©´ DOMContentLoaded ì•ˆì˜ ì½”ë“œë“¤ì´ ì´ í•¨ìˆ˜ë“¤ì„ í•­ìƒ ì°¸ì¡°í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

Â  async function handleSubmitLoginForm(e) {
Â  Â  console.log('Login form submitted. Event triggered.');
Â  Â  e.preventDefault(); 

Â  Â  clearErrors(); 

Â  Â  const roomNo = roomNoInput.value.trim();
Â  Â  const name = userNameInput.value.trim();
Â  Â  const selectedDorm = dormitorySelect.value; 
Â  Â  const honeypotField = loginForm.querySelector('input[name="honeypot_field"]').value; 

Â  Â  console.log('Input values:', { roomNo, name, selectedDorm, honeypotField }); 

Â  Â  let valid = true; 
Â  Â  if (!roomNoPattern.test(roomNo)) {
Â  Â  Â  roomError.textContent = 'ë£¸ ë²ˆí˜¸ëŠ” 000í˜¸ í˜•ì‹ìœ¼ë¡œ ì…ë ¥í•˜ì„¸ìš”.';
Â  Â  Â  valid = false;
Â  Â  }
Â  Â  if (!koreanNamePattern.test(name)) {
Â  Â  Â  nameError.textContent = 'ì´ë¦„ì€ í•œê¸€ 2~4ìì—¬ì•¼ í•©ë‹ˆë‹¤.';
Â  Â  Â  valid = false;
Â  Â  }
Â  Â  if (!selectedDorm) { 
Â  Â  Â  dormError.textContent = 'ê¸°ìˆ™ì‚¬ë¥¼ ì„ íƒí•˜ì„¸ìš”.';
Â  Â  Â  valid = false;
Â  Â  }
Â  Â  if (honeypotField) { 
Â  Â  Â  Â  console.warn('ğŸ¯ Honeypot field filled on frontend. Likely a bot.');
Â  Â  Â  Â  valid = false; 
Â  Â  Â  Â  alert('ë¹„ì •ìƒì ì¸ ìš”ì²­ì´ ê°ì§€ë˜ì—ˆìŠµë‹ˆë‹¤. (Honeypot)');
Â  Â  }

Â  Â  if (!valid) {
Â  Â  Â  console.log('Login form validation failed. Not proceeding.');
Â  Â  Â  return; 
Â  Â  }
Â  Â  console.log('Login form validation passed. Proceeding with logic.');

Â  Â  const hasReservation = Object.values(allReservations).some(r => r.roomNo === roomNo && r.name === name);
Â  Â  console.log('User has existing reservation?', hasReservation);

Â  Â  if (hasReservation) {
Â  Â  Â  const existing = Object.values(allReservations).find(r => r.roomNo === roomNo && r.name === name);
Â  Â  Â  currentUser = {roomNo, name, dormitory: selectedDorm}; 
Â  Â  Â  currentFloor = existing.floor;
Â  Â  Â  selectedSeat = existing.seat;
Â  Â  Â  setFloorOptions(selectedDorm); 
Â  Â  Â  if (floorSelect) floorSelect.value = currentFloor; 
Â  Â  Â  if (welcomeText) welcomeText.textContent = `${name} (${selectedDorm} ê¸°ìˆ™ì‚¬)`; 
Â  Â  Â  if (selectedDormTitle) selectedDormTitle.textContent = selectedDorm; 
Â  Â  Â  if (selectedFloorTitle) selectedFloorTitle.textContent = currentFloor; 
Â  Â  Â  renderSeatMap(selectedDorm, currentFloor); 
Â  Â  Â  updateReservationAvailability();
Â  Â  Â  console.log('Existing user: Redirecting to seat map page.');
Â  Â  Â  showSection(seatMapPage);
Â  Â  } else {
Â  Â  Â  currentUser = {roomNo, name, dormitory: selectedDorm}; 
Â  Â  Â  setFloorOptions(selectedDorm); 
Â  Â  Â  if (welcomeText) welcomeText.textContent = `${name} (${selectedDorm} ê¸°ìˆ™ì‚¬)`; 
Â  Â  Â  console.log('New user: Redirecting to floor select page.');
Â  Â  Â  showSection(floorSelectPage);
Â  Â  }
Â  }

Â  function handleClickBackToLoginBtn() {
Â  Â  console.log('Back to Login button clicked.');
Â  Â  currentUser = null; currentFloor = null; selectedSeat = null; 
Â  Â  if (loginForm) loginForm.reset(); 
Â  Â  showSection(loginPage);
Â  }

Â  function handleClickFloorNextBtn() {
Â  Â  console.log('Floor Next button clicked.');
Â  Â  if (!floorSelect) { 
Â  Â  Â  console.error('Critical Error: floorSelect element is null in handleClickFloorNextBtn. Check HTML ID "floorSelect" and DOM loading.');
Â  Â  Â  alert('ì˜¤ë¥˜: ì¸µ ì„ íƒ ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•´ì£¼ì„¸ìš”.');
Â  Â  Â  return;
Â  Â  }
Â  Â  // â­ ì¤‘ìš”: floorSelect.value ì ‘ê·¼ ì‹œ undefinedê°€ ë˜ì§€ ì•Šë„ë¡ ë‹¤ì‹œ í•œë²ˆ ë°©ì–´ ì½”ë“œ ê°•í™” â­
Â  Â  if (floorSelect.value === null || floorSelect.value === undefined || floorSelect.value === '') { 
Â  Â  Â  alert('ì¸µì„ ì„ íƒí•˜ì„¸ìš”.');
Â  Â  Â  console.log('Floor not selected.');
Â  Â  Â  return;
Â  Â  }
Â  Â  const floor = floorSelect.value; 
Â  Â  
Â  Â  currentFloor = floor;
Â  Â  if (selectedDormTitle) selectedDormTitle.textContent = currentUser.dormitory; 
Â  Â  if (selectedFloorTitle) selectedFloorTitle.textContent = currentFloor; 
Â  Â  selectedSeat = null;
Â  Â  if (confirmBtn) confirmBtn.disabled = true; 
Â  Â  renderSeatMap(currentUser.dormitory, currentFloor);
Â  Â  updateReservationAvailability();
Â  Â  showSection(seatMapPage);
Â  }

Â  function handleClickCancelSeatBtn() {
Â  Â  console.log('Cancel Seat button clicked.');
Â  Â  selectedSeat = null;
Â  Â  if (confirmBtn) confirmBtn.disabled = true; 
Â  Â  showSection(floorSelectPage);
Â  }

Â  function handleClickAdminLoginBtn() {
Â  Â  console.log('Admin Login button clicked.');
Â  Â  if (adminLoginForm) adminLoginForm.reset(); 
Â  Â  if (adminError) adminError.textContent = ''; 
Â  Â  showSection(adminLoginPage);
Â  }

Â  function handleClickAdminLoginBackBtn() {
Â  Â  console.log('Admin Login Back button clicked.');
Â  Â  showSection(loginPage);
Â  }

Â  async function handleSubmitAdminLoginForm(e) {
Â  Â  console.log('Admin login form submitted. Event triggered.'); 
Â  Â  e.preventDefault();
Â  Â  const pw = adminPasswordInput.value.trim();

Â  Â  try {
Â  Â  Â  Â  console.log('Sending admin login request to backend...'); 
Â  Â  Â  Â  const response = await fetch(`${BACKEND_URL}/api/admin-login`, {
Â  Â  Â  Â  Â  Â  method: 'POST',
Â  Â  Â  Â  Â  Â  headers: { 'Content-Type': 'application/json' },
Â  Â  Â  Â  Â  Â  body: JSON.stringify({ password: pw })
Â  Â  Â  Â  });
Â  Â  Â  Â  const result = await response.json();
Â  Â  Â  Â  
Â  Â  Â  Â  console.log('Admin login response:', result); 
Â  Â  Â  Â  if (result.success) { 
Â  Â  Â  Â  Â  Â  console.log('Admin login successful. Redirecting to admin page.'); 
Â  Â  Â  Â  Â  Â  await loadAdminPage(); 
Â  Â  Â  Â  Â  Â  if (currentAnnouncement) {
Â  Â  Â  Â  Â  Â  Â  Â  if (announcementMessageInput) announcementMessageInput.value = currentAnnouncement.message; 
Â  Â  Â  Â  Â  Â  Â  Â  if (announcementActiveCheckbox) announcementActiveCheckbox.checked = currentAnnouncement.active; 
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  showSection(adminPage);
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  console.log('Admin login failed. Message:', result.message); 
Â  Â  Â  Â  Â  Â  if (adminError) adminError.textContent = result.message || 'ë¡œê·¸ì¸ ì‹¤íŒ¨: ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'; 
Â  Â  Â  Â  }
Â  Â  } catch (error) {
Â  Â  Â  Â  console.error('Admin login fetch error:', error); 
Â  Â  Â  Â  if (adminError) adminError.textContent = 'ë¡œê·¸ì¸ ìš”ì²­ ì¤‘ ì˜¤ë¥˜ ë°œìƒ. ì„œë²„ë¥¼ í™•ì¸í•˜ì„¸ìš”.'; 
Â  Â  }
Â  }

Â  function handleClickAdminLogoutBtn() {
Â  Â  showSection(loginPage);
Â  }

Â  async function handleSubmitConfirmBtn() {
Â  Â  if (!selectedSeat) {
Â  Â  Â  alert("ì¢Œì„ì„ ì„ íƒí•´ì£¼ì„¸ìš”.");
Â  Â  Â  return;
Â  Â  }
Â  Â  if (!isReservationTimeAllowed().allowed) {
Â  Â  Â  alert("ì˜ˆì•½ ê°€ëŠ¥ ì‹œê°„ì´ ì•„ë‹™ë‹ˆë‹¤.");
Â  Â  Â  updateReservationAvailability();
Â  Â  Â  return;
Â  Â  }

Â  Â  try {
Â  Â  Â  const reservationData = {
Â  Â  Â  Â  Â  roomNo: currentUser.roomNo,
Â  Â  Â  Â  Â  name: currentUser.name,
Â  Â  Â  Â  Â  dormitory: currentUser.dormitory,
Â  Â  Â  Â  Â  floor: currentFloor,
Â  Â  Â  Â  Â  seat: selectedSeat,
Â  Â  Â  Â  Â  honeypot_field: '' 
Â  Â  Â  };

Â  Â  Â  const response = await fetch(`${BACKEND_URL}/api/reservations`, {
Â  Â  Â  Â  method: "POST",
Â  Â  Â  Â  headers: { "Content-Type": "application/json" },
Â  Â  Â  Â  body: JSON.stringify(reservationData),
Â  Â  Â  });
Â  Â  Â  const result = await response.json();

Â  Â  Â  if (response.ok) { 
Â  Â  Â  Â  alert(`${result.newReservation.dormitory} ${result.newReservation.floor}ì¸µ ${result.newReservation.seat}ë²ˆ ìë¦¬ ì˜ˆì•½ ì™„ë£Œ!`);
Â  Â  Â  Â  
Â  Â  Â  Â  currentUser.dormitory = result.newReservation.dormitory;
Â  Â  Â  Â  currentUser.floor = result.newReservation.floor;
Â  Â  Â  Â  currentUser.seat = result.newReservation.seat;

Â  Â  Â  Â  selectedSeat = null; 
Â  Â  Â  Â  
Â  Â  Â  Â  renderSeatMap(currentUser.dormitory, currentUser.floor);
Â  Â  Â  Â  updateReservationAvailability();
Â  Â  Â  } else { 
Â  Â  Â  Â  alert("ì˜ˆì•½ ì‹¤íŒ¨: " + (result.message || "ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜"));
Â  Â  Â  Â  if (currentUser && currentFloor) {
Â  Â  Â  Â  Â  Â  await fetchAllReservations(); 
Â  Â  Â  Â  Â  Â  renderSeatMap(currentUser.dormitory, currentFloor);
Â  Â  Â  Â  }
Â  Â  Â  }
Â  Â  } catch (e) {
Â  Â  Â  alert("ì˜ˆì•½ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì„œë²„ ìƒíƒœë¥¼ í™•ì¸í•˜ì„¸ìš”.");
Â  Â  Â  console.error(e);
Â  Â  }
Â  }

Â  async function loadAdminPage() {
Â  Â  if(reservationListBody) reservationListBody.innerHTML = ""; 
Â  Â  let resArr = Object.values(allReservations);
Â  Â  
Â  Â  resArr.sort((a, b) => {
Â  Â  Â  Â  if (a.dormitory !== b.dormitory) {
Â  Â  Â  Â  Â  Â  return a.dormitory.localeCompare(b.dormitory);
Â  Â  Â  Â  }
Â  Â  Â  Â  const parseFloor = (f) => parseFloat(f.replace('-', '.'));
Â  Â  Â  Â  if (parseFloor(a.floor) !== parseFloor(b.floor)) {
Â  Â  Â  Â  Â  Â  return parseFloor(a.floor) - parseFloor(b.floor);
Â  Â  Â  Â  }
Â  Â  Â  Â  return a.seat - b.seat;
Â  Â  });

Â  Â  if (resArr.length === 0) {
Â  Â  Â  if(reservationListBody) reservationListBody.innerHTML = '<tr><td colspan="6">ë“±ë¡ëœ ì˜ˆì•½ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>'; 
Â  Â  Â  return;
Â  Â  }
Â  Â  resArr.forEach((resv) => {
Â  Â  Â  const tr = document.createElement("tr");
Â  Â  Â  tr.innerHTML = `
Â  Â  Â  Â  <td>${resv.name}</td>
Â  Â  Â  Â  <td>${resv.roomNo}</td>
Â  Â  Â  Â  <td>${resv.dormitory}</td>
Â  Â  Â  Â  <td>${resv.floor}</td>
Â  Â  Â  Â  <td>${resv.seat}</td>
Â  Â  Â  Â  <td><button type="button" class="cancel-btn" data-id="${resv._id}">ì·¨ì†Œ</button></td>`;
Â  Â  Â  if(reservationListBody) reservationListBody.appendChild(tr); 
Â  Â  });
Â  Â  if(reservationListBody) { 
Â  Â  Â  reservationListBody.querySelectorAll(".cancel-btn").forEach((btn) => {
Â  Â  Â  Â  btn.onclick = async () => {
Â  Â  Â  Â  Â  if (confirm("ì •ë§ ì˜ˆì•½ì„ ì·¨ì†Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
Â  Â  Â  Â  Â  Â  const id = btn.dataset.id;
Â  Â  Â  Â  Â  Â  const res = await fetch(`${BACKEND_URL}/api/reservations/${id}`, { method: "DELETE" });
Â  Â  Â  Â  Â  Â  if (res.ok) alert("ì˜ˆì•½ì´ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.");
Â  Â  Â  Â  Â  Â  else alert("ì˜ˆì•½ ì·¨ì†Œ ì‹¤íŒ¨");
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  };
Â  Â  Â  });
Â  Â  }

Â  Â  if (resStartTimeInput) resStartTimeInput.value = adminSettings.reservationStartTime ? new Date(adminSettings.reservationStartTime).toISOString().slice(0, 16) : ""; 
Â  Â  if (resEndTimeInput) resEndTimeInput.value = adminSettings.reservationEndTime ? new Date(adminSettings.reservationEndTime).toISOString().slice(0, 16) : ""; 
Â  Â  if (timeSettingMessage) timeSettingMessage.textContent = ""; 
Â  Â  
Â  Â  if (currentAnnouncement) {
Â  Â  Â  Â  if (announcementMessageInput) announcementMessageInput.value = currentAnnouncement.message; 
Â  Â  Â  Â  if (announcementActiveCheckbox) announcementActiveCheckbox.checked = currentAnnouncement.active; 
Â  Â  Â  Â  if (announcementMessageStatus) announcementMessageStatus.textContent = ''; 
Â  Â  }
Â  }

Â  async function handleClickClearAllReservationsBtn() {
Â  Â  Â  if (!confirm('ì •ë§ ëª¨ë“  ì˜ˆì•½ì„ ì·¨ì†Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤!')) {
Â  Â  Â  Â  Â  return;
Â  Â  Â  }
Â  Â  Â  try {
Â  Â  Â  Â  Â  const response = await fetch(`${BACKEND_URL}/api/reservations/all`, {
Â  Â  Â  Â  Â  Â  Â  method: 'DELETE'
Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  if (response.ok) {
Â  Â  Â  Â  Â  Â  Â  alert('ëª¨ë“  ì˜ˆì•½ì´ ì„±ê³µì ìœ¼ë¡œ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.');
Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  const errorResult = await response.json();
Â  Â  Â  Â  Â  Â  Â  alert(`ëª¨ë“  ì˜ˆì•½ ì·¨ì†Œ ì‹¤íŒ¨: ${errorResult.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'}`);
Â  Â  Â  Â  Â  }
Â  Â  Â  } catch (e) {
Â  Â  Â  Â  Â  console.error('ëª¨ë“  ì˜ˆì•½ ì·¨ì†Œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:', e);
Â  Â  Â  Â  Â  alert('ëª¨ë“  ì˜ˆì•½ ì·¨ì†Œ ì¤‘ í†µì‹  ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë°±ì—”ë“œ ì„œë²„ë¥¼ í™•ì¸í•˜ì„¸ìš”.');
Â  Â  Â  }
Â  }

Â  async function handleSubmitReservationTimeForm(e) {
Â  Â  e.preventDefault();

Â  Â  if (!resStartTimeInput.value || !resEndTimeInput.value) {
Â  Â  Â  if (timeSettingMessage) { 
Â  Â  Â  Â  Â  timeSettingMessage.textContent = "ì‹œì‘ê³¼ ì¢…ë£Œ ì‹œê°„ì„ ëª¨ë‘ ì…ë ¥í•˜ì„¸ìš”.";
Â  Â  Â  Â  Â  timeSettingMessage.style.color = "red";
Â  Â  Â  }
Â  Â  Â  return;
Â  Â  }

Â  Â  if (new Date(resEndTimeInput.value) <= new Date(resStartTimeInput.value)) {
Â  Â  Â  if (timeSettingMessage) { 
Â  Â  Â  Â  Â  timeSettingMessage.textContent = "ì¢…ë£Œ ì‹œê°„ì€ ì‹œì‘ ì‹œê°„ë³´ë‹¤ ëŠ¦ì–´ì•¼ í•©ë‹ˆë‹¤.";
Â  Â  Â  Â  Â  timeSettingMessage.style.color = "red";
Â  Â  Â  }
Â  Â  Â  return;
Â  Â  }

Â  Â  try {
Â  Â  Â  const res = await fetch(`${BACKEND_URL}/api/admin-settings`, {
Â  Â  Â  Â  method: "PUT",
Â  Â  Â  Â  headers: { "Content-Type": "application/json" },
Â  Â  Â  Â  body: JSON.stringify({
Â  Â  Â  Â  Â  reservationStartTime: new Date(resStartTimeInput.value).toISOString(),
Â  Â  Â  Â  Â  reservationEndTime: new Date(resEndTimeInput.value).toISOString(),
Â  Â  Â  Â  }),
Â  Â  Â  });

Â  Â  Â  if (res.ok) {
Â  Â  Â  Â  if (timeSettingMessage) { 
Â  Â  Â  Â  Â  Â  timeSettingMessage.textContent = "ì˜ˆì•½ ê°€ëŠ¥ ì‹œê°„ì´ ì„¤ì •ë˜ì—ˆìŠµë‹ˆë‹¤.";
Â  Â  Â  Â  Â  Â  timeSettingMessage.style.color = "green";
Â  Â  Â  Â  }
Â  Â  Â  Â  await loadAdminPage(); 
Â  Â  Â  } else {
Â  Â  Â  Â  if (timeSettingMessage) { 
Â  Â  Â  Â  Â  Â  timeSettingMessage.textContent = "ì„¤ì • ì‹¤íŒ¨";
Â  Â  Â  Â  Â  Â  timeSettingMessage.style.color = "red";
Â  Â  Â  Â  }
Â  Â  Â  }
Â  Â  } catch (e) {
Â  Â  Â  console.error(e);
Â  Â  Â  if (timeSettingMessage) { 
Â  Â  Â  Â  Â  timeSettingMessage.textContent = "ì„œë²„ ì˜¤ë¥˜ ë°œìƒ";
Â  Â  Â  Â  Â  timeSettingMessage.style.color = "red";
Â  Â  Â  }
Â  Â  }
Â  }

Â  async function handleSubmitAnnouncementForm(e) {
Â  Â  Â  e.preventDefault();
Â  Â  Â  const message = announcementMessageInput.value.trim();
Â  Â  Â  const active = announcementActiveCheckbox.checked;

Â  Â  Â  if (!message && active) {
Â  Â  Â  Â  Â  if (announcementMessageStatus) { 
Â  Â  Â  Â  Â  Â  Â  announcementMessageStatus.textContent = 'í™œì„±í™”í•˜ë ¤ë©´ ê³µì§€ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”.';
Â  Â  Â  Â  Â  Â  Â  announcementMessageStatus.style.color = 'red';
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  return;
Â  Â  Â  }
Â  Â  Â  if (!message && !active) { 
Â  Â  Â  Â  Â  if (announcementMessageStatus) { 
Â  Â  Â  Â  Â  Â  Â  announcementMessageStatus.textContent = 'ê³µì§€ ë¹„í™œì„±í™” ë° ë‚´ìš© ì‚­ì œ ì™„ë£Œ.';
Â  Â  Â  Â  Â  Â  Â  announcementMessageStatus.style.color = "green";
Â  Â  Â  Â  Â  }
Â  Â  Â  }

Â  Â  Â  try {
Â  Â  Â  Â  Â  const response = await fetch(`${BACKEND_URL}/api/announcement`, {
Â  Â  Â  Â  Â  Â  Â  method: 'PUT',
Â  Â  Â  Â  Â  Â  Â  headers: { "Content-Type": "application/json" },
Â  Â  Â  Â  Â  Â  Â  body: JSON.stringify({ message, active })
Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  if (response.ok) {
Â  Â  Â  Â  Â  Â  Â  if (announcementMessageStatus) { 
Â  Â  Â  Â  Â  Â  Â  Â  Â  announcementMessageStatus.textContent = active ? 'ê³µì§€ì‚¬í•­ì´ ì €ì¥ë˜ê³  í™œì„±í™”ë˜ì—ˆìŠµë‹ˆë‹¤.' : 'ê³µì§€ì‚¬í•­ì´ ì €ì¥ë˜ê³  ë¹„í™œì„±í™”ë˜ì—ˆìŠµë‹ˆë‹¤.';
Â  Â  Â  Â  Â  Â  Â  Â  Â  announcementMessageStatus.style.color = "green";
Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  if (announcementMessageStatus) { 
Â  Â  Â  Â  Â  Â  Â  Â  Â  announcementMessageStatus.textContent = 'ê³µì§€ ì €ì¥ ì‹¤íŒ¨';
Â  Â  Â  Â  Â  Â  Â  Â  Â  announcementMessageStatus.style.color = "red";
Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  }
Â  Â  Â  } catch (e) {
Â  Â  Â  Â  Â  console.error('ê³µì§€ ì €ì¥ ì¤‘ ì˜¤ë¥˜:', e);
Â  Â  Â  Â  Â  if (announcementMessageStatus) { 
Â  Â  Â  Â  Â  Â  Â  announcementMessageStatus.textContent = 'ê³µì§€ ì €ì¥ ì¤‘ ì„œë²„ ì˜¤ë¥˜ ë°œìƒ';
Â  Â  Â  Â  Â  Â  Â  announcementMessageStatus.style.color = "red";
Â  Â  Â  Â  Â  }
Â  Â  Â  }
Â  }

Â  function showAnnouncement(message) {
Â  Â  Â  console.log("showAnnouncement called with message:", message); 
Â  Â  Â  if (announcementOverlay && announcementPopupMessage) {
Â  Â  Â  Â  Â  announcementPopupMessage.textContent = message; 
Â  Â  Â  Â  Â  announcementOverlay.classList.remove('hidden');
Â  Â  Â  } else {
Â  Â  Â  Â  Â  console.error("ê³µì§€ íŒì—… ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
Â  Â  Â  }
Â  }

Â  function hideAnnouncement() {
Â  Â  Â  console.log("hideAnnouncement called."); 
Â  Â  Â  if (announcementOverlay) {
Â  Â  Â  Â  Â  announcementOverlay.classList.add('hidden');
Â  Â  Â  } else {
Â  Â  Â  Â  Â  console.error("announcementOverlay not found during hideAnnouncement.");
Â  Â  Â  }
Â  }


Â  // --- ì´ˆê¸° ë°ì´í„° ë¡œë“œ ë° í˜ì´ì§€ í‘œì‹œ ---
Â  document.addEventListener('DOMContentLoaded', async () => {
Â  Â  Â  console.log('DOM Content Loaded. Script execution starts.');
Â  Â  Â  
Â  Â  Â  // â­â­ ëª¨ë“  DOM ìš”ì†Œ ì°¸ì¡°ë¥¼ DOMContentLoaded ì•ˆì—ì„œ ìˆ˜í–‰ â­â­
Â  Â  Â  // ì´ ë³€ìˆ˜ë“¤ì€ DOMì´ ì™„ì „íˆ ë¡œë“œëœ í›„ì— í• ë‹¹ë©ë‹ˆë‹¤.
Â  Â  Â  loginPage = document.getElementById('loginPage');
Â  Â  Â  loginForm = document.getElementById('loginForm');
Â  Â  Â  roomNoInput = document.getElementById('roomNo');
Â  Â  Â  userNameInput = document.getElementById('userName');
Â  Â  Â  dormitorySelect = document.getElementById('dormitory');
Â  Â  Â  roomError = document.getElementById('roomError');
Â  Â  Â  nameError = document.getElementById('nameError');
Â  Â  Â  dormError = document.getElementById('dormError');
Â  Â  Â  adminLoginBtn = document.getElementById('adminLoginBtn');

Â  Â  Â  floorSelectPage = document.getElementById('floorSelectPage');
Â  Â  Â  floorSelect = document.getElementById('floorSelect');
Â  Â  Â  floorNextBtn = document.getElementById('floorNextBtn');
Â  Â  Â  backToLoginBtn = document.getElementById('backToLoginBtn');
Â  Â  Â  welcomeText = document.getElementById('welcomeText'); 

Â  Â  Â  seatMapPage = document.getElementById('seatMapPage');
Â  Â  Â  seatMapContainer = document.getElementById('seatMap');
Â  Â  Â  confirmBtn = document.getElementById('confirmBtn');
Â  Â  Â  cancelSeatBtn = document.getElementById('cancelSeatBtn');
Â  Â  Â  selectedDormTitle = document.getElementById('selectedDorm');
Â  Â  Â  selectedFloorTitle = document.getElementById('selectedFloor');
Â  Â  Â  reservationAvailabilityMessage = document.getElementById('reservationAvailabilityMessage');

Â  Â  Â  adminLoginPage = document.getElementById('adminLoginPage');
Â  Â  Â  adminLoginForm = document.getElementById('adminLoginForm');
Â  Â  Â  adminPasswordInput = document.getElementById('adminPassword');
Â  Â  Â  adminError = document.getElementById('adminError');

Â  Â  Â  adminPage = document.getElementById('adminPage');
Â  Â  Â  adminLogoutBtn = document.getElementById('adminLogoutBtn');
Â  Â  Â  reservationListBody = document.getElementById('reservationListBody');
Â  Â  Â  clearAllReservationsBtn = document.getElementById('clearAllReservationsBtn');

Â  Â  Â  reservationTimeForm = document.getElementById('reservationTimeForm');
Â  Â  Â  resStartTimeInput = document.getElementById('resStartTime');
Â  Â  Â  resEndTimeInput = document.getElementById('resEndTime');
Â  Â  Â  timeSettingMessage = document.getElementById('timeSettingMessage');

Â  Â  Â  announcementOverlay = document.getElementById('announcementOverlay');
Â  Â  Â  announcementPopupMessage = document.getElementById('announcementMessage');
Â  Â  Â  announcementCloseBtn = announcementOverlay ? announcementOverlay.querySelector('.close-btn') : null; 
Â  Â  Â  announcementForm = document.getElementById('announcementForm');
Â  Â  Â  announcementMessageInput = document.getElementById('announcementMessageInput');
Â  Â  Â  announcementActiveCheckbox = document.getElementById('announcementActiveCheckbox');
Â  Â  Â  announcementMessageStatus = document.getElementById('announcementMessageStatus');
Â  Â  Â  // â­â­â­ DOM ìš”ì†Œ ì°¸ì¡° ë â­â­â­

Â  Â  Â  // DOM ìš”ì†Œ ì°¸ì¡° ê²€ì‚¬ ë¡œê·¸ (ëª¨ë“  ìš”ì†Œê°€ 'found.'ë¡œ ë‚˜ì™€ì•¼ í•©ë‹ˆë‹¤!)
Â  Â  Â  console.log('--- DOM Element Checks ---');
Â  Â  Â  console.log('loginPage:', loginPage);
Â  Â  Â  console.log('loginForm:', loginForm);
Â  Â  Â  console.log('roomNoInput:', roomNoInput);
Â  Â  Â  console.log('userNameInput:', userNameInput);
Â  Â  Â  console.log('dormitorySelect:', dormitorySelect);
Â  Â  Â  console.log('roomError:', roomError);
Â  Â  Â  console.log('nameError:', nameError);
Â  Â  Â  console.log('dormError:', dormError);
Â  Â  Â  console.log('adminLoginBtn:', adminLoginBtn);
Â  Â  Â  console.log('floorSelectPage:', floorSelectPage);
Â  Â  Â  console.log('floorSelect:', floorSelect); // <<< ì—¬ê¸°ì„œ floorSelectì˜ ê°’ì´ ì¤‘ìš”í•©ë‹ˆë‹¤!
Â  Â  Â  console.log('floorNextBtn:', floorNextBtn);
Â  Â  Â  console.log('backToLoginBtn:', backToLoginBtn);
Â  Â  Â  console.log('welcomeText:', welcomeText);
Â  Â  Â  console.log('seatMapPage:', seatMapPage);
Â  Â  Â  console.log('seatMapContainer:', seatMapContainer);
Â  Â  Â  console.log('confirmBtn:', confirmBtn);
Â  Â  Â  console.log('cancelSeatBtn:', cancelSeatBtn);
Â  Â  Â  console.log('selectedDormTitle:', selectedDormTitle);
Â  Â  Â  console.log('selectedFloorTitle:', selectedFloorTitle);
Â  Â  Â  console.log('reservationAvailabilityMessage:', reservationAvailabilityMessage);
Â  Â  Â  console.log('adminLoginPage:', adminLoginPage);
Â  Â  Â  console.log('adminLoginForm:', adminLoginForm);
Â  Â  Â  console.log('adminPasswordInput:', adminPasswordInput);
Â  Â  Â  console.log('adminError:', adminError);
Â  Â  Â  console.log('adminPage:', adminPage);
Â  Â  Â  console.log('adminLogoutBtn:', adminLogoutBtn);
Â  Â  Â  console.log('reservationListBody:', reservationListBody);
Â  Â  Â  console.log('clearAllReservationsBtn:', clearAllReservationsBtn);
Â  Â  Â  console.log('announcementOverlay:', announcementOverlay);
Â  Â  Â  console.log('announcementPopupMessage:', announcementPopupMessage);
Â  Â  Â  console.log('announcementCloseBtn:', announcementCloseBtn);
Â  Â  Â  console.log('announcementForm:', announcementForm);
Â  Â  Â  console.log('announcementMessageInput:', announcementMessageInput);
Â  Â  Â  console.log('announcementActiveCheckbox:', announcementActiveCheckbox);
Â  Â  Â  console.log('announcementMessageStatus:', announcementMessageStatus);
Â  Â  Â  console.log('reservationTimeForm:', reservationTimeForm);
Â  Â  Â  console.log('resStartTimeInput:', resStartTimeInput);
Â  Â  Â  console.log('resEndTimeInput:', resEndTimeInput);
Â  Â  Â  console.log('timeSettingMessage:', timeSettingMessage);
Â  Â  Â  console.log('--- End DOM Element Checks ---');

Â  Â  Â  // Socket.IO í´ë¼ì´ì–¸íŠ¸ ì´ˆê¸°í™”
Â  Â  Â  try {
Â  Â  Â  Â  Â  // Socket.IO í´ë¼ì´ì–¸íŠ¸ ë¼ì´ë¸ŒëŸ¬ë¦¬(io ê°ì²´)ê°€ ë¡œë“œëœ í›„ì—ë§Œ í˜¸ì¶œ
Â  Â  Â  Â  Â  if (typeof io !== 'undefined') {
Â  Â  Â  Â  Â  Â  Â  socket = io(BACKEND_URL); // Socket.IO ì—°ê²°
Â  Â  Â  Â  Â  Â  Â  setupSocketListeners(); // Socket.IO ë¦¬ìŠ¤ë„ˆ ì„¤ì •
Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  console.error("Critical Error: Socket.IO library (io object) is not available. Check script src.");
Â  Â  Â  Â  Â  Â  Â  alert("ì˜¤ë¥˜: Socket.IO ë¼ì´ë¸ŒëŸ¬ë¦¬ê°€ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•´ì£¼ì„¸ìš”.");
Â  Â  Â  Â  Â  Â  Â  return; // Socket.IO ì—†ìœ¼ë©´ ì´í›„ ë¡œì§ ì§„í–‰ ì˜ë¯¸ ì—†ìŒ
Â  Â  Â  Â  Â  }
Â  Â  Â  } catch (e) {
Â  Â  Â  Â  Â  console.error("Error during Socket.IO initialization or listener setup:", e);
Â  Â  Â  Â  Â  alert("ì›¹ì‚¬ì´íŠ¸ ì´ˆê¸°í™” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ê°œë°œì ì½˜ì†”ì„ í™•ì¸í•´ì£¼ì„¸ìš”.");
Â  Â  Â  Â  Â  return; // Socket.IO ì—°ê²° ì˜¤ë¥˜ ì‹œ ë‹¤ë¥¸ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë¶™ì´ëŠ” ê²ƒ ì¤‘ë‹¨
Â  Â  Â  }


Â  Â  Â  // â­â­â­ ëª¨ë“  ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡ â­â­â­
Â  Â  Â  // ì´ì œ DOMContentLoaded ì•ˆì—ì„œ ëª¨ë“  ìš”ì†Œê°€ í• ë‹¹ë˜ì—ˆìœ¼ë¯€ë¡œ, ì•ˆì „í•˜ê²Œ ë¦¬ìŠ¤ë„ˆ ë“±ë¡ ê°€ëŠ¥
Â  Â  Â  // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆì˜ ì½œë°± í•¨ìˆ˜ëŠ” ìµœìƒìœ„ ìŠ¤ì½”í”„ì— ì •ì˜ëœ í•¨ìˆ˜ë¥¼ ì°¸ì¡°í•©ë‹ˆë‹¤.
Â  Â  Â  try {
Â  Â  Â  Â  Â  if (loginForm) {
Â  Â  Â  Â  Â  Â  Â  console.log('Attaching event listener to loginForm.');
Â  Â  Â  Â  Â  Â  Â  loginForm.addEventListener('submit', handleSubmitLoginForm); 
Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  console.error("Critical Error: loginForm element not found. Login will not work. Please check HTML IDs.");
Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  if (backToLoginBtn) backToLoginBtn.addEventListener('click', handleClickBackToLoginBtn); 
Â  Â  Â  Â  Â  if (floorNextBtn) floorNextBtn.addEventListener('click', handleClickFloorNextBtn); 
Â  Â  Â  Â  Â  if (cancelSeatBtn) cancelSeatBtn.addEventListener('click', handleClickCancelSeatBtn); 
Â  Â  Â  Â  Â  if (adminLoginBtn) adminLoginBtn.addEventListener('click', handleClickAdminLoginBtn); 
Â  Â  Â  Â  Â  if (document.getElementById('adminLoginBackBtn')) document.getElementById('adminLoginBackBtn').addEventListener('click', handleClickAdminLoginBackBtn); 
Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  if (adminLoginForm) { 
Â  Â  Â  Â  Â  Â  Â  adminLoginForm.addEventListener('submit', handleSubmitAdminLoginForm); 
Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  console.error("Critical Error: adminLoginForm element not found. Admin login will not work. Please check HTML IDs.");
Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  if (adminLogoutBtn) adminLogoutBtn.addEventListener('click', handleClickAdminLogoutBtn); 
Â  Â  Â  Â  Â  if (clearAllReservationsBtn) clearAllReservationsBtn.addEventListener('click', handleClickClearAllReservationsBtn); 

Â  Â  Â  Â  Â  if (confirmBtn) confirmBtn.addEventListener("click", handleSubmitConfirmBtn); 

Â  Â  Â  Â  Â  if (reservationTimeForm) { 
Â  Â  Â  Â  Â  Â  Â  reservationTimeForm.addEventListener("submit", handleSubmitReservationTimeForm); 
Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  if (announcementForm) { 
Â  Â  Â  Â  Â  Â  Â  announcementForm.addEventListener('submit', handleSubmitAnnouncementForm); 
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  if (announcementCloseBtn) { 
Â  Â  Â  Â  Â  Â  Â  announcementCloseBtn.addEventListener('click', hideAnnouncement);
Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  console.error("Error: announcementCloseBtn element not found. Close button might not work.");
Â  Â  Â  Â  Â  }
Â  Â  Â  } catch (e) {
Â  Â  Â  Â  Â  console.error("Error attaching event listeners:", e);
Â  Â  Â  Â  Â  alert("ì›¹ì‚¬ì´íŠ¸ ì´ˆê¸°í™” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ê°œë°œì ì½˜ì†”ì„ í™•ì¸í•´ì£¼ì„¸ìš”.");
Â  Â  Â  }

Â  Â  Â  // --- ì´ˆê¸° ë°ì´í„° ë¡œë“œ ë° í˜ì´ì§€ í‘œì‹œ ---
Â  Â  Â  console.log('All event listeners attached. Starting initial fetches.');
Â  Â  Â  await fetchAllReservations();
Â  Â  Â  await fetchAdminSettings();
Â  Â  Â  await fetchAnnouncement(); 
Â  Â  Â  console.log('Initial fetches completed. Showing login page.');
Â  Â  Â  showSection(loginPage);
Â  });
})();
</script>