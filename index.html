<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
<title>ëœì„ ì„ ì˜ˆì•½ ì‹œìŠ¤í…œ</title>
<style>
  /* ë°˜ì‘í˜• ë° ëª¨ë°”ì¼ ìµœì í™” */
  body {
    font-family: 'Malgun Gothic', Arial, sans-serif;
    margin: 0; padding: 10px 0; /* ìƒí•˜ ì—¬ë°± ì¶”ê°€ */
    background: #fafafc;
    color: #2c3e50;
  }
  h1, h2 {
    text-align: center;
    margin: 1em 0;
    color: #334155;
  }
  .container {
    max-width: 960px; /* ìµœëŒ€ ë„ˆë¹„ ì¦ê°€ */
    margin: 10px auto 40px;
    background: white;
    padding: 15px 20px; /* ë‚´ë¶€ ì—¬ë°± ì¡°ì • */
    border-radius: 12px;
    box-shadow: 0 0 20px rgba(0,0,0,0.06);
  }
  .hidden { display: none; }

  form {
    max-width: 400px;
    margin: 0 auto;
  }
  label {
    font-weight: 700;
    margin-top: 12px; /* ì—¬ë°± ì¡°ì • */
    display: block;
    color: #475569;
  }
  input[type=text], input[type=password], input[type=datetime-local], select {
    width: 100%;
    padding: 10px 12px;
    margin-top: 6px;
    font-size: 1rem;
    border: 2px solid #cbd5e1;
    border-radius: 8px;
    box-sizing: border-box;
    transition: border-color 0.3s; /* íŠ¸ëœì§€ì…˜ ë‹¨ì¶• */
  }
  input[type=text]:focus, input[type=password]:focus, input[type=datetime-local]:focus, select:focus {
    border-color: #fbbf24;
    outline: none;
  }
  .error {
    color: #dc2626;
    font-size: 0.9rem; /* rem ë‹¨ìœ„ ì‚¬ìš© */
    height: 20px;
    margin-top: 4px;
  }
  button {
    background-color: #fbbf24;
    border: none;
    border-radius: 8px;
    padding: 12px 25px;
    font-size: 1.1rem;
    font-weight: 700;
    color: #92400e;
    cursor: pointer;
    margin-top: 20px; /* ì—¬ë°± ì¡°ì • */
    box-shadow: 1px 3px 6px rgba(251,191,36,0.5);
    transition: background-color 0.3s; /* íŠ¸ëœì§€ì…˜ ë‹¨ì¶• */
    display: inline-block;
    min-width: 120px; /* ìµœì†Œ ë„ˆë¹„ */
  }
  button:hover:not(:disabled) {
    background-color: #f59e0b;
  }
  button:disabled {
    background-color: #fde68a;
    cursor: not-allowed;
  }
  nav {
    text-align: center;
    margin-top: 20px;
  }
  nav button {
    background: transparent;
    color: #b45309;
    font-weight: 600;
    padding: 8px 16px;
    border: 2px solid #fbbf24;
    border-radius: 8px;
    cursor: pointer;
    transition: background-color 0.3s;
  }
  nav button:hover {
    background-color: #fbbf24;
    color: #92400e;
  }

  /* ì¢Œì„ ë°°ì¹˜ë„ */
  #seatMap {
    margin: 20px auto 40px;
    display: grid;
    gap: 8px;
    justify-content: center;
    width: 100%; /* ë„ˆë¹„ë¥¼ 100%ë¡œ ì„¤ì • */
    max-width: 100%;
  }
  .seat-btn {
    background: #fef3c7;
    border: 2px solid #fbbf24;
    border-radius: 6px;
    font-weight: 700;
    color: #92400e;
    cursor: pointer;
    user-select: none;
    display: flex;
    justify-content: center;
    align-items: center;
    font-size: 1.1rem;
    min-width: 36px; /* ìµœì†Œ ë„ˆë¹„ ì¤„ì„ */
    aspect-ratio: 1/1; /* 1:1 ë¹„ìœ¨ ìœ ì§€ */
    transition: background-color 0.3s, border-color 0.3s;
  }
  .seat-btn:hover:not(.booked) {
    background-color: #fde68a;
    border-color: #fbbf24;
  }
  .seat-btn.booked {
    background: #d1d5db;
    color: #6b7280;
    cursor: not-allowed;
  }
  .seat-btn.mine {
    background: #fef08a;
    border-color: #ca8a04;
    font-weight: 800;
  }
  .seat-btn.empty {
    visibility: hidden;
    pointer-events: none;
  }

  /* ê´€ë¦¬ì ì˜ˆì•½ í˜„í™© í…Œì´ë¸” */
  table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 15px;
    font-size: 1rem;
  }
  th, td {
    border: 1px solid #cbd5e1;
    padding: 10px 12px;
    text-align: center;
  }
  th {
    background-color: #fbbf24;
    color: #92400e;
  }
  td button {
    background: #ef4444;
    color: white;
    border: none;
    border-radius: 6px; /* ë‘¥ê·¼ ì •ë„ ì¡°ì • */
    padding: 6px 12px;
    font-weight: 600;
    cursor: pointer;
    transition: background-color 0.3s;
  }
  td button:hover {
    background: #b91c1c;
  }

  /* ì˜ˆì•½ ì•ˆë‚´ ë©”ì‹œì§€ */
  #reservationAvailabilityMessage {
    margin-top: 10px; /* ì—¬ë°± ì¡°ì • */
    font-weight: 700;
    padding: 0.5em;
    border-radius: 5px;
    text-align: center;
    color: #ef4444;
    background-color: #fee2e2;
  }
  #reservationAvailabilityMessage.available {
    color: #10b981;
    background-color: #d1fae5;
  }

  #timeSettingMessage {
    margin-top: 12px;
    text-align: center;
    font-size: 0.9rem;
    min-height: 1.5em;
  }

  /* ë°˜ì‘í˜• */
  @media (max-width: 768px) {
    .container {
      margin: 10px auto 30px;
      padding: 15px;
    }
    .seat-btn {
      font-size: 1rem;
    }
  }

  @media (max-width: 480px) {
    body { padding: 5px; }
    .container {
      margin: 5px auto 20px;
      padding: 10px;
      border-radius: 8px;
    }
    h1, h2 { font-size: 1.4rem; margin: 0.8em 0; }
    label, input, select { font-size: 0.9rem; }
    button { padding: 10px 15px; font-size: 1rem; margin-top: 15px; min-width: auto; }
    nav button { padding: 6px 10px; font-size: 0.9rem; }
    
    #seatMap {
      gap: 5px; /* ê°„ê²© ì¡°ì • */
      /* ë³µì¡í•œ ê·¸ë¦¬ë“œ ëŒ€ì‹  auto-fitìœ¼ë¡œ ìœ ë™ì ìœ¼ë¡œ */
      grid-template-columns: repeat(auto-fit, minmax(28px, 1fr)); 
      max-width: 100%;
    }
    .seat-btn {
      min-width: 28px;
      font-size: 0.9rem;
      padding: 0; /* íŒ¨ë”© ì œê±°ë¡œ í¬ê¸° ì¡°ì ˆ */
    }
    table { font-size: 0.85rem; }
    th, td { padding: 8px 5px; }
    td button { padding: 4px 8px; font-size: 0.8rem; }
  }
</style>
</head>
<body>

<!-- ë¡œê·¸ì¸ í˜ì´ì§€ -->
<div class="container" id="loginPage">
  <h1>ëœì„ ì„ ì˜ˆì•½ ë¡œê·¸ì¸</h1>
  <form id="loginForm" autocomplete="off" novalidate>
    <label for="roomNo">ë£¸ ë²ˆí˜¸ (000í˜¸ í˜•ì‹)</label>
    <input type="text" id="roomNo" name="roomNo" placeholder="101í˜¸" required />
    <div id="roomError" class="error"></div>

    <label for="userName">ì´ë¦„ (í•œê¸€ 2~4ì)</label>
    <input type="text" id="userName" name="userName" placeholder="í™ê¸¸ë™" required />
    <div id="nameError" class="error"></div>

    <label for="dormitory">ê¸°ìˆ™ì‚¬ ì„ íƒ</label>
    <select id="dormitory" name="dormitory" required>
      <option value="" disabled selected>ì„ íƒí•˜ì„¸ìš”</option>
      <option value="ê¿ˆë™">ê¿ˆë™</option>
      <option value="ë¯¸ë˜ë™">ë¯¸ë˜ë™</option>
    </select>
    <div id="dormError" class="error"></div>

    <button type="submit">ë‹¤ìŒ</button>
  </form>
  <nav>
    <button id="adminLoginBtn" type="button">ê´€ë¦¬ì ë¡œê·¸ì¸</button>
  </nav>
</div>

<!-- ì¸µ ì„ íƒ í˜ì´ì§€ -->
<div class="container hidden" id="floorSelectPage">
  <h2><span id="welcomeText"></span>ë‹˜, ì¸µì„ ì„ íƒí•´ì£¼ì„¸ìš”</h2>
  <select id="floorSelect" required>
    <option value="" disabled selected>ì¸µ ì„ íƒ</option>
  </select>
  <button id="floorNextBtn" type="button">ì¢Œì„ ì„ íƒìœ¼ë¡œ</button>
  <button id="backToLoginBtn" type="button">ë’¤ë¡œê°€ê¸°</button>
</div>

<!-- ì¢Œì„ ì„ íƒ í˜ì´ì§€ -->
<div class="container hidden" id="seatMapPage">
  <h2>ì¢Œì„ ë°°ì¹˜ë„ - <span id="selectedDorm"></span> <span id="selectedFloor"></span>ì¸µ</h2>
  <div id="seatMap"></div>
  <div id="reservationAvailabilityMessage"></div>
  <button id="confirmBtn" type="button" disabled>ì˜ˆì•½ í™•ì •</button>
  <button id="cancelSeatBtn" type="button">ì·¨ì†Œ ë° ë’¤ë¡œê°€ê¸°</button>
</div>

<!-- ê´€ë¦¬ì ë¡œê·¸ì¸ í˜ì´ì§€ -->
<div class="container hidden" id="adminLoginPage">
  <h1>ê´€ë¦¬ì ë¡œê·¸ì¸</h1>
  <form id="adminLoginForm" autocomplete="off" novalidate>
    <label for="adminPassword">ë¹„ë°€ë²ˆí˜¸</label>
    <input type="password" id="adminPassword" name="adminPassword" required />
    <div id="adminError" class="error"></div>
    <button type="submit">ë¡œê·¸ì¸</button>
  </form>
  <button id="adminLoginBackBtn" type="button">ë¡œê·¸ì¸í˜ì´ì§€ë¡œ ëŒì•„ê°€ê¸°</button>
</div>

<!-- ê´€ë¦¬ì í˜ì´ì§€ -->
<div class="container hidden" id="adminPage">
  <h1>ê´€ë¦¬ì í˜ì´ì§€</h1>
  <button id="adminLogoutBtn" type="button">ë¡œê·¸ì•„ì›ƒ</button>

  <h2>ì˜ˆì•½ ê°€ëŠ¥ ì‹œê°„ ì„¤ì •</h2>
  <form id="reservationTimeForm" novalidate>
    <label for="resStartTime">ì˜ˆì•½ ì‹œì‘ ì‹œê°„:</label>
    <input type="datetime-local" id="resStartTime" required />
    <label for="resEndTime">ì˜ˆì•½ ì¢…ë£Œ ì‹œê°„:</label>
    <input type="datetime-local" id="resEndTime" required />
    <button type="submit">ì‹œê°„ ì„¤ì • ì €ì¥</button>
    <div id="timeSettingMessage"></div>
  </form>

  <hr style="margin: 2em 0;"> <!-- êµ¬ë¶„ì„  ì¶”ê°€ -->

  <h2>ì˜ˆì•½ í˜„í™©</h2>
  <table>
    <thead>
      <tr><th>ì´ë¦„</th><th>ë£¸ ë²ˆí˜¸</th><th>ê¸°ìˆ™ì‚¬</th><th>ì¸µ</th><th>ìë¦¬ ë²ˆí˜¸</th><th>ì˜ˆì•½ ì·¨ì†Œ</th></tr>
    </thead>
    <tbody id="reservationListBody"></tbody>
  </table>

  <button id="clearAllReservationsBtn" type="button" style="background-color: #dc2626; color: white; float: right; margin-top: 15px;">ëª¨ë“  ì˜ˆì•½ ì·¨ì†Œ</button>
</div>

<script src="https://seat-reservation-backend-ygl9.onrender.com/socket.io/socket.io.js"></script>
<script>
(() => {
  const BACKEND_URL = "https://seat-reservation-backend-ygl9.onrender.com";
  const socket = io(BACKEND_URL);
  const ADMIN_PASSWORD = "admin1234";

  let allReservations = {};
  let adminSettings = {};
  let availabilityCheckInterval = null; // ì˜ˆì•½ ê°€ëŠ¥ ì‹œê°„ ì¦‰ì‹œ ë°˜ì˜ì„ ìœ„í•œ ì¸í„°ë²Œ ë³€ìˆ˜
  let prevAllowedState = null; // ì˜ˆì•½ ê°€ëŠ¥ ìƒíƒœ ë³€ê²½ ê°ì§€ìš©

  const loginPage = document.getElementById('loginPage');
  const loginForm = document.getElementById('loginForm');
  const roomNoInput = document.getElementById('roomNo');
  const userNameInput = document.getElementById('userName');
  const dormitorySelect = document.getElementById('dormitory');
  const roomError = document.getElementById('roomError');
  const nameError = document.getElementById('nameError');
  const dormError = document.getElementById('dormError');
  const adminLoginBtn = document.getElementById('adminLoginBtn');

  const floorSelectPage = document.getElementById('floorSelectPage');
  const floorSelect = document.getElementById('floorSelect');
  const floorNextBtn = document.getElementById('floorNextBtn');
  const backToLoginBtn = document.getElementById('backToLoginBtn');
  const welcomeText = document.getElementById('welcomeText');

  const seatMapPage = document.getElementById('seatMapPage');
  const seatMapContainer = document.getElementById('seatMap');
  const confirmBtn = document.getElementById('confirmBtn');
  const cancelSeatBtn = document.getElementById('cancelSeatBtn');
  const selectedDormTitle = document.getElementById('selectedDorm');
  const selectedFloorTitle = document.getElementById('selectedFloor');
  const reservationAvailabilityMessage = document.getElementById('reservationAvailabilityMessage');

  const adminLoginPage = document.getElementById('adminLoginPage');
  const adminLoginForm = document.getElementById('adminLoginForm');
  const adminPasswordInput = document.getElementById('adminPassword');
  const adminError = document.getElementById('adminError');

  const adminPage = document.getElementById('adminPage');
  const adminLogoutBtn = document.getElementById('adminLogoutBtn');
  const reservationListBody = document.getElementById('reservationListBody');
  const clearAllReservationsBtn = document.getElementById('clearAllReservationsBtn'); // ëª¨ë“  ì˜ˆì•½ ì·¨ì†Œ ë²„íŠ¼

  const reservationTimeForm = document.getElementById('reservationTimeForm');
  const resStartTimeInput = document.getElementById('resStartTime');
  const resEndTimeInput = document.getElementById('resEndTime');
  const timeSettingMessage = document.getElementById('timeSettingMessage');

  let currentUser = null;
  let currentFloor = null;
  let selectedSeat = null;

  const roomNoPattern = /^\d{3}í˜¸$/;
  const koreanNamePattern = /^[ê°€-í£]{2,4}$/;

  const seatLayouts = {
    "ê¿ˆë™": {
      "2": [
        [null,4,null,5,6,7,8,9,10,null,null,null,null],
        [null,3,null,null,null,null,null,null,null,11,null,null,null],
        [null,2,null,null,null,null,null,null,null,12,null,null,null],
        [null,1,null,null,null,null,null,null,null,null,null,null,null]
      ],
      "3": [
        [null,4,null,5,6,7,8,9,10,null,11,null,null,null],
        [null,3,null,null,null,null,null,null,null,null,12,null,null,null],
        [null,2,null,null,null,null,null,null,null,null,13,null,null,null],
        [null,1,null,null,null,null,null,null,null,null,14,null,null,null]
      ],
      "4": [
        [null,4,null,null,null,null,null,null,null,null],
        [null,3,null,null,5,7,null,null,null,null],
        [null,2,null,null,6,8,null,null,null,null],
        [null,1,null,null,null,null,null,null,null,null]
      ],
      "5": [
        [null,4,null,null,null,5,8,null,null,null],
        [null,3,null,null,null,6,9,null,null,null],
        [null,2,null,null,null,7,10,null,null,null],
        [null,1,null,null,null,null,null,null,null,null]
      ],
      "8": [
        [null,4,null,5,6,7,8,null,null,null,null,null,null],
        [null,3,null,null,null,null,null,null,null,null,null,null,null],
        [null,2,null,null,null,null,null,null,null,null,null,null,null],
        [null,1,null,null,null,null,null,null,null,null,null,null,null]
      ]
    },
    "ë¯¸ë˜ë™": {
      "2": [
        [null,null,null,null,null,5,6,7,8,9,10,11,12,null,null,null,null,null],
        [null,null,null,null,4,null,null,null,null,null,null,null,null,13,null,null,null,null],
        [null,null,null,null,3,null,null,null,null,null,null,null,null,14,null,null,null,null],
        [null,null,1,2,null,null,null,null,null,null,null,null,null,null,15,16,null,null],
        [null,17,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null]
      ],
      "4-1": [
        [null,3,null,4,5,null,6,null,null,null],
        [null,2,null,null,null,7,null,null,null,null],
        [null,1,null,null,null,8,null,null,null,null]
      ],
      "4-2": [
        [null,4,null,5,6,7,8,9,10,11,12,null,13,null],
        [null,3,null,null,null,null,null,null,null,null,null,null,14,null],
        [null,2,null,null,null,null,null,null,null,null,null,null,null,null],
        [null,1,null,null,null,null,null,null,null,null,null,null,null,null]
      ]
    }
  };

  // --- API í†µì‹  í•¨ìˆ˜ë“¤ ---
  async function fetchAllReservations() {
    try {
      const res = await fetch(`${BACKEND_URL}/api/reservations`);
      if (!res.ok) throw new Error('ì˜ˆì•½ ì¡°íšŒ ì‹¤íŒ¨');
      const data = await res.json();
      allReservations = {};
      data.forEach(r => allReservations[r._id] = r);
    } catch (e) {
      alert('ì˜ˆì•½ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¤ëŠ” ë° ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë°±ì—”ë“œ ì„œë²„ ìƒíƒœë¥¼ í™•ì¸í•˜ì„¸ìš”.');
      console.error('API í˜¸ì¶œ ì—ëŸ¬: ì˜ˆì•½ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨', e);
      return {};
    }
  }

  async function fetchAdminSettings() {
    try {
      const res = await fetch(`${BACKEND_URL}/api/admin-settings`);
      if (!res.ok) throw new Error('ê´€ë¦¬ì ì„¤ì • ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨');
      adminSettings = await res.json();
    } catch (e) {
      alert('ê´€ë¦¬ì ì„¤ì •ì„ ê°€ì ¸ì˜¤ëŠ” ë° ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë°±ì—”ë“œ ì„œë²„ ìƒíƒœë¥¼ í™•ì¸í•˜ì„¸ìš”.');
      console.error('API í˜¸ì¶œ ì—ëŸ¬: ê´€ë¦¬ì ì„¤ì • ë¡œë“œ ì‹¤íŒ¨', e);
      return { reservationStartTime: null, reservationEndTime: null };
    }
  }

  // --- Socket.IO ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ (ì‹¤ì‹œê°„ ë™ê¸°í™”) ---
  if (socket) {
    socket.on('reservationsUpdated', async updated => {
      allReservations = {};
      updated.forEach(r => allReservations[r._id] = r);
      // í˜„ì¬ ë³´ê³  ìˆëŠ” í™”ë©´ì— ë”°ë¼ UI ê°±ì‹ 
      if (!seatMapPage.classList.contains("hidden") && currentUser && currentFloor) {
        renderSeatMap(currentUser.dormitory, currentFloor);
      }
      if (!adminPage.classList.contains("hidden")) {
        await loadAdminPage(); // ê´€ë¦¬ì í˜ì´ì§€ ì—…ë°ì´íŠ¸ ì‹œì—ë„ ì˜ˆì•½ ëª©ë¡ ì •ë ¬ ìœ ì§€
      }
      console.log('ğŸ”— Socket.IO: ì˜ˆì•½ ë°ì´í„° ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸ ì™„ë£Œ');
    });

    socket.on('settingsUpdated', async updated => {
      adminSettings = updated;
      // í˜„ì¬ ë³´ê³  ìˆëŠ” í™”ë©´ì— ë”°ë¼ UI ê°±ì‹ 
      if (!adminPage.classList.contains("hidden")) {
        await loadAdminPage(); // ê´€ë¦¬ì í˜ì´ì§€ ì—…ë°ì´íŠ¸
      }
      // ì˜ˆì•½ ê°€ëŠ¥ ì‹œê°„ ì—…ë°ì´íŠ¸ ë¡œì§ì´ isReservationTimeAllowedì—ë§Œ ìˆëŠ” ê²½ìš° renderSeatMap ì¬í˜¸ì¶œí•˜ì—¬ ì¢Œì„ë„ ì—…ë°ì´íŠ¸
      updateReservationAvailability(); 
      if (!seatMapPage.classList.contains("hidden") && currentUser && currentFloor) {
        renderSeatMap(currentUser.dormitory, currentFloor);
      }
      console.log('ğŸ”— Socket.IO: ê´€ë¦¬ì ì„¤ì • ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸ ì™„ë£Œ');
    });
  }

  // --- ì˜ˆì•½ ê°€ëŠ¥ ì‹œê°„ í™•ì¸ ë¡œì§ ---
  function isReservationTimeAllowed() {
    if (!adminSettings.reservationStartTime || !adminSettings.reservationEndTime) {
      return { allowed: false, message: 'ê´€ë¦¬ìê°€ ì˜ˆì•½ ê°€ëŠ¥ ì‹œê°„ì„ ì„¤ì •í•˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.' };
    }
    const now = new Date();
    const start = new Date(adminSettings.reservationStartTime);
    const end = new Date(adminSettings.reservationEndTime);
    return now >= start && now <= end
      ? { allowed: true, message: `ì˜ˆì•½ ê°€ëŠ¥ ì‹œê°„ì…ë‹ˆë‹¤. (${formatDate(start)} ~ ${formatDate(end)})` }
      : { allowed: false, message: `í˜„ì¬ ì˜ˆì•½ ê°€ëŠ¥ ì‹œê°„ì´ ì•„ë‹™ë‹ˆë‹¤. (${formatDate(start)} ~ ${formatDate(end)})` };
  }

  // ë‚ ì§œ í¬ë§·íŒ… ìœ í‹¸ë¦¬í‹°
  function formatDate(date) {
    const pad = n => (n < 10 ? '0' + n : n);
    return `${pad(date.getMonth() + 1)}-${pad(date.getDate())} ${pad(date.getHours())}:${pad(date.getMinutes())}`;
  }

  // --- UI í˜ì´ì§€ ì „í™˜ ---
  function showSection(section) {
    [loginPage, floorSelectPage, seatMapPage, adminLoginPage, adminPage].forEach(el => el.classList.add('hidden'));
    section.classList.remove('hidden');
    
    // ì˜ˆì•½ ê°€ëŠ¥ ì‹œê°„ ì‹¤ì‹œê°„ ì²´í¬ ì¸í„°ë²Œ ê´€ë¦¬
    if (section === seatMapPage) {
      if (availabilityCheckInterval) clearInterval(availabilityCheckInterval);
      updateReservationAvailability(); // ì¦‰ì‹œ í•œë²ˆ í˜¸ì¶œí•˜ì—¬ ì´ˆê¸° ìƒíƒœ ë°˜ì˜
      availabilityCheckInterval = setInterval(updateReservationAvailability, 1000); // 1ì´ˆë§ˆë‹¤ ì²´í¬
    } else {
      if (availabilityCheckInterval) {
        clearInterval(availabilityCheckInterval);
        availabilityCheckInterval = null;
      }
    }
  }

  // --- ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ---
  loginForm.addEventListener('submit', async e => {
    e.preventDefault();
    clearErrors();

    const roomNo = roomNoInput.value.trim();
    const name = userNameInput.value.trim();
    const dormitory = dormitorySelect.value;

    let valid = true;
    if (!roomNoPattern.test(roomNo)) {
      roomError.textContent = 'ë£¸ ë²ˆí˜¸ëŠ” 000í˜¸ í˜•ì‹ìœ¼ë¡œ ì…ë ¥í•˜ì„¸ìš”.';
      valid = false;
    }
    if (!koreanNamePattern.test(name)) {
      nameError.textContent = 'ì´ë¦„ì€ í•œê¸€ 2~4ìì—¬ì•¼ í•©ë‹ˆë‹¤.';
      valid = false;
    }
    if (!dormitory) {
      dormError.textContent = 'ê¸°ìˆ™ì‚¬ë¥¼ ì„ íƒí•˜ì„¸ìš”.';
      valid = false;
    }
    if (!valid) return;

    const hasReservation = Object.values(allReservations).some(r => r.roomNo === roomNo && r.name === name);

    if (hasReservation) {
      const existing = Object.values(allReservations).find(r => r.roomNo === roomNo && r.name === name);
      currentUser = {roomNo, name, dormitory};
      currentFloor = existing.floor;
      selectedSeat = existing.seat;
      setFloorOptions(dormitory);
      floorSelect.value = currentFloor;
      welcomeText.textContent = `${name}ë‹˜, ${dormitory} ê¸°ìˆ™ì‚¬`;
      selectedDormTitle.textContent = dormitory;
      selectedFloorTitle.textContent = currentFloor;
      renderSeatMap(dormitory, currentFloor);
      updateReservationAvailability();
      showSection(seatMapPage);
    } else {
      currentUser = {roomNo, name, dormitory};
      setFloorOptions(dormitory);
      welcomeText.textContent = `${name}ë‹˜, ${dormitory} ê¸°ìˆ™ì‚¬`;
      showSection(floorSelectPage);
    }
  });

  backToLoginBtn.addEventListener('click', () => {
    currentUser = currentFloor = selectedSeat = null;
    loginForm.reset();
    showSection(loginPage);
  });

  floorNextBtn.addEventListener('click', () => {
    const floor = floorSelect.value;
    if (!floor) {
      alert('ì¸µì„ ì„ íƒí•˜ì„¸ìš”.');
      return;
    }
    currentFloor = floor;
    selectedDormTitle.textContent = currentUser.dormitory;
    selectedFloorTitle.textContent = currentFloor;
    selectedSeat = null;
    confirmBtn.disabled = true;
    renderSeatMap(currentUser.dormitory, currentFloor);
    updateReservationAvailability();
    showSection(seatMapPage);
  });

  cancelSeatBtn.addEventListener('click', () => {
    selectedSeat = null;
    confirmBtn.disabled = true;
    showSection(floorSelectPage);
  });

  adminLoginBtn.addEventListener('click', () => {
    adminLoginForm.reset();
    adminError.textContent = '';
    showSection(adminLoginPage);
  });

  document.getElementById('adminLoginBackBtn').addEventListener('click', () => {
    showSection(loginPage);
  });

  adminLoginForm.addEventListener('submit', async e => {
    e.preventDefault();
    const pw = adminPasswordInput.value.trim();
    if (pw === ADMIN_PASSWORD) {
      await loadAdminPage(); // ê´€ë¦¬ì í˜ì´ì§€ ë°ì´í„° ë¡œë“œ
      showSection(adminPage);
    } else {
      adminError.textContent = 'ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤.';
    }
  });

  adminLogoutBtn.addEventListener('click', () => {
    showSection(loginPage);
  });

  // --- ì¢Œì„ ë°°ì¹˜ë„ ê´€ë ¨ í•¨ìˆ˜ë“¤ ---
  function setFloorOptions(dorm) {
    floorSelect.innerHTML = '<option value="" disabled selected>ì¸µ ì„ íƒ</option>';
    const floors = Object.keys(seatLayouts[dorm]).sort((a,b) => {
      const parseFloor = (f) => parseFloat(f.replace('-', '.'));
      return parseFloor(a) - parseFloor(b);
    });
    floors.forEach(floor => {
      const option = document.createElement('option');
      option.value = floor;
      option.textContent = floor.includes('-') ? floor.replace('-', 'ì¸µ-') : floor + 'ì¸µ';
      floorSelect.appendChild(option);
    });
  }

  function renderSeatMap(dorm, floor) {
    seatMapContainer.innerHTML = '';
    const layout = seatLayouts[dorm]?.[floor];
    if (!layout) {
      seatMapContainer.textContent = 'í•´ë‹¹ ì¸µ ì¢Œì„ ë°°ì¹˜ë„ê°€ ì—†ìŠµë‹ˆë‹¤.';
      return;
    }
    const maxCols = Math.max(...layout.map(row => row.length));
    seatMapContainer.style.gridTemplateColumns = `repeat(${maxCols}, 1fr)`;

    const allowed = isReservationTimeAllowed().allowed;

    layout.forEach(row => {
      row.forEach(seatNum => {
        const btn = document.createElement('button');
        btn.type = 'button';

        if (seatNum === null) {
          btn.classList.add('seat-btn', 'empty');
          btn.textContent = '';
        } else {
          btn.classList.add('seat-btn');
          btn.textContent = seatNum;

          const booked = Object.values(allReservations).find(r => r.dormitory===dorm && r.floor===floor && r.seat===seatNum);

          if (booked) {
            btn.classList.add('booked');
            btn.disabled = true; // ê¸°ë³¸ì ìœ¼ë¡œ ì˜ˆì•½ëœ ì¢Œì„ì€ ë¹„í™œì„±í™”

            // ì¼ë°˜ ì‚¬ìš©ì í™”ë©´ì—ì„œëŠ” ì˜ˆì•½ì ì´ë¦„ ìˆ¨ê¸°ê¸°
            btn.title = `ì˜ˆì•½ëœ ì¢Œì„`; 

            // ìì‹ ì˜ ì˜ˆì•½ì¸ ê²½ìš°ë§Œ ì´ë¦„ í‘œì‹œ ë° í™œì„±í™”
            if (currentUser && booked.roomNo===currentUser.roomNo && booked.name===currentUser.name) {
              btn.classList.add('mine');
              btn.disabled = false; // ìì‹ ì˜ ì˜ˆì•½ ì¢Œì„ì€ ë‹¤ì‹œ í™œì„±í™”
              btn.title = `ë‚´ ì˜ˆì•½ (${booked.name}ë‹˜)`; // ìì‹ ì˜ ì˜ˆì•½ì€ ì´ë¦„ í‘œì‹œ
            }
          } else {
            // ì˜ˆì•½ ê°€ëŠ¥ ì—¬ë¶€ì— ë”°ë¼ ì¢Œì„ ë²„íŠ¼ í™œì„±í™”/ë¹„í™œì„±í™”
            btn.disabled = !allowed;
            btn.title = allowed ? 'ì˜ˆì•½ ê°€ëŠ¥ ìë¦¬' : 'ì˜ˆì•½ ê°€ëŠ¥ ì‹œê°„ì´ ì•„ë‹™ë‹ˆë‹¤.';
            btn.onclick = () => {
              if (allowed) { // ì˜ˆì•½ ê°€ëŠ¥í•œ ì‹œê°„ì¸ ê²½ìš°ì—ë§Œ ì¢Œì„ ì„ íƒ ê°€ëŠ¥
                selectedSeat = seatNum;
                confirmBtn.disabled = false;
                highlightSelectedSeat();
              }
            };
          }
        }
        seatMapContainer.appendChild(btn);
      });
    });
    highlightSelectedSeat();
  }

  function highlightSelectedSeat() {
    seatMapContainer.querySelectorAll("button.seat-btn").forEach(btn => {
      btn.classList.toggle("mine", parseInt(btn.textContent) === selectedSeat);
    });
  }

  function updateReservationAvailability() {
    const status = isReservationTimeAllowed();
    reservationAvailabilityMessage.textContent = status.message;

    // ì˜ˆì•½ ê°€ëŠ¥ ìƒíƒœê°€ ë³€ê²½ë˜ì—ˆëŠ”ì§€ ê°ì§€
    const currentAllowedState = status.allowed;
    const hasAllowedStateChanged = (prevAllowedState !== null && prevAllowedState !== currentAllowedState);
    prevAllowedState = currentAllowedState; // ë‹¤ìŒ ì²´í¬ë¥¼ ìœ„í•´ í˜„ì¬ ìƒíƒœ ì €ì¥

    if (currentAllowedState) {
      reservationAvailabilityMessage.classList.add("available");
      confirmBtn.disabled = (selectedSeat === null);
    } else {
      reservationAvailabilityMessage.classList.remove("available");
      confirmBtn.disabled = true;
    }
    
    // ì˜ˆì•½ ê°€ëŠ¥ ìƒíƒœê°€ ë³€ê²½ë˜ì—ˆê³  í˜„ì¬ ì¢Œì„ ë°°ì¹˜ë„ í™”ë©´ì´ë¼ë©´, ì¢Œì„ ë²„íŠ¼ ìƒíƒœë„ ì¦‰ì‹œ ì—…ë°ì´íŠ¸
    if (hasAllowedStateChanged && !seatMapPage.classList.contains("hidden") && currentUser && currentFloor) {
        renderSeatMap(currentUser.dormitory, currentFloor);
    }
  }

  confirmBtn.addEventListener("click", async () => {
    if (!selectedSeat) {
      alert("ì¢Œì„ì„ ì„ íƒí•´ì£¼ì„¸ìš”.");
      return;
    }
    if (!isReservationTimeAllowed().allowed) {
      alert("ì˜ˆì•½ ê°€ëŠ¥ ì‹œê°„ì´ ì•„ë‹™ë‹ˆë‹¤.");
      updateReservationAvailability();
      return;
    }

    try {
      await fetch(`${BACKEND_URL}/api/reservations/user/${currentUser.roomNo}/${currentUser.name}`, {
        method: "DELETE",
      });
    } catch (e) {
      console.warn("ê¸°ì¡´ ì˜ˆì•½ ì‚­ì œ ì¤‘ ì˜¤ë¥˜:", e);
    }

    try {
      const response = await fetch(`${BACKEND_URL}/api/reservations`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          roomNo: currentUser.roomNo,
          name: currentUser.name,
          dormitory: currentUser.dormitory,
          floor: currentFloor,
          seat: selectedSeat,
        }),
      });
      const result = await response.json();

      if (response.ok) {
        alert(`${currentUser.dormitory} ${currentFloor}ì¸µ ${selectedSeat}ë²ˆ ìë¦¬ ì˜ˆì•½ ì™„ë£Œ!`);
        currentUser = null;
        currentFloor = null;
        selectedSeat = null;
        loginForm.reset();
        showSection(loginPage);
      } else {
        alert("ì˜ˆì•½ ì‹¤íŒ¨: " + (result.message || "ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜"));
        if (currentUser && currentFloor) renderSeatMap(currentUser.dormitory, currentFloor);
      }
    } catch (e) {
      alert("ì˜ˆì•½ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì„œë²„ ìƒíƒœë¥¼ í™•ì¸í•˜ì„¸ìš”.");
      console.error(e);
    }
  });

  // --- ê´€ë¦¬ì í˜ì´ì§€ ê´€ë ¨ í•¨ìˆ˜ë“¤ ---
  async function loadAdminPage() {
    reservationListBody.innerHTML = "";
    let resArr = Object.values(allReservations);
    
    // ì˜ˆì•½ í˜„í™© ìœ„ì¹˜ë³„ ì •ë ¬ ë¡œì§
    resArr.sort((a, b) => {
        // 1. ê¸°ìˆ™ì‚¬ë³„ ì •ë ¬ (ê¿ˆë™ < ë¯¸ë˜ë™ ë“±)
        if (a.dormitory !== b.dormitory) {
            return a.dormitory.localeCompare(b.dormitory);
        }
        // 2. ì¸µë³„ ì •ë ¬ (ìˆ«ì ìˆœ, '4-1' ê°™ì€ í˜•ì‹ë„ ê³ ë ¤)
        const parseFloor = (f) => parseFloat(f.replace('-', '.')); // '4-1' -> 4.1ë¡œ íŒŒì‹±í•˜ì—¬ ë¹„êµ
        if (parseFloor(a.floor) !== parseFloor(b.floor)) {
            return parseFloor(a.floor) - parseFloor(b.floor);
        }
        // 3. ì¢Œì„ ë²ˆí˜¸ë³„ ì •ë ¬
        return a.seat - b.seat;
    });

    if (resArr.length === 0) {
      reservationListBody.innerHTML = '<tr><td colspan="6">ì˜ˆì•½ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
      return;
    }
    resArr.forEach((resv) => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${resv.name}</td>
        <td>${resv.roomNo}</td>
        <td>${resv.dormitory}</td>
        <td>${resv.floor}</td>
        <td>${resv.seat}</td>
        <td><button type="button" class="cancel-btn" data-id="${resv._id}">ì·¨ì†Œ</button></td>`;
      reservationListBody.appendChild(tr);
    });
    document.querySelectorAll(".cancel-btn").forEach((btn) => {
      btn.onclick = async () => {
        if (confirm("ì •ë§ ì˜ˆì•½ì„ ì·¨ì†Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
          const id = btn.dataset.id;
          const res = await fetch(`${BACKEND_URL}/api/reservations/${id}`, { method: "DELETE" });
          if (res.ok) alert("ì˜ˆì•½ì´ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.");
          else alert("ì˜ˆì•½ ì·¨ì†Œ ì‹¤íŒ¨");
        }
      };
    });

    if (adminSettings.reservationStartTime)
      resStartTimeInput.value = new Date(adminSettings.reservationStartTime).toISOString().slice(0, 16);
    else resStartTimeInput.value = "";
    if (adminSettings.reservationEndTime)
      resEndTimeInput.value = new Date(adminSettings.reservationEndTime).toISOString().slice(0, 16);
    else resEndTimeInput.value = "";
    timeSettingMessage.textContent = "";
  }

  // ëª¨ë“  ì˜ˆì•½ ì·¨ì†Œ ë²„íŠ¼ ì´ë²¤íŠ¸
  clearAllReservationsBtn.addEventListener('click', async () => {
      if (!confirm('ì •ë§ ëª¨ë“  ì˜ˆì•½ì„ ì·¨ì†Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤!')) {
          return;
      }
      try {
          // ë°±ì—”ë“œì˜ ëª¨ë“  ì˜ˆì•½ ì‚­ì œ API í˜¸ì¶œ (ì´ APIëŠ” app.jsì— ì¶”ê°€ë˜ì–´ì•¼ í•©ë‹ˆë‹¤.)
          const response = await fetch(`${BACKEND_URL}/api/reservations/all`, {
              method: 'DELETE'
          });
          if (response.ok) {
              alert('ëª¨ë“  ì˜ˆì•½ì´ ì„±ê³µì ìœ¼ë¡œ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.');
          } else {
              const errorResult = await response.json();
              alert(`ëª¨ë“  ì˜ˆì•½ ì·¨ì†Œ ì‹¤íŒ¨: ${errorResult.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'}`);
          }
      } catch (e) {
          console.error('ëª¨ë“  ì˜ˆì•½ ì·¨ì†Œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:', e);
          alert('ëª¨ë“  ì˜ˆì•½ ì·¨ì†Œ ì¤‘ í†µì‹  ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë°±ì—”ë“œ ì„œë²„ë¥¼ í™•ì¸í•˜ì„¸ìš”.');
      }
  });


  reservationTimeForm.addEventListener("submit", async (e) => {
    e.preventDefault();

    if (!resStartTimeInput.value || !resEndTimeInput.value) {
      timeSettingMessage.textContent = "ì‹œì‘ê³¼ ì¢…ë£Œ ì‹œê°„ì„ ëª¨ë‘ ì…ë ¥í•˜ì„¸ìš”.";
      timeSettingMessage.style.color = "red";
      return;
    }

    if (new Date(resEndTimeInput.value) <= new Date(resStartTimeInput.value)) {
      timeSettingMessage.textContent = "ì¢…ë£Œ ì‹œê°„ì€ ì‹œì‘ ì‹œê°„ë³´ë‹¤ ëŠ¦ì–´ì•¼ í•©ë‹ˆë‹¤.";
      timeSettingMessage.style.color = "red";
      return;
    }

    try {
      const res = await fetch(`${BACKEND_URL}/api/admin-settings`, {
        method: "PUT",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          reservationStartTime: new Date(resStartTimeInput.value).toISOString(),
          reservationEndTime: new Date(resEndTimeInput.value).toISOString(),
        }),
      });

      if (res.ok) {
        timeSettingMessage.textContent = "ì˜ˆì•½ ê°€ëŠ¥ ì‹œê°„ì´ ì„¤ì •ë˜ì—ˆìŠµë‹ˆë‹¤.";
        timeSettingMessage.style.color = "green";
        await loadAdminPage(); // ì„¤ì • ë³€ê²½ í›„ ê´€ë¦¬ì í˜ì´ì§€ ì¦‰ì‹œ ì—…ë°ì´íŠ¸
        // ì„¤ì •ì´ ë³€ê²½ë˜ì—ˆìœ¼ë¯€ë¡œ, ì¢Œì„ ë°°ì¹˜ë„ í™”ë©´ì˜ ì˜ˆì•½ ê°€ëŠ¥ ìƒíƒœë„ ì¦‰ì‹œ ê°±ì‹ 
        updateReservationAvailability(); 
        if (!seatMapPage.classList.contains("hidden") && currentUser && currentFloor) {
            renderSeatMap(currentUser.dormitory, currentFloor);
        }

      } else {
        timeSettingMessage.textContent = "ì„¤ì • ì €ì¥ ì‹¤íŒ¨";
        timeSettingMessage.style.color = "red";
      }
    } catch (e) {
      console.error(e);
      timeSettingMessage.textContent = "ì„œë²„ ì˜¤ë¥˜ ë°œìƒ";
      timeSettingMessage.style.color = "red";
    }
  });

  function clearErrors() {
    roomError.textContent = "";
    nameError.textContent = "";
    dormError.textContent = "";
  }

  // ì´ˆê¸° ë°ì´í„° ë¡œë“œ ë° í˜ì´ì§€ í‘œì‹œ
  (async () => {
    await fetchAllReservations();
    await fetchAdminSettings();
    showSection(loginPage);
  })();
})();
</script>
</body>
</html>