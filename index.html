<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>랜선석 예약 시스템</title>

<style>
  /* 기본 스타일 */
  body {
    font-family: 'Malgun Gothic', Arial, sans-serif;
    margin: 0; padding: 0;
    background: #fafafc;
    color: #2c3e50;
  }

  h1, h2 {
    text-align: center;
    margin: 1em 0;
    color: #334155;
  }

  .container {
    max-width: 900px;
    margin: 15px auto 40px;
    background: white;
    padding: 25px 30px;
    border-radius: 12px;
    box-shadow: 0 0 20px rgba(0,0,0,0.06);
  }

  .hidden { display: none; }

  form {
    max-width: 400px;
    margin: 0 auto;
  }

  label {
    font-weight: 700;
    margin-top: 1.2em;
    display: block;
    color: #475569;
  }

  input[type=text], input[type=password], input[type=datetime-local], select {
    width: 100%;
    padding: 10px 12px;
    margin-top: 6px;
    font-size: 1rem;
    border: 2px solid #cbd5e1;
    border-radius: 8px;
    box-sizing: border-box;
    transition: border-color 0.3s ease;
  }

  input[type=text]:focus, input[type=password]:focus, input[type=datetime-local]:focus, select:focus {
    border-color: #fbbf24;
    outline: none;
  }

  .error {
    color: #dc2626;
    font-size: 0.9em;
    height: 20px;
    margin-top: 4px;
  }

  button {
    background-color: #fbbf24;
    border: none;
    border-radius: 8px;
    padding: 12px 25px;
    font-size: 1.1rem;
    font-weight: 700;
    color: #92400e;
    cursor: pointer;
    margin-top: 1.5em;
    box-shadow: 1px 3px 6px rgba(251,191,36,0.5);
    transition: background-color 0.3s ease;
    display: inline-block;
  }
  
  button:hover:not(:disabled) {
    background-color: #f59e0b;
  }
  
  button:disabled {
    background-color: #fde68a;
    cursor: not-allowed;
    box-shadow: none;
  }
  
  nav {
    text-align: center;
    margin-top: 2em;
  }
  
  nav button {
    background: transparent;
    color: #b45309;
    font-weight: 600;
    padding: 8px 16px;
    border: 2px solid #fbbf24;
    border-radius: 8px;
    cursor: pointer;
    transition: background-color 0.3s ease;
  }
  
  nav button:hover {
    background-color: #fbbf24;
    color: #92400e;
  }

  /* 좌석 배치도 스타일 */
  #seatMap {
    margin: 20px auto 40px;
    display: grid;
    gap: 8px;
    justify-content: center;
  }

  .seat-btn {
    background: #fef3c7;
    border: 2px solid #fbbf24;
    border-radius: 6px;
    font-weight: 700;
    color: #92400e;
    cursor: pointer;
    user-select: none;
    text-align: center;
    font-size: 1.1rem;
    min-width: 44px;
    transition: background-color 0.3s ease, border-color 0.3s ease;
    display: flex;
    justify-content: center;
    align-items: center;
  }
  
  .seat-btn:hover:not(.booked) {
    background-color: #fde68a;
    border-color: #fbbf24;
  }
  
  .seat-btn.booked {
    background: #d1d5db;
    color: #6b7280;
    cursor: not-allowed;
    box-shadow: none;
  }

  .seat-btn.mine {
    background: #fef08a;
    border-color: #ca8a04;
    font-weight: 800;
  }
  
  .seat-btn.empty {
    visibility: hidden;
    pointer-events: none;
  }

  /* 관리자 예약 현황 테이블 스타일 */
  table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 15px;
    font-size: 1rem;
  }

  th, td {
    border: 1px solid #cbd5e1;
    padding: 8px 12px;
    text-align: center;
  }

  th {
    background-color: #fbbf24;
    color: #92400e;
  }

  td button {
    background: #ef4444;
    color: white;
    border: none;
    border-radius: 5px;
    padding: 6px 12px;
    font-weight: 600;
    cursor: pointer;
    transition: background-color 0.3s ease;
  }

  td button:hover {
    background: #b91c1c;
  }

  /* 예약 가능 시간 안내 메시지 */
  #reservationAvailabilityMessage {
    text-align: center;
    font-weight: 700;
    padding: 0.5em;
    margin-top: 1em;
    border-radius: 5px;
    color: #ef4444;
    background-color: #fee2e2;
  }
  
  #reservationAvailabilityMessage.available {
    color: #10b981;
    background-color: #d1fae5;
  }

  /* 관리자 예약 시간 설정 메시지 */
  #timeSettingMessage {
    text-align: center;
    margin-top: 10px;
    font-size: 0.9rem;
    min-height: 1.5em;
  }

  /* 반응형 */
  @media (max-width: 600px) {
    .container {
      margin: 10px 15px 30px;
      padding: 20px;
    }
    #seatMap {
      gap: 6px;
    }
    .seat-btn {
      padding: 10px 8px;
      font-size: 1rem;
      min-width: 36px;
    }
  }
</style>

</head>
<body>

<!-- 로그인 페이지 -->
<div class="container" id="loginPage">
  <h1>랜선석 예약 로그인</h1>

  <form id="loginForm" autocomplete="off">
    <label for="roomNo">룸 번호 (000호 형식):</label>
    <input type="text" id="roomNo" placeholder="101호" />
    <div id="roomError" class="error"></div>

    <label for="userName">이름 (한글 2~4자):</label>
    <input type="text" id="userName" placeholder="홍길동" />
    <div id="nameError" class="error"></div>

    <label for="dormitory">기숙사 선택:</label>
    <select id="dormitory" >
      <option value="" disabled selected>선택하세요</option>
      <option value="꿈동">꿈동</option>
      <option value="미래동">미래동</option>
    </select>
    <div id="dormError" class="error"></div>

    <button type="submit">다음</button>
  </form>

  <nav>
    <button id="adminLoginBtn">관리자 로그인</button>
  </nav>
</div>

<!-- 층 선택 페이지 -->
<div class="container hidden" id="floorSelectPage">
  <h2><span id="welcomeText"></span>님, 층을 선택해주세요</h2>
  <select id="floorSelect">
    <option value="" disabled selected>층 선택</option>
  </select>
  <button id="floorNextBtn">좌석 선택으로</button>
  <button id="backToLoginBtn">뒤로가기</button>
</div>

<!-- 좌석 선택 페이지 -->
<div class="container hidden" id="seatMapPage">
  <h2>좌석 배치 - <span id="selectedDorm"></span> <span id="selectedFloor"></span>층</h2>
  <div id="seatMap"></div>
  <div id="reservationAvailabilityMessage"></div>
  <button id="confirmBtn" disabled>예약 확정</button>
  <button id="cancelSeatBtn">뒤로가기</button>
</div>

<!-- 관리자 로그인 페이지 -->
<div class="container hidden" id="adminLoginPage">
  <h1>관리자 로그인</h1>
  <form id="adminLoginForm" autocomplete="off">
    <label for="adminPassword">비밀번호:</label>
    <input type="password" id="adminPassword" />
    <div id="adminError" class="error"></div>
    <button type="submit">로그인</button>
  </form>
  <button id="adminLoginBackBtn">로그인페이지로 돌아가기</button>
</div>

<!-- 관리자 페이지 -->
<div class="container hidden" id="adminPage">
  <h1>관리자 페이지</h1>
  <button id="adminLogoutBtn">로그아웃</button>

  <h2>예약 가능 시간 설정</h2>
  <form id="reservationTimeForm">
    <label for="resStartTime">예약 시작 시간</label>
    <input type="datetime-local" id="resStartTime" />
    <label for="resEndTime">예약 종료 시간</label>
    <input type="datetime-local" id="resEndTime" />
    <button type="submit">시간설정 저장</button>
    <div id="timeSettingMessage"></div>
  </form>

  <h2>현재 예약 현황</h2>
  <table>
    <thead>
      <tr><th>이름</th><th>룸 번호</th><th>기숙사</th><th>층</th><th>좌석 번호</th><th>삭제</th></tr>
    </thead>
    <tbody id="reservationListBody"></tbody>
  </table>
</div>

<script src="https://seat-reservation-backend-ygl9.onrender.com"></script>
<script>
(() => {
  const BACKEND_URL = "https://seat-reservation-backend-ygl9.onrender.com";

  const socket = io(BACKEND_URL);

  const ADMIN_PASSWORD = "admin1234";

  let allReservations = {};
  let adminSettings = {};

  // 페이지 요소
  const loginPage = document.getElementById('loginPage');
  const loginForm = document.getElementById('loginForm');
  const roomNoInput = document.getElementById('roomNo');
  const userNameInput = document.getElementById('userName');
  const dormitorySelect = document.getElementById('dormitory');
  const roomError = document.getElementById('roomError');
  const nameError = document.getElementById('nameError');
  const dormError = document.getElementById('dormError');
  const adminLoginBtn = document.getElementById('adminLoginBtn');

  const floorSelectPage = document.getElementById('floorSelectPage');
  const floorSelect = document.getElementById('floorSelect');
  const floorNextBtn = document.getElementById('floorNextBtn');
  const backToLoginBtn = document.getElementById('backToLoginBtn');
  const welcomeText = document.getElementById('welcomeText');

  const seatMapPage = document.getElementById('seatMapPage');
  const seatMapContainer = document.getElementById('seatMap');
  const confirmBtn = document.getElementById('confirmBtn');
  const cancelSeatBtn = document.getElementById('cancelSeatBtn');
  const selectedDormTitle = document.getElementById('selectedDorm');
  const selectedFloorTitle = document.getElementById('selectedFloor');
  const reservationAvailabilityMessage = document.getElementById('reservationAvailabilityMessage');

  const adminLoginPage = document.getElementById('adminLoginPage');
  const adminLoginForm = document.getElementById('adminLoginForm');
  const adminPasswordInput = document.getElementById('adminPassword');
  const adminError = document.getElementById('adminError');

  const adminPage = document.getElementById('adminPage');
  const adminLogoutBtn = document.getElementById('adminLogoutBtn');
  const reservationListBody = document.getElementById('reservationListBody');

  const reservationTimeForm = document.getElementById('reservationTimeForm');
  const resStartTimeInput = document.getElementById('resStartTime');
  const resEndTimeInput = document.getElementById('resEndTime');
  const timeSettingMessage = document.getElementById('timeSettingMessage');

  // 상태
  let currentUser = null;
  let currentFloor = null;
  let selectedSeat = null;

  // 정규식
  const roomNoPattern = /^\d{3}호$/;
  const koreanNamePattern = /^[가-힣]{2,4}$/;

  // 좌석배치
  const seatLayouts = {
    "꿈동": {
      "2": [
        [null,4,null,5,6,7,8,9,10,null,null,null,null],
        [null,3,null,null,null,null,null,null,null,11,null,null,null],
        [null,2,null,null,null,null,null,null,null,12,null,null,null],
        [null,1,null,null,null,null,null,null,null,null,null,null,null]
      ],
      // 다른 층도 위와 같은 패턴으로 정의 (생략)
    },
    "미래동": {
      "2": [
        [null,null,null,null,null,5,6,7,8,9,10,11,12,null,null,null,null,null],
        // 다른 층도 위와 같은 패턴으로 정의 (생략)
      ]
    }
  };

  // API 호출 - 예약 전체 불러오기
  async function fetchAllReservations() {
    try {
      const res = await fetch(BACKEND_URL + '/api/reservations');
      if (!res.ok) throw new Error('예약 조회 실패');
      const data = await res.json();
      allReservations = {};
      data.forEach(r => allReservations[r._id] = r);
      if (!seatMapPage.classList.contains('hidden') && currentUser && currentFloor) {
        renderSeatMap(currentUser.dormitory, currentFloor);
      }
      if (!adminPage.classList.contains('hidden')) {
        loadAdminPage();
      }
    } catch (e) {
      alert('예약 데이터 로드 실패! 백엔드 상태를 확인하세요.');
      console.error(e);
    }
  }

  // API 호출 - 관리자 설정 불러오기
  async function fetchAdminSettings() {
    try {
      const res = await fetch(BACKEND_URL + '/api/admin-settings');
      if (!res.ok) throw new Error('관리자 설정 조회 실패');
      adminSettings = await res.json();
      if (!adminPage.classList.contains('hidden')) loadAdminPage();
      updateReservationAvailability();
      if (!seatMapPage.classList.contains('hidden') && currentUser && currentFloor) {
        renderSeatMap(currentUser.dormitory, currentFloor);
      }
    } catch (e) {
      alert('관리자 설정 로드 실패! 백엔드 상태를 확인하세요.');
      console.error(e);
    }
  }

  // Socket.IO 이벤트 리스너
  socket.on('reservationsUpdated', updated => {
    allReservations = {};
    updated.forEach(r => allReservations[r._id] = r);
    if (!seatMapPage.classList.contains('hidden') && currentUser && currentFloor) renderSeatMap(currentUser.dormitory, currentFloor);
    if (!adminPage.classList.contains('hidden')) loadAdminPage();
  });

  socket.on('settingsUpdated', updated => {
    adminSettings = updated;
    if (!adminPage.classList.contains('hidden')) loadAdminPage();
    updateReservationAvailability();
    if (!seatMapPage.classList.contains('hidden') && currentUser && currentFloor) renderSeatMap(currentUser.dormitory, currentFloor);
  });

  // 예약 가능 시간 확인 함수
  function isReservationTimeAllowed() {
    if (!adminSettings.reservationStartTime || !adminSettings.reservationEndTime) {
      return { allowed: false, message: '관리자가 예약 가능 시간을 설정하지 않았습니다.' };
    }
    const now = new Date();
    const start = new Date(adminSettings.reservationStartTime);
    const end = new Date(adminSettings.reservationEndTime);
    if (now >= start && now <= end) {
      return { allowed: true, message: `예약 가능 시간입니다. (${formatDate(start)} ~ ${formatDate(end)})` };
    } else {
      return { allowed: false, message: `현재 예약 가능 시간이 아닙니다. (${formatDate(start)} ~ ${formatDate(end)})` };
    }
  }

  function formatDate(date) {
    const pad = n => (n < 10 ? '0' + n : n);
    return `${pad(date.getMonth() + 1)}-${pad(date.getDate())} ${pad(date.getHours())}:${pad(date.getMinutes())}`;
  }

  // 페이지 숨김/표시 함수
  function showSection(section) {
    [loginPage, floorSelectPage, seatMapPage, adminLoginPage, adminPage].forEach(s => s.classList.add('hidden'));
    section.classList.remove('hidden');
  }

  // 좌석 렌더링 함수 (이전 좌석 표시 포함)
  function renderSeatMap(dorm, floor) {
    seatMapContainer.innerHTML = '';
    const layout = seatLayouts[dorm]?.[floor];
    if (!layout) {
      seatMapContainer.textContent = '해당 층의 좌석 배치도가 없습니다.';
      return;
    }
    const maxCols = Math.max(...layout.map(row => row.length));
    seatMapContainer.style.gridTemplateColumns = `repeat(${maxCols}, 44px)`;

    const allowed = isReservationTimeAllowed().allowed;

    layout.forEach(row => {
      row.forEach(seat => {
        const btn = document.createElement('button');
        btn.type = 'button';

        if (seat === null) {
          btn.classList.add('seat-btn', 'empty');
          btn.textContent = '';
        } else {
          btn.classList.add('seat-btn');
          btn.textContent = seat;

          const booked = Object.values(allReservations).find(r => r.dormitory === dorm && r.floor === floor && r.seat === seat);
          if (booked) {
            btn.classList.add('booked');
            btn.disabled = true;
            btn.title = `${booked.name}님 예약됨`;
            if (currentUser && booked.name === currentUser.name && booked.roomNo === currentUser.roomNo) {
              btn.classList.add('mine');
              btn.disabled = false;
            }
          } else {
            btn.disabled = !allowed;
            btn.title = allowed ? '예약 가능 자리' : '예약 가능 시간이 아닙니다.';
            btn.onclick = () => {
              if (allowed) {
                selectedSeat = seat;
                confirmBtn.disabled = false;
                highlightSelectedSeat();
              }
            };
          }
        }
        seatMapContainer.appendChild(btn);
      });
    });
    highlightSelectedSeat();
  }

  function highlightSelectedSeat() {
    seatMapContainer.querySelectorAll('button.seat-btn').forEach(btn => {
      btn.classList.toggle('mine', parseInt(btn.textContent) === selectedSeat);
    });
  }

  // 예약 가능 메시지 및 확인 버튼 상태 업데이트
  function updateReservationAvailability() {
    const status = isReservationTimeAllowed();
    reservationAvailabilityMessage.textContent = status.message;
    if (status.allowed) {
      reservationAvailabilityMessage.classList.add('available');
      confirmBtn.disabled = selectedSeat === null;
    } else {
      reservationAvailabilityMessage.classList.remove('available');
      confirmBtn.disabled = true;
    }
  }

  // 로그인 폼 제출 이벤트
  loginForm.addEventListener('submit', async e => {
    e.preventDefault();
    clearErrors();

    const roomNo = roomNoInput.value.trim();
    const name = userNameInput.value.trim();
    const dorm = dormitorySelect.value;

    let valid = true;
    if (!roomNoPattern.test(roomNo)) {
      roomError.textContent = '룸 번호를 000호 형태로 입력하세요.';
      valid = false;
    }
    if (!koreanNamePattern.test(name)) {
      nameError.textContent = '이름은 한글 2~4자여야 합니다.';
      valid = false;
    }
    if (!dorm) {
      dormError.textContent = '기숙사를 선택하세요.';
      valid = false;
    }
    if (!valid) return;

    // 중복 예약 확인
    const hasReservation = Object.values(allReservations).some(r => r.roomNo === roomNo && r.name === name);

    if (hasReservation) {
      const existing = Object.values(allReservations).find(r => r.roomNo === roomNo && r.name === name);
      currentUser = { roomNo, name, dormitory: dorm };
      currentFloor = existing.floor;
      selectedSeat = existing.seat;
      setFloorOptions(dorm);
      floorSelect.value = currentFloor;
      welcomeText.textContent = `${name}님, ${dorm}입니다.`;
      selectedDormTitle.textContent = dorm;
      selectedFloorTitle.textContent = currentFloor;
      renderSeatMap(dorm, currentFloor);
      updateReservationAvailability();
      showSection(seatMapPage);
    } else {
      currentUser = { roomNo, name, dormitory: dorm };
      setFloorOptions(dorm);
      welcomeText.textContent = `${name}님, ${dorm}입니다.`;
      showSection(floorSelectPage);
    }
  });

  backToLoginBtn.addEventListener('click', () => {
    currentUser = currentFloor = selectedSeat = null;
    loginForm.reset();
    showSection(loginPage);
  });

  floorNextBtn.addEventListener('click', () => {
    const floor = floorSelect.value;
    if (!floor) {
      alert('층을 선택하세요.');
      return;
    }
    currentFloor = floor;
    selectedDormTitle.textContent = currentUser.dormitory;
    selectedFloorTitle.textContent = currentFloor;
    selectedSeat = null;
    confirmBtn.disabled = true;
    renderSeatMap(currentUser.dormitory, currentFloor);
    updateReservationAvailability();
    showSection(seatMapPage);
  });

  cancelSeatBtn.addEventListener('click', () => {
    selectedSeat = null;
    confirmBtn.disabled = true;
    showSection(floorSelectPage);
  });

  adminLoginBtn.addEventListener('click', () => {
    adminLoginForm.reset();
    adminError.textContent = '';
    showSection(adminLoginPage);
  });

  document.getElementById('adminLoginBackBtn').addEventListener('click', () => {
    showSection(loginPage);
  });

  adminLoginForm.addEventListener('submit', e => {
    e.preventDefault();
    const pw = adminPasswordInput.value.trim();
    if (pw === ADMIN_PASSWORD) {
      loadAdminPage();
      showSection(adminPage);
    } else {
      adminError.textContent = '비밀번호가 틀렸습니다.';
    }
  });

  adminLogoutBtn.addEventListener('click', () => {
    showSection(loginPage);
  });

  async function loadAdminPage() {
    reservationListBody.innerHTML = '';
    const resList = Object.values(allReservations);
    if (resList.length === 0) {
      reservationListBody.innerHTML = '<tr><td colspan="6">예약이 없습니다.</td></tr>';
    } else {
      for (const r of resList) {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${r.name}</td><td>${r.roomNo}</td><td>${r.dormitory}</td><td>${r.floor}</td><td>${r.seat}</td><td><button data-id="${r._id}" class="cancel-btn">취소</button></td>`;
        reservationListBody.appendChild(tr);
      }
      document.querySelectorAll('.cancel-btn').forEach(btn => {
        btn.addEventListener('click', async () => {
          if (confirm('예약을 취소할까요?')) {
            const id = btn.dataset.id;
            const res = await fetch(`${BACKEND_URL}/api/reservations/${id}`, {method: 'DELETE'});
            if (res.ok) alert('예약 취소되었습니다.');
            else alert('예약 취소 실패.');
          }
        });
      });
    }

    if (adminSettings.reservationStartTime) resStartTimeInput.value = new Date(adminSettings.reservationStartTime).toISOString().slice(0, 16);
    else resStartTimeInput.value = '';
    if (adminSettings.reservationEndTime) resEndTimeInput.value = new Date(adminSettings.reservationEndTime).toISOString().slice(0, 16);
    else resEndTimeInput.value = '';
    timeSettingMessage.textContent = '';
  }

  reservationTimeForm.addEventListener('submit', async e => {
    e.preventDefault();
    const start = resStartTimeInput.value;
    const end = resEndTimeInput.value;
    if (!start || !end) {
      timeSettingMessage.textContent = '예약 시간 범위를 모두 입력하세요.';
      return;
    }
    if (new Date(end) <= new Date(start)) {
      timeSettingMessage.textContent = '종료 시간은 시작 시간보다 늦어야 합니다.';
      return;
    }

    const res = await fetch(`${BACKEND_URL}/api/admin-settings`, {
      method: 'PUT',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({
        reservationStartTime: new Date(start).toISOString(),
        reservationEndTime: new Date(end).toISOString()
      })
    });
    if (res.ok) {
      timeSettingMessage.textContent = '예약 시간 설정이 저장되었습니다.';
      loadAdminPage();
    } else {
      timeSettingMessage.textContent = '예약 시간 설정 저장 중 오류가 발생했습니다.';
    }
  });

  function clearErrors() {
    roomError.textContent = '';
    nameError.textContent = '';
    dormError.textContent = '';
  }

  (async () => {
    await fetchAllReservations();
    await fetchAdminSettings();
    showSection(loginPage);
  })();
})();
</script>
</body>
</html>