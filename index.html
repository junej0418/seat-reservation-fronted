<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
<title>랜선석 예약 시스템</title>
<style>
  /* 기본 스타일 */
  body {
    font-family: 'Malgun Gothic', Arial, sans-serif;
    margin: 0; padding: 10px 0;
    background: #fafafc;
    color: #2c3e50;
  }
  h1, h2 {
    text-align: center;
    margin: 1em 0;
    color: #334155;
  }
  .container {
    max-width: 960px;
    margin: 10px auto 40px;
    background: white;
    padding: 15px 20px;
    border-radius: 12px;
    box-shadow: 0 0 20px rgba(0,0,0,0.06);
  }
  .hidden { display: none; }

  /* 폼 요소 */
  form {
    max-width: 400px;
    margin: 0 auto;
  }
  label {
    font-weight: 700;
    margin-top: 12px;
    display: block;
    color: #475569;
  }
  input[type=text], input[type=password], input[type=datetime-local], select {
    width: 100%;
    padding: 10px 12px;
    margin-top: 6px;
    font-size: 1rem;
    border: 2px solid #cbd5e1;
    border-radius: 8px;
    box-sizing: border-box;
    transition: border-color 0.3s;
  }
  input[type=text]:focus, input[type=password]:focus, input[type=datetime-local]:focus, select:focus {
    border-color: #fbbf24;
    outline: none;
  }
  .error {
    color: #dc2626;
    font-size: 0.9rem;
    height: 20px;
    margin-top: 4px;
  }

  /* 버튼 스타일 */
  button {
    background-color: #fbbf24;
    border: none;
    border-radius: 8px;
    padding: 12px 25px;
    font-size: 1.1rem;
    font-weight: 700;
    color: #92400e;
    cursor: pointer;
    margin-top: 20px;
    box-shadow: 1px 3px 6px rgba(251,191,36,0.5);
    transition: background-color 0.3s;
    display: inline-block;
    min-width: 120px;
  }
  button:hover:not(:disabled) {
    background-color: #f59e0b;
  }
  button:disabled {
    background-color: #fde68a;
    cursor: not-allowed;
  }
  nav {
    text-align: center;
    margin-top: 20px;
  }
  nav button {
    background: transparent;
    color: #b45309;
    font-weight: 600;
    padding: 8px 16px;
    border: 2px solid #fbbf24;
    border-radius: 8px;
    cursor: pointer;
    transition: background-color 0.3s;
  }
  nav button:hover {
    background-color: #fbbf24;
    color: #92400e;
  }

  /* 좌석 배치도 */
  #seatMapWrapper { /* 좌석 배치도 스크롤링을 위한 래퍼 */
    overflow-x: auto; /* 내용이 넘칠 경우 가로 스크롤 */
    -webkit-overflow-scrolling: touch; /* 모바일에서 부드러운 스크롤 */
    padding-bottom: 10px; /* 스크롤바 때문에 내용이 가려지지 않도록 */
  }

  #seatMap {
    margin: 20px auto 40px;
    display: grid;
    gap: 8px;
    justify-content: center;
    min-width: fit-content; /* 내용에 맞춰 최소 너비 설정, 스크롤 가능하게 함 */
  }
  .seat-btn {
    background: #fef3c7;
    border: 2px solid #fbbf24;
    border-radius: 6px;
    font-weight: 700;
    color: #92400e;
    cursor: pointer;
    user-select: none;
    display: flex;
    justify-content: center;
    align-items: center;
    font-size: 1.1rem;
    min-width: 44px; /* PC/태블릿 기본 좌석 너비 */
    aspect-ratio: 1/1; /* 1:1 비율 유지 */
    transition: background-color 0.3s, border-color 0.3s;
  }
  .seat-btn:hover:not(.booked) {
    background-color: #fde68a;
    border-color: #fbbf24;
  }
  .seat-btn.booked {
    background: #d1d5db;
    color: #6b7280;
    cursor: not-allowed;
  }
  .seat-btn.mine {
    background: #fef08a;
    border-color: #ca8a04;
    font-weight: 800;
  }
  .seat-btn.empty {
    visibility: hidden;
    pointer-events: none;
  }

  /* 관리자 예약 현황 테이블 */
  table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 15px;
    font-size: 1rem;
  }
  th, td {
    border: 1px solid #cbd5e1;
    padding: 10px 12px;
    text-align: center;
  }
  th {
    background-color: #fbbf24;
    color: #92400e;
  }
  td button {
    background: #ef4444;
    color: white;
    border: none;
    border-radius: 6px;
    padding: 6px 12px;
    font-weight: 600;
    cursor: pointer;
    transition: background-color 0.3s;
  }
  td button:hover {
    background: #b91c1c;
  }

  /* 예약 안내 메시지 */
  #reservationAvailabilityMessage {
    margin-top: 10px;
    font-weight: 700;
    padding: 0.5em;
    border-radius: 5px;
    text-align: center;
    color: #ef4444;
    background-color: #fee2e2;
  }
  #reservationAvailabilityMessage.available {
    color: #10b981;
    background-color: #d1fae5;
  }

  #timeSettingMessage {
    margin-top: 12px;
    text-align: center;
    font-size: 0.9rem;
    min-height: 1.5em;
  }

  /* 반응형 */
  @media (max-width: 768px) {
    .container {
      margin: 10px auto 30px;
      padding: 10px;
    }
    .seat-btn {
      min-width: 38px;
      font-size: 1rem;
    }
    h1, h2 { font-size: 1.5rem; }
  }

  @media (max-width: 480px) {
    body { padding: 5px; }
    .container {
      margin: 5px auto 20px;
      padding: 8px;
      border-radius: 8px;
    }
    h1, h2 { font-size: 1.4rem; margin: 0.8em 0; }
    label, input, select { font-size: 0.9rem; }
    button { padding: 8px 12px; font-size: 0.95rem; margin-top: 15px; min-width: auto; }
    nav button { padding: 5px 8px; font-size: 0.85rem; }
    
    #seatMap {
      gap: 4px;
    }
    .seat-btn {
      min-width: 26px; /* 휴대폰 등 작은 화면에서의 좌석 최소 너비 */
      font-size: 0.85rem;
      padding: 0;
    }
    table { font-size: 0.8rem; }
    th, td { padding: 6px 4px; }
    td button { padding: 3px 6px; font-size: 0.75rem; }
  }
</style>
</head>
<body>

<!-- 로그인 페이지 -->
<div class="container" id="loginPage">
  <h1>랜선석 예약 로그인</h1>
  <form id="loginForm" autocomplete="off" novalidate>
    <label for="roomNo">룸 번호 (000호 형식):</label>
    <input type="text" id="roomNo" name="roomNo" placeholder="예: 101호" required />
    <div id="roomError" class="error"></div>

    <label for="userName">이름 (한글 2~4자):</label>
    <input type="text" id="userName" name="userName" placeholder="예: 홍길동" required />
    <div id="nameError" class="error"></div>

    <label for="dormitory">기숙사 선택:</label>
    <select id="dormitory" name="dormitory" required>
      <option value="" disabled selected>선택하세요</option>
      <option value="꿈동">꿈동</option>
      <option value="미래동">미래동</option>
    </select>
    <div id="dormError" class="error"></div>

    <!-- 🍯 허니팟 필드 추가: 봇만 채워넣는 숨겨진 필드 -->
    <input type="text" name="honeypot_field" style="display: none !important; visibility: hidden !important; opacity: 0 !important; width: 0 !important; height: 0 !important; border: none !important; padding: 0 !important; margin: 0 !important;" tabindex="-1" autocomplete="off" />

    <button type="submit">다음</button>
  </form>
  <nav>
    <button id="adminLoginBtn" type="button">관리자 로그인</button>
  </nav>
</div>

<!-- 층 선택 페이지 -->
<div class="container hidden" id="floorSelectPage">
  <!-- "님" 중복 해결을 위해 HTML에서 "님, 층을 선택해주세요" 로 고정하고 welcomeText는 이름과 기숙사만 표시 -->
  <h2><span id="welcomeText"></span>님, 층을 선택해주세요</h2> 
  <select id="floorSelect" required>
    <option value="" disabled selected>층 선택</option>
  </select>
  <button id="floorNextBtn" type="button">좌석 선택으로</button>
  <button id="backToLoginBtn" type="button">뒤로가기</button>
</div>

<!-- 좌석 선택 페이지 -->
<div class="container hidden" id="seatMapPage">
  <h2>좌석 배치도 - <span id="selectedDorm"></span> <span id="selectedFloor"></span>층</h2>
  <div id="seatMapWrapper">
    <div id="seatMap"></div>
  </div>
  <div id="reservationAvailabilityMessage"></div>
  <button id="confirmBtn" type="button" disabled>예약 확정</button>
  <button id="cancelSeatBtn" type="button">취소 및 뒤로가기</button>
</div>

<!-- 관리자 로그인 페이지 -->
<div class="container hidden" id="adminLoginPage">
  <h1>관리자 로그인</h1>
  <form id="adminLoginForm" autocomplete="off" novalidate>
    <label for="adminPassword">비밀번호:</label>
    <input type="password" id="adminPassword" name="adminPassword" required />
    <div id="adminError" class="error"></div>
    <button type="submit">로그인</button>
  </form>
  <button id="adminLoginBackBtn" type="button">로그인페이지로 돌아가기</button>
</div>

<!-- 관리자 페이지 -->
<div class="container hidden" id="adminPage">
  <h1>관리자 페이지</h1>
  <button id="adminLogoutBtn" type="button">로그아웃</button>

  <h2>예약 가능 시간 설정</h2>
  <form id="reservationTimeForm" novalidate>
    <label for="resStartTime">예약 시작 시간:</label>
    <input type="datetime-local" id="resStartTime" required />
    <label for="resEndTime">예약 종료 시간:</label>
    <input type="datetime-local" id="resEndTime" required />
    <button type="submit">시간 설정 저장</button>
    <div id="timeSettingMessage"></div>
  </form>

  <hr style="margin: 2em 0;">

  <h2>예약 현황</h2>
  <table>
    <thead>
      <tr><th>이름</th><th>룸 번호</th><th>기숙사</th><th>층</th><th>자리 번호</th><th>예약 취소</th></tr>
    </thead>
    <tbody id="reservationListBody"></tbody>
  </table>

  <button id="clearAllReservationsBtn" type="button" style="background-color: #dc2626; color: white; float: right; margin-top: 15px;">모든 예약 취소</button>
</div>

<script src="https://seat-reservation-backend-ygl9.onrender.com/socket.io/socket.io.js"></script>
<script>
(() => {
  const BACKEND_URL = "https://seat-reservation-backend-ygl9.onrender.com";
  const socket = io(BACKEND_URL);
  // ADMIN_PASSWORD 상수는 프론트엔드에서 제거했습니다. 이제 백엔드에서 검증합니다.

  let allReservations = {};
  let adminSettings = {};
  let availabilityCheckInterval = null;
  let prevAllowedState = null;

  // DOM 요소 참조 (getElementById는 항상 스크립트 로드 시점에 존재해야 함)
  const loginPage = document.getElementById('loginPage');
  const loginForm = document.getElementById('loginForm');
  const roomNoInput = document.getElementById('roomNo');
  const userNameInput = document.getElementById('userName');
  const dormitorySelect = document.getElementById('dormitory');
  const roomError = document.getElementById('roomError');
  const nameError = document.getElementById('nameError');
  const dormError = document.getElementById('dormError');
  const adminLoginBtn = document.getElementById('adminLoginBtn');

  const floorSelectPage = document.getElementById('floorSelectPage');
  const floorSelect = document.getElementById('floorSelect');
  const floorNextBtn = document.getElementById('floorNextBtn');
  const backToLoginBtn = document.getElementById('backToLoginBtn');
  const welcomeText = document.getElementById('welcomeText'); 

  const seatMapPage = document.getElementById('seatMapPage');
  const seatMapContainer = document.getElementById('seatMap');
  const confirmBtn = document.getElementById('confirmBtn');
  const cancelSeatBtn = document.getElementById('cancelSeatBtn');
  const selectedDormTitle = document.getElementById('selectedDorm');
  const selectedFloorTitle = document.getElementById('selectedFloor');
  const reservationAvailabilityMessage = document.getElementById('reservationAvailabilityMessage');

  const adminLoginPage = document.getElementById('adminLoginPage');
  const adminLoginForm = document.getElementById('adminLoginForm');
  const adminPasswordInput = document.getElementById('adminPassword');
  const adminError = document.getElementById('adminError');

  const adminPage = document.getElementById('adminPage');
  const adminLogoutBtn = document.getElementById('adminLogoutBtn');
  const reservationListBody = document.getElementById('reservationListBody');
  const clearAllReservationsBtn = document.getElementById('clearAllReservationsBtn');

  const reservationTimeForm = document.getElementById('reservationTimeForm');
  const resStartTimeInput = document.getElementById('resStartTime');
  const resEndTimeInput = document.getElementById('resEndTime');
  const timeSettingMessage = document.getElementById('timeSettingMessage');

  let currentUser = null;
  let currentFloor = null;
  let selectedSeat = null;

  const roomNoPattern = /^\d{3}호$/;
  const koreanNamePattern = /^[가-힣]{2,4}$/;

  const seatLayouts = {
    "꿈동": {
      "2": [
        [null,4,null,5,6,7,8,9,10,null,null,null,null],
        [null,3,null,null,null,null,null,null,null,11,null,null,null],
        [null,2,null,null,null,null,null,null,null,12,null,null,null],
        [null,1,null,null,null,null,null,null,null,null,null,null,null]
      ],
      "3": [
        [null,4,null,5,6,7,8,9,10,null,11,null,null,null],
        [null,3,null,null,null,null,null,null,null,null,12,null,null,null],
        [null,2,null,null,null,null,null,null,null,null,13,null,null,null],
        [null,1,null,null,null,null,null,null,null,null,14,null,null,null]
      ],
      "4": [
        [null,4,null,null,null,null,null,null,null,null],
        [null,3,null,null,5,7,null,null,null,null],
        [null,2,null,null,6,8,null,null,null,null],
        [null,1,null,null,null,null,null,null,null,null]
      ],
      "5": [
        [null,4,null,null,null,5,8,null,null,null],
        [null,3,null,null,null,6,9,null,null,null],
        [null,2,null,null,null,7,10,null,null,null],
        [null,1,null,null,null,null,null,null,null,null]
      ],
      "8": [
        [null,4,null,5,6,7,8,null,null,null,null,null,null],
        [null,3,null,null,null,null,null,null,null,null,null,null,null],
        [null,2,null,null,null,null,null,null,null,null,null,null,null],
        [null,1,null,null,null,null,null,null,null,null,null,null,null]
      ]
    },
    "미래동": {
      "2": [
        [null,null,null,null,null,5,6,7,8,9,10,11,12,null,null,null,null,null],
        [null,null,null,null,4,null,null,null,null,null,null,null,null,13,null,null,null,null],
        [null,null,null,null,3,null,null,null,null,null,null,null,null,14,null,null,null,null],
        [null,null,1,2,null,null,null,null,null,null,null,null,null,null,15,16,null,null],
        [null,17,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null]
      ],
      // 4-1층 좌석 배치도 - 수정된 내용으로 반영
      "4-1": [
        [null,3,null,4,5,null,6,null,null],
        [null,2,null,null,null,null,7,null,null],
        [null,1,null,null,null,null,8,null,null]
      ],
      "4-2": [
        [null,4,null,5,6,7,8,9,10,11,12,null,13,null],
        [null,3,null,null,null,null,null,null,null,null,null,null,14,null],
        [null,2,null,null,null,null,null,null,null,null,null,null,null,null],
        [null,1,null,null,null,null,null,null,null,null,null,null,null,null]
      ]
    }
  };

  // --- API 통신 함수들 ---
  async function fetchAllReservations() {
    console.log('Fetching all reservations...');
    try {
      const res = await fetch(`${BACKEND_URL}/api/reservations`);
      if (!res.ok) throw new Error('예약 데이터 불러오기 실패: ' + res.statusText);
      const data = await res.json();
      allReservations = {};
      data.forEach(r => allReservations[r._id] = r);
      console.log('Reservations fetched successfully:', Object.keys(allReservations).length, 'reservations found.');
    } catch (e) {
      alert('예약 데이터를 가져오는 데 문제가 발생했습니다. 백엔드 서버 상태를 확인하세요.');
      console.error('API 호출 에러: 예약 데이터 로드 실패', e);
      return {};
    }
  }

  async function fetchAdminSettings() {
    console.log('Fetching admin settings...');
    try {
      const res = await fetch(`${BACKEND_URL}/api/admin-settings`);
      if (!res.ok) throw new Error('관리자 설정 불러오기 실패: ' + res.statusText);
      adminSettings = await res.json();
      console.log('Admin settings fetched successfully:', adminSettings);
    } catch (e) {
      alert('관리자 설정을 가져오는 데 문제가 발생했습니다. 백엔드 서버 상태를 확인하세요.');
      console.error('API 호출 에러: 관리자 설정 로드 실패', e);
      return { reservationStartTime: null, reservationEndTime: null };
    }
  }

  // --- Socket.IO 이벤트 리스너 (실시간 동기화) ---
  if (socket) {
    socket.on('reservationsUpdated', async updated => {
      console.log('🔗 Socket.IO: 예약 데이터 실시간 업데이트 수신');
      allReservations = {};
      updated.forEach(r => allReservations[r._id] = r);
      // 현재 보고 있는 화면에 따라 UI 갱신
      if (!seatMapPage.classList.contains("hidden") && currentUser && currentFloor) {
        renderSeatMap(currentUser.dormitory, currentFloor);
      }
      if (!adminPage.classList.contains("hidden")) {
        await loadAdminPage(); // 관리자 페이지 업데이트 시에도 예약 목록 정렬 유지
      }
      console.log('🔗 Socket.IO: 예약 데이터 실시간 업데이트 완료');
    });

    socket.on('settingsUpdated', async updated => {
      console.log('🔗 Socket.IO: 관리자 설정 실시간 업데이트 수신');
      adminSettings = updated;
      // 현재 보고 있는 화면에 따라 UI 갱신
      if (!adminPage.classList.contains("hidden")) {
        await loadAdminPage(); // 관리자 페이지 업데이트
      }
      updateReservationAvailability(); 
      if (!seatMapPage.classList.contains("hidden") && currentUser && currentFloor) {
        renderSeatMap(currentUser.dormitory, currentFloor);
      }
      console.log('🔗 Socket.IO: 관리자 설정 실시간 업데이트 완료');
    });
  }

  // --- 예약 가능 시간 확인 로직 ---
  function isReservationTimeAllowed() {
    if (!adminSettings.reservationStartTime || !adminSettings.reservationEndTime) {
      return { allowed: false, message: '관리자가 예약 가능 시간을 설정하지 않았습니다.' };
    }
    const now = new Date();
    const startTime = new Date(adminSettings.reservationStartTime);
    const endTime = new Date(adminSettings.reservationEndTime);
    
    return now >= startTime && now <= endTime
      ? { allowed: true, message: `예약 가능 시간입니다. (${formatDate(startTime)} ~ ${formatDate(endTime)})` }
      : { allowed: false, message: `현재 예약 가능 시간이 아닙니다. (${formatDate(startTime)} ~ ${formatDate(endTime)})` };
  }

  // 날짜 포맷팅 유틸리티
  function formatDate(date) {
    const pad = n => (n < 10 ? '0' + n : n);
    return `${pad(date.getMonth() + 1)}-${pad(date.getDate())} ${pad(date.getHours())}:${pad(date.getMinutes())}`;
  }

  // --- UI 페이지 전환 ---
  function showSection(section) {
    console.log('Showing section:', section.id);
    [loginPage, floorSelectPage, seatMapPage, adminLoginPage, adminPage].forEach(el => el.classList.add('hidden'));
    section.classList.remove('hidden');
    
    // 예약 가능 시간 실시간 체크 인터벌 관리 (새로고침 없이 바로 반영되도록)
    if (section === seatMapPage) {
      if (availabilityCheckInterval) clearInterval(availabilityCheckInterval); // 기존 인터벌 클리어
      updateReservationAvailability(); // 즉시 한번 호출하여 초기 상태 반영
      availabilityCheckInterval = setInterval(updateReservationAvailability, 1000); 
    } else {
      if (availabilityCheckInterval) {
        clearInterval(availabilityCheckInterval);
        availabilityCheckInterval = null;
      }
    }
  }

  // --- 이벤트 리스너 ---
  loginForm.addEventListener('submit', async e => {
    console.log('Login form submitted. Event triggered.');
    e.preventDefault(); // 중요: 폼 기본 제출 동작 방지

    // 모든 에러 메시지 초기화
    clearErrors(); 

    const roomNo = roomNoInput.value.trim();
    const name = userNameInput.value.trim();
    const selectedDorm = dormitorySelect.value; // **수정: dormitorySelect.value를 변수에 저장**

    console.log('Input values:', { roomNo, name, selectedDorm }); // 입력 값 확인

    let valid = true; // 입력 유효성 검사 플래그
    if (!roomNoPattern.test(roomNo)) {
      roomError.textContent = '룸 번호는 000호 형식으로 입력하세요.';
      valid = false;
    }
    if (!koreanNamePattern.test(name)) {
      nameError.textContent = '이름은 한글 2~4자여야 합니다.';
      valid = false;
    }
    if (!selectedDorm) { // **수정: selectedDorm 사용**
      dormError.textContent = '기숙사를 선택하세요.';
      valid = false;
    }

    if (!valid) {
      console.log('Login form validation failed. Not proceeding.');
      return; // 유효성 검사 실패 시 여기서 함수 종료
    }
    console.log('Login form validation passed. Proceeding with logic.');

    // 기존 예약 확인 (allReservations는 최신 데이터)
    const hasReservation = Object.values(allReservations).some(r => r.roomNo === roomNo && r.name === name);
    console.log('User has existing reservation?', hasReservation);

    if (hasReservation) {
      const existing = Object.values(allReservations).find(r => r.roomNo === roomNo && r.name === name);
      currentUser = {roomNo, name, dormitory: selectedDorm}; // **수정: selectedDorm 사용**
      currentFloor = existing.floor;
      selectedSeat = existing.seat;
      setFloorOptions(selectedDorm); // **수정: selectedDorm 사용**
      floorSelect.value = currentFloor;
      welcomeText.textContent = `${name} (${selectedDorm} 기숙사)`; // **수정: selectedDorm 사용**
      selectedDormTitle.textContent = selectedDorm; // **수정: selectedDorm 사용**
      selectedFloorTitle.textContent = currentFloor;
      renderSeatMap(selectedDorm, currentFloor); // **수정: selectedDorm 사용**
      updateReservationAvailability();
      console.log('Existing user: Redirecting to seat map page.');
      showSection(seatMapPage);
    } else {
      // 새로운 예약인 경우, 층 선택 페이지로 이동
      currentUser = {roomNo, name, dormitory: selectedDorm}; // **수정: selectedDorm 사용**
      setFloorOptions(selectedDorm); // **수정: selectedDorm 사용**
      welcomeText.textContent = `${name} (${selectedDorm} 기숙사)`; // **수정: selectedDorm 사용**
      console.log('New user: Redirecting to floor select page.');
      showSection(floorSelectPage);
    }
  });

  backToLoginBtn.addEventListener('click', () => {
    console.log('Back to Login button clicked.');
    currentUser = currentFloor = selectedSeat = null;
    loginForm.reset();
    showSection(loginPage);
  });

  floorNextBtn.addEventListener('click', () => {
    console.log('Floor Next button clicked.');
    const floor = floorSelect.value;
    if (!floor) {
      alert('층을 선택하세요.');
      console.log('Floor not selected.');
      return;
    }
    currentFloor = floor;
    selectedDormTitle.textContent = currentUser.dormitory;
    selectedFloorTitle.textContent = currentFloor;
    selectedSeat = null;
    confirmBtn.disabled = true;
    renderSeatMap(currentUser.dormitory, currentFloor);
    updateReservationAvailability();
    showSection(seatMapPage);
  });

  cancelSeatBtn.addEventListener('click', () => {
    console.log('Cancel Seat button clicked.');
    selectedSeat = null;
    confirmBtn.disabled = true;
    showSection(floorSelectPage);
  });

  adminLoginBtn.addEventListener('click', () => {
    console.log('Admin Login button clicked.');
    adminLoginForm.reset();
    adminError.textContent = '';
    showSection(adminLoginPage);
  });

  document.getElementById('adminLoginBackBtn').addEventListener('click', () => {
    console.log('Admin Login Back button clicked.');
    showSection(loginPage);
  });

  adminLoginForm.addEventListener('submit', async e => {
    console.log('Admin login form submitted. Event triggered.'); // 디버깅
    e.preventDefault();
    const pw = adminPasswordInput.value.trim();

    try {
        console.log('Sending admin login request to backend...'); // 디버깅
        const response = await fetch(`${BACKEND_URL}/api/admin-login`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ password: pw })
        });
        const result = await response.json();
        
        console.log('Admin login response:', result); // 디버깅
        if (result.success) { // 백엔드가 { success: true }를 반환
            console.log('Admin login successful. Redirecting to admin page.'); // 디버깅
            await loadAdminPage(); // 관리자 페이지 데이터 로드
            showSection(adminPage);
        } else {
            console.log('Admin login failed. Message:', result.message); // 디버깅
            adminError.textContent = result.message || '로그인 실패: 알 수 없는 오류';
        }
    } catch (error) {
        console.error('Admin login fetch error:', error); // 디버깅
        adminError.textContent = '로그인 요청 중 오류 발생. 서버를 확인하세요.';
    }
  });

  adminLogoutBtn.addEventListener('click', () => {
    showSection(loginPage);
  });

  // --- 좌석 배치도 관련 함수들 ---
  function setFloorOptions(dorm) {
    console.log('setFloorOptions called with dorm:', dorm); // 디버깅
    if (!seatLayouts[dorm]) {
        console.error('Error: seatLayouts[' + dorm + '] is undefined or null. Check dorm value and seatLayouts definition.');
        floorSelect.innerHTML = '<option value="" disabled selected>해당 기숙사의 층 정보가 없습니다.</option>';
        return; // Early exit to prevent error
    }

    floorSelect.innerHTML = '<option value="" disabled selected>층 선택</option>';
    const floors = Object.keys(seatLayouts[dorm]).sort((a,b) => {
      const parseFloor = (f) => parseFloat(f.replace('-', '.'));
      return parseFloor(a) - parseFloor(b);
    });
    console.log('Available floors for dorm', dorm + ':', floors); // 디버깅
    floors.forEach(floor => {
      const option = document.createElement('option');
      option.value = floor;
      option.textContent = floor.includes('-') ? floor.replace('-', '층-') : floor + '층';
      floorSelect.appendChild(option);
    });
  }

  function renderSeatMap(dorm, floor) {
    console.log('renderSeatMap called with dorm:', dorm, 'floor:', floor); // 디버깅
    seatMapContainer.innerHTML = '';
    const layout = seatLayouts[dorm]?.[floor];
    if (!layout) {
      seatMapContainer.textContent = '해당 층 좌석 배치도가 없습니다.';
      console.warn('Layout for', dorm, floor, 'is undefined or null.'); // 디버깅
      return;
    }
    // 그리드 컬럼 설정 (반응형: 1fr로 유연하게, minmax로 최소 크기 보장)
    const maxCols = Math.max(...layout.map(row => row.length));
    seatMapContainer.style.gridTemplateColumns = `repeat(${maxCols}, 1fr)`;

    const allowed = isReservationTimeAllowed().allowed;

    layout.forEach(row => {
      row.forEach(seatNum => {
        const btn = document.createElement('button');
        btn.type = 'button';

        if (seatNum === null) {
          btn.classList.add('seat-btn', 'empty');
          btn.textContent = '';
        } else {
          btn.classList.add('seat-btn');
          btn.textContent = seatNum;

          const booked = Object.values(allReservations).find(r => r.dormitory===dorm && r.floor===floor && r.seat===seatNum);

          if (booked) {
            btn.classList.add('booked');
            btn.disabled = true; // 기본적으로 예약된 좌석은 비활성화

            // 일반 사용자 화면에서는 예약자 이름 숨기기
            btn.title = `예약된 좌석`; 

            // 자신의 예약인 경우만 이름 표시 및 활성화
            if (currentUser && booked.roomNo===currentUser.roomNo && booked.name===currentUser.name) {
              btn.classList.add('mine');
              btn.disabled = false; // 자신의 예약 좌석은 다시 활성화
              btn.title = `내 예약 (${booked.name}님)`; // 자신의 예약은 이름 표시
            }
          } else {
            // 예약 가능 여부에 따라 좌석 버튼 활성화/비활성화
            btn.disabled = !allowed;
            btn.title = allowed ? '예약 가능 자리' : '예약 가능 시간이 아닙니다.';
            btn.onclick = () => {
              if (allowed) { // 예약 가능한 시간인 경우에만 좌석 선택 가능
                selectedSeat = seatNum;
                confirmBtn.disabled = false;
                highlightSelectedSeat();
              }
            };
          }
        }
        seatMapContainer.appendChild(btn);
      });
    });
    highlightSelectedSeat();
  }

  function highlightSelectedSeat() {
    seatMapContainer.querySelectorAll("button.seat-btn").forEach(btn => {
      btn.classList.toggle("mine", parseInt(btn.textContent) === selectedSeat);
    });
  }

  function updateReservationAvailability() {
    const status = isReservationTimeAllowed();
    reservationAvailabilityMessage.textContent = status.message;

    // 예약 가능 상태가 변경되었는지 감지
    const currentAllowedState = status.allowed;
    const hasAllowedStateChanged = (prevAllowedState !== null && prevAllowedState !== currentAllowedState);
    prevAllowedState = currentAllowedState; // 다음 체크를 위해 현재 상태 저장

    if (currentAllowedState) {
      reservationAvailabilityMessage.classList.add("available");
      confirmBtn.disabled = (selectedSeat === null);
    } else {
      reservationAvailabilityMessage.classList.remove("available");
      confirmBtn.disabled = true;
    }
    
    // 예약 가능 상태가 변경되었고 현재 좌석 배치도 화면이라면, 좌석 버튼 상태도 즉시 업데이트
    if (hasAllowedStateChanged && !seatMapPage.classList.contains("hidden") && currentUser && currentFloor) {
        renderSeatMap(currentUser.dormitory, currentFloor); // 좌석의 활성화/비활성화 상태를 갱신하기 위해 다시 렌더링
    }
  }

  confirmBtn.addEventListener("click", async () => {
    if (!selectedSeat) {
      alert("좌석을 선택해주세요.");
      return;
    }
    if (!isReservationTimeAllowed().allowed) {
      alert("예약 가능 시간이 아닙니다.");
      updateReservationAvailability();
      return;
    }

    try {
      await fetch(`${BACKEND_URL}/api/reservations/user/${currentUser.roomNo}/${currentUser.name}`, {
        method: "DELETE",
      });
    } catch (e) {
      console.warn("기존 예약 삭제 중 오류:", e);
    }

    try {
      const response = await fetch(`${BACKEND_URL}/api/reservations`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          roomNo: currentUser.roomNo,
          name: currentUser.name,
          dormitory: currentUser.dormitory,
          floor: currentFloor,
          seat: selectedSeat,
        }),
      });
      const result = await response.json();

      if (response.ok) {
        alert(`${currentUser.dormitory} ${currentFloor}층 ${selectedSeat}번 자리 예약 완료!`);
        currentUser = null;
        currentFloor = null;
        selectedSeat = null;
        loginForm.reset();
        showSection(loginPage);
      } else {
        alert("예약 실패: " + (result.message || "알 수 없는 오류"));
        if (currentUser && currentFloor) renderSeatMap(currentUser.dormitory, currentFloor);
      }
    } catch (e) {
      alert("예약 처리 중 오류가 발생했습니다. 서버 상태를 확인하세요.");
      console.error(e);
    }
  });

  // --- 관리자 페이지 관련 함수들 ---
  async function loadAdminPage() {
    reservationListBody.innerHTML = "";
    let resArr = Object.values(allReservations);
    
    // 예약 현황 위치별 정렬 로직
    resArr.sort((a, b) => {
        // 1. 기숙사별 정렬 (꿈동 < 미래동 등)
        if (a.dormitory !== b.dormitory) {
            return a.dormitory.localeCompare(b.dormitory);
        }
        // 2. 층별 정렬 (숫자 순, '4-1' 같은 형식도 고려)
        const parseFloor = (f) => parseFloat(f.replace('-', '.'));
        if (parseFloor(a.floor) !== parseFloor(b.floor)) {
            return parseFloor(a.floor) - parseFloor(b.floor);
        }
        // 3. 좌석 번호별 정렬
        return a.seat - b.seat;
    });

    if (resArr.length === 0) {
      reservationListBody.innerHTML = '<tr><td colspan="6">등록된 예약이 없습니다.</td></tr>';
      return;
    }
    resArr.forEach((resv) => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${resv.name}</td>
        <td>${resv.roomNo}</td>
        <td>${resv.dormitory}</td>
        <td>${resv.floor}</td>
        <td>${resv.seat}</td>
        <td><button type="button" class="cancel-btn" data-id="${resv._id}">취소</button></td>`;
      reservationListBody.appendChild(tr);
    });
    document.querySelectorAll(".cancel-btn").forEach((btn) => {
      btn.onclick = async () => {
        if (confirm("정말 예약을 취소하시겠습니까?")) {
          const id = btn.dataset.id;
          const res = await fetch(`${BACKEND_URL}/api/reservations/${id}`, { method: "DELETE" });
          if (res.ok) alert("예약이 취소되었습니다.");
          else alert("예약 취소 실패");
        }
      };
    });

    if (adminSettings.reservationStartTime)
      resStartTimeInput.value = new Date(adminSettings.reservationStartTime).toISOString().slice(0, 16);
    else resStartTimeInput.value = "";
    if (adminSettings.reservationEndTime)
      resEndTimeInput.value = new Date(adminSettings.reservationEndTime).toISOString().slice(0, 16);
    else resEndTimeInput.value = "";
    timeSettingMessage.textContent = "";
  }

  // 모든 예약 취소 버튼 이벤트
  clearAllReservationsBtn.addEventListener('click', async () => {
      if (!confirm('정말 모든 예약을 취소하시겠습니까? 이 작업은 되돌릴 수 없습니다!')) {
          return;
      }
      try {
          const response = await fetch(`${BACKEND_URL}/api/reservations/all`, {
              method: 'DELETE'
          });
          if (response.ok) {
              alert('모든 예약이 성공적으로 취소되었습니다.');
          } else {
              const errorResult = await response.json();
              alert(`모든 예약 취소 실패: ${errorResult.message || '알 수 없는 오류'}`);
          }
      } catch (e) {
          console.error('모든 예약 취소 중 오류 발생:', e);
          alert('모든 예약 취소 중 통신 오류가 발생했습니다. 백엔드 서버를 확인하세요.');
      }
  });


  reservationTimeForm.addEventListener("submit", async (e) => {
    e.preventDefault();

    if (!resStartTimeInput.value || !resEndTimeInput.value) {
      timeSettingMessage.textContent = "시작과 종료 시간을 모두 입력하세요.";
      timeSettingMessage.style.color = "red";
      return;
    }

    if (new Date(resEndTimeInput.value) <= new Date(resStartTimeInput.value)) {
      timeSettingMessage.textContent = "종료 시간은 시작 시간보다 늦어야 합니다.";
      timeSettingMessage.style.color = "red";
      return;
    }

    try {
      const res = await fetch(`${BACKEND_URL}/api/admin-settings`, {
        method: "PUT",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          reservationStartTime: new Date(resStartTimeInput.value).toISOString(),
          reservationEndTime: new Date(resEndTimeInput.value).toISOString(),
        }),
      });

      if (res.ok) {
        timeSettingMessage.textContent = "예약 가능 시간이 설정되었습니다.";
        timeSettingMessage.style.color = "green";
        await loadAdminPage(); // 설정 변경 후 관리자 페이지 즉시 업데이트
      } else {
        timeSettingMessage.textContent = "설정 실패";
        timeSettingMessage.style.color = "red";
      }
    } catch (e) {
      console.error(e);
      timeSettingMessage.textContent = "서버 오류 발생";
      timeSettingMessage.style.color = "red";
    }
  });

  function clearErrors() {
    roomError.textContent = "";
    nameError.textContent = "";
    dormError.textContent = "";
  }

  // 초기 데이터 로드 및 페이지 표시
  // `DOMContentLoaded` 이벤트를 사용하여 DOM이 완전히 로드된 후에 초기화 함수 호출
  document.addEventListener('DOMContentLoaded', async () => {
      console.log('DOM Content Loaded. Starting initial fetches.');
      
      // 혹시 모를 DOM 요소 참조 오류 방지 (추가 디버깅 포인트)
      // 이 로그가 잘 뜨는지 확인해주세요.
      if (!loginPage) console.error('Error: loginPage element not found!');
      if (!loginForm) console.error('Error: loginForm element not found!');
      if (!roomNoInput) console.error('Error: roomNoInput element not found!');
      if (!userNameInput) console.error('Error: userNameInput element not found!');
      if (!dormitorySelect) console.error('Error: dormitorySelect element not found!');
      if (!roomError) console.error('Error: roomError element not found!');
      if (!nameError) console.error('Error: nameError element not found!');
      if (!dormError) console.error('Error: dormError element not found!');
      if (!adminLoginBtn) console.error('Error: adminLoginBtn element not found!');

      if (!floorSelectPage) console.error('Error: floorSelectPage element not found!');
      if (!floorSelect) console.error('Error: floorSelect element not found!');
      if (!floorNextBtn) console.error('Error: floorNextBtn element not found!');
      if (!backToLoginBtn) console.error('Error: backToLoginBtn element not found!');
      if (!welcomeText) console.error('Error: welcomeText element not found!');

      if (!seatMapPage) console.error('Error: seatMapPage element not found!');
      if (!seatMapContainer) console.error('Error: seatMapContainer element not found!');
      if (!confirmBtn) console.error('Error: confirmBtn element not found!');
      if (!cancelSeatBtn) console.error('Error: cancelSeatBtn element not found!');
      if (!selectedDormTitle) console.error('Error: selectedDormTitle element not found!');
      if (!selectedFloorTitle) console.error('Error: selectedFloorTitle element not found!');
      if (!reservationAvailabilityMessage) console.error('Error: reservationAvailabilityMessage element not found!');

      if (!adminLoginPage) console.error('Error: adminLoginPage element not found!');
      if (!adminLoginForm) console.error('Error: adminLoginForm element not found!');
      if (!adminPasswordInput) console.error('Error: adminPasswordInput element not found!');
      if (!adminError) console.error('Error: adminError element not found!');

      if (!adminPage) console.error('Error: adminPage element not found!');
      if (!adminLogoutBtn) console.error('Error: adminLogoutBtn element not found!');
      if (!reservationListBody) console.error('Error: reservationListBody element not found!');
      if (!clearAllReservationsBtn) console.error('Error: clearAllReservationsBtn element not found!');

      if (!reservationTimeForm) console.error('Error: reservationTimeForm element not found!');
      if (!resStartTimeInput) console.error('Error: resStartTimeInput element not found!');
      if (!resEndTimeInput) console.error('Error: resEndTimeInput element not found!');
      if (!timeSettingMessage) console.error('Error: timeSettingMessage element not found!');

      // 만약 위에서 어떤 에러라도 발생한다면, 이 아래 함수들은 호출되지 않아야 합니다.
      // 실제 코드가 실행되는지를 확인하기 위한 로그
      console.log('All element references checked. Starting fetch operations.');
      
      await fetchAllReservations();
      await fetchAdminSettings();
      console.log('Initial fetches completed. Showing login page.');
      showSection(loginPage);
  });
})();
</script>
</body>
</html>