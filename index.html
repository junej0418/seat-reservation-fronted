<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
<title>랜선석 예약 시스템</title>
<style>
  /* 기본 스타일 */
  body {
    font-family: 'Malgun Gothic', Arial, sans-serif;
    margin: 0; padding: 10px 0;
    background: #fafafc;
    color: #2c3e50;
  }
  h1, h2 {
    text-align: center;
    margin: 1em 0;
    color: #334155;
  }
  .container {
    max-width: 960px;
    margin: 10px auto 40px;
    background: white;
    padding: 15px 20px;
    border-radius: 12px;
    box-shadow: 0 0 20px rgba(0,0,0,0.06);
  }
  .hidden { display: none !important; } /* 중요! */

  form {
    max-width: 400px;
    margin: 0 auto;
  }
  label {
    font-weight: 700;
    margin-top: 12px;
    display: block;
    color: #475569;
  }
  input[type=text], input[type=password], input[type=datetime-local], select, textarea {
    width: 100%;
    padding: 10px 12px;
    margin-top: 6px;
    font-size: 1rem;
    border: 2px solid #cbd5e1;
    border-radius: 8px;
    box-sizing: border-box;
    transition: border-color 0.3s;
  }
  input[type=text]:focus, input[type=password]:focus, input[type=datetime-local]:focus,
  select:focus, textarea:focus {
    border-color: #fbbf24;
    outline: none;
  }
  .error {
    color: #dc2626;
    font-size: 0.9rem;
    height: 20px;
    margin-top: 4px;
  }

  button {
    background-color: #fbbf24;
    border: none;
    border-radius: 8px;
    padding: 12px 25px;
    font-size: 1.1rem;
    font-weight: 700;
    color: #92400e;
    cursor: pointer;
    margin-top: 20px;
    box-shadow: 1px 3px 6px rgba(251,191,36,0.5);
    transition: background-color 0.3s;
    display: inline-block;
    min-width: 120px;
  }
  button:hover:not(:disabled) {
    background-color: #f59e0b;
  }
  button:disabled {
    background-color: #fde68a;
    cursor: not-allowed;
  }
  nav {
    text-align: center;
    margin-top: 20px;
  }
  nav button {
    background: transparent;
    color: #b45309;
    font-weight: 600;
    padding: 8px 16px;
    border: 2px solid #fbbf24;
    border-radius: 8px;
    cursor: pointer;
    transition: background-color 0.3s;
  }
  nav button:hover {
    background-color: #fbbf24;
    color: #92400e;
  }

  #seatMapWrapper {
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
    padding-bottom: 10px;
  }
  #seatMap {
    margin: 20px auto 40px;
    display: grid;
    gap: 8px;
    justify-content: center;
    min-width: fit-content;
  }
  .seat-btn {
    background: #CCFFCC;
    border: 2px solid #88CC88;
    font-weight: 700;
    color: #336633;
    cursor: pointer;
    user-select: none;
    display: flex;
    justify-content: center;
    align-items: center;
    font-size: 1.1rem;
    min-width: 44px;
    aspect-ratio: 1 / 1;
    border-radius: 6px;
    transition: background-color 0.3s, border-color 0.3s;
  }
  .seat-btn:hover:not(.booked) {
    background-color: #AACC88;
    border-color: #669944;
  }
  .seat-btn.booked {
    background: #FFCCCC;
    border: 2px solid #CC8888;
    color: #663333;
    cursor: not-allowed;
  }
  .seat-btn.mine {
    background: #FFCCFF;
    border: 2px solid #CC88CC;
    color: #663366;
  }
  .seat-btn.empty {
    visibility: hidden;
    pointer-events: none;
  }

  table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 15px;
    font-size: 1rem;
  }
  th, td {
    border: 1px solid #cbd5e1;
    padding: 10px 12px;
    text-align: center;
  }
  th {
    background-color: #fbbf24;
    color: #92400e;
  }
  td button {
    background: #ef4444;
    color: white;
    border: none;
    border-radius: 6px;
    padding: 6px 12px;
    font-weight: 600;
    cursor: pointer;
    transition: background-color 0.3s;
  }
  td button:hover {
    background: #b91c1c;
  }

  #reservationAvailabilityMessage {
    margin-top: 10px;
    font-weight: 700;
    padding: 0.5em;
    border-radius: 5px;
    text-align: center;
    color: #ef4444;
    background-color: #fee2e2;
  }
  #reservationAvailabilityMessage.available {
    color: #10b981;
    background-color: #d1fae5;
  }

  #timeSettingMessage {
    margin-top: 12px;
    text-align: center;
    font-size: 0.9rem;
    min-height: 1.5em;
  }

  @media (max-width: 768px) {
    .container {
      margin: 10px auto 30px;
      padding: 10px;
    }
    .seat-btn {
      min-width: 38px;
      font-size: 1rem;
    }
    h1, h2 { font-size: 1.5rem; }
  }

  @media (max-width: 480px) {
    body { padding: 5px; }
    .container {
      margin: 5px auto 20px;
      padding: 8px;
      border-radius: 8px;
    }
    h1, h2 { font-size: 1.4rem; margin: 0.8em 0; }
    label, input, select, textarea { font-size: 0.9rem; }
    button { padding: 8px 12px; font-size: 0.95rem; margin-top: 15px; min-width: auto; }
    nav button { padding: 5px 8px; font-size: 0.85rem; }
    #seatMap {
      gap: 4px;
    }
    .seat-btn {
      min-width: 26px;
      font-size: 0.85rem;
      padding: 0;
    }
    table { font-size: 0.8rem; }
    th, td { padding: 6px 4px; }
    td button { padding: 3px 6px; font-size: 0.75rem; }
  }

  .announcement-overlay {
    position: fixed;
    top: 0; left: 0;
    width: 100%; height: 100%;
    background: rgba(0,0,0,0.7);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 1000;
  }
  .announcement-popup {
    background: white;
    padding: 30px;
    border-radius: 10px;
    box-shadow: 0 0 25px rgba(0,0,0,0.5);
    max-width: 500px;
    width: 90%;
    text-align: left;
    position: relative;
    font-size: 1.1rem;
    line-height: 1.5;
  }
  .announcement-popup h3 {
    margin-top: 0;
    color: #b45309;
    font-size: 1.5rem;
    margin-bottom: 20px;
    text-align: center;
  }
  .announcement-popup p {
    margin-bottom: 20px;
    color: #333;
    white-space: pre-wrap;
  }
  .announcement-popup button.close-btn {
    background: #b45309;
    color: white;
    border: none;
    border-radius: 5px;
    padding: 10px 20px;
    cursor: pointer;
    font-size: 1rem;
    transition: background 0.3s;
    margin: 0 auto;
    display: block;
  }
  .announcement-popup button.close-btn:hover {
    background: #8e420b;
  }
  #announcementMessageInput {
    width: calc(100% - 20px);
    height: 80px;
    padding: 10px;
    margin-top: 10px;
    border: 1px solid #ccc;
    border-radius: 5px;
    resize: vertical;
    font-size: 1rem;
  }
  #announcementActiveCheckbox {
    margin-top: 15px;
    margin-right: 8px;
  }
  .button-group {
    display: flex;
    justify-content: space-between;
    align-items: center;
    width: 100%;
    margin-top: 20px;
  }
  .button-group button {
    margin-top: 0;
  }
  .color-legend {
    text-align: center;
    margin-top: 30px;
    padding: 15px;
    border-top: 1px solid #eee;
    display: flex;
    flex-wrap: wrap;
    justify-content: center;
    gap: 20px;
    font-size: 0.9rem;
    color: #555;
  }
  .legend-item {
    display: flex;
    align-items: center;
    gap: 8px;
  }
  .legend-box {
    width: 20px;
    height: 20px;
    border-radius: 4px;
    border: 1px solid #ccc;
  }
  .legend-box.empty { background-color: #CCFFCC; border-color: #88CC88; }
  .legend-box.booked { background-color: #FFCCCC; border-color: #CC8888; }
  .legend-box.mine { background-color: #FFCCFF; border-color: #CC88CC; }
</style>
</head>
<body>
  <!-- 로그인 페이지 -->
  <div class="container" id="loginPage">
    <h1>랜선석 예약 로그인</h1>
    <form id="loginForm" autocomplete="off" novalidate>
      <label for="roomNo">룸 번호 (000호 형식):</label>
      <input type="text" id="roomNo" name="roomNo" placeholder="예: 101호" required />
      <div id="roomError" class="error"></div>

      <label for="userName">이름 (한글 2~4자):</label>
      <input type="text" id="userName" name="userName" placeholder="예: 홍길동" required />
      <div id="nameError" class="error"></div>

      <label for="dormitory">기숙사 선택:</label>
      <select id="dormitory" name="dormitory" required>
        <option value="" disabled selected>선택하세요</option>
        <option value="꿈동">꿈동</option>
        <option value="미래동">미래동</option>
      </select>
      <div id="dormError" class="error"></div>

      <!-- 허니팟 필드 (봇 방지용) -->
      <input type="text" name="honeypot_field" style="display:none !important; visibility:hidden !important; opacity:0 !important; width:0 !important; height:0 !important; border:none !important; padding:0 !important; margin:0 !important;" tabindex="-1" autocomplete="off" />

      <button type="submit">다음</button>
    </form>
    <nav>
      <button id="adminLoginBtn" type="button">관리자 로그인</button>
    </nav>
  </div>

  <!-- 층 선택 페이지 -->
  <div class="container hidden" id="floorSelectPage">
    <h1 id="welcomeText"></h1>
    <p>층을 선택하세요:</p>
    <select id="floorSelect">
      <!-- 옵션은 JavaScript로 동적으로 추가됩니다. -->
    </select>
    <div id="floorError" class="error"></div>
    <button id="floorNextBtn">다음</button>
    <nav>
      <button id="backToLoginBtn" type="button">뒤로가기</button>
    </nav>
  </div>

  <!-- 좌석 배치도 페이지 -->
  <div class="container hidden" id="seatMapPage">
    <h2 id="selectedDormTitle"></h2>
    <h3 id="selectedFloorTitle"></h3>
    <div id="reservationAvailabilityMessage"></div>
    <div id="seatMapWrapper">
      <div id="seatMap" class="seat-grid">
        <!-- 좌석은 JavaScript로 동적으로 생성됩니다. -->
      </div>
    </div>
    <button id="confirmBtn">이 좌석으로 예약</button>
    <button id="cancelSeatBtn" type="button" style="background-color: #fca5a5;">내 예약 취소</button>
    <div class="color-legend">
      <div class="legend-item"><span class="legend-box empty"></span> 예약 가능</div>
      <div class="legend-item"><span class="legend-box booked"></span> 예약 불가능</div>
      <div class="legend-item"><span class="legend-box mine"></span> 내 예약</div>
    </div>
  </div>

  <!-- 관리자 로그인 페이지 -->
  <div class="container hidden" id="adminLoginPage">
    <h1>관리자 로그인</h1>
    <form id="adminLoginForm">
      <label for="adminPassword">관리자 비밀번호:</label>
      <input type="password" id="adminPasswordInput" name="password" required />
      <div id="adminError" class="error"></div>
      <button type="submit">로그인</button>
    </form>
  </div>

  <!-- 관리자 페이지 -->
  <div class="container hidden" id="adminPage">
    <button id="adminLogoutBtn" type="button" style="background-color: #ef4444; color: white; float: right;">로그아웃</button>
    <h1>관리자 페이지</h1>

    <h2>예약 가능 시간 설정</h2>
    <form id="reservationTimeForm">
      <label for="resStartTime">예약 시작 시간:</label>
      <input type="datetime-local" id="resStartTimeInput" required />
      <label for="resEndTime">예약 종료 시간:</label>
      <input type="datetime-local" id="resEndTimeInput" required />
      <div id="timeSettingMessage"></div>
      <button type="submit">시간 설정 저장</button>
    </form>

    <h2>공지사항 설정</h2>
    <form id="announcementForm">
      <label for="announcementMessageInput">공지 내용:</label>
      <textarea id="announcementMessageInput" placeholder="공지 내용을 입력하세요."></textarea>
      <input type="checkbox" id="announcementActiveCheckbox" />
      <label for="announcementActiveCheckbox">공지 활성화</label>
      <div id="announcementMessageStatus" class="error"></div>
      <div class="button-group">
        <button type="submit" style="width: 48%;">공지 저장</button>
        <button type="button" id="announcementDeleteBtn" style="background-color: #fca5a5; color: #b91c1c; width: 48%;">공지 삭제</button>
      </div>
    </form>

    <h2>예약 현황</h2>
    <table>
      <thead>
        <tr><th>이름</th><th>룸 번호</th><th>기숙사</th><th>층</th><th>자리 번호</th><th>예약 취소</th></tr>
      </thead>
      <tbody id="reservationListBody"></tbody>
    </table>

    <button id="clearAllReservationsBtn" type="button" style="background-color: #dc2626; color: white; float: right; margin-top: 15px;">모든 예약 취소</button>
  </div>

  <!-- 공지사항 팝업 오버레이 -->
  <div class="announcement-overlay hidden" id="announcementOverlay">
    <div class="announcement-popup">
      <h3>공지사항</h3>
      <p id="announcementMessage"></p>
      <button class="close-btn" type="button">닫기</button>
    </div>
  </div>


  <!-- Socket.IO 클라이언트 스크립트 (Sentry 관련 코드 없음) -->
  <script src="https://seat-reservation-backend-ygl9.onrender.com/socket.io/socket.io.js"></script>

  <!-- 프론트엔드 자바스크립트 코드 -->
  <script>
    const BACKEND_URL = "https://seat-reservation-backend-ygl9.onrender.com";
    let socket = null;

    let allReservations = {};
    let adminSettings = {};
    let availabilityCheckInterval = null;
    let prevAllowedState = null;
    let currentAnnouncement = null;

    // DOM 요소 참조 변수 선언 (DOMContentLoaded에서 할당)
    let loginPage, loginForm, roomNoInput, userNameInput, dormitorySelect, roomError, nameError, dormError, adminLoginBtn;
    let floorSelectPage, floorSelect, floorNextBtn, backToLoginBtn, welcomeText;
    let seatMapPage, seatMapContainer, confirmBtn, cancelSeatBtn, selectedDormTitle, selectedFloorTitle, reservationAvailabilityMessage;
    let adminLoginPage, adminLoginForm, adminPasswordInput, adminError;
    let adminPage, adminLogoutBtn, reservationListBody, clearAllReservationsBtn;
    let reservationTimeForm, resStartTimeInput, resEndTimeInput, timeSettingMessage;
    let announcementOverlay, announcementPopupMessage, announcementCloseBtn, announcementForm, announcementMessageInput, announcementActiveCheckbox, announcementMessageStatus, announcementDeleteBtn;

    let currentUser = null;
    let currentFloor = null;
    let selectedSeat = null;

    const roomNoPattern = /^\d{3}호$/;
    const koreanNamePattern = /^[가-힣]{2,4}$/;

    // 좌석 배치도 데이터
    const seatLayouts = {
      "꿈동": {
        "2": [
          [null,4,null,5,6,7,8,9,10,null,null,null,null],
          [null,3,null,null,null,null,null,null,null,11,null,null,null],
          [null,2,null,null,null,null,null,null,null,12,null,null,null],
          [null,1,null,null,null,null,null,null,null,null,null,null,null]
        ],
        "3": [
          [null,4,null,5,6,7,8,9,10,null,11,null,null,null],
          [null,3,null,null,null,null,null,null,null,null,12,null,null,null],
          [null,2,null,null,null,null,null,null,null,null,13,null,null,null],
          [null,1,null,null,null,null,null,null,null,null,14,null,null,null]
        ],
        "4": [
          [null,4,null,null,null,null,null,null,null,null],
          [null,3,null,null,5,7,null,null,null,null],
          [null,2,null,null,6,8,null,null,null,null],
          [null,1,null,null,null,null,null,null,null,null]
        ],
        "5": [
          [null,4,null,null,null,5,8,null,null,null],
          [null,3,null,null,null,6,9,null,null,null],
          [null,2,null,null,null,7,10,null,null,null],
          [null,1,null,null,null,null,null,null,null,null]
        ],
        "8": [
          [null,4,null,5,6,7,8,null,null,null,null,null,null],
          [null,3,null,null,null,null,null,null,null,null,null,null,null],
          [null,2,null,null,null,null,null,null,null,null,null,null,null],
          [null,1,null,null,null,null,null,null,null,null,null,null,null]
        ]
      },
      "미래동": {
        "2": [
          [null,null,null,null,null,5,6,7,8,9,10,11,12,null,null,null,null,null],
          [null,null,null,null,4,null,null,null,null,null,null,null,null,13,null,null,null,null],
          [null,null,null,null,3,null,null,null,null,null,null,null,null,14,null,null,null,null],
          [null,null,1,2,null,null,null,null,null,null,null,null,null,null,15,16,null,null],
          [null,17,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null]
        ],
        "4-1": [
          [null,3,null,4,5,null,6,null,null],
          [null,2,null,null,null,null,7,null,null],
          [null,1,null,null,null,null,8,null,null]
        ],
        "4-2": [
          [null,4,null,5,6,7,8,9,10,11,12,null,13,null],
          [null,3,null,null,null,null,null,null,null,null,null,null,14,null],
          [null,2,null,null,null,null,null,null,null,null,null,null,null,null],
          [null,1,null,null,null,null,null,null,null,null,null,null,null,null]
        ]
      }
    };

    // --- API 통신 함수 ---
    async function fetchAllReservations() {
      try {
        const res = await fetch(`${BACKEND_URL}/api/reservations`);
        if (!res.ok) throw new Error('예약 데이터 불러오기 실패: ' + res.statusText);
        const data = await res.json();
        allReservations = {};
        data.forEach(r => allReservations[r._id] = r);
      } catch (e) {
        alert('예약 데이터를 가져오는 데 문제가 발생했습니다. 백엔드 서버 상태를 확인하세요.');
        console.error('API 호출 에러: fetchAllReservations', e);
        // Sentry 관련 코드 제거
        return {};
      }
    }

    async function fetchAdminSettings() {
      try {
        const res = await fetch(`${BACKEND_URL}/api/admin-settings`);
        if (!res.ok) throw new Error('관리자 설정 불러오기 실패: ' + res.statusText);
        adminSettings = await res.json();
      } catch (e) {
        console.error('API 호출 에러: fetchAdminSettings', e);
        // Sentry 관련 코드 제거
      }
    }

    async function fetchAnnouncement() {
      try {
        const res = await fetch(`${BACKEND_URL}/api/announcement`);
        if (!res.ok) throw new Error('공지사항 불러오기 실패: ' + res.statusText);
        currentAnnouncement = await res.json();
      } catch (e) {
        console.error('API 호출 에러: fetchAnnouncement', e);
        // Sentry 관련 코드 제거
      }
    }

    async function adminLogin(password) {
      try {
        const res = await fetch(`${BACKEND_URL}/api/admin-login`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ password })
        });
        const data = await res.json();
        if (data.success) {
          adminError.textContent = '';
          return true;
        } else {
          adminError.textContent = data.message;
          return false;
        }
      } catch (e) {
        console.error('API 호출 에러: adminLogin', e);
        adminError.textContent = '로그인 중 오류가 발생했습니다.';
        // Sentry 관련 코드 제거
        return false;
      }
    }

    async function sendReservation(reservationData) {
      try {
        const res = await fetch(`${BACKEND_URL}/api/reservations`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(reservationData)
        });
        const data = await res.json();
        if (!res.ok) {
          // 서버에서 에러 메시지를 보냈을 경우
          const errorMsg = data.message || '예약 처리 중 오류가 발생했습니다.';
          throw new Error(errorMsg);
        }
        return { success: true, message: data.message, newReservation: data.newReservation };
      } catch (e) {
        console.error('API 호출 에러: sendReservation', e);
        // Sentry 관련 코드 제거
        return { success: false, message: e.message || '예약 처리 중 알 수 없는 오류 발생' };
      }
    }

    async function deleteReservation(id) {
      try {
        const res = await fetch(`${BACKEND_URL}/api/reservations/${id}`, {
          method: 'DELETE'
        });
        const data = await res.json();
        if (!res.ok) throw new Error(data.message || '예약 취소 실패');
        return { success: true, message: data.message };
      } catch (e) {
        console.error('API 호출 에러: deleteReservation', e);
        // Sentry 관련 코드 제거
        return { success: false, message: e.message || '예약 취소 중 알 수 없는 오류 발생' };
      }
    }

    async function deleteAllReservations() {
      try {
        const res = await fetch(`${BACKEND_URL}/api/reservations/all`, {
          method: 'DELETE'
        });
        const data = await res.json();
        if (!res.ok) throw new Error(data.message || '모든 예약 취소 실패');
        return { success: true, message: data.message };
      } catch (e) {
        console.error('API 호출 에러: deleteAllReservations', e);
        // Sentry 관련 코드 제거
        return { success: false, message: e.message || '모든 예약 취소 중 알 수 없는 오류 발생' };
      }
    }

    async function updateAdminSettings(startTime, endTime) {
      try {
        const res = await fetch(`${BACKEND_URL}/api/admin-settings`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ reservationStartTime: startTime, reservationEndTime: endTime })
        });
        const data = await res.json();
        if (!res.ok) throw new Error(data.message || '설정 저장 실패');
        return { success: true, message: '설정이 성공적으로 저장되었습니다.' };
      } catch (e) {
        console.error('API 호출 에러: updateAdminSettings', e);
        // Sentry 관련 코드 제거
        return { success: false, message: e.message || '설정 저장 중 오류 발생' };
      }
    }

    async function updateAnnouncement(message, active) {
      try {
        const res = await fetch(`${BACKEND_URL}/api/announcement`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ message, active })
        });
        const data = await res.json();
        if (!res.ok) throw new Error(data.message || '공지사항 저장 실패');
        return { success: true, message: '공지사항이 저장되었습니다.' };
      } catch (e) {
        console.error('API 호출 에러: updateAnnouncement', e);
        // Sentry 관련 코드 제거
        return { success: false, message: e.message || '공지사항 저장 중 오류 발생' };
      }
    }

    async function deleteAnnouncement() {
      // 서버에서 직접 공지사항을 삭제하는 API가 없다면 (메시지를 빈값으로 업데이트하는 방식만 있다면)
      // 이 함수는 단순히 updateAnnouncement(null, false)를 호출하도록 구현
      // 현재 백엔드에는 delete API가 없으므로 update 로직으로 처리
      return updateAnnouncement("", false);
    }

    // --- 페이지 전환 함수 ---
    function showPage(pageId) {
      ['loginPage', 'floorSelectPage', 'seatMapPage', 'adminLoginPage', 'adminPage'].forEach(id => {
        document.getElementById(id).classList.add('hidden');
      });
      document.getElementById(pageId).classList.remove('hidden');
    }

    // --- 데이터 처리 및 UI 업데이트 함수 ---
    function isSeatAvailable(dormitory, floor, seat) {
      for (const resId in allReservations) {
        const reservation = allReservations[resId];
        if (reservation.dormitory === dormitory && reservation.floor === floor && reservation.seat === seat) {
          return false; // 이미 예약됨
        }
      }
      return true;
    }

    function isMySeat(dormitory, floor, seat, roomNo, name) {
      if (!currentUser || currentUser.roomNo !== roomNo || currentUser.name !== name) {
        return false;
      }
      for (const resId in allReservations) {
        const reservation = allReservations[resId];
        if (reservation.dormitory === dormitory && reservation.floor === floor && reservation.seat === seat &&
            reservation.roomNo === roomNo && reservation.name === name) {
          return true; // 내 예약임
        }
      }
      return false;
    }

    function getMyReservation() {
      if (!currentUser) return null;
      for (const resId in allReservations) {
        const reservation = allReservations[resId];
        if (reservation.roomNo === currentUser.roomNo && reservation.name === currentUser.name) {
          return reservation;
        }
      }
      return null;
    }

    function renderSeatMap(dormitory, floor) {
      const layout = seatLayouts[dormitory][floor];
      if (!layout) {
        seatMapContainer.innerHTML = '<p>해당 층의 좌석 배치도 정보가 없습니다.</p>';
        return;
      }

      seatMapContainer.innerHTML = ''; // 기존 좌석 삭제
      seatMapContainer.style.gridTemplateColumns = `repeat(${layout[0].length}, auto)`; // 컬럼 수 동적 설정

      layout.forEach(row => {
        row.forEach(seatNum => {
          const seatButton = document.createElement('button');
          seatButton.type = 'button';
          seatButton.classList.add('seat-btn');

          if (seatNum === null) {
            seatButton.classList.add('empty'); // 빈 공간
            seatButton.textContent = '';
          } else {
            seatButton.textContent = seatNum;
            seatButton.dataset.seat = seatNum; // 데이터셋에 좌석 번호 저장
            if (!isSeatAvailable(dormitory, floor, seatNum)) {
              seatButton.classList.add('booked');
              seatButton.disabled = true; // 예약된 좌석은 비활성화
            } else {
              seatButton.classList.remove('booked');
              seatButton.disabled = false;
            }

            if (isMySeat(dormitory, floor, seatNum, currentUser.roomNo, currentUser.name)) {
              seatButton.classList.add('mine');
              selectedSeat = seatNum; // 내 좌석을 기본 선택으로
            } else {
              seatButton.classList.remove('mine');
            }

            seatButton.addEventListener('click', () => {
              if (seatButton.classList.contains('booked')) return; // 이미 예약된 좌석은 클릭 불가
              document.querySelectorAll('.seat-btn').forEach(btn => btn.classList.remove('selected'));
              seatButton.classList.add('selected');
              selectedSeat = seatNum;
            });
          }
          seatMapContainer.appendChild(seatButton);
        });
      });

      // 내 좌석이 있다면 자동으로 선택 표시
      if (selectedSeat) {
        const mySeatButton = seatMapContainer.querySelector(`[data-seat="${selectedSeat}"]`);
        if (mySeatButton) {
          mySeatButton.classList.add('selected');
        }
      }
    }


    function renderReservationList() {
      reservationListBody.innerHTML = '';
      const reservationsArray = Object.values(allReservations).sort((a, b) => new Date(a.createdAt) - new Date(b.createdAt)); // 생성일자 순으로 정렬
      reservationsArray.forEach(res => {
        const row = reservationListBody.insertRow();
        row.insertCell(0).textContent = res.name;
        row.insertCell(1).textContent = res.roomNo;
        row.insertCell(2).textContent = res.dormitory;
        row.insertCell(3).textContent = res.floor;
        row.insertCell(4).textContent = res.seat;

        const cancelCell = row.insertCell(5);
        const cancelButton = document.createElement('button');
        cancelButton.textContent = '취소';
        cancelButton.dataset.id = res._id; // 예약 ID 저장
        cancelButton.addEventListener('click', async (e) => {
          if (confirm('이 예약을 취소하시겠습니까?')) {
            const result = await deleteReservation(e.target.dataset.id);
            if (result.success) {
              alert(result.message);
              // Socket.IO가 알아서 reservationsUpdated를 보낼 것이므로 여기서는 직접 UI 업데이트 안함
            } else {
              alert('취소 실패: ' + result.message);
            }
          }
        });
        cancelCell.appendChild(cancelButton);
      });
    }

    function checkReservationAvailability() {
      const myReservation = getMyReservation();
      if (!adminSettings || !adminSettings.reservationStartTime || !adminSettings.reservationEndTime) {
        reservationAvailabilityMessage.textContent = '관리자가 예약 가능 시간을 설정하지 않았습니다.';
        reservationAvailabilityMessage.classList.remove('available');
        prevAllowedState = false;
        return;
      }

      const now = new Date();
      const isAllowed = now >= new Date(adminSettings.reservationStartTime) && now <= new Date(adminSettings.reservationEndTime);

      if (isAllowed) {
        reservationAvailabilityMessage.textContent = myReservation ?
          '현재 예약 가능 시간입니다. (예약 중)' :
          '현재 예약 가능 시간입니다. (예약 대기 중)';
        reservationAvailabilityMessage.classList.add('available');
        confirmBtn.disabled = false;
        cancelSeatBtn.disabled = false;
      } else {
        reservationAvailabilityMessage.textContent = myReservation ?
          '현재 예약 불가능 시간입니다. (예약 중)' :
          '현재 예약 불가능 시간입니다.';
        reservationAvailabilityMessage.classList.remove('available');
        confirmBtn.disabled = true;
        cancelSeatBtn.disabled = true;
      }

      if (prevAllowedState !== isAllowed) {
        if (!isAllowed) {
          alert('현재 예약 불가능 시간입니다.');
        } else if (prevAllowedState !== null) { // 첫 로드 시에는 알림 X
          alert('현재 예약 가능 시간입니다.');
        }
        prevAllowedState = isAllowed;
      }
    }


    function updateAnnouncementDisplay() {
      if (currentAnnouncement && currentAnnouncement.active && currentAnnouncement.message) {
        announcementPopupMessage.textContent = currentAnnouncement.message;
        announcementOverlay.classList.remove('hidden');
      } else {
        announcementOverlay.classList.add('hidden');
      }
    }

    function formatDateTimeLocal(date) {
      if (!date) return '';
      const d = new Date(date);
      // yyyy-MM-ddThh:mm 형식으로 포맷
      return new Date(d.getTime() - (d.getTimezoneOffset() * 60000)).toISOString().slice(0, 16);
    }

    // --- 이벤트 리스너 및 초기화 ---
    document.addEventListener('DOMContentLoaded', async () => {
      // DOM 요소 할당
      loginPage = document.getElementById('loginPage');
      loginForm = document.getElementById('loginForm');
      roomNoInput = document.getElementById('roomNo');
      userNameInput = document.getElementById('userName');
      dormitorySelect = document.getElementById('dormitory');
      roomError = document.getElementById('roomError');
      nameError = document.getElementById('nameError');
      dormError = document.getElementById('dormError');
      adminLoginBtn = document.getElementById('adminLoginBtn');

      floorSelectPage = document.getElementById('floorSelectPage');
      floorSelect = document.getElementById('floorSelect');
      floorNextBtn = document.getElementById('floorNextBtn');
      backToLoginBtn = document.getElementById('backToLoginBtn');
      welcomeText = document.getElementById('welcomeText');

      seatMapPage = document.getElementById('seatMapPage');
      seatMapContainer = document.getElementById('seatMap');
      confirmBtn = document.getElementById('confirmBtn');
      cancelSeatBtn = document.getElementById('cancelSeatBtn');
      selectedDormTitle = document.getElementById('selectedDormTitle');
      selectedFloorTitle = document.getElementById('selectedFloorTitle');
      reservationAvailabilityMessage = document.getElementById('reservationAvailabilityMessage');

      adminLoginPage = document.getElementById('adminLoginPage');
      adminLoginForm = document.getElementById('adminLoginForm');
      adminPasswordInput = document.getElementById('adminPasswordInput');
      adminError = document.getElementById('adminError');

      adminPage = document.getElementById('adminPage');
      adminLogoutBtn = document.getElementById('adminLogoutBtn');
      reservationListBody = document.getElementById('reservationListBody');
      clearAllReservationsBtn = document.getElementById('clearAllReservationsBtn');

      reservationTimeForm = document.getElementById('reservationTimeForm');
      resStartTimeInput = document.getElementById('resStartTimeInput');
      resEndTimeInput = document.getElementById('resEndTimeInput');
      timeSettingMessage = document.getElementById('timeSettingMessage');

      announcementOverlay = document.getElementById('announcementOverlay');
      announcementPopupMessage = document.getElementById('announcementMessage');
      announcementCloseBtn = announcementOverlay.querySelector('.close-btn');
      announcementForm = document.getElementById('announcementForm');
      announcementMessageInput = document.getElementById('announcementMessageInput');
      announcementActiveCheckbox = document.getElementById('announcementActiveCheckbox');
      announcementMessageStatus = document.getElementById('announcementMessageStatus');
      announcementDeleteBtn = document.getElementById('announcementDeleteBtn');

      // 초기 데이터 로드 및 UI 업데이트
      await fetchAllReservations();
      await fetchAdminSettings();
      await fetchAnnouncement();
      updateAnnouncementDisplay();
      checkReservationAvailability();

      // 주기적으로 예약 가능 시간 체크
      availabilityCheckInterval = setInterval(() => {
        checkReservationAvailability();
        // Socket.IO를 통해 실시간 업데이트 받으므로 reservations는 주기적으로 불러오지 않음
      }, 5000); // 5초마다

      showPage('loginPage'); // 시작 페이지 설정

      // --- 이벤트 리스너 설정 ---

      // 로그인 폼 제출
      loginForm.addEventListener('submit', (e) => {
        e.preventDefault();
        roomError.textContent = '';
        nameError.textContent = '';
        dormError.textContent = '';

        const roomNo = roomNoInput.value.trim();
        const userName = userNameInput.value.trim();
        const dormitory = dormitorySelect.value;

        let isValid = true;
        if (!roomNoPattern.test(roomNo)) {
          roomError.textContent = '룸 번호는 000호 형식이어야 합니다.';
          isValid = false;
        }
        if (!koreanNamePattern.test(userName)) {
          nameError.textContent = '이름은 한글 2~4자여야 합니다.';
          isValid = false;
        }
        if (!dormitory) {
          dormError.textContent = '기숙사를 선택해주세요.';
          isValid = false;
        }

        if (isValid) {
          currentUser = { roomNo, name: userName, dormitory };
          welcomeText.textContent = `${currentUser.roomNo} ${currentUser.name}님 환영합니다!`;
          // 해당 기숙사의 층 옵션 동적 추가
          floorSelect.innerHTML = '<option value="" disabled selected>층을 선택하세요</option>';
          Object.keys(seatLayouts[currentUser.dormitory]).forEach(floor => {
            const option = document.createElement('option');
            option.value = floor;
            option.textContent = floor + '층';
            floorSelect.appendChild(option);
          });
          showPage('floorSelectPage');
        }
      });

      // 층 선택 후 다음 버튼
      floorNextBtn.addEventListener('click', () => {
        const selectedFloor = floorSelect.value;
        if (!selectedFloor) {
          document.getElementById('floorError').textContent = '층을 선택해주세요.';
          return;
        }
        document.getElementById('floorError').textContent = '';
        currentFloor = selectedFloor;
        selectedDormTitle.textContent = `${currentUser.dormitory}`;
        selectedFloorTitle.textContent = `${currentFloor}층 좌석 현황`;
        renderSeatMap(currentUser.dormitory, currentFloor);
        showPage('seatMapPage');
      });

      // 뒤로가기 버튼 (층 선택 -> 로그인)
      backToLoginBtn.addEventListener('click', () => {
        currentUser = null;
        roomNoInput.value = '';
        userNameInput.value = '';
        dormitorySelect.value = '';
        showPage('loginPage');
      });

      // 좌석 예약 버튼
      confirmBtn.addEventListener('click', async () => {
        if (confirmBtn.disabled) return; // 예약 불가능 시간인 경우 클릭 무시

        if (!selectedSeat) {
          alert('좌석을 선택해주세요.');
          return;
        }

        const reservationData = {
          roomNo: currentUser.roomNo,
          name: currentUser.name,
          dormitory: currentUser.dormitory,
          floor: currentFloor,
          seat: selectedSeat
        };

        const result = await sendReservation(reservationData);
        if (result.success) {
          alert(result.message);
          // Socket.IO가 알아서 reservationsUpdated를 보낼 것이므로 여기서는 직접 UI 업데이트 안함
        } else {
          alert('예약 실패: ' + result.message);
        }
      });

      // 내 예약 취소 버튼
      cancelSeatBtn.addEventListener('click', async () => {
        if (cancelSeatBtn.disabled) return; // 예약 불가능 시간인 경우 클릭 무시

        const myReservation = getMyReservation();
        if (!myReservation) {
          alert('아직 예약한 좌석이 없습니다.');
          return;
        }

        if (confirm(`현재 예약된 ${myReservation.seat}번 좌석을 취소하시겠습니까?`)) {
          const result = await deleteReservation(myReservation._id);
          if (result.success) {
            alert(result.message);
            selectedSeat = null; // 선택된 좌석 초기화
            // Socket.IO가 알아서 reservationsUpdated를 보낼 것이므로 여기서는 직접 UI 업데이트 안함
          } else {
            alert('취소 실패: ' + result.message);
          }
        }
      });

      // 관리자 로그인 페이지로 이동
      adminLoginBtn.addEventListener('click', () => {
        adminPasswordInput.value = '';
        adminError.textContent = '';
        showPage('adminLoginPage');
      });

      // 관리자 로그인 폼 제출
      adminLoginForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const password = adminPasswordInput.value;
        const success = await adminLogin(password);
        if (success) {
          await fetchAllReservations(); // 관리자 페이지 진입 시 모든 예약 다시 로드
          renderReservationList();
          // 예약 시간 설정을 다시 불러와 UI에 표시
          await fetchAdminSettings();
          if (adminSettings.reservationStartTime) {
            resStartTimeInput.value = formatDateTimeLocal(adminSettings.reservationStartTime);
          }
          if (adminSettings.reservationEndTime) {
            resEndTimeInput.value = formatDateTimeLocal(adminSettings.reservationEndTime);
          }

          // 공지사항 설정도 다시 불러와 UI에 표시
          await fetchAnnouncement();
          announcementMessageInput.value = currentAnnouncement ? currentAnnouncement.message : '';
          announcementActiveCheckbox.checked = currentAnnouncement ? currentAnnouncement.active : false;


          showPage('adminPage');
        }
      });

      // 관리자 로그아웃
      adminLogoutBtn.addEventListener('click', () => {
        if (confirm('관리자 페이지에서 로그아웃하시겠습니까?')) {
          showPage('loginPage'); // 로그인 페이지로 돌아감
        }
      });

      // 모든 예약 취소 버튼 (관리자용)
      clearAllReservationsBtn.addEventListener('click', async () => {
        if (confirm('경고: 모든 예약을 정말로 취소하시겠습니까? 이 작업은 되돌릴 수 없습니다.')) {
          const result = await deleteAllReservations();
          if (result.success) {
            alert(result.message);
            // Socket.IO가 알아서 reservationsUpdated를 보낼 것이므로 여기서는 직접 UI 업데이트 안함
          } else {
            alert('모든 예약 취소 실패: ' + result.message);
          }
        }
      });

      // 예약 시간 설정 폼 제출 (관리자용)
      reservationTimeForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const startTime = resStartTimeInput.value;
        const endTime = resEndTimeInput.value;

        if (!startTime || !endTime) {
          timeSettingMessage.textContent = '시작 시간과 종료 시간을 모두 입력하세요.';
          return;
        }

        const startDateTime = new Date(startTime);
        const endDateTime = new Date(endTime);

        if (startDateTime >= endDateTime) {
          timeSettingMessage.textContent = '시작 시간은 종료 시간보다 빨라야 합니다.';
          return;
        }

        const result = await updateAdminSettings(startDateTime, endDateTime);
        if (result.success) {
          timeSettingMessage.textContent = result.message;
          timeSettingMessage.style.color = '#10b981'; // 초록색
          // Socket.IO가 알아서 settingsUpdated를 보낼 것이므로 여기서는 직접 UI 업데이트 안함
        } else {
          timeSettingMessage.textContent = '설정 저장 실패: ' + result.message;
          timeSettingMessage.style.color = '#dc2626'; // 빨간색
        }
      });

      // 공지사항 팝업 닫기 버튼
      announcementCloseBtn.addEventListener('click', () => {
        announcementOverlay.classList.add('hidden');
      });

      // 공지사항 설정 폼 제출
      announcementForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const message = announcementMessageInput.value.trim();
        const active = announcementActiveCheckbox.checked;

        if (!active && !message) { // 공지 비활성화 & 메시지도 없으면 바로 저장
          const result = await updateAnnouncement(message, active);
          if (result.success) {
            announcementMessageStatus.textContent = '공지사항이 비활성화되었습니다.';
            announcementMessageStatus.style.color = '#10b981';
          } else {
            announcementMessageStatus.textContent = result.message;
            announcementMessageStatus.style.color = '#dc2626';
          }
          return;
        }

        if (active && !message) {
          announcementMessageStatus.textContent = '공지를 활성화하려면 내용을 입력해야 합니다.';
          announcementMessageStatus.style.color = '#dc2626';
          return;
        }

        const result = await updateAnnouncement(message, active);
        if (result.success) {
          announcementMessageStatus.textContent = result.message;
          announcementMessageStatus.style.color = '#10b981';
          // Socket.IO가 알아서 announcementUpdated를 보낼 것이므로 여기서는 직접 UI 업데이트 안함
        } else {
          announcementMessageStatus.textContent = result.message;
          announcementMessageStatus.style.color = '#dc2626';
        }
      });

      // 공지사항 삭제 버튼
      announcementDeleteBtn.addEventListener('click', async () => {
        if (confirm('공지사항을 정말로 삭제하시겠습니까?')) {
          const result = await deleteAnnouncement();
          if (result.success) {
            alert('공지사항이 삭제되었습니다.');
            announcementMessageInput.value = '';
            announcementActiveCheckbox.checked = false;
            // Socket.IO가 알아서 announcementUpdated를 보낼 것이므로 여기서는 직접 UI 업데이트 안함
          } else {
            alert('공지사항 삭제 실패: ' + result.message);
          }
        }
      });


      // --- Socket.IO 이벤트 리스너 ---
      socket = io(); // Socket.IO 클라이언트 연결

      socket.on('connect', () => {
        console.log('Socket.IO 연결 성공!', socket.id);
      });

      socket.on('disconnect', () => {
        console.log('Socket.IO 연결 종료!');
      });

      socket.on('reservationsUpdated', (updatedReservations) => {
        console.log('예약 정보 업데이트 수신:', updatedReservations);
        allReservations = {};
        updatedReservations.forEach(r => allReservations[r._id] = r);
        if (document.getElementById('seatMapPage').classList.contains('hidden')) {
          // 좌석 페이지가 아닌 경우, adminPage가 활성화되어 있으면 예약 목록만 다시 렌더링
          if (!document.getElementById('adminPage').classList.contains('hidden')) {
            renderReservationList();
          }
        } else {
          // 좌석 페이지인 경우, 좌석 맵과 예약 현황 메시지 모두 업데이트
          renderSeatMap(currentUser.dormitory, currentFloor);
          checkReservationAvailability();
        }
        // 예약 목록이 표시되는 모든 페이지에 업데이트를 반영 (예: 관리자 페이지)
        renderReservationList();
      });

      socket.on('settingsUpdated', (updatedSettings) => {
        console.log('관리자 설정 업데이트 수신:', updatedSettings);
        adminSettings = updatedSettings;
        checkReservationAvailability(); // 예약 가능 시간 변경에 따라 메시지 업데이트
      });

      socket.on('announcementUpdated', (updatedAnnouncement) => {
        console.log('공지사항 업데이트 수신:', updatedAnnouncement);
        currentAnnouncement = updatedAnnouncement;
        updateAnnouncementDisplay(); // 공지사항 표시 업데이트
        // 관리자 페이지에 있을 경우 입력 필드도 업데이트
        if (!adminPage.classList.contains('hidden')) {
          announcementMessageInput.value = currentAnnouncement ? currentAnnouncement.message : '';
          announcementActiveCheckbox.checked = currentAnnouncement ? currentAnnouncement.active : false;
        }
      });
    });
  </script>
</body>
</html>